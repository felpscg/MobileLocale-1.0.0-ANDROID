// Copyright (c) 2009-2017 SAP SE, All Rights Reserved
sap.ui.define(["sap/m/library","sap/m/Button","sap/m/List","sap/m/StandardListItem","sap/m/ResponsivePopover","sap/ui/model/json/JSONModel","sap/ui/model/Filter","sap/ui/model/FilterOperator","sap/ui/model/Sorter","sap/ushell/applications/PageComposer/i18n/resources","sap/ushell/services/Container"],function(m,B,L,S,R,J,F,c,d,r){"use strict";var e=m.ButtonType;var P=m.PlacementType;var f=m.ListMode;var g=m.ListSeparators;return function(){var p,t,T,A,o,G,h,j,s,k={},C={};this.init=function(a){p=a.getView();t=p.byId("tileSelectorList");T=p.byId("tileSelectorToolbar");A=p.byId("tileSelectorAddButton");t.setBusy(true);G=new L({mode:f.MultiSelect,showSeparators:g.None,includeItemInSelection:true,selectionChange:function(){h.getBeginButton().setEnabled(!!G.getSelectedItem());},items:{path:"/page/content/sections",template:new S({title:"{title}"})},noDataText:r.i18n.getText("Message.NoGroups")}).setModel(p.getModel());A.setEnabled(false);t.attachSelectionChange(this._onSelectionChange);};this.initTiles=function(E){if(E.aTreeOverride){_(E.aTreeOverride);return;}sap.ushell.Container.getServiceAsync("LaunchPage").then(function(H){C=E.mCatalogTiles;var I=E.catalogTiles.reduce(function(K,M,i){if(M.length){K.push({catalogTitle:E.catalogTitles[i],tiles:M.map(function(a){return{vizId:H.getCatalogTileId(a),title:H.getCatalogTilePreviewTitle(a)||H.getCatalogTileTitle(a),subtitle:H.getCatalogTilePreviewSubtitle(a),icon:H.getCatalogTilePreviewIcon(a)};}).sort(function(a,b){if(a.title>b.title){return 1;}if(a.title<b.title){return-1;}return 0;})});}return K;},[]);_(I);});};this.onSearchTiles=function(){l();};this.onAddTiles=function(E){var a=G.getItems(),b=E.getSource().getBindingContext("catalogs");o=b?b.getProperty():null;if(a.length===1){a[0].setSelected(true);D();}else{w(E);}};this.onSortCatalogsToggle=function(){n();};this.onCollapseAllCatalogs=function(){q(true);};this.onExpandAllCatalogs=function(){q(false);};this.onCatalogItemPress=function(E){u(E.getParameters().listItem);};this._onSelectionChange=function(E){if(h&&h.isOpen()){h.getBeginButton().setEnabled(false);h.close();}E.getParameters().listItems.forEach(function(i){if(i.getBindingContext("catalogs").getProperty().tiles){i.setSelected(false);u(i);}});A.setEnabled(!!v().length);};this.setAddTileHandler=function(a){j=a;};this.onDragStart=function(E){var i=E.getParameter("target").getBindingContext("catalogs").getProperty();if(!i.vizId){E.preventDefault();return;}E.getParameter("dragSession").setComplexData("callback",function callback(a,b){Promise.all([sap.ushell.Container.getServiceAsync("LaunchPage"),sap.ushell.Container.getServiceAsync("NavTargetResolution")]).then(function(H){z(i.vizId,H[0],H[1]).then(function(I){j(I,[b],a);},function(I){j(I,[b],a);});});});};function _(a){var M=new J({catalogs:a});M.setSizeLimit(Infinity);p.setModel(M,"catalogs");s=true;n();t.expandToLevel(1);t.setBusy(false);}function l(){var a=p.getModel().getProperty("/searchText")||"";t.getBinding("items").filter([new F([new F("title",c.Contains,a),new F("subtitle",c.Contains,a)],false)]);}function n(){s=!s;var i=t.getBinding("items"),a=new d("catalogTitle",s);i.sort(a);}function q(b){if(b){t.collapseAll();}else{t.expandToLevel(1);}}function u(a){var i=t.indexOfItem(a);if(a.getExpanded()){t.collapse(i);}else{t.expand(i);}}function v(){return t.getSelectedContextPaths().map(function(a){return p.getModel("catalogs").getContext(a).getProperty();});}function w(E){if(!h||h.bIsDestroyed){y();}G.removeSelections(true);h.getBeginButton().setEnabled(false);h.getEndButton().setEnabled(true);if(!o&&x(A)){h.openBy(T.getAggregation("_overflowButton"));}else{h.openBy(E.getSource());}}function x(a){return(a.hasStyleClass("sapMOTAPButtonNoIcon")||a.hasStyleClass("sapMOTAPButtonWithIcon"));}function y(){h=new R({placement:P.Auto,title:r.i18n.getText("Tooltip.AddToGroups"),beginButton:new B({type:e.Emphasized,text:r.i18n.getText("Button.Add"),press:function(){this.setEnabled(false);h.close();D();}}),endButton:new B({text:r.i18n.getText("Button.Cancel"),press:function(){this.setEnabled(false);h.close();}}),content:G,initialFocus:G});p.addDependent(h);}function z(V,a,b){var i=a.getCatalogTileTargetURL(C[V]);if(i&&i[0]==="#"){if(!k[i]){k[i]=b.resolveHashFragment(i);}return Promise.resolve(k[i].then(function(E){return{vizId:V,inboundPermanentKey:E.inboundPermanentKey};},function(){return{vizId:V,inboundPermanentKey:"",error:"Resolving the hash fragment "+i+" failed."};}));}return Promise.resolve({vizId:V,inboundPermanentKey:""});}function D(){if(typeof j!=="function"){return;}var a=G.getSelectedItems().map(function(i){return G.indexOfItem(i);});var b;if(o){b=[o];}else{b=v();}Promise.all([sap.ushell.Container.getServiceAsync("LaunchPage"),sap.ushell.Container.getServiceAsync("NavTargetResolution")]).then(function(i){b.forEach(function(E){z(E.vizId,i[0],i[1]).then(function(H){j(H,a);},function(H){j(H,a);});});if(!o){A.setEnabled(false);t.removeSelections(true);}});}};});

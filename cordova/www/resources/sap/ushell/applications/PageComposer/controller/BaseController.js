// Copyright (c) 2009-2017 SAP SE, All Rights Reserved
sap.ui.define(["sap/ui/core/mvc/Controller","sap/ui/core/UIComponent","sap/ushell/applications/PageComposer/util/PagePersistence","sap/ushell/applications/PageComposer/util/Transport","sap/m/MessageBox","sap/m/library","sap/base/Log","sap/ushell/applications/PageComposer/i18n/resources"],function(C,U,P,t,M,s,L,r){"use strict";return C.extend("sap.ushell.applications.PageComposer.controller.BaseController",{getPageRepository:function(){if(!this.oPagePersistenceInstance){this.oPagePersistenceInstance=new P(this.getView().getModel("PageRepository"));}return this.oPagePersistenceInstance;},getRouter:function(){return U.getRouterFor(this);},getModel:function(n){return this.getView().getModel(n);},setModel:function(m,n){return this.getView().setModel(m,n);},getResourceBundle:function(){return this.getOwnerComponent().getModel("i18n").getResourceBundle();},_createEditDialog:function(o,a){var v=this.getOwnerComponent().getRootControl();return new Promise(function(b,c){sap.ui.require(["sap/ushell/applications/PageComposer/controller/EditDialog.controller"],function(E){if(!this.oEditPageDialogController){this.oEditPageDialogController=new E(v);}this.oEditPageDialogController.attachCancel(a);this.oEditPageDialogController.attachConfirm(o);this.oEditPageDialogController.load().then(function(){b(this.oEditPageDialogController);}.bind(this));}.bind(this));}.bind(this));},showCreateDialog:function(o,a){var v=this.getOwnerComponent().getRootControl();sap.ui.require(["sap/ushell/applications/PageComposer/controller/CreatePageDialog.controller"],function(b){if(!this.oCreatePageDialogController){this.oCreatePageDialogController=new b(v);}this.oCreatePageDialogController.attachConfirm(o);this.oCreatePageDialogController.attachCancel(a);this.oCreatePageDialogController.load().then(function(){if(t.isTransportSupported()){return this.getOwnerComponent().createTransportComponent().then(function(c){return t.enhanceDialogWithTransport(this.oCreatePageDialogController,c,o);}.bind(this));}return this.oCreatePageDialogController;}.bind(this)).then(function(e){if(e){e.open();}}).catch(function(e){this.oCreatePageDialogController.destroy();this.handleBackendError(e);}.bind(this));}.bind(this));},_createDeleteDialog:function(o,a){var v=this.getOwnerComponent().getRootControl();return new Promise(function(b,c){sap.ui.require(["sap/ushell/applications/PageComposer/controller/DeleteDialog.controller"],function(D){if(!this.oDeletePageDialogController){this.oDeletePageDialogController=new D(v);}this.oDeletePageDialogController.attachCancel(a);this.oDeletePageDialogController.attachConfirm(o);this.oDeletePageDialogController.load().then(function(){b(this.oDeletePageDialogController);}.bind(this));}.bind(this));}.bind(this));},checkShowEditDialog:function(p,o,a){t.checkShowTransport(p).then(function(b){if(b){return Promise.all([this.getOwnerComponent().createTransportComponent(p.metadata.devclass),this._createEditDialog(o,a)]).then(function(c){var T=c[0];var d=c[1];d.getModel().setProperty("/message",r.i18n.getText("EditDialog.TransportRequired"));var e=t.enhanceDialogWithTransport(d,T,o);e.open();});}return t.checkShowLocked(p).then(function(c){if(c){return this.showMessageBoxError(r.i18n.getText("EditDialog.LockedText",[c.foreignOwner]),true);}}.bind(this));}.bind(this)).catch(function(e){this.handleBackendError(e);}.bind(this));},checkShowDeleteDialog:function(p,o,a){t.checkShowTransport(p).then(function(b){if(b){return Promise.all([this.getOwnerComponent().createTransportComponent(p.metadata.devclass),this._createDeleteDialog(o,a)]).then(function(c){var T=c[0];var d=c[1];d.getModel().setProperty("/message",r.i18n.getText("DeleteDialog.TransportRequired"));var e=t.enhanceDialogWithTransport(d,T,o);e.open();});}return t.checkShowLocked(p).then(function(c){if(c){return this.showMessageBoxError(r.i18n.getText("DeleteDialog.LockedText",[c.foreignOwner]),true);}return this._createDeleteDialog(o,a).then(function(d){d.getModel().setProperty("/message",r.i18n.getText("DeleteDialog.Text"));d.open();});}.bind(this));}.bind(this)).catch(function(e){this.handleBackendError(e);}.bind(this));},showMessageBoxError:function(e,n){if(n){M.error(e,{onClose:function(){this.navigateToPageOverview();}.bind(this)});}else{M.error(e);}},navigateToPageOverview:function(){this.getRouter().navTo("overview");},preview:function(p){if(sap.ushell.Container.getDirtyFlag()){this.showMessageBoxError(this.getResourceBundle().getText("Message.SaveChanges"));}else{var u=sap.ushell.Container.getService("URLParsing");var o=u.parseParameters(window.location.search);o["sap-ushell-xx-overwrite-config"]=["ushell/pages/enable:true"];o["sap-ushell-page"]=[p];var a=u.paramsToString(o);var b=window.location.pathname+"?"+a;s.URLHelper.redirect(b,true);}},handleBackendError:function(e){if(e.responseText){this.getOwnerComponent().showErrorDialog(e);}else{L.error(e);}}});});

// Copyright (c) 2009-2017 SAP SE, All Rights Reserved
sap.ui.define(["sap/ushell/EventHub","sap/ushell/Config","sap/ui/core/Component","sap/ushell/components/applicationIntegration/AppLifeCycle","sap/ui/thirdparty/jquery","sap/ui/model/json/JSONModel","sap/ui/core/theming/Parameters","sap/ui/Device","sap/ushell/resources"],function(E,C,a,A,q,J,P,D,r){"use strict";sap.ui.controller("sap.ushell.components.shell.UserSettings.ThemeSelector",{TILE_SIZE:{Small:0,Responsive:1,getName:function(v){return Object.keys(this)[v];}},onInit:function(){try{this.userInfoService=sap.ushell.Container.getService("UserInfo");this.oUser=this.userInfoService.getUser();}catch(e){q.sap.log.error("Getting UserInfo service failed.");this.oUser=sap.ushell.Container.getUser();}this.currentThemeId=this.oUser.getTheme();this.origThemeId=this.currentThemeId;this.aThemeList=null;this.isContentLoaded=false;this.aSapThemeMap={base:"sapUshellBaseIconStyle",sap_bluecrystal:"sapUshellBlueCrystalIconStyle",sap_belize_hcb:"sapUshellHCBIconStyle",sap_belize_hcw:"sapUshellHCWIconStyle",sap_belize:"sapUshellBelizeIconStyle",sap_belize_plus:"sapUshellPlusIconStyle",sap_fiori_3:"sapUshellQuartzLightIconStyle"};this.oPersonalizers={};},getConfigurationModel:function(){var c=new J({});c.setData({isRTL:sap.ui.getCore().getConfiguration().getRTL(),sapUiContentIconColor:P.get("sapUiContentIconColor"),flexAlignItems:"Center",textAlign:D.system.phone?"Left":"Right",textDirection:"Row",labelWidth:"auto",isCozyContentMode:this.isCozyContentMode(),sizeBehaviorConfigurable:C.last("/core/home/sizeBehaviorConfigurable")});return c;},_getIsChangeThemePermitted:function(){return this.oUser.isSetThemePermitted();},onAfterRendering:function(){var t=this;var d=E.on("UserPreferencesDetailNavigated");d.do(function(i){if(i!=="detailuserPrefThemeSelector"){return;}d.off("UserPreferencesDetailNavigated");var l=sap.ui.getCore().byId("userPrefThemeSelector--themeList"),b=l.getItems(),I,T;l.toggleStyleClass("sapUshellThemeListDisabled",!t.isListActive());b.forEach(function(L){T=L.getCustomData()[0].getValue();I=L.getContent()[0].getItems()[0].getItems()[0];if(!t.isListActive()){L.isSelectable=function(){return false;};}if(T===t.currentThemeId){L.setSelected(true);if(!t.isListActive()){L.toggleStyleClass("sapUshellThemeListItemSelected",true);}}else{L.setSelected(false);}if(t.aSapThemeMap[T]){I.addStyleClass(t.aSapThemeMap[T]);}I.toggleStyleClass("sapUshellHCBIconStyleOnHCB",T===t.currentThemeId&&T==="sap_belize_hcb");I.toggleStyleClass("sapUshellHCWIconStyleOnHCW",t.currentThemeId!=="sap_belize_hcb"&&T==="sap_belize_hcw");});var c=sap.ui.getCore().byId("userPrefThemeSelector--contentDensitySwitch");if(c){c.setState(t.currentContentDensity==="cozy");c.setEnabled(t.isContentDensitySwitchEnabled());}var e=sap.ui.getCore().byId("userPrefThemeSelector--tileSizeRadioButtonGroup");if(e){var s=C.last("/core/home/sizeBehavior");e.setSelectedIndex(t.TILE_SIZE[s]);}l.getModel("config").setProperty("/sapUiContentIconColor",P.get("sapUiContentIconColor"));q(".sapUshellAppearanceTable > table").attr("role","list");});},getContent:function(){var t=this;var d=q.Deferred();var R=r.getTranslationModel();this.getView().setModel(R,"i18n");this.getView().setModel(this.getConfigurationModel(),"config");if(this.isContentDensitySwitchEnabled()){this.origContentDensity=this.currentContentDensity;if(this.oUser.getContentDensity()){this.currentContentDensity=this.oUser.getContentDensity();}else{this.currentContentDensity="cozy";}}if(this.isContentLoaded===true){d.resolve(this.getView());}else{var b=this._getThemeList();b.done(function(T){if(T.length>0){T.sort(function(c,e){var f=c.name,g=e.name;if(f<g){return-1;}if(f>g){return 1;}return 0;});for(var i=0;i<T.length;i++){if(T[i].id===t.currentThemeId){T[i].isSelected=true;}else{T[i].isSelected=false;}}t.getView().getModel().setProperty("/options",T);d.resolve(t.getView());}else{d.reject();}});b.fail(function(){d.reject();});}return d.promise();},getValue:function(){var d=q.Deferred();var t=this._getThemeList();var b=this;var c;t.done(function(T){b.aThemeList=T;c=b._getThemeNameById(b.currentThemeId);d.resolve(c);});t.fail(function(e){d.reject(e);});return d.promise();},onCancel:function(){this.currentThemeId=this.oUser.getTheme();if(this.isContentDensitySwitchEnabled()){this.currentContentDensity=this.oUser.getContentDensity();}this.tileSizeChanged=false;},onSave:function(){var R=q.Deferred(),w,p=[],t=0,s=0,f=0,F=[],b=function(){s++;R.notify();},c=function(e){F.push({entry:"currEntryTitle",message:e});f++;R.notify();};var T=this.onSaveThemes();T.done(b);T.fail(c);p.push(T);if(this.isContentDensitySwitchEnabled()){var o=this.onSaveContentDensity();o.done(b);o.fail(c);p.push(o);}if(this.tileSizeChanged&&this.currentTileSize){C.emit("/core/home/sizeBehavior",this.currentTileSize);if(this.currentTileSize==="Responsive"){q(".sapUshellTile").removeClass("sapUshellSmall");q(".sapUshellPlusTile").removeClass("sapUshellPlusTileSmall");}else{q(".sapUshellTile").addClass("sapUshellSmall");q(".sapUshellPlusTile").addClass("sapUshellPlusTileSmall");}this.tileSizeChanged=false;var S=this.writeToPersonalization("flp.settings.FlpSettings","sizeBehavior",this.currentTileSize);S.done(b);S.fail(c);p.push(S);}w=q.when.apply(null,p);w.done(function(){R.resolve();});R.progress(function(){if(f>0&&(f+s===t)){R.reject("At least one save action failed");}});return R.promise();},onSaveThemes:function(){var d=q.Deferred();var u;if(this.oUser.getTheme()!==this.currentThemeId&&this.isListActive()){if(this.currentThemeId){this.oUser.setTheme(this.currentThemeId);A.postMessageToIframeApp("sap.ushell.appRuntime","themeChange",{"currentThemeId":this.currentThemeId});u=this.userInfoService.updateUserPreferences(this.oUser);u.done(function(){this.origThemeId=this.currentThemeId;this.oUser.resetChangedProperty("theme");d.resolve();}.bind(this));u.fail(function(e){this.oUser.setTheme(this.origThemeId);this.oUser.resetChangedProperty("theme");this.currentThemeId=this.origThemeId;q.sap.log.error(e);d.reject(e);}.bind(this));}else{d.reject("Could not find theme: "+this.currentThemeId);}}else{d.resolve();}return d.promise();},_getThemeList:function(){var d=q.Deferred(),t=this;if(!this.aThemeList){var g=this.userInfoService.getThemeList();g.done(function(o){t.aThemeList=o.options;if(t._getIsChangeThemePermitted()===false){t.aThemeList=[{id:t.currentThemeId,name:t._getThemeNameById(t.currentThemeId)}];}d.resolve(t.aThemeList);});g.fail(function(){d.reject("Failed to load theme list.");});}else{d.resolve(this.aThemeList);}return d.promise();},getCurrentThemeId:function(){return this.currentThemeId;},setCurrentThemeId:function(n){this.currentThemeId=n;},_getThemeNameById:function(t){if(this.aThemeList){for(var i=0;i<this.aThemeList.length;i++){if(this.aThemeList[i].id===t){return this.aThemeList[i].name;}}}return t;},onSaveContentDensity:function(){var d=q.Deferred();var u;if(this.oUser.getContentDensity()!==this.currentContentDensity&&this.isContentDensitySwitchEnabled()){if(this.currentContentDensity){this.oUser.setContentDensity(this.currentContentDensity);u=this.userInfoService.updateUserPreferences(this.oUser);u.done(function(){this.oUser.resetChangedProperty("contentDensity");this.origContentDensity=this.currentContentDensity;sap.ui.getCore().getEventBus().publish("launchpad","toggleContentDensity",{contentDensity:this.currentContentDensity});E.emit("toggleContentDensity",{contentDensity:this.currentContentDensity});E.once("toggleContentDensity").do(function(){d.resolve();});}.bind(this));u.fail(function(e){this.oUser.setContentDensity(this.origContentDensity);this.oUser.resetChangedProperty("contentDensity");this.currentContentDensity=this.origContentDensity;q.sap.log.error(e);d.reject(e);}.bind(this));}else{d.reject("Could not find mode: "+this.currentContentDensity);}}else{d.resolve();}return d.promise();},getCurrentContentDensity:function(){return this.currentContentDensity;},isCozyContentMode:function(){return!!q("body.sapUiSizeCozy").length;},setCurrentContentDensity:function(e){var n=e.getSource().getState()?"cozy":"compact";this.currentContentDensity=n;},setCurrentTileSize:function(e){var n=e.getSource().getSelectedIndex();this.currentTileSize=this.TILE_SIZE.getName(n);this.tileSizeChanged=true;},getIconFormatter:function(t){if(this.aSapThemeMap[t]){return undefined;}return"sap-icon://palette";},onSelectHandler:function(e){var i=e.getParameters().listItem;this.setCurrentThemeId(i.getBindingContext().getProperty("id"));},isContentDensitySwitchEnabled:function(){return(D.system.combi&&this.getView().getModel().getProperty("/contentDensity")&&this.oUser.isSetContentDensityPermitted())||false;},isListActive:function(){return this.getView().getModel().getProperty("/setTheme");},writeToPersonalization:function(c,i,v){var p;try{p=this.getPersonalizer(c,i).setPersData(v);}catch(e){q.sap.log.error("Personalization service does not work:");q.sap.log.error(e.name+": "+e.message);p=q.when(Promise.reject(e));}return p;},getPersonalizer:function(c,i){var k=c+"-"+i;if(this.oPersonalizers[k]){return this.oPersonalizers[k];}var p=sap.ushell.Container.getService("Personalization");var o=a.getOwnerComponentFor(this);var s={keyCategory:p.constants.keyCategory.FIXED_KEY,writeFrequency:p.constants.writeFrequency.LOW,clientStorageAllowed:true};if(!this.oPersonalizers[k]){this.oPersonalizers[k]=p.getPersonalizer({container:c,item:i},s,o);}return this.oPersonalizers[k];}});});

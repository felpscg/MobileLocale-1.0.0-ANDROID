// Copyright (c) 2009-2017 SAP SE, All Rights Reserved
sap.ui.define(["sap/m/Text","sap/m/Dialog","sap/m/Button","sap/ui/thirdparty/jquery","sap/base/Log","sap/ui/Device"],function(T,D,B,q,L,a){"use strict";function U(c,p,S){var o=(S&&S.config)||{},b=[],A=false,i=false,l,I;window.oCustomProperties={};this.setLegalText=function(t){l=t;if(I){this.init(I.usageAnalyticsTitle,I.iAgree,I.iDisagree,I.remindMeLater);}};this.getLegalText=function(){return l;};this.setTrackUsageAnalytics=function(s){var d=q.Deferred(),u,f=s,g=sap.ushell.Container.getUser().getTrackUsageAnalytics();try{var h=sap.ushell.Container.getService("UserInfo");if(g!==f){sap.ushell.Container.getUser().setTrackUsageAnalytics(f);u=h.updateUserPreferences(sap.ushell.Container.getUser());u.done(function(){sap.ushell.Container.getUser().resetChangedProperty("trackUsageAnalytics");if(!i&&f){this.start();}else if(i&&f===false){window.swa.disable();}else if(i&&f){window.swa.enable();}d.resolve();}.bind(this));u.fail(function(E){sap.ushell.Container.getUser().setTrackUsageAnalytics(g);sap.ushell.Container.getUser().resetChangedProperty("trackUsageAnalytics");L.error(E);d.reject(E);});}else{d.resolve();}}catch(e){L.error("Getting UserInfo service failed.");d.reject("Getting UserInfo service failed.");}return d.promise();};this.showLegalPopup=function(){setTimeout(function(){var d=new D("agreementMessageBox",{title:I.usageAnalyticsTitle,type:"Message",stretch:a.system.phone,buttons:[new B("remindMeLaterButton",{text:I.remindMeLater,press:function(){d.close();}}),new B("iAgreeButton",{text:I.iAgree,type:"Accept",press:function(){sap.ushell.Container.getService("UsageAnalytics").setTrackUsageAnalytics(true);d.close();}}),new B("iDisagreeButton",{text:I.iDisagree,press:function(){sap.ushell.Container.getService("UsageAnalytics").setTrackUsageAnalytics(false);d.close();}})],afterClose:function(){d.destroy();},content:[new T({text:l})]}).addStyleClass("sapUshellUsageAnalyticsPopUp");d.open();},100);};this.systemEnabled=function(){if(!o.enabled||!o.pubToken||(this.isSetUsageAnalyticsPermitted()&&!l)){if(!o.pubToken){L.warning("No valid pubToken was found in the service configuration");}if(!l){L.warning("No Legal text message found.");}return false;}return true;};this.userEnabled=function(){var u=sap.ushell.Container.getUser();if(!this.systemEnabled()){return false;}return u.getTrackUsageAnalytics();};this.start=function(){sap.ui.getCore().getEventBus().publish("sap.ushell.services.UsageAnalytics","usageAnalyticsStarted");this._initUsageAnalyticsLogging();i=true;window.swa.custom2={ref:sap.ui.getCore().getConfiguration().getLanguage()};};this.init=function(u,s,d,r){I={usageAnalyticsTitle:u,iAgree:s,iDisagree:d,remindMeLater:r};if(this.systemEnabled()&&!i){if(!this.isSetUsageAnalyticsPermitted()){this.start();}else if(l){if(this.userEnabled()===true){this.start();}else if(this.userEnabled()===null||this.userEnabled()===undefined){this.showLegalPopup();}}}};this.setCustomAttributes=function(C){var d,P="attribute",s,e="custom",f,F,g="customFunction";if(!this.userEnabled()&&this.isSetUsageAnalyticsPermitted()){return;}for(d=1;d<6;d++){f=e.concat(d+4);if(window.swa[f]!==undefined){continue;}s=P+d;if(C[s]===undefined){continue;}if(q.isFunction(C[s])){F=g+d;window[F]=C[s];window.swa[f]={ref:F};}else{window.swa[f]={ref:C[s]};}}};this.logCustomEvent=function(e,d,f){if(!this.userEnabled()&&this.isSetUsageAnalyticsPermitted()){return;}if(!this._isAnalyticsScriptLoaded()){this._addDelayedEvent(e,d,f);return;}if(f){f.unshift(d);f.unshift(e);window.swa.trackCustomEvent.apply(window.swa.trackCustomEvent,f);}else{window.swa.trackCustomEvent(e,d);}};window._trackingScriptsLoaded=function(){var d,t;A=true;for(d=0;d<b.length;d++){t=b[d];this.logCustomEvent(t.eventType,t.customEventValue,t.aAdditionalValues);}b=null;};this._initUsageAnalyticsLogging=function(){if(window.swa===undefined){window.swa={};}window.swa.pubToken=o.pubToken;window.swa.baseUrl=o.baseUrl;window.swa.bannerEnabled=false;window.swa.loggingEnabled=true;window.swa.visitorCookieTimeout=63113852;window.swa.dntLevel=1;window.swa.trackerReadyCallback=window._trackingScriptsLoaded.bind(this);window.swa.clicksEnabled=(o.logClickEvents!==false);window.swa.pageLoadEnabled=(o.logPageLoadEvents!==false);this._handlingTrackingScripts();};this._handlingTrackingScripts=function(){var d=document,g=d.createElement("script"),s=d.getElementsByTagName("script")[0];g.onerror=function(){L.warning("SWA scripts not loaded!");};g.type="text/javascript";g.defer=true;g.async=true;g.src=window.swa.baseUrl+"js/privacy.js";s.parentNode.insertBefore(g,s);};this._isAnalyticsScriptLoaded=function(){return A;};this.isSetUsageAnalyticsPermitted=function(){if(o.setUsageAnalyticsPermitted===undefined){return true;}return o.setUsageAnalyticsPermitted;};this._addDelayedEvent=function(e,d,f){var g={eventType:e,customEventValue:d,aAdditionalValues:f};b.push(g);};}U.hasNoAdapter=true;return U;},true);

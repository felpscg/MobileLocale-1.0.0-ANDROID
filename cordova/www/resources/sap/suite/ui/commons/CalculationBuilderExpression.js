sap.ui.define(["sap/ui/thirdparty/jquery","./library","./CalculationBuilderItem","sap/ui/core/Control","sap/ui/core/ValueState","sap/ui/core/Popup","sap/ui/core/TextAlign","sap/ui/core/delegate/ItemNavigation","sap/m/MessageBox","sap/m/OverflowToolbar","sap/m/OverflowToolbarToggleButton","sap/m/OverflowToolbarButton","sap/m/ToolbarSpacer","sap/m/Title","sap/m/ButtonType","sap/m/Button","sap/m/FlexBox","sap/m/FlexRendertype","sap/m/FlexAlignItems","sap/m/FlexDirection","sap/m/SegmentedButton","sap/m/SegmentedButtonItem","sap/m/StepInput","sap/m/Input","sap/m/InputType","sap/m/Page","sap/m/List","sap/m/ListMode","sap/m/ListType","sap/m/StandardListItem","sap/m/NavContainer","sap/m/SearchField","sap/m/Label","sap/m/Panel","sap/m/ResponsivePopover","sap/m/PlacementType","sap/m/Toolbar","sap/m/MessageStrip","./CalculationBuilderValidationResult","sap/suite/ui/commons/ControlProxy","sap/ui/core/Icon","sap/ui/thirdparty/jqueryui/jquery-ui-core","sap/ui/thirdparty/jqueryui/jquery-ui-widget","sap/ui/thirdparty/jqueryui/jquery-ui-mouse","sap/ui/thirdparty/jqueryui/jquery-ui-draggable","sap/ui/thirdparty/jqueryui/jquery-ui-droppable","sap/ui/thirdparty/jqueryui/jquery-ui-selectable"],function(q,l,C,a,V,P,T,I,M,O,b,c,d,e,B,f,F,g,h,j,S,m,n,o,p,r,L,s,t,u,N,v,w,x,R,y,z,A,D,E,G){"use strict";var H=l.CalculationBuilderItemType,J=l.CalculationBuilderOperatorType,K=l.CalculationBuilderComparisonOperatorType,Q=l.CalculationBuilderLogicalOperatorType,U=l.CalculationBuilderLayoutType;var W=Object.freeze({PAGE_MAIN:"-pagemain",PAGE_OPERATORS:"-pageoperators",PAGE_CONSTANT:"-pageconstant",PAGE_VARIABLE:"-pagevariable",PAGE_FUNCTIONS:"-pagefunctions"});var X=Object.freeze({OPERATORS_CATEGORY:"sap-icon://attachment-html",CONSTANTS_CATEGORY:"sap-icon://grid",VARIABLES_CATEGORY:"sap-icon://notes",FUNCTIONS_CATEGORY:"sap-icon://chalkboard",DELETE:"sap-icon://delete"});var Y=Object.freeze({KEY_PREVIOUS:"previous",KEY_NEXT:"next",MOUSE:"mouse"});var Z="##DEFAULT##";var $=sap.ui.getCore().getLibraryResourceBundle("sap.suite.ui.commons");var _=a.extend("sap.suite.ui.commons.CalculationBuilderExpression",{metadata:{library:"sap.suite.ui.commons",defaultAggregation:"items",aggregations:{items:{type:"sap.suite.ui.commons.CalculationBuilderItem",multiple:true,singularName:"item",bindable:"bindable"},variables:{type:"sap.suite.ui.commons.CalculationBuilderVariable",multiple:true,singularName:"Variable"},functions:{type:"sap.suite.ui.commons.CalculationBuilderFunction",multiple:true,singularName:"Function"},operators:{type:"sap.ui.core.Item",multiple:true,singularName:"operator"},groups:{type:"sap.suite.ui.commons.CalculationBuilderGroup",multiple:true,singularName:"Group"}},events:{change:{}}},renderer:function(k,a1){k.write("<div");k.writeControlData(a1);k.addClass("sapCalculationBuilderInner");k.writeClasses(a1);k.write(">");k.write(a1._renderDelimiter(0));a1.getItems().forEach(function(b1,i){b1._iIndex=i;b1._bReadOnly=a1._bReadOnly;k.renderControl(b1);k.write(a1._renderDelimiter(i+1));},this);if(!a1._bReadOnly){k.renderControl(a1._getNewItem());}k.write("<div class=\"sapCalculationBuilderSelected\"></div>");k.write("</div>");k.write("<div id=\""+a1.getId()+"-erroricon\"  class=\"sapCalculationBuilderExpressionErrorIcon\">");k.renderControl(a1._getErrorIcon());k.write("</div>");}});_.prototype.init=function(){this._aErrors=[];this._bAreSelectedItemsDeleting=false;this._bDragging=false;this._bIsCalculationBuilderRendering=false;};_.prototype._renderDelimiter=function(i){var k="";k+="<div class=\"sapCalculationBuilderDelimiter sapCalculationBuilderDroppable\" index=\""+i+"\">";k+="<div class=\"sapCalculationBuilderDroppableLine\"></div>";k+="<div class=\"sapCalculationBuilderDroppableCircle\"></div>";k+="<div class=\"sapCalculationBuilderDelimiterNewButton\">";k+="<span role=\"presentation\" aria-hidden=\"true\" data-sap-ui-icon-content=\"î€¸\""+"class=\"sapUiIcon sapUiIconMirrorInRTL sapCalculationBuilderDelimiterNewButtonIcon\" style=\"font-family:'SAP-icons'\"></span>";k+="</div>";k+="</div>";return k;};_.prototype.onBeforeRendering=function(){this._reset();this._createPopup();this.getParent()._enableOrDisableExpandAllButton();this._aErrors=this._validateSyntax();this._fireAfterValidation();this._bIsCalculationBuilderRendering=true;this._bRendered=false;};_.prototype.onAfterRendering=function(){this._bIsCalculationBuilderRendering=false;if(!this._bReadOnly){this._setupDroppable();this._setupSelectable();this._setupNewButtonEvents();}this._setupKeyboard();this._bRendered=true;var i=this.getParent();if(i._bRendered){i._setExpression(i._oInput._itemsToString({items:this.getItems(),errors:this._aErrors}));i._oInput._displayError(this._aErrors.length!==0);}};_.prototype.onsapfocusleave=function(){if(!this._bAreSelectedItemsDeleting){this._deselect();}};_.prototype.onsapenter=function(i){this._handleEnter(i);};_.prototype.onsapspace=function(i){if(q(i.target).hasClass("sapCalculationBuilderItem")){this._handleSpace(i);}};_.prototype.onsappreviousmodifiers=function(i){if(i.ctrlKey){this._handleCtrlPrevious(i);}};_.prototype.onsapnextmodifiers=function(i){if(i.ctrlKey){this._handleCtrlNext(i);}};_.prototype.onsapdelete=function(i){this._handleDelete(i);};_.prototype.exit=function(){if(this._oPopover){this._oPopover.destroy();}if(this._oItemNavigation){this.removeDelegate(this._oItemNavigation);this._oItemNavigation.destroy();}if(this._oErrorIcon){this._oErrorIcon.destroy();this._oErrorIcon=null;}};_.prototype._getErrorIcon=function(){if(!this._oErrorIcon){this._oErrorIcon=new G({src:"sap-icon://message-error",useIconTooltip:false,size:"20px"});}return this._oErrorIcon;};_.prototype._createPopup=function(){var i={};this._createPopoverLayout(i);this._createPopoverConstantsItems(i);this._createPopoverFunctionsItems(i);this._createPopoverOperatorsItems(i);this._createPopoverNavContainer(i);this._createPopover(i);};_.prototype._reset=function(){this.getItems().forEach(function(i){i._reset();});if(this._oPopover){this._oPopover.destroy();this._oPopover=null;}};_.prototype._createPopoverLayout=function(i){var k=function(b1){return new f({text:b1==="*"?"x":b1,press:this._updateOrCreateItem.bind(this,{type:H.Operator,key:b1})}).addStyleClass("sapUiTinyMarginEnd");}.bind(this);var a1=new F({renderType:g.Div});a1.addStyleClass("sapCalculationBuilderItemPopupOperators");Object.keys(J).forEach(function(b1){if(this.getParent()._isTokenAllowed(b1)){var c1=k(J[b1]);if(b1===J[","]){this._attachAriaLabelToButton(c1,$.getText("CALCULATION_BUILDER_COMMA_ARIA_LABEL"));}else if(b1===J["-"]){this._attachAriaLabelToButton(c1,$.getText("CALCULATION_BUILDER_MINUS_ARIA_LABEL"));}a1.addItem(c1);}}.bind(this));i.layout=a1.getItems().length>0?a1:null;};_.prototype._createPopoverConstantsItems=function(i){if(this.getParent().getAllowStringConstants()){i.constantInput=new o({width:"100%",placeholder:$.getText("CALCULATION_BUILDER_ADD_CONSTANT_FIELD_PLACEHOLDER_ANY_STRING"),valueStateText:$.getText("CALCULATION_BUILDER_ADD_CONSTANT_FIELD_PLACEHOLDER_ERROR"),liveChange:function(k){var a1=k.getSource(),b1=k.getParameter("value"),c1=b1.indexOf("\"")===-1;a1.setValueState(c1?V.None:V.Error);i.constantInput.okButton.setEnabled(c1);}});}else{i.constantInput=new n({width:"100%",placeholder:$.getText("CALCULATION_BUILDER_ADD_CONSTANT_FIELD_PLACEHOLDER"),textAlign:T.Right,valueStateText:$.getText("CALCULATION_BUILDER_ADD_CONSTANT_FIELD_ERROR_TEXT"),displayValuePrecision:3});}};_.prototype._createPopoverVariablesItems=function(i){if(!i){return[];}var k=[];i.forEach(function(c1){var d1=new u({title:c1._getLabel()});d1._calculationBuilderKey=c1.getKey();k.push(d1);},this);k=k.sort(function(o1,o2){return o1.getTitle().localeCompare(o2.getTitle());});var a1=new L({mode:s.SingleSelectMaster,selectionChange:function(c1){this._updateOrCreateItem({type:H.Variable,key:c1.getParameter("listItem")._calculationBuilderKey});}.bind(this),items:k});var b1=new v({placeholder:$.getText("CALCULATION_BUILDER_SEARCH_VARIABLE"),liveChange:function(c1){var d1=c1.getSource().getValue();if(d1||d1===""){a1.removeAllItems();k.forEach(function(e1){if(e1.getTitle().toLowerCase().indexOf(d1.toLowerCase())!==-1){a1.addItem(e1);}});}}});this._aVariableLists.push(a1);return[b1,a1];};_.prototype._createPopoverFunctionsItems=function(i){var k=this,a1=this.getParent();var b1=function(c1){return new u({title:c1.title,description:c1.description,type:t.Active,customData:[{key:"functionKey",value:c1.key}],press:c1.press});};i.functionList=new L({mode:s.SingleSelectMaster,itemPress:function(){this.getSelectedItem().firePress();}});a1._getAllFunctions().forEach(function(c1){i.functionList.addItem(b1({key:c1.key,title:c1.title,description:c1.description,press:k._updateOrCreateItem.bind(k,{key:c1.key,type:c1.type,functionObject:c1.functionObject})}));});};_.prototype._createPopoverOperatorsItems=function(i){var k=this.getParent();var a1=function(f1,g1){var h1=[];Object.keys(f1).forEach(function(i1){var j1,k1,l1=f1[i1];if(k._isTokenAllowed(i1)){if(typeof l1==="object"){k1=l1.getText();j1=l1.getKey();}else{j1=k1=l1;}var m1=new f({text:k1,press:this._updateOrCreateItem.bind(this,{type:g1,key:j1})}).addStyleClass("sapCalculationBuilderPopoverOperatorsButton").addStyleClass("sapUiTinyMarginEnd");if(i1===K["!="]){this._attachAriaLabelToButton(m1,$.getText("CALCULATION_BUILDER_NOT_EQUAL_ARIA_LABEL"));}h1.push(m1);}}.bind(this));return h1;}.bind(this);var b1=function(f1,g1,h1){var i1=a1(g1,h1);if(i1.length>0){return new x({content:[new w({width:"100%",text:f1}).addStyleClass("sapUiTinyMarginBottom"),i1]});}return null;};i.operatorsItems=[];if(this.getParent().getAllowComparisonOperators()){var c1=b1($.getText("CALCULATION_BUILDER_COMPARISON_TITLE_SELECT"),K,H.Operator);c1&&i.operatorsItems.push(c1);}if(this.getParent().getAllowLogicalOperators()){var d1=b1($.getText("CALCULATION_BUILDER_LOGICAL_TITLE_SELECT"),Q,H.Operator);d1&&i.operatorsItems.push(d1);}var e1=this.getParent().getOperators();if(e1.length>0){i.operatorsItems.push(b1($.getText("CALCULATION_BUILDER_OPERATORS_TITLE"),e1,H.CustomOperator));}};_.prototype._createPopoverNavContainer=function(i){var k=function(f1){var g1=e1.getPage(f1);e1.to(g1);};var a1=function(){var f1=new A({type:"Error",showIcon:true}).addStyleClass("sapUiTinyMarginBegin sapUiTinyMarginEnd sapUiTinyMarginTop");this._aStrips.push(f1);return f1;}.bind(this);this._aStrips=[];var b1=[new u({title:$.getText("CALCULATION_BUILDER_CONSTANTS_TITLE"),type:t.Active,description:$.getText("CALCULATION_BUILDER_CONSTANTS_CATEGORY_DESCRIPTION"),icon:X.CONSTANTS_CATEGORY,press:k.bind(this,this.getId()+W.PAGE_CONSTANT)})];var c1=this._createPopoverVariablesItems(this._mGroups[Z]);if(c1.length>0){b1.push(new u({title:$.getText("CALCULATION_BUILDER_VARIABLES_TITLE"),description:$.getText("CALCULATION_BUILDER_VARIABLES_CATEGORY_DESCRIPTION"),icon:X.VARIABLES_CATEGORY,press:k.bind(this,this.getId()+W.PAGE_VARIABLE),type:t.Active}));}var d1=i.functionList.getItems();if(d1.length>0){b1.push(new u({title:$.getText("CALCULATION_BUILDER_FUNCTIONS_TITLE"),type:t.Active,description:$.getText("CALCULATION_BUILDER_FUNCTIONS_CATEGORY_DESCRIPTION"),icon:X.FUNCTIONS_CATEGORY,press:k.bind(this,this.getId()+W.PAGE_FUNCTIONS)}));}if(i.operatorsItems.length>0){b1.unshift(new u({title:$.getText("CALCULATION_BUILDER_OPERATORS_TITLE"),type:t.Active,description:$.getText("CALCULATION_BUILDER_OPERATORS_CATEGORY_DESCRIPTION"),icon:X.OPERATORS_CATEGORY,press:k.bind(this,this.getId()+W.PAGE_OPERATORS)}));}this.getGroups().forEach(function(f1){b1.push(new u({title:f1._getTitle(),type:t.Active,description:f1.getDescription(),icon:f1.getIcon(),press:k.bind(this,this.getId()+f1.getKey())}));}.bind(this));var e1=new N({defaultTransitionName:"show",navigate:function(f1){var g1=f1.getParameters().to;g1.setFooter(this._getPageFooter(g1.getId(),i));}.bind(this),pages:[new r({id:this.getId()+W.PAGE_MAIN,title:$.getText("CALCULATION_BUILDER_DIALOG_TITLE"),content:[a1(),i.layout,new F({direction:j.Column,items:[new L({items:b1})]}).addStyleClass("sapUiSmallMarginBeginEnd").addStyleClass("sapUiTinyMarginTop").addStyleClass("sapCalculationBuilderNavMainPage")]})]});if(i.operatorsItems.length>0){e1.addPage(new r({id:this.getId()+W.PAGE_OPERATORS,content:[a1(),new F({direction:j.Column,items:[i.operatorsItems]}).addStyleClass("sapUiSmallMarginBeginEnd").addStyleClass("sapUiTinyMarginTop")],showNavButton:true,title:$.getText("CALCULATION_BUILDER_OPERATORS_PAGE_TITLE"),navButtonPress:k.bind(this,this.getId()+W.PAGE_MAIN)}));}e1.addPage(new r({id:this.getId()+W.PAGE_CONSTANT,content:[a1(),new F({direction:j.Column,items:[i.constantInput]}).addStyleClass("sapUiSmallMarginBeginEnd").addStyleClass("sapUiTinyMarginTop")],showNavButton:true,title:$.getText("CALCULATION_BUILDER_CONSTANTS_PAGE_TITLE"),navButtonPress:k.bind(this,this.getId()+W.PAGE_MAIN)}));if(c1.length>0){e1.addPage(new r({id:this.getId()+W.PAGE_VARIABLE,content:[a1(),new F({direction:j.Column,items:c1}).addStyleClass("sapUiSmallMarginBeginEnd").addStyleClass("sapUiTinyMarginTop")],showNavButton:true,title:$.getText("CALCULATION_BUILDER_VARIABLES_PAGE_TITLE"),navButtonPress:k.bind(this,this.getId()+W.PAGE_MAIN)}));}if(d1.length>0){e1.addPage(new r({id:this.getId()+W.PAGE_FUNCTIONS,content:[a1(),new F({direction:j.Column,items:[i.functionList]}).addStyleClass("sapUiSmallMarginBeginEnd").addStyleClass("sapUiTinyMarginTop")],showNavButton:true,title:$.getText("CALCULATION_BUILDER_FUNCTIONS_PAGE_TITLE"),navButtonPress:k.bind(this,this.getId()+W.PAGE_MAIN)}));}this.getGroups().forEach(function(f1){var g1=new r({id:this.getId()+f1.getKey(),showNavButton:true,title:f1._getTitle(),navButtonPress:k.bind(this,this.getId()+W.PAGE_MAIN),content:a1()});var h1=f1.getCustomView();if(h1){var i1=new E();i1.setAssociation("control",h1);g1.addContent(i1);}else{g1.addContent(new F({direction:j.Column,items:this._createPopoverVariablesItems(this._mGroups[f1.getKey()])}).addStyleClass("sapUiSmallMarginBeginEnd").addStyleClass("sapUiTinyMarginTop"));}e1.addPage(g1);}.bind(this));i.navContainer=e1;};_.prototype._callFunctionFireSelection=function(k){this.getGroups().forEach(function(i){if(i.getCustomView()){i.fireSetSelection({key:k});}});};_.prototype._clearVariableLists=function(){this._aVariableLists.forEach(function(i){var k=i.getSelectedItem();if(k){i.setSelectedItem(k,false);}});this._callFunctionFireSelection();};_.prototype._setVariableListSelection=function(a1){for(var i=0;i<this._aVariableLists.length;i++){var b1=this._aVariableLists[i],c1=this._aVariableLists[i].getItems();for(var k=0;k<c1.length;k++){if(c1[k]._calculationBuilderKey===a1){b1.setSelectedItem(c1[k],true);return;}}}this._callFunctionFireSelection(a1);};_.prototype._sanitizeStringConstant=function(i){if(this.getParent()._isStringConstant(i)){i=i.substring(1,i.length-1);}return i;};_.prototype._createPopover=function(k){var a1=function(){var b1=this._oCurrentItem,c1=k.navContainer.getCurrentPage().getId(),d1=k.functionList.getSelectedItem(),e1,f1,g1;k.constantInput.setValue(this.getParent().getAllowStringConstants()?"":0);this._clearVariableLists();if(d1){k.functionList.setSelectedItem(d1,false);}if(!b1){e1=this.getId()+W.PAGE_MAIN;}else{if(b1._isFunction()){g1=b1.getKey();e1=this.getId()+W.PAGE_FUNCTIONS;f1=k.functionList.getItems();for(var i=0;i<f1.length;i++){var h1=f1[i].data("functionKey");if((h1&&h1.toLowerCase())===g1.toLowerCase()){k.functionList.setSelectedItem(f1[i],true);break;}}}else if(b1._isConstant()){var i1=this._sanitizeStringConstant(b1.getKey());k.constantInput.setValue(i1);e1=this.getId()+W.PAGE_CONSTANT;}else if(b1._isVariable()){this._setVariableListSelection(b1.getKey());var j1=b1._oVariable||b1.getVariable(),k1=(j1&&j1.getGroup())||W.PAGE_VARIABLE;e1=this.getId()+k1;}else if(b1._isSecondaryOperator()){e1=this.getId()+W.PAGE_OPERATORS;}else{e1=this.getId()+W.PAGE_MAIN;}}if(e1!==c1){if(e1!==this.getId()+W.PAGE_MAIN){k.navContainer.backToPage(this.getId()+W.PAGE_MAIN);}k.navContainer.to(k.navContainer.getPage(e1),"show");}else{k.navContainer.getCurrentPage().setFooter(this._getPageFooter(c1,k));}var l1=this._oCurrentItem&&this._oCurrentItem._getItemError(),m1=l1&&(" "+l1.title);this._aStrips.forEach(function(n1){n1.setVisible(!!l1);n1.setText(m1?$.getText("CALCULATION_BUILDER_INCORRECT_SYNTAX")+m1:"");});}.bind(this);this._oPopover=new R({showHeader:false,resizable:true,placement:y.PreferredBottomOrFlip,contentWidth:"400px",contentHeight:"450px",content:[k.navContainer],beforeOpen:a1,afterClose:function(){this._bDragging=false;this._clearNewButtonPositions();}.bind(this)});};_.prototype._getPageFooter=function(i,k){var a1=false,b1=false,c1=function(){};if(this._oCurrentItem&&!this._oCurrentItem._bIsNew){b1=true;}if(i===(this.getId()+W.PAGE_CONSTANT)){a1=k.constantInput.getValueState()===V.None;c1=function(){var d1=k.constantInput.getValue();if(this.getParent()&&this.getParent().getAllowStringConstants()&&!q.isNumeric(d1)){d1="\""+d1+"\"";}this._updateOrCreateItem({type:H.Constant,key:d1});k.constantInput.setValueState(V.None);}.bind(this);}k.constantInput.okButton=new f({enabled:a1,text:$.getText("CALCULATION_BUILDER_CONFIRM_BUTTON"),press:c1});return new z({content:[new d(),k.constantInput.okButton,new f({enabled:b1,text:$.getText("CALCULATION_BUILDER_DELETE_BUTTON"),press:this._deleteItem.bind(this)}),new f({text:$.getText("CALCULATION_BUILDER_CLOSE_BUTTON"),press:this._instantClose.bind(this)})]});};_.prototype._insertFunctionItems=function(i,k){var a1=function(b1){i.push(b1);};if(k&&k.length>0){k.forEach(function(b1){a1(b1);});}else{a1("");}a1(")");};_.prototype._updateOrCreateItem=function(k){var a1=!this._oCurrentItem||this._oCurrentItem._bIsNew,b1=this._oCurrentItem&&!this._oCurrentItem.getKey(),c1=this.getParent(),d1=k.functionObject,e1=this.getItems();var f1=function(){var e1=k.type===H.Function?d1.template:c1._convertToTemplate(d1.getItems());this._insertFunctionItems(i1,e1);}.bind(this);var g1=function(){var i=isNaN(this._iCurrentIndex)?this.getItems().length:this._iCurrentIndex,j1=this._getKeys();this._smartRender(j1.slice(0,i).concat(i1,j1.slice(i)));}.bind(this);var h1=function(){for(var i=0;i<e1.length;i++){if(e1[i]===this._oCurrentItem){return i+1;}}return null;}.bind(this);if(a1){var i1=[k.key];if(d1){f1();}g1();}else{this._oCurrentItem.setKey(k.key);if(k.type){this._oCurrentItem._sType=k.type;}if(b1&&d1){var i1=[];this._iCurrentIndex=h1();f1();g1();}}this._instantClose();this._fireChange();};_.prototype._expandAllVariables=function(){this.getItems().forEach(function(i){if(i.isExpandable()){i._expandVariable(false);}});this._fireChange();};_.prototype._handleDelete=function(i){if(this._isEmptySelected()){return;}this._bAreSelectedItemsDeleting=true;M.show($.getText("CALCULATION_BUILDER_DELETE_MESSAGE_TEXT"),{icon:M.Icon.WARNING,title:$.getText("CALCULATION_BUILDER_DELETE_MESSAGE_TITLE"),actions:[M.Action.YES,M.Action.CANCEL],onClose:function(k){if(k===M.Action.YES){var a1=this.$().find(".sapCalculationBuilderSelected .sapCalculationBuilderItem"),b1=a1.length,c1=a1.first(),d1=sap.ui.getCore().byId(c1.attr("id"));if(d1){var e1=this._getKeys();e1.splice(d1._iIndex,b1);this._smartRender(e1);this._fireChange();}}this._bAreSelectedItemsDeleting=false;}.bind(this)});};_.prototype._handleEnter=function(i){var k=q(i.target),a1;if(this._oItemNavigation&&!this._bReadOnly){if(k.hasClass("sapCalculationBuilderNewItem")){a1=this._getNewItem();if(a1){a1._buttonPress(i);}}else if(k.hasClass("sapCalculationBuilderItem")){a1=this._getItemById(k[0].id);if(a1){a1._buttonPress(i);}}else if(k.hasClass("sapCalculationBuilderItemExpandButton")){a1=this._getItemById(k.closest(".sapCalculationBuilderItem")[0].id);if(a1){a1._expandButtonPress(i);}}}};_.prototype._createVariablesMap=function(){this._mGroups={};this._aVariableLists=[];this.getVariables().forEach(function(i){var k=i.getGroup()||Z;if(!this._mGroups[k]){this._mGroups[k]=[];}this._mGroups[k].push(i);}.bind(this));};_.prototype._handleSpace=function(i){this._selectItem(i.target);};_.prototype._handleCtrlNext=function(i){this._moveItems(Y.KEY_NEXT);};_.prototype._handleCtrlPrevious=function(i){this._moveItems(Y.KEY_PREVIOUS);};_.prototype._getVariableByKey=function(k){var a1=this.getVariables();if(!k){return null;}k=k.toLowerCase();for(var i=0;i<a1.length;i++){if(a1[i].getKey().toLowerCase()===k){return a1[i];}}return null;};_.prototype.setTitle=function(i){var k=this._oToolbarTitle;if(k){k.setText(i);k.setVisible(!!i);}this.setProperty("title",i);};_.prototype._getKeys=function(){return this.getItems().map(function(i){return i.getKey();});};_.prototype._deleteItem=function(){var k=this._getKeys();k.splice(this._oCurrentItem._iIndex,1);this._smartRender(k);this._instantClose();this._fireChange();};_.prototype._openDialog=function(i){this._oCurrentItem=i.currentItem;this._iCurrentIndex=i.index;this._oPopover.openBy(i.opener);};_.prototype._setupDroppable=function(i){var k=this;i=i||this.$().find(".sapCalculationBuilderDroppable");i.droppable({scope:k.getId()+"-scope",tolerance:"pointer",activeClass:"sapCalculationBuilderDroppableActive",hoverClass:"sapCalculationBuilderDroppableActive",drop:function(a1,ui){if(!ui.draggable.hasClass("sapCalculationBuilderSelected")){k._selectItem(ui.draggable[0]);}k._moveItems(Y.MOUSE,parseInt(q(this).attr("index"),10));k._bDragging=false;},over:function(a1,ui){k._bDragging=true;}});};_.prototype._clearNewButtonPositions=function(){var i=this.$();i.find(".sapCalculationBuilderDelimiterNewButton").hide(200);i.find(".sapCalculationBuilderItem").animate({"left":0},300);};_.prototype._setupNewButtonEvents=function(){var i=13,k=300;var a1=this.$().find(".sapCalculationBuilderDelimiter[data-events!='bound']"),b1=this.$().find(".sapCalculationBuilderDelimiterNewButton[data-events!='bound']"),c1=this,d1,e1;var f1=function(g1,h1){g1.prev().animate({"left":-h1},k);g1.next().animate({"left":h1},k);};b1.click(function(ev){var g1=q(this),h1=parseInt(g1.parent().attr("index"),10);g1.css("opacity",1);c1._oCurrentItem=null;c1._iCurrentIndex=h1;c1._openDialog({opener:this,index:h1});});b1.attr("data-events","bound");a1.mouseover(function(ev){var g1=q(this);if(!c1._bDragging&&!c1._oPopover.isOpen()){d1=true;e1=setTimeout(function(){if(d1){d1=false;f1(g1,i);g1.find(".sapCalculationBuilderDelimiterNewButton").show(200);}},400);}});a1.mouseout(function(ev){var g1=q(this).find(".sapCalculationBuilderDelimiterNewButton"),h1=q(this);d1=false;clearTimeout(e1);if(c1._bDragging||c1._oPopover.isOpen()){return;}if(!g1.is(':hover')){f1(h1,0);g1.hide(200);}});a1.attr("data-events","bound");};_.prototype._setupSelectable=function(){this.$().selectable({cancel:".sapCalculationBuilderCancelSelectable",distance:5,start:function(){this._deselect();this._instantClose();}.bind(this),stop:function(){this._selectItems(this.$().find(".sapCalculationBuilderItem.ui-selected"));}.bind(this)});};_.prototype._selectItemsTo=function(i){var k=q(i.next(".sapCalculationBuilderDelimiter")[0]),a1=k.attr("index")-1,b1=this.$(),c1,d1,e1,f1,g1;if(i.parent().hasClass("sapCalculationBuilderSelected")||this._isEmptySelected()){this._selectItem(i);return;}if(a1>this._iLastSelectedIndex){c1=this._iFirstSelectedIndex;d1=a1+1;}else{c1=a1;d1=this._iLastSelectedIndex+1;}this._deselect();f1=b1.find(".sapCalculationBuilderDelimiter[index=\""+c1+"\"]");g1=b1.find(".sapCalculationBuilderDelimiter[index=\""+d1+"\"]");e1=f1.nextUntil(g1,".sapCalculationBuilderItem");this._selectItems(e1);};_.prototype._selectItems=function(k){for(var i=0;i<k.length;i++){this._selectItem(k[i]);}};_.prototype._selectItem=function(i){var k=this.$().find(".sapCalculationBuilderSelected"),a1=q(i),b1=q(a1.next(".sapCalculationBuilderDelimiter")[0]),c1=k[0].children.length,d1=b1.attr("index")-1,e1=true;if(!this._oItemNavigation||!this._getItemById(a1[0].id)||this._bReadOnly){return;}if(c1===0){this._iFirstSelectedIndex=d1;this._iLastSelectedIndex=d1;}else{if(a1.parent().hasClass("sapCalculationBuilderSelected")){if(this._iFirstSelectedIndex===d1){this._iFirstSelectedIndex++;this._deselectItem(a1,false);}else if(this._iLastSelectedIndex===d1){this._iLastSelectedIndex--;this._deselectItem(a1,true);}else{this._deselect();}this._setCorrectFocus();return;}if((this._iFirstSelectedIndex-d1)===1){this._iFirstSelectedIndex=d1;e1=false;}else if((d1-this._iLastSelectedIndex)===1){this._iLastSelectedIndex=d1;e1=true;}else{this._iFirstSelectedIndex=d1;this._iLastSelectedIndex=d1;this._deselect();}}var f1=this.$();if(this._isEmptySelected()){k.detach().insertBefore(a1);k.draggable({revert:"invalid",cursor:"move",axis:"x",scope:this.getId()+"-scope",helper:function(g1){var h1=k.clone();h1.removeClass("sapCalculationBuilderSelected");h1.addClass("sapCalculationBuilderDraggingSelectedClone");return h1;},start:function(){k.addClass("sapCalculationBuilderDragging");f1.find(".sapCalculationBuilderItemContent").css("cursor","move");},stop:function(){k.removeClass("sapCalculationBuilderDragging");f1.find(".sapCalculationBuilderItemContent").css("cursor","pointer");}});}if(e1){a1.detach().appendTo(k);b1.detach().appendTo(k);}else{b1.detach().prependTo(k);a1.detach().prependTo(k);}if(a1.hasClass("sapCalculationBuilderItem")){a1.draggable("disable");a1.addClass("ui-selected");}this._setCorrectFocus();};_.prototype._isEmptySelected=function(){var i=this.$().find(".sapCalculationBuilderSelected");if(i){return i.is(":empty");}return true;};_.prototype._deselectItem=function(i,k){var a1=this.$().find(".sapCalculationBuilderSelected"),b1=q(i.next(".sapCalculationBuilderDelimiter")[0]);if(!i.hasClass("ui-selected")){return;}if(k){b1.detach().insertAfter(a1);i.detach().insertAfter(a1);}else{i.detach().insertBefore(a1);b1.detach().insertBefore(a1);}i.draggable("enable");i.removeClass("ui-selected");};_.prototype._deselect=function(){var i=this.$().find(".sapCalculationBuilderSelected");if(this._isEmptySelected()){return;}this.$().find(".sapCalculationBuilderSelected .ui-selected").removeClass("ui-selected");i.children().each(function(){var k=q(this);if(k.hasClass("sapCalculationBuilderItem")){k.draggable("enable");}k.detach().insertBefore(i);});};_.prototype._setupKeyboard=function(){var i=this.getDomRef(),k=[];this.getItems().forEach(function(a1){k.push(a1.getFocusDomRef());if(a1.isExpandable()){k.push(a1.$("expandbutton"));}});k.push(this._getNewItem().getFocusDomRef());if(!this._oItemNavigation){this._oItemNavigation=new I();this.addDelegate(this._oItemNavigation);}this._oItemNavigation.setRootDomRef(i);this._oItemNavigation.setItemDomRefs(k);this._oItemNavigation.setCycling(true);this._oItemNavigation.setPageSize(250);};_.prototype._setCorrectFocus=function(){q(this._oItemNavigation.getFocusedDomRef()).focus();};_.prototype._getItemById=function(i){return this.getItems().filter(function(k){return k.getId()===i;})[0];};_.prototype._getNewItem=function(){if(!this._oNewItem){this._oNewItem=new C();this._oNewItem._bIsNew=true;this._oNewItem.setParent(this,null,true);}return this._oNewItem;};_.prototype._instantClose=function(){var i=this._oPopover.getAggregation("_popup");if(i&&i.oPopup&&i.oPopup.close){i.oPopup.close(0);this._setCorrectFocus();}};_.prototype._attachAriaLabelToButton=function(i,k){i.addEventDelegate({onAfterRendering:function(a1){a1.srcControl.$("content").attr("aria-label",k);}});};_.prototype._printErrors=function(){this.getItems().forEach(function(i){var k=i._getItemError(),a1=i.$(),b1=!!k?"addClass":"removeClass";a1[b1]("sapCalculationBuilderItemErrorSyntax");});if(this.getParent().getLayoutType()===U.VisualOnly){this._showErrorIcon();}};_.prototype._validateSyntax=function(k){var a1=function(){var z1=this.getItems()[p1],A1=z1.getKey();return!z1._isOperator()||A1==="("||A1==="+"||A1==="-"||A1.toLowerCase()==="not";}.bind(this);var b1=function(){var j1=this.getItems(),z1=j1[q1-1];return!z1._isOperator()||z1.getKey()===")";}.bind(this);var c1=function(m1){var z1=m1.getKey().toLowerCase();if(m1._isOperator()){return z1==="not"||z1==="("||z1===")"?z1:"#op#";}return m1._isFunction()?"#fun#":"#col#";};var d1=function(m1){return{index:i,item:m1,items:[],text:m1.getKey()+(m1._isFunction()?"(":"")};};var e1=function(v1){var z1=1,A1=i;i++;for(;i<j1.length;i++){var m1=j1[i],B1=m1.getKey(),C1=d1(m1);v1.items.push(C1);switch(B1){case")":z1--;break;case"(":z1++;break;case",":z1=1;break;}if(m1._isFunction()){e1(C1);v1.text+=C1.text;}else{v1.text+=B1;}if(z1===0){return v1;}}t1.push({index:A1,title:$.getText("CALCULATION_BUILDER_CLOSING_BRACKET_ERROR_TEXT")});return v1;};var f1=function(v1){var z1=this.getParent()._getFunctionAllowParametersCount(v1.item.getKey()),A1=[],B1=[];v1.items.forEach(function(m1){if(m1.item._isComma()){A1.push(B1);B1=[];}else{B1.push(m1);}});if(B1.length>0&&B1[B1.length-1].text===")"){B1.pop();}A1.push(B1);if(A1.length!==z1){t1.push({index:v1.index,title:$.getText(A1.length<z1?"CALCULATION_BUILDER_TOO_LITTLE_PARAMETERS":"CALCULATION_BUILDER_TOO_MANY_PARAMETERS")});}if(A1.length>0){A1.forEach(function(C1){if(C1.length>0){q.merge(t1,this._validateSyntax({from:C1[0].index,to:C1[C1.length-1].index+1}));}else{t1.push({index:v1.index,title:$.getText("CALCULATION_BUILDER_EMPTY_PARAMETER")});}}.bind(this));}}.bind(this);var g1=0;var h1=function(){var z1=m1.getKey()==="+"||m1.getKey()==="-";if(z1){g1++;if(g1>2){t1.push({index:i,title:$.getText("CALCULATION_BUILDER_SYNTAX_ERROR_TEXT")});}}else{g1=0;}};var i1={"#op#":["(","#col#","#fun#","not","+","-"],"(":["(","+","-","#col#","#fun#","not"],")":["#op#",")"],"#col#":["#op#",")"],"#fun#":["(","+","-","#col#","#fun#"],"not":["#col#","#fun#","not","("]};k=k||{};var j1=k.items||this.getItems(),k1,l1,m1,n1,o1,p1=k.from||0,q1=k.to||j1.length,r1=(p1===0&&q1===j1.length),s1=[],t1=[];if(j1.length>0){if(!a1()){t1.push({index:p1,title:$.getText("CALCULATION_BUILDER_FIRST_CHAR_ERROR_TEXT")});}if(!b1()){t1.push({index:q1-1,title:$.getText("CALCULATION_BUILDER_LAST_CHAR_ERROR_TEXT")});}}for(var i=p1;i<q1;i++){m1=j1[i];if(m1._getType()===H.Error){t1.push({index:i,title:$.getText("CALCULATION_BUILDER_SYNTAX_ERROR_TEXT")});continue;}h1();if(!k.skipCustomValidation&&m1._isFunction()){var u1=m1._getCustomFunction(),v1=e1(d1(m1));if(u1&&!u1.getUseDefaultValidation()){var w1=new D();this.getParent().fireValidateFunction({definition:v1,customFunction:u1,result:w1});q.merge(t1,w1.getErrors());}else{f1(v1);}}if(i<q1-1){n1=j1[i+1];k1=c1(j1[i]);l1=c1(n1);o1=n1?n1.getKey().toLowerCase():"";var x1=n1._isCustomOperator()||m1._isCustomOperator();if(i1[k1].indexOf(l1)===-1&&i1[k1].indexOf(o1)===-1&&!x1){var y1={index:i+1};if(m1._isOperator()&&n1._isOperator()){y1.title=$.getText("CALCULATION_BUILDER_BEFORE_OPERATOR_ERROR_TEXT",n1.getKey());}else if(!m1._isOperator()&&!n1._isOperator()){y1.title=$.getText("CALCULATION_BUILDER_BETWEEN_NOT_OPERATORS_ERROR_TEXT",[m1.getKey(),n1.getKey()]);}else if(m1.getKey()===")"&&!n1._isOperator()){y1.title=$.getText("CALCULATION_BUILDER_AFTER_CLOSING_BRACKET_ERROR_TEXT");}else if(!m1._isOperator()&&(n1.getKey()==="(")){y1.title=$.getText("CALCULATION_BUILDER_BEFORE_OPENING_BRACKET_ERROR_TEXT");}else{y1.title=$.getText("CALCULATION_BUILDER_CHAR_ERROR_TEXT");}t1.push(y1);}}if(m1._isFunction()){continue;}if(r1&&m1.getKey()===","){t1.push({index:i,title:$.getText("CALCULATION_BUILDER_WRONG_PARAMETER_MARK")});}if((m1._isOperator()&&m1.getKey()==="(")||m1._isFunction()){s1.push(i);}if(m1._isOperator()&&m1.getKey()===")"){if(s1.length===0){t1.push({index:i,title:$.getText("CALCULATION_BUILDER_OPENING_BRACKET_ERROR_TEXT")});}else{s1.pop();}}}for(i=0;i<s1.length;i++){t1.push({index:s1[i],title:$.getText("CALCULATION_BUILDER_CLOSING_BRACKET_ERROR_TEXT")});}return t1;};_.prototype._getType=function(k){return this.getParent()&&this.getParent()._getType(k);};_.prototype._moveItems=function(k,a1){var b1=[],c1=this.$(),d1=this.getItems(),e1=c1.find(".sapCalculationBuilderSelected"),f1,g1,h1,i1;if(this._isEmptySelected()){return;}i1=(e1.length>1)?q(e1[0]).children():e1.children();if(k===Y.KEY_PREVIOUS){g1=this._iFirstSelectedIndex-1;}else if(k===Y.KEY_NEXT){g1=this._iLastSelectedIndex+2;}else if(k===Y.MOUSE){g1=a1;}if(g1<0||g1===(d1.length+1)){return;}f1=this.$().find(".sapCalculationBuilderDelimiter[index=\""+g1+"\"]");for(var i=0;i<d1.length+1;i++){h1=d1[i];if(g1===i){i1.each(function(){var c1=q(this),h1;if(c1.hasClass("sapCalculationBuilderItem")){h1=sap.ui.getCore().byId(q(this)[0].id);b1.push(h1);h1._bMovingItem=true;c1.draggable("enable");}c1.css("left",0);c1.detach().insertAfter(f1).removeClass("");f1=c1;});}if(h1&&!h1.$().parent().hasClass("sapCalculationBuilderSelected")&&!h1._bMovingItem){b1.push(h1);}}e1.css("left","");c1.find(".sapCalculationBuilderDelimiter").each(function(i){q(this).attr("index",i);});this.removeAllAggregation("items",true);b1.forEach(function(h1,i){h1._bMovingItem=false;h1._iIndex=i;this.addAggregation("items",h1,true);}.bind(this));this._setupKeyboard();this._selectItems(i1.filter(function(i,el){return q(el).hasClass("sapCalculationBuilderItem");}));this._fireChange();};_.prototype._fireAfterValidation=function(){this.getParent().fireAfterValidation();};_.prototype._setItems=function(i){this.removeAllAggregation("items",true);(i||[]).forEach(function(k){this.addAggregation("items",this._convertFromNewItem(k),true);}.bind(this));};_.prototype._getKeyFromCreatedItem=function(i){return typeof i==="object"?i.getKey():i;};_.prototype._convertFromNewItem=function(i){return typeof i==="object"?i:new C({key:i});};_.prototype._showErrorIcon=function(){var i=this.$("erroricon"),k=this.getParent(),a1=k._createErrorText(null,true);if(a1){i.show();i.attr("title",k._createErrorText(null,true));}else{i.hide();}};_.prototype._smartRender=function(k){var a1="",b1=this.$(),c1=[],d1=this.getItems(),e1=d1.length;var f1=function(h1){h1=this._convertFromNewItem(h1);this.addAggregation("items",h1,true);h1._iIndex=i;if(b1[0]){a1+=h1._render();a1+=this._renderDelimiter(i+1);}h1.bOutput=true;c1.push(h1);}.bind(this);if(!this.getParent()._isExpressionVisible()){this._setItems(k);return;}this._bRendered=false;this._bIsCalculationBuilderRendering=true;this._deselect();for(var i=0;i<k.length;i++){var g1=d1[i],h1=k[i],i1=typeof h1==="object"&&h1.getKey?h1.getKey():h1,j1=h1._sType?h1._sType:"";if(!g1){f1(k[i]);}else if(g1.getKey()!==i1||g1._sType!==j1){g1.setKey(i1,true);g1._sType=j1;var k1=g1.$();k1[0].innerHTML=g1._innerRender();k1.attr("class",g1._getClass());k1.attr("title",g1._getTooltip());g1._setEvents();}}if(k.length<e1){for(var i=k.length;i<d1.length;i++){var k1=d1[i].$();k1.next().remove();k1.remove();this.removeAggregation("items",d1[i],true);}}if(b1[0]&&c1.length>0){b1.find(".sapCalculationBuilderDelimiter").last().after(a1);c1.forEach(function(g1){g1._afterRendering();});this._setupDroppable(b1.find(".sapCalculationBuilderDroppable").filter(function(){return parseInt(q(this).attr("index"),10)>e1;}));}this._bRendered=true;this._setupKeyboard();this._setupNewButtonEvents();this._bIsCalculationBuilderRendering=false;};_.prototype._fireChange=function(){this.fireEvent("change");};return _;});

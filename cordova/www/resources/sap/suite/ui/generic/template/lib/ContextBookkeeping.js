sap.ui.define(["sap/ui/base/Object"],function(B){"use strict";function g(a){var p={};var P=[];function c(C){var D=a.getTransactionController().getDraftController();var i=D.getDraftContext();var t=C.getObject();var I=i.hasDraft(C);var u=I&&!t.IsActiveEntity;var v=u&&!t.HasActiveEntity;var w=false;var O=t.HasDraftEntity?C.getObject("DraftAdministrativeData/DraftIsCreatedByMe"):false;if(t.DraftEntityCreationDateTime&&t.DraftEntityLastChangeDateTime){w=t.DraftEntityCreationDateTime.getTime()!==t.DraftEntityLastChangeDateTime.getTime();}return{bIsDraft:u,bIsDraftSupported:I,bIsCreate:v,bIsDraftModified:w,bOwnDraftExists:O};}function r(C,v,E){var t=C.getPath();var u=c(C);if(v===1&&!u.bIsCreate){P.push(t);}var S=null;if(u.bIsDraftSupported&&!u.bIsCreate){var M=C.getModel();var w=M.getMetaModel();var x=w.getODataEntitySet(E);var y=x&&w.getODataEntityType(x.entityType);var z=y&&y["com.sap.vocabularies.Common.v1.SemanticKey"];if(z){S=[];for(var i=0;i<z.length;i++){S.push(C.getProperty(z[i].PropertyPath));}}}var D=Object.assign(p[t]||{},{oContextInfo:u,oContext:C,aSemanticKeysValues:S});delete D.oRemovalPromise;p[t]=D;if(u.bIsDraft&&!u.bIsCreate){p[t].bReplaceByActive=false;}else if(u.bOwnDraftExists&&!u.bIsCreate){if(p[t].oEditingPromise){p[t].oEditingPromise.then(function(F){var G=F.context.getPath();p[G].bReplaceByActive=true;});}else{l(C).then(function(F){var G=F.getPath();var H=p[G];if(H){p[G].bReplaceByActive=true;}});}}return u;}function b(){for(var i=P.length-1;i>=0;i--){var C=p[P[i]].oContext;if(C){return P[i];}}}function d(C){var i=C.getPath();var R=p[i];return R;}function e(C,R,i){var t=d(C);if(!t.oContextInfo.bIsCreate||!i){t.oRemovalPromise=R;}R.then(function(u){if(!t.oContextInfo.bIsCreate||!i){var D=u.context.getPath();var v=p[D];if(v){delete v.oEditingPromise;v.oContextInfo.bOwnDraftExists=false;}}t.oContext=null;},function(){delete t.oRemovalPromise;});}function f(C,i){e(C,i,false);}function h(C,i){e(C,i,true);}function j(C,E){var i=d(C);i.oEditingPromise=new Promise(function(R,t){var N=function(){delete i.oEditingPromise;i.oContextInfo.bOwnDraftExists=false;t();};E.then(function(u){if(u.draftAdministrativeData){N();}else{i.oContextInfo.bOwnDraftExists=true;var v=u.context.getPath();p[v]={sActiveContextPath:C.getPath(),oContextInfo:{bIsDraft:true,bIsDraftSupported:true,bIsCreate:false,bIsDraftModified:false,bOwnDraftExists:false}};R(u);}},N);});i.oEditingPromise.catch(jQuery.noop);}function A(i){var C=p[i];if(C){C.oContext=null;}}function k(M,i){return new Promise(function(R,t){M.read(i+"/SiblingEntity",{success:function(u){if(u){var v=M.getContext("/"+M.getKey(u));R(v);}else{t();}},error:function(E){t(E);}});});}function l(C){var i=d(C);if(i.oContextInfo.bIsCreate){return Promise.resolve();}else if(i.sActiveContextPath){var t=p[i.sActiveContextPath];return Promise.resolve(t.oContext);}var S=i.oSiblingPromise;if(!S){S=i.oContextInfo.bIsDraftSupported?k(C.getModel(),C.getPath()):Promise.resolve(C);if(i.oContextInfo.bIsDraft||!i.oContextInfo.bIsDraftSupported){i.oSiblingPromise=S;}}return S;}function m(C){var i=p[C];return i?l(i.oContext):k(a.getModel(),C);}function n(i){var C=p[i];if(!C){return Promise.resolve();}return new Promise(function(R){var t=null;var u=function(){R(t);};var H=function(E){E.then(function(v){var w=v.context.getPath();var x=p[w];if(x&&x.oContext&&!x.bReplaceByActive){t={context:v.context,iDisplayMode:2};}u();},u);};if(C.oRemovalPromise){C.oRemovalPromise.then(function(v){t={context:v.context,iDisplayMode:1};var D=v.context.getPath();var w=p[D];var E=w&&w.oEditingPromise;if(E){H(E);}else{u();}},u);}else if(C.bReplaceByActive){l(C.oContext).then(function(v){t={context:v,iDisplayMode:1};u();});}else if(C.oContextInfo&&!C.oContextInfo.bIsDraft&&C.oContextInfo.bOwnDraftExists){if(C.oEditingPromise){H(C.oEditingPromise);}else{l(C.oContext).then(function(D){var v=D.getPath();var E=p[v];if(E&&E.oContext&&!E.bReplaceByActive){t={context:D,iDisplayMode:2};}u();});}}else{u();}});}function o(t,u,I){return new Promise(function(R,v){if(t===u){R(true);return;}if(!t||!u){R(false);return;}var C=p[t];if(!C||!C.oContextInfo.bIsDraftSupported){R(false);return;}var w=p[u];if(!w||!w.oContextInfo){R(false);return;}if(!C.oContextInfo.bIsDraft&&!w.oContextInfo.bIsDraft){R(false);return;}if(C.oContextInfo.bIsCreate&&w.oContextInfo.bIsCreate){R(false);return;}if(I){n(t).then(function(y){R(!!y&&y.context.getPath()===u);},v);return;}if(C.aSemanticKeysValues){var x=!!w.aSemanticKeysValues;for(var i=0;x&&i<C.aSemanticKeysValues.length;i++){x=C.aSemanticKeysValues[i]===w.aSemanticKeysValues[i];}R(x);return;}R(false);});}function q(i){return p[i].oContextInfo.bIsDraftModified;}function s(i){if(p[i]){p[i].oContextInfo.bIsDraftModified=true;}}return{registerContext:r,adaptAfterObjectDeleted:A,activationStarted:f,cancellationStarted:h,editingStarted:j,getDraftSiblingPromise:l,getSiblingPromise:m,getAlternativeContextPromise:n,getPathOfLastShownDraftRoot:b,areTwoKnownPathesIdentical:o,markDraftAsModified:s,getIsDraftModified:q};}return B.extend("sap.suite.ui.generic.template.lib.ContextBookkeeping",{constructor:function(a){Object.assign(this,g(a));}});});

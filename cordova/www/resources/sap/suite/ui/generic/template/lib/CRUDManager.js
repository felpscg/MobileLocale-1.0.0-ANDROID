sap.ui.define(["sap/ui/base/Object","sap/m/MessageToast","sap/ui/generic/app/util/ModelUtil","sap/ui/generic/app/util/ActionUtil","sap/suite/ui/generic/template/lib/MessageUtils","sap/m/MessageBox","sap/suite/ui/generic/template/lib/CRUDHelper","sap/suite/ui/generic/template/lib/testableHelper"],function(B,M,a,A,b,c,C,t){"use strict";var r=Promise.reject();r.catch(jQuery.noop);function g(o,d,s,e,f){function h(O,i,j,P){b.handleError(O,o,s,j,P);return(i||jQuery.noop)(j);}var E;function l(i){return new Promise(function(j,k){var G=o.getOwnerComponent();var H=G.getBindingContext();var I=G.getModel();I.read(H.getPath(),{urlParameters:{"$expand":"DraftAdministrativeData"},success:function(R){if(!R.DraftAdministrativeData){if(i){return h(b.operations.editEntity,k,i);}return j({});}if(R.DraftAdministrativeData.InProcessByUser){var U=R.DraftAdministrativeData.InProcessByUserDescription||R.DraftAdministrativeData.InProcessByUser;i=i||new Error(e.getText("ST_GENERIC_DRAFT_LOCKED_BY_USER",[" ",U]));return h(b.operations.editEntity,k,i,i);}return j({draftAdministrativeData:R.DraftAdministrativeData});},error:h.bind(null,b.operations.editEntity,k)});});}function m(i,U,P){if(P.draftAdministrativeData){return Promise.resolve(P);}return new Promise(function(j,k){s.oTransactionController.editEntity(o.getView().getBindingContext(),!U).then(function(R){if(i){var V=o.getView();var G=V.getBindingContext();var I=function(){G.getModel().invalidateEntry(G);V.detachEvent("modelContextChange",I);};V.attachEvent("modelContextChange",I);}return j({context:R.context});},function(R){if(R&&R.response&&R.response.statusCode==="409"&&i&&!U){b.removeTransientMessages();return l(R).then(j,k);}else{h(b.operations.editEntity,k,R,R);}});});}E=function(U){var i=d.isDraftEnabled();var R;var j=o.getOwnerComponent();var k=j.getBindingContext();if(i&&!U){var G=s.oDraftController.getDraftContext();var P=G.hasPreserveChanges(k);if(!P){R=l().then(m.bind(null,true,true));}}R=R||m(i,U,{});if(i){s.oApplication.editingStarted(k,R);}return R;};function n(U){if(f.isBusy()){return r;}var R=E(U);f.setBusy(R);return R;}function p(i,H,j,k,S){var R=new Promise(function(G,I){var J=function(K){return h(b.operations.deleteEntity,I,K);};if(i&&k){s.oDraftController.getDraftForActiveEntity(j).then(function(K){s.oTransactionController.deleteEntity(K.context).then(function(){if(!S){b.showSuccessMessageIfRequired(e.getText("ST_GENERIC_DRAFT_WITH_ACTIVE_DOCUMENT_DELETED"),s);}return G();});},J);}else{s.oTransactionController.deleteEntity(j).then(function(){var K=a.getEntitySetFromContext(j);var L=s.oDraftController.getDraftContext();var N=L.isDraftRoot(K);var O=e.getText("ST_GENERIC_OBJECT_DELETED");if(!i&&N){O=e.getText(H?"ST_GENERIC_DRAFT_WITH_ACTIVE_DOCUMENT_DELETED":"ST_GENERIC_DRAFT_WITHOUT_ACTIVE_DOCUMENT_DELETED");}if(!S){b.showSuccessMessageIfRequired(O,s);}return G();},J);}});return R;}function q(i,S){var R=new Promise(function(j,k){var G=o.getView().getBindingContext();var I=s.oDraftController.isActiveEntity(G);var H=s.oDraftController.hasActiveEntity(G);var J;if(i){J=Promise.resolve(G);}else if(H&&!I){J=s.oApplication.getDraftSiblingPromise(G);}else{J=Promise.resolve();}J.then(function(K){var L=p(I,H,G,i,S);L.then(j,k);if(!I){var T=function(){return{context:K};};var N=L.then(T);s.oApplication.cancellationStarted(G,N);}},k);});return R;}function u(P){var R=Object.create(null);var G=new Promise(function(H,I){var O=Object.create(null);var J=function(K,i,j){R[K]={resolve:i,reject:j};};for(var k=0;k<P.length;k++){var K=P[k];O[K]=new Promise(J.bind(null,K));}s.oApplication.prepareDeletion(O);s.oTransactionController.deleteEntities(P).then(function(L){var N=[];var Q=sap.ui.getCore().getMessageManager().getMessageModel().getData();for(var i=0;i<Q.length;i++){var S=Q[i].getTarget();for(var j=0;j<P.length;j++){var T=Q[i].getType()||"";if(S.indexOf(P[j])>-1&&(T!=="Information"&&T!=="Success")){N.push(S);break;}}}return H(N);},function(i){return I(i);});});G.then(function(j){var k=[];for(var i=0;i<P.length;i++){var H=R[P[i]];if(j.indexOf(P[i])===-1){k.push(P[i]);H.resolve();s.oApplication.markCurrentDraftAsModified();}else{H.reject();}}},jQuery.noop);return G;}function v(i,j){if(f.isBusy()){j();return;}s.oTransactionController.triggerSubmitChanges().then(function(R){i(R.context);},function(){var k=s.oTemplateCapabilities.oMessageButtonHelper&&s.oTemplateCapabilities.oMessageButtonHelper.getContextFilter();if(k){var G=sap.ui.getCore().getMessageManager();var H=G.getMessageModel();var I=H.bindList("/",null,null,[k]);var J=I.getContexts().map(function(K){var L=K.getObject();L.persistent=false;L.technical=false;return L;});G.removeMessages(J);G.addMessages(J);s.oTemplateCapabilities.oMessageButtonHelper.showMessagePopover();}j();});}function w(){var R=new Promise(function(i,j){s.oApplication.performAfterSideEffectExecution(v.bind(null,i,j));});f.setBusy(R);return R;}function x(S){if(f.isBusy()){return r;}var R=new Promise(function(i,j){var k=o.getView().getBindingContext();var W=false;var H=function(){W=true;var G=function(){var I=s.oDraftController.activateDraftEntity(k,true);s.oApplication.activationStarted(k,I);I.then(function(J){i(J);},function(J){b.handleError(b.operations.activateDraftEntity,o,s,J,null);j();});f.setBusy(I);};S.handleSaveScenario(4,G,j);};s.oApplication.getDraftSiblingPromise(k).then(function(G){if(G){o.getOwnerComponent().getModel().invalidateEntry(G);}var I=s.oDraftController.activateDraftEntity(k,false);f.setBusy(I);s.oApplication.activationStarted(k,I);I.then(function(J){i(J);},function(J){b.handleError(b.operations.activateDraftEntity,o,s,J,null,{"412":H});if(!W){j();}});});});return R;}function y(P){return new A(P);}function z(P,S,R,j){if(f.isBusy()){j();return;}var k=P.functionImportPath;var G=P.contexts;var H=P.sourceControl;var I=P.label;var O=P.operationGrouping;var J=y({controller:o,contexts:G,applicationController:s.oApplicationController,operationGrouping:O});var K=function(V,W){if(V.pages){for(var i in V.pages){var X=V.pages[i];if(X.component.list!=true&&X.entitySet===W){return true;}else{var Y=K(X,W);if(Y){return true;}}}}return false;};var N=function(i,V){var W=i.getAppComponent().getConfig();if(V&&V.sPath){var X=V.sPath.split("(")[0].replace("/","");return K(W.pages[0],X);}return false;};var L=function(i){var V,W,X,Y;if(Array.isArray(i)&&i.length===1){V=i[0];}else{V={response:{context:i.context}};}W=V.response&&V.response.context;var Z;if(W&&W.getObject()){Z=d.registerContext(W);}X=o.getOwnerComponent();Y=N(X,W);if(Y&&W&&W!==V.actionContext&&W.getPath()!=="/undefined"){if(H){e.navigateFromListItem(W,H);}else{s.oApplication.navigateToSubContext(W,false,Z.bIsDraft?2*(1+Z.bIsCreate):1,Z);}}if(i.length>0){var $=e.getTableBindingInfo(H);var _=$&&$.binding;if(_&&_.oEntityType){e.setEnabledToolbarButtons(H);if(d.isListReportTemplate()){e.setEnabledFooterButtons(H);}}}R(i);};var Q=function(){if(G&&G[0]){var i=G[0].oModel;if(i&&i.hasPendingChanges()){i.resetChanges();}}};var T=function(i){Q();j(i);};var U=function(i){if(Array.isArray(i)){if(i.length===1){i=i[0].error;}else{i=null;}}var V={context:G};Q();h(b.operations.callAction,null,i,V);j(i);};J.call(k,I,d.isDraftEnabled()).then(function(i){var V={};V.actionLabel=I;f.setBusy(i.executionPromise,null,V);i.executionPromise.then(L,U);},T);}function D(P,S){var R=new Promise(function(i,j){s.oApplication.performAfterSideEffectExecution(z.bind(null,P,S,i,j));});return R;}function F(T,P){if(!T){throw new Error("Unknown Table");}var i="";var j="";var k;var G=o.getOwnerComponent();if(G.getMetadata().getName()==="sap.suite.ui.generic.template.ListReport.Component"){k=(G.getCreationEntitySet&&G.getCreationEntitySet())||(T.getEntitySet&&T.getEntitySet());}else{k=(G.getCreationEntitySet&&G.getCreationEntitySet())||G.getEntitySet();}var H,I,N,J;var V=o.getView();var K=V.getModel();var L=V.getBindingContext();if(L){j=e.getTableBindingInfo(T).path;J=K.getMetaModel();I=J.getODataEntitySet(k);H=J.getODataEntityType(I.entityType);N=J.getODataAssociationSetEnd(H,j);if(N){k=N.entitySet;}j="/"+j;i=G.getComponentContainer().getElementBinding().getPath()+j;}else{i="/"+k;}var O=C.create(s.oDraftController,k,i,K,s.oApplication,P);s.oApplication.getBusyHelper().setBusy(O);return O.then(function(Q){s.oApplication.markCurrentDraftAsModified();return{newContext:Q,tableBindingPath:j};},h.bind(null,b.operations.addEntry,function(Q){throw Q;}));}var h=t.testable(h,"handleError");var y=t.testable(y,"getActionUtil");return{editEntity:n,deleteEntity:q,deleteEntities:u,saveEntity:w,activateDraftEntity:x,callAction:D,addEntry:F};}return B.extend("sap.suite.ui.generic.template.lib.CRUDManager",{constructor:function(o,d,s,e,f){Object.assign(this,g(o,d,s,e,f));}});});

sap.ui.define(["sap/ui/base/Object","sap/ui/model/Filter","sap/suite/ui/generic/template/lib/testableHelper","sap/base/Log","sap/suite/ui/generic/template/ObjectPage/controller/MultipleViewsSingleTableModeHelper"],function(B,F,t,L,M){"use strict";var P="/objectPage/multipleViews";var a="/selectedKey";var b="/items";function g(s,c,T,C){var I;var q;var m;var S;var o=T.oComponentUtils.getTemplatePrivateModel();var d;var D=T.oServices.oApplication.getBusyHelper().getBusyDelay();function f(i){var j;if(!i){return"";}if(i.state==="error"){return T.oCommonUtils.getText("SEG_BUTTON_ERROR",i.text);}if(i.state===""||i.state==="busy"){var E=sap.ui.core.format.NumberFormat.getIntegerInstance({groupingEnabled:true});j=E.format(i.count);}return T.oCommonUtils.getText("SEG_BUTTON_TEXT",[i.text,i.state==="busyLong"?"...":j]);}function e(){return o.getProperty(p(a));}function h(E,G){var H=[],J;var K=T.oCommonUtils.getElementCustomData(G).variantAnnotationPath;if(K){var V=E[K];if(!V){return[];}if(!V.SelectOptions&&V.SelectionVariant){V=V.SelectionVariant;if(V.Path){K=V.Path.split("@")[1];V=K&&E[K];}}if(V.AnnotationPath){J=V.AnnotationPath.split("@")[1];V=E[J];}for(var i in V.SelectOptions){if(V.SelectOptions[i].PropertyName){var N=V.SelectOptions[i].PropertyName.PropertyPath;for(var j in V.SelectOptions[i].Ranges){var O=V.SelectOptions[i].Ranges[j].Option;O.EnumMember=O.EnumMember.replace("com.sap.vocabularies.UI.v1.SelectionRangeOptionType/","");var Q=V.SelectOptions[i].Ranges[j].Low;var U=V.SelectOptions[i].Ranges[j].High;var W=Object.keys(Q)[0];if(U){var X=Object.keys(U)[0];H.push(new F(N,O.EnumMember,Q[W],U[X]));}else{H.push(new F(N,O.EnumMember,Q[W]));}}}}}return H;}function k(E){if(!I){return;}var i=E.getSource();var j=i.getModel();var G=j.getMetaModel();var H=i.getEntitySet();var J=G.getODataEntitySet(H);var K=G.getODataEntityType(J.entityType);var N=function(O,Q){var U=h(K,Q);var V=T.oCommonUtils.getElementCustomData(Q);var W=d[O]||Object.create(null);W.selectionVariantFilters=U;W.templateSortOrder=V.TemplateSortOrder;W.implementingControl=i;W.dirtyState=0;d[O]=W;if(S){var X=p(b)+"/"+O;var Y=function($,_,a1){if(W.numberOfUpdates!==_){return;}var Z=Object.assign({},o.getProperty(X));if(!Z.state&&$=="busy"){setTimeout(function(){if(o.getProperty(X).state==="busy"){Z=Object.assign({},o.getProperty(X));Z.state="busyLong";o.setProperty(X,Z);}},D);}Z.state=$;if(!$){Z.count=a1;}o.setProperty(X,Z);};W.numberOfUpdates=0;W.updateStartFunction=Y.bind(null,"busy");W.updateSuccessFunction=Y.bind(null,"");W.errorFunction=Y.bind(null,"error");var Z={text:V.text,count:0,state:"",facetId:C.key};o.setProperty(X,Z);}};I.init(E,N);}function l(){return m;}function n(){return d[o.getProperty(p(a))];}function p(i){return P+"/"+C.key+i;}function r(E){if(!I){return;}var i=E.getParameter("bindingParams");s.oMultipleViewsHandler[C.key].oFiltersWithoutSmartFilterBar=jQuery.extend(true,{},i);s.oMultipleViewsHandler[C.key].oFiltersForCounts=jQuery.extend(true,{},i);A(i);}function A(j){var E=n();if(E){var G=E.selectionVariantFilters;for(var i in G){j.filters.push(G[i]);}}}function R(E,G){for(var i in G){var H=G[i];for(var j=E.length;j--;j>=0){if(JSON.stringify(E[j])===JSON.stringify(H)){E.splice(j,1);break;}}}}function u(){var i=s.oMultipleViewsHandler[C.key].oSmartTable;var j=i.getModel();var E=i.getBindingContext();var G=E.getPath();var H=i.getTableBindingPath();var J=[],K;var N;for(var O in d){N=jQuery.extend(true,{},s.oMultipleViewsHandler[C.key].oFiltersForCounts);var Q=d[O];K=Q.entitySet;if(!K){K=i.getEntitySet();}Q.numberOfUpdates++;Q.updateStartFunction(Q.numberOfUpdates);J=N.filters.concat(Q.selectionVariantFilters);j.read(G+"/"+H+"/$count",{filters:J,groupId:"updateMultipleViewsItemsCounts",success:Q.updateSuccessFunction.bind(null,Q.numberOfUpdates),error:Q.errorFunction.bind(null,Q.numberOfUpdates)});}}function v(){if(S){u();}}function w(){return S;}function x(i){var K;for(K in d){if(d[K].implementingControl===i){return d[K].properties;}}}function y(i){var j=T.oCommonUtils.isSmartTable(s.oMultipleViewsHandler[C.key].oSmartTable);if(i!==2){s.oMultipleViewsHandler[C.key].oSmartTable["rebindTable"]();}if(i>1){if(j){T.oCommonUtils.refreshModel(s.oMultipleViewsHandler[C.key].oSmartTable);T.oCommonUtils.refreshSmartTable(s.oMultipleViewsHandler[C.key].oSmartTable);}else{}}}function z(V){var i=o.getProperty(P);if(!i){i={};i[C.key]=V;}else if(i&&!i[C.key]){i[C.key]=V;}else if(i&&i[C.key]){for(var j in V){i[C.key][j]=V[j];}}o.setProperty(P,i);}(function(){var Q;if(!C){return;}Q=C.quickVariantSelection;q=Q;if(!q){return;}S=q.showCounts;d=Object.create(null);z({"items":{}});var i=function(j){z({"selectedKey":j});var E=o.bindProperty(p(a));E.attachChange(function(G){var N=G.getSource().getValue();if(I.onSelectedKeyChanged){I.onSelectedKeyChanged(N);}var H=(m==="single")?3:d[N].dirtyState;if(H<2){H=H+2;}if(H>0){y(H);}else{T.oCommonUtils.setEnabledToolbarButtons(s.oMultipleViewsHandler[C.key].oSmartTable);}d[N]=d[N]||{};d[N].dirtyState=0;});};if(Q){I=new M(Q,s,c,T,i,d,C);m="single";L.info("This section supports multiple views with single table");}z({"mode":m});})();var R=t.testable(R,"fnRemoveTableSettingsFromFilters");var x=t.testable(x,"findEntityProperties");var h=t.testable(h,"getSelectionVariantFilters");t.testable(function(){return I;},"getImplementingHelper");return{onDataRequested:v,formatItemTextForMultipleView:f,getVariantSelectionKey:e,init:k,getMode:l,onRebindContentControl:r,getShowCounts:w};}return B.extend("sap.suite.ui.generic.template.ObjectPage.controller.MultipleViewsHandler",{constructor:function(s,c,T,C){Object.assign(this,g(s,c,T,C));}});});

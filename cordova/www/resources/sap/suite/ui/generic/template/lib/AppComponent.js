/*
 * ! SAP UI development toolkit for HTML5 (SAPUI5)

		(c) Copyright 2009-2015 SAP SE. All rights reserved
	
 */
sap.ui.define(["sap/ui/core/UIComponent","sap/m/NavContainer","sap/f/FlexibleColumnLayout","sap/ui/model/Filter","sap/ui/model/FilterOperator","sap/ui/model/odata/MessageScope","sap/ui/model/json/JSONModel","sap/ui/model/resource/ResourceModel","sap/ui/generic/app/ApplicationController","sap/suite/ui/generic/template/lib/Application","sap/suite/ui/generic/template/lib/BusyHelper","sap/suite/ui/generic/template/lib/NavigationController","sap/suite/ui/generic/template/lib/ProcessObserver","sap/suite/ui/generic/template/lib/TemplateAssembler","sap/suite/ui/generic/template/lib/CRUDHelper","sap/suite/ui/generic/template/lib/ViewDependencyHelper","sap/suite/ui/generic/template/lib/testableHelper","sap/suite/ui/generic/template/support/lib/CommonMethods","sap/suite/ui/generic/template/library","sap/base/Log"],function(U,N,F,a,b,M,J,R,A,c,B,d,P,T,C,V,t,e,f,L){"use strict";A=t.observableConstructor(A);var D=sap.m.DraftIndicatorState;var r=T.getRegisterAppComponent();var o;function g(){o=o||new R({bundleName:"sap/suite/ui/generic/template/lib/i18n/i18n"}).getResourceBundle();return o.getText.apply(o,arguments);}function h(){return new P({processObservers:[]});}var m=sap.ui.getCore().getMessageManager().getMessageModel();var v=new a({path:"validation",operator:b.EQ,value1:true});function j(k,l){var n={oAppComponent:k,componentRegistry:Object.create(null),aRunningSideEffectExecutions:[],getText:g,mRouteToTemplateComponentPromise:Object.create(null),oTemplatePrivateGlobalModel:(new J()).setDefaultBindingMode("TwoWay"),aStateChangers:[],oPaginatorInfo:Object.create(null),oStatePreserversAvailablePromise:Promise.resolve(),oValidationMessageBinding:m.bindList("/",null,null,v)};n.oValidationMessageBinding.attachChange(jQuery.noop);var p;var q;var s;function u(){var i=sap.ushell&&sap.ushell.Container&&sap.ushell.Container.getService("URLParsing");n.oTemplatePrivateGlobalModel.setProperty("/generic",{crossAppNavSupport:!!i&&i.isIntentUrl(document.URL),draftIndicatorState:D.Clear,shellServiceUnavailable:false,forceFullscreenCreate:false});k.setModel(n.oTemplatePrivateGlobalModel,"_templPrivGlobal");n.oShellServicePromise.catch(function(){n.oTemplatePrivateGlobalModel.setProperty("/generic/shellServiceUnavailable",true);});}function w(){n.fnAddSideEffectPromise=function(e1){var i=0;for(;n.aRunningSideEffectExecutions[i];){i++;}n.aRunningSideEffectExecutions[i]=e1;var f1=function(){n.aRunningSideEffectExecutions[i]=null;};e1.then(f1,f1);};p.attachEvent("beforeSideEffectExecution",function(i){if(i.getParameter("valueChange")||i.getParameter("fieldControl")){var e1=i.getParameter("promise");setTimeout(n.oBusyHelper.setBusy.bind(null,e1),1000);n.fnAddSideEffectPromise(e1);}});var c1=k.getModel("_templPrivGlobal");var d1="/generic/draftIndicatorState";p.attachBeforeQueueItemProcess(function(i){if(i.draftSave){c1.setProperty(d1,D.Saving);}});p.attachOnQueueCompleted(function(){if(c1.getProperty(d1)===D.Saving){c1.setProperty(d1,D.Saved);}});p.attachOnQueueFailed(function(){if(c1.getProperty(d1)===D.Saving){c1.setProperty(d1,D.Clear);}});c1.setProperty("/generic/appComponentName",k.getMetadata().getComponentName());}function x(){var i={appComponent:k,oTemplateContract:n,application:new c(n),oViewDependencyHelper:new V(n)};n.oViewDependencyHelper=i.oViewDependencyHelper;n.oShellServicePromise=k.getService("ShellUIService").catch(function(){var e1=sap.ui.core.service.ServiceFactoryRegistry.get("sap.ushell.ui5service.ShellUIService");return((e1&&e1.createInstance())||Promise.reject());});n.oShellServicePromise.catch(function(){L.warning("No ShellService available");});(U.prototype.init||jQuery.noop).apply(k,arguments);n.oBusyHelper.setBusy(n.oShellServicePromise);s=r(i);var c1=k.getModel();n.bCreateRequestsCanonical=true;var d1=c1.messageScopeSupported();n.oBusyHelper.setBusy(d1);d1.then(function(e1){if(e1){c1.setMessageScope(M.BusinessObject);n.bCreateRequestsCanonical=false;}p=new A(c1);u();q=new d(n);w();C.enableAutomaticDraftSaving(n);if((!c1.oMetadata||!c1.oMetadata.isLoaded())||c1.oMetadata.isFailed()){c1.attachMetadataFailed(function(){q.navigateToMessagePage({title:g("ST_GENERIC_ERROR_TITLE"),text:g("ST_GENERIC_ERROR_SYSTEM_UNAVAILABLE"),icon:"sap-icon://message-error",description:g("ST_GENERIC_ERROR_SYSTEM_UNAVAILABLE_DESC")});for(var f1 in n.componentRegistry){n.componentRegistry[f1].fnViewRegisteredResolve(true);}});}if(k&&k.getMetadata()&&k.getMetadata().getManifest()){e.setAppComponent(k);}e.setApplicationStatus(e.mApplicationStatus.LOADING);e.publishEvent("elements","ViewRenderingStarted",{});});}function y(){if(n.oNavigationHost){return"";}if(n.sRoutingType==="f"){var i=new F();n.oNavigationHost=i;n.aNavigationObservers=[new P({processName:"BeginColumnNavigation",eventHandlers:{attachProcessStart:i.attachBeginColumnNavigate.bind(i),attachProcessStop:i.attachAfterBeginColumnNavigate.bind(i)}}),new P({processName:"MidColumnNavigation",eventHandlers:{attachProcessStart:i.attachMidColumnNavigate.bind(i),attachProcessStop:i.attachAfterMidColumnNavigate.bind(i)}}),new P({processName:"EndColumnNavigation",eventHandlers:{attachProcessStart:i.attachEndColumnNavigate.bind(i),attachProcessStop:i.attachAfterEndColumnNavigate.bind(i)}})];n.oNavigationObserver=new P({processObservers:n.aNavigationObservers});n.aHeaderLoadingObservers=[h(),h(),h()];}else{var c1=new N({id:k.getId()+"-appContent"});n.oNavigationHost=c1;n.oNavigationObserver=new P({processName:"Navigation",eventHandlers:{attachProcessStart:c1.attachNavigate.bind(c1),attachProcessStop:c1.attachAfterNavigate.bind(c1)}});}n.oHeaderLoadingObserver=new P({processObservers:n.aHeaderLoadingObservers||[]});n.oPagesDataLoadedObserver=new P({processObservers:[n.oHeaderLoadingObserver,n.oNavigationObserver]});n.oNavigationHost.addStyleClass(n.oApplicationProxy.getContentDensityClass());n.oBusyHelper=new B(n);n.oBusyHelper.setBusyReason("HashChange",true,true);return n.oNavigationHost;}function z(){if(n.oNavigationHost){n.oNavigationHost.destroy();}if(p){p.destroy();}if(q){q.destroy();}if(n.oValidationMessageBinding){n.oValidationMessageBinding.destroy();}e.setAppComponent(null);(U.prototype.exit||jQuery.noop).apply(k,arguments);s();t.endApp(l);}function E(i){var c1=Object.keys(i).map(function(d1){var e1=i[d1];if(e1.pages){e1.pages=E(e1.pages);}return i[d1];});return c1;}function G(S){if(S._version==="1.3.0"&&S.pages&&jQuery.isPlainObject(S.pages)){S.pages=E(S.pages);}}function H(c1,d1){if(!c1){return;}for(var i=0;i<c1.length;i++){var e1=c1[i];if(e1.routingSpec&&e1.routingSpec.noOData){e1.entitySet=e1.routingSpec.routeName;if(d1>1){e1.navigationProperty=e1.routingSpec.routeName;}}H(e1.pages,d1+1);if(e1.embeddedComponents){for(var f1 in e1.embeddedComponents){var g1=e1.embeddedComponents[f1];if(g1.pages){g1.pages=E(g1.pages);H(g1.pages,d1+1);}}}if(e1.implementingComponent&&e1.implementingComponent.pages){e1.implementingComponent.pages=E(e1.implementingComponent.pages);H(e1.implementingComponent.pages,d1+1);}}}function I(S){H(S.pages,0);}function K(i){if(i){var c1=i.entitySet;var d1=(i.component&&i.component.settings&&i.component.settings.quickVariantSelectionX&&i.component.settings.quickVariantSelectionX.variants)||{};var e1=function(d1){for(var f1 in d1){var g1=d1[f1];if(!!g1.entitySet){return true;}}return false;};if(e1(d1)){for(var f1 in d1){var g1=d1[f1];if(g1.entitySet===undefined){g1.entitySet=c1;}}}}}function O(S){K(S.pages[0]);}function Q(c1){var d1;if(c1.component){d1=c1.component.settings;}else{d1=c1;if(!d1.tableSettings&&!d1.tableType&&d1.multiSelect===undefined){return;}}d1=d1||{};d1.tableType=d1.tableType||(d1.gridTable?"GridTable":undefined);d1.tableType=d1.tableType||(d1.treeTable?"TreeTable":undefined);d1.tableSettings=d1.tableSettings||{};d1.tableSettings.type=d1.tableSettings.type||d1.tableType;d1.tableSettings.multiSelect=(d1.tableSettings.multiSelect===undefined?d1.multiSelect:d1.tableSettings.multiSelect);d1.tableType=d1.tableSettings.type;d1.multiSelect=d1.tableSettings.multiSelect;d1.tableSettings.selectAll=(d1.tableSettings.selectAll===undefined?false:d1.tableSettings.selectAll);for(var i in c1.pages){Q(c1.pages[i]);}for(var i in d1.sections){Q(d1.sections[i]);}}var S;function W(){if(!S){var i=k.getMetadata();S=i.getManifestEntry("sap.ui.generic.app");G(S);I(S);O(S);Q(S.pages[0]);}return S;}var X;function Y(){if(!X){X=Object.assign({},k.getMetadata().getManifest());X["sap.ui.generic.app"]=W();}return X;}function Z(){var i=k.getManifestObject();var c1=i.getEntry("sap.ui.generic.app").settings;n.sRoutingType=(c1&&c1.flexibleColumnLayout)?"f":"m";return"sap."+n.sRoutingType+".routing.Router";}var $=Promise.resolve();function _(){var i=new Promise(function(c1){$.then(function(){var d1=[];n.oNavigationControllerProxy.getActiveComponents().forEach(function(e1){var f1=n.componentRegistry[e1];var g1=f1.oComponent.getComponentContainer();var h1=g1.getParent();if(h1.getMetadata().getName()!=="sap.m.NavContainer"){throw new Error("Recreation only possible for sap.m.NavContainer");}var i1=n.oNavigationControllerProxy.createComponentInstance(n,f1.routeConfig,n.oNavigationControllerProxy.mRouteToComponentResolve[f1.route]);d1.push(i1.loaded().then(function(i1){var j1=g1.getComponentInstance().getBindingContext();h1.removePage(g1);h1.addPage(i1);h1.to(i1);g1.destroy();var k1=i1.getComponentInstance();var l1=n.componentRegistry[k1.sId];n.mRouteToTemplateComponentPromise[f1.route]=Promise.resolve(k1);if(j1){Promise.all([l1.viewRegistered,l1.reuseComponentsReady]).then(function(){l1.utils.bindComponent(j1.getPath(),true);});}return l1.oViewRenderedPromise;}));});c1(Promise.all(d1));});});$=i.then(jQuery.noop);return $;}var a1={init:x,createContent:y,exit:z,_getRouterClassName:Z,getConfig:W,getInternalManifest:Y,getTransactionController:function(){return p.getTransactionController();},getApplicationController:function(){return p;},getNavigationController:function(){return q;}};var b1={retemplateActiveComponents:_};if(sap.ui.getCore().getConfiguration().getDesignMode()){Object.assign(a1,b1);}var G=t.testable(G,"fnNormalizePagesMapToArray");W=t.testable(W,"getConfig");return a1;}return U.extend("sap.suite.ui.generic.template.lib.AppComponent",{metadata:{config:{title:"SAP UI Application Component",fullWidth:true},properties:{forceGlobalRefresh:{type:"boolean",defaultValue:true},"considerAnalyticalParameters":{"type":"boolean","defaultValue":"false"},"showDraftToggle":{"type":"boolean","defaultValue":false}},events:{pageDataLoaded:{}},routing:{config:{async:true,viewType:"XML",viewPath:"",clearTarget:false},routes:[],targets:[]},library:"sap.suite.ui.generic.template"},constructor:function(){var i=t.startApp();Object.assign(this,j(this,i));(U.prototype.constructor||jQuery.noop).apply(this,arguments);}});});

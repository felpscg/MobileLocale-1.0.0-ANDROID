sap.ui.define(["sap/ui/base/Object","sap/suite/ui/generic/template/lib/testableHelper","sap/base/Log"],function(B,t,L){"use strict";var c=(sap&&sap.ushell&&sap.ushell.Container)?sap.ushell.Container.getService("CrossApplicationNavigation"):(function(){var r=jQuery.Deferred();r.resolve(Object.create(null));return{createEmptyAppState:function(){return{getKey:function(){return"";},setData:jQuery.noop,save:function(){return Promise.resolve();}};},getAppState:function(){return r;}};})();t.testableStatic(function setCrossAppNavService(s){c=s;},"StatePreserver_setCrossAppNavService");function g(T,s){var r="";var I=false;var a=Promise.resolve();var n=null;var A=false;var S=null;var b=null;var l,d;var C=Object.create(null);var o={};var e={};function f(){C.permanentEntries=Object.create(null);C.sessionEntries=Object.create(null);C.pageEntries=Object.create(null);C.allEntries=Object.create(null);}f();function h(i){f();for(var K in i){var M=jQuery.extend(true,{},i[K]);C.allEntries[K]=M;var N=M.lifecycle||Object.create(null);if(N.permanent){C.permanentEntries[K]=M;}else if(N.session){C.sessionEntries[K]=M;}if(N.page||N.pagination){C.pageEntries[K]=M;}}return C;}function m(i,P){if(P===i){return;}var N=P.next.next;P.next.next=i.next;i.next=P.next;P.next=N;}function j(i,K,P){if(jQuery.isEmptyObject(K)){return{appStateKey:""};}var M=JSON.stringify(K);var N=0;var O;for(O=i;O.next&&N<10;N++){if(O.next.serialize===M){m(i,O);return{appStateKey:i.next.appStateKey};}O=O.next;}O.next=null;var Q=c.createEmptyAppState(s.oComponent.getAppComponent(),!P);var U={next:i.next,serialize:M,appStateKey:Q.getKey()};Q.setData(K);Q.save();i.next=U;return{appStateKey:U.appStateKey};}function k(){var i=j(e,C.sessionEntries,false);var K=Object.create(null);if(i.appStateKey){K.sessionAppStateKey=i.appStateKey;}if(!jQuery.isEmptyObject(C.permanentEntries)){K.permanentEntries=C.permanentEntries;}S=j(o,K,true);A=false;if(b===S.appStateKey){S=null;}else{T.oNavigationControllerProxy.navigateByExchangingQueryParam(s.appStateName,S.appStateKey);}}function p(){if(!A){return;}var i=s.getCurrentState()||Object.create(null);h(i);k();}function q(){var K=T.componentRegistry[s.oComponent.getId()];var M=K.aKeys;var N="";var O=K.route;for(var i=M.length-1;i>0;i--){var P=T.mRoutingTree[O];var Q=i===1?P.entitySet:P.navigationProperty;N="/"+Q+(M[i]?"("+M[i]+")":"")+N;O=P.parentRoute;}return N;}function u(P,i){return a.then(function(){var K=Object.create(null);var M=(!P||q()===P)&&l;if(M){K[s.appStateName]=M;}return K;});}function v(){if(I){return;}if(!A){A=true;if(n){p();}else{setTimeout(p,0);}}}function w(i){r=i;S=null;l=i;}function x(i,K,U){if(!K){return;}for(var M in K){var N=K[M];if(U||N.lifecycle.page){i[M]=N;}}}function R(i,K,N){h(N);var M=Object.create(null);for(var O in N){M[O]=N[O].data;}s.applyState(M,i);if(n){n();n=null;}w(K);k();}function y(i,K,M){for(var N=i;N.next;N=N.next){if(N.next.appStateKey===M){m(i,N);return;}}var O={next:i.next,serialize:JSON.stringify(K),appStateKey:M};i.next=O;}function z(i,K,M,N,O,P,Q,U){if(I){K();return;}if(b===null){b=M;}else if(M!==b){K();return;}if(U){var V=U.getData();y(e,V,Q);x(O,V,true);}x(O,P,true);R(N,b,O);i();}function D(i,K,M,N,O,P){var Q=P.getData();y(o,Q,M);if(Q.sessionAppStateKey){var U=c.getAppState(s.oComponent.getAppComponent(),Q.sessionAppStateKey);U.done(z.bind(null,i,K,M,N,O,Q.permanentEntries,Q.sessionAppStateKey));U.fail(z.bind(null,i,K,M,N,O,Q.permanentEntries,"",null));}else{z(i,K,M,N,O,Q.permanentEntries,"",null);}}function E(i){var K=T.componentRegistry[s.oComponent.getId()];var M=K.utils.getHeaderDataAvailablePromise()||Promise.resolve();return M.then(function(){return T.oApplicationProxy.areTwoKnownPathesIdentical(d,i,K.viewLevel===1);});}function F(i,K){if(i===d){K(true);return;}if(!i||!d){K(false);return;}E(i).then(K);}function G(i,K){var M=new Promise(function(N,O){F(i,function(P){d=i;var Q=Object.create(null);x(Q,C[P?"allEntries":"pageEntries"],P||K);if(b===r||!b){if(b||P){x(Q,C.sessionEntries,true);x(Q,C.permanentEntries,true);}R(P,b,Q);N();return;}if(!n){a=new Promise(function(V){n=V;});}var U=c.getAppState(s.oComponent.getAppComponent(),b);U.done(D.bind(null,N,O,b,P,Q));U.fail(O);},O);});return M;}function H(i){b=i[s.appStateName]||"";if(Array.isArray(b)){b=b.sort()[0]||"";}if(S){if(S.appStateKey!==b){L.error("StatePreserver: Got AppstateKey "+b+" expected "+S.appStateKey);return false;}w(b);return true;}return false;}function J(){return{isStateChange:H};}return{getUrlParameterInfo:u,stateChanged:v,applyAppState:G,getAsStateChanger:J};}return B.extend("sap.suite.ui.generic.template.lib.StatePreserver",{constructor:function(T,s){Object.assign(this,g(T,s));}});});

sap.ui.define(["sap/ui/core/mvc/Controller","sap/m/library","sap/ui/model/odata/ODataUtils","sap/ovp/cards/generic/Component","sap/ui/generic/app/navigation/service/NavigationHandler","sap/m/MessageBox","sap/ovp/cards/CommonUtils","sap/ovp/cards/PersonalizationUtils","sap/ovp/cards/charts/VizAnnotationManager","sap/m/BusyDialog","sap/ui/model/Filter","sap/ui/fl/ControlPersonalizationAPI","sap/ui/generic/app/navigation/service/SelectionVariant","sap/ui/comp/state/UIState","sap/m/ColumnListItem","sap/m/Text","sap/m/Switch","sap/m/Table","sap/m/Column","sap/m/Button","sap/m/Dialog","sap/ui/model/json/JSONModel","sap/ui/Device","sap/ovp/ui/SmartphoneHeaderToggle","sap/ui/model/odata/v2/ODataModel","sap/ui/model/odata/ODataMetadata","sap/ui/fl/FlexControllerFactory","sap/ui/thirdparty/hasher","sap/ui/model/analytics/odata4analytics","sap/m/BackgroundDesign","sap/m/ListSeparators","sap/ui/core/TextAlign","sap/ovp/support/lib/CommonMethods","sap/ovp/app/resources","sap/ovp/app/TemplateBaseExtension","sap/ui/core/mvc/ControllerExtension","sap/ovp/app/OVPUtils","sap/base/Log","sap/base/util/merge","sap/base/security/encodeURL","sap/base/util/ObjectPath","sap/ui/thirdparty/jquery"],function(C,S,O,a,N,M,b,P,V,B,F,c,d,U,f,T,g,h,m,n,D,J,o,p,q,r,s,t,u,v,L,w,x,y,z,A,E,G,H,I,K,Q){"use strict";var R="sap.ovp.app.customData",W="sap.ovp.app.extensionData";return C.extend("sap.ovp.app.Main",{getCustomAppStateDataExtension:function(e){},restoreCustomAppStateDataExtension:function(e){},getCustomFilters:function(){},onCustomActionPress:function(e){},onCustomParams:function(e){},modifyStartupExtension:function(e){},getCustomMessage:function(e,i){},onBeforeRebindPageExtension:function(){},oRefreshTimer:null,nRefreshInterval:0,filterItemInFocus:null,bFinishedCardsCreationProcess:false,storeIncomingDeltaChanges:function(e){this.deltaCardsInfo=e?e:[];},appendIncomingDeltaChange:function(e){this.deltaChanges.push(e);},templateBaseExtension:z,onInit:function(){this.bDeltaChangesEnabled=false;this.deltaChanges=[];this._initFlexibilityPersonalization();this.getView().loaded().then(function(){var e=this.getOwnerComponent();var i=e.getMetadata();if(e&&i&&i.getManifest()){x.setAppComponent(this.getOwnerComponent());}x.setApplicationStatus(x.mApplicationStatus.LOADING);x.publishEvent("elements","ViewRenderingStarted",{});this.oContainer=sap.ushell&&sap.ushell.Container;this.aErrorCards=[];this.oCardsModels={};this.aFilters=[];this.errorHandlingObject={atLeastOneRequestSuccess:false,errorLoadingTimeout:{}};this.sPreviousEntityType="";this.sCurrentEntityType="";this.oLoadedComponents={};this.bGlobalFilterLoaded=false;this.bGoButtonPressed=false;this.bSearchButtonPressed=false;this.isInitialLoading=true;var j=this.getUIModel();this.bDisableErrorPage=j&&j.getProperty("/disableErrorPage");this.oNavigationHandler=this.oNavigationHandler||new N(this);this.getLayout().addStyleClass("ovpLayoutElement");this.oState={};this.oState.oSmartFilterbar=this.byId("ovpGlobalFilter");this._initGlobalFilter();this._createModelForTile();this._checkJamAuth();b.enable(this,this.oNavigationHandler);}.bind(this));},performRecreationOfCard:function(e){e.settings.baseUrl=this._getBaseUrl();this._clearStoredEntities();this._initCardModel(e.model);e=this._getTemplateForChart(e);this._loadCardComponent(e.template);this._createModelViewMap(e);Q.when(this.createCard(e)).then(function(){if(this.getLayout().getMetadata().getName()==="sap.ovp.ui.DashboardLayout"){var i=this.getLayout().getDashboardLayoutUtil();if(i){var j=i.getDashboardLayoutModel();var k=j.getCardById(e.id);i._sizeCard(k);j.extractCurrentLayoutVariant();}}}.bind(this));},recreateCard:function(e){var i=this._getCardFromManifest(e.cardId);if(i.template=="sap.ovp.cards.charts.analytical"||i.template=="sap.ovp.cards.charts.smart.chart"){i.settings.chartAnnotationPath=e.chartAnnotationPath;i.settings.colorPalette=e.colorPalette;i.settings.bEnableStableColors=e.bEnableStableColors;if(e.navigation){i.settings.navigation=e.navigation;}}if(e.entitySet){i.settings.entitySet=e.entitySet;}i.settings.annotationPath=e.annotationPath;i.settings.dynamicSubtitleAnnotationPath=e.dynamicSubtitleAnnotationPath;i.settings.presentationAnnotationPath=e.presentationAnnotationPath;i.settings.selectionAnnotationPath=e.selectionAnnotationPath;i.settings.selectionPresentationAnnotationPath=e.selectionPresentationAnnotationPath;i.settings.kpiAnnotationPath=e.kpiAnnotationPath;i.settings.dataPointAnnotationPath=e.dataPointAnnotationPath;i.settings.identificationAnnotationPath=e.identificationAnnotationPath;i.settings.headerAnnotationPath=e.headerAnnotationPath;if(e.staticParameters){i.settings.staticParameters=e.staticParameters;}var j=i.settings.selectedKey;i.settings.selectedKey=e.selectedKey;if(i){this.performRecreationOfCard(i);}var k={changeType:"viewSwitch",content:{cardId:e.cardId,selectedKey:e.selectedKey,oldKey:j},isUserDependent:true};this.savePersonalization(k);},recreateRTAClonedCard:function(e){var i=this._getCardFromManifest(e.id);if(i){i.settings=e.settings;this.performRecreationOfCard(i);}},onBeforeRendering:function(){},onRequestCompleted:function(e){if(e&&e.getParameters()&&e.getParameters().success){var i=e.getParameters().response&&e.getParameters().response.responseText?JSON.parse(e.getParameters().response.responseText):"";if(i&&i.d&&i.d.results&&i.d.results.length==0){this.fVerifyAndSetErrorOrCustomMessageCard(e,true);}}else if(e&&e.getParameters()&&e.getParameters().response&&e.getParameters().response.statusCode!==0){this.fVerifyAndSetErrorOrCustomMessageCard(e,false);}},fVerifyAndSetErrorOrCustomMessageCard:function(i,j){var k;this._loadCardComponent("sap.ovp.cards.error");for(k in this.aOrderedCards){var l=this.getView().byId(this.aOrderedCards[k].id);var X=l&&l.getComponentInstance();var Y=X&&X.getComponentData();var Z=X&&X.getRootControl();var $=Z&&Z.getController();var _=$&&$.getCardItemsBinding();if(_){var a1=i.getParameters().url;var b1=_.sCustomParams;var c1=_.sFilterParams;var d1=_.sPath.replace("/","");var e1=_.sRangeParams;var f1=_.sCountMode&&_.sCountMode.indexOf("Inline");var g1=_.sSortParams;var h1=i.getSource().sServiceUrl;var i1=i.oSource&&i.oSource.oMetadata;var j1=$.getEntityType();var k1;try{k1=sap.ui.model.odata.ODataUtils.createFilterParams(this.aFilters,i1,j1);}catch(e){G.error("applying filter on a card which is not valid");}a1=a1.split(d1).join("").split(b1).join("").split(c1).join("").split(e1).join("").split(g1).join("").split(h1).join("").split(k1).join("").split("?").join("").split("&").join("").split("/").join("");if(!f1){a1=a1.split("$inlinecount=allpages").join("");}var l1=Y&&Y.cardId;var m1=this._getCardFromManifest(l1);if(a1){var n1=/sap-client=[0-9][0-9][0-9]/i;a1=a1.replace(n1,"");}if(m1&&!a1){var o1=Q.extend(true,{},i);var p1=Q.extend(true,{},m1);var q1=this.getCustomMessage(o1,p1.id);q1=q1&&typeof q1==="object"?q1:"";if(j&&!q1){return;}if(q1){if(j&&q1.hasOwnProperty("sMessage")&&q1.sMessage&&typeof q1.sMessage==="string"){i.getParameters().response.statusText=q1.sMessage;if(q1.hasOwnProperty("sIcon")&&q1.sIcon&&typeof q1.sIcon==="string"&&q1.sIcon.indexOf("sap-icon")!==-1){i.getParameters().response.sIcon=q1.sIcon;}}else if(!j&&q1.hasOwnProperty("sMessage")&&q1.sMessage&&typeof q1.sMessage==="string"){i.getParameters().response.statusText=q1.sMessage;}}if(this.getLayout().getMetadata().getName()==="sap.ovp.ui.DashboardLayout"){var r1=this.getLayout();var s1=r1.getDashboardLayoutModel();var t1=s1.getCardById(m1.id);m1=t1;}if(this.aErrorCards.indexOf(l1)==-1){this.aErrorCards.push(m1.id);}else{X.destroy();}this.createErrorCard(m1,i);}}}},onAfterRendering:function(){x.setApplicationStatus(x.mApplicationStatus.RENDERED);x.publishEvent("elements","ViewRendered",{});this.oModelViewMap={};this.oAppStatePromise=null;if(this.getView().getModel("ui").getProperty("/refreshIntervalInMinutes")){this.nRefreshInterval=this.getView().getModel("ui").getProperty("/refreshIntervalInMinutes");this.nRefreshInterval=(this.nRefreshInterval<=1?1:this.nRefreshInterval)*60000;}var e=this._getCardsModel();var i=[];var k;for(k in e){if(i.indexOf(e[k].model)==-1){i.push(e[k].model);}}var j=this.getOwnerComponent();if(j){for(k in i){var l=j.getModel(i[k]);if(l){l.attachRequestCompleted(this.onRequestCompleted.bind(this));l.attachRequestSent(this.destroyErrorCardsAndReplaceWithOriginal.bind(this));}}}if(this.initialized){return;}this.initialized=true;Promise.all([this.oFlexibilityPersonalizationPromise,this.oGlobalFilterLoadedPromise]).then(function(){this.getView().byId("ovpFilterNotFulfilledPage").setVisible(false);this.getView().byId("ovpCardPage").setVisible(true);this.persistencyVariantLoaded=true;var X;var Y=[],Z=[];this.aManifestOrderedCards=this._getCardArrayAsVariantFormat(this.getLayout().getContent());for(var $=0;$<this.aManifestOrderedCards.length;$++){X=this._getCardFromManifest(this.aManifestOrderedCards[$].id);if(X&&X.settings&&X.settings.requireAppAuthorization){Y.push({id:X.id,cardIntent:X.settings.requireAppAuthorization});Z.push(X.settings.requireAppAuthorization);}}if(Z.length>0){this._checkForAuthorization(Y,Z);}else{this.aOrderedCards=this._mergeLREPContent(this.aManifestOrderedCards);this.organizeCards(this.aOrderedCards);}}.bind(this));if(o.system.phone){p.enable(this);}},organizeCards:function(e){var k;var l=[];this._updateLayoutWithOrderedCards();this._updateDashboardLayoutCards(e);if(this.isDragAndDropEnabled()){if(sap.ushell&&sap.ushell.Container){this._initShowHideCardsButton();}}this._clearStoredEntities();for(var i=0;i<this.aOrderedCards.length;i++){if(this.aOrderedCards[i].visibility){k=this._getCardFromManifest(this.aOrderedCards[i].id);if(k){l.push(k);}}}for(var i=0;i<l.length;i++){this._initCardModel(l[i].model);this._loadCardComponent(l[i].template);this._createModelViewMap(l[i]);}setTimeout(function(){this.getLayout().addStyleClass("ovpLayoutElementShow");}.bind(this),0);var X=this.fGetViewSwitchIndex(l);for(var i=0,j=0;j<l.length;i++,j++){while(l[j].id!==e[i].id){i++;}k=l[j];if(!k.settings.title){G.error("title is mandatory for card ID : "+k.id);}if(k.settings.tabs){var Y=0;var Z=X&&X.hasOwnProperty(k.id)?X[k.id]:"";if(Z&&typeof Z=="number"&&Z>0&&Z<=k.settings.tabs.length){Y=Z>=1?Z-1:Z;this.setOrderedCardsSelectedKey(k.id,Z);}else if(this.aOrderedCards[i].selectedKey&&k.settings.tabs.length>=this.aOrderedCards[i].selectedKey){Y=this.aOrderedCards[i].selectedKey-1;}this.initializeTabbedCard(k,Y);}k=this._getTemplateForChart(k);this._loadCardComponent(k.template);k.settings.baseUrl=this._getBaseUrl();this.createCard(k);}this.bFinishedCardsCreationProcess=true;if(this.busyDialog){this.busyDialog.close();}},_getTemplateForChart:function(e){if(e.template==="sap.ovp.cards.charts.smart.chart"){var i=this.getView();var j=i.getModel(e.model);var k=j.getMetaModel();var l=k.getODataEntitySet(e.settings.entitySet);var X=k.getODataEntityType(l.entityType);var Y;var Z;var $;var _=false;var a1;if(e&&e.settings){if(!_&&e.settings.kpiAnnotationPath){var b1=X[e.settings.kpiAnnotationPath];a1=b1.Detail.DefaultPresentationVariant&&b1.Detail.DefaultPresentationVariant.Path;if(a1){$=this._getTemplateForChartFromVisualization(a1,e,j,l,X);_=$.bTemplateUpdated;if(_){e=$.oCard;return e;}}}if(!_&&e.settings.selectionPresentationAnnotationPath){var c1=X[e.settings.selectionPresentationAnnotationPath];if(c1){a1=c1.PresentationVariant&&c1.PresentationVariant.Path;if(a1){$=this._getTemplateForChartFromVisualization(a1,e,j,l,X);_=$.bTemplateUpdated;if(_){e=$.oCard;return e;}}}}if(!_&&e.settings.presentationAnnotationPath){a1=e.settings.presentationAnnotationPath;$=this._getTemplateForChartFromVisualization(a1,e,j,l,X);_=$.bTemplateUpdated;if(_){e=$.oCard;return e;}}if(!_&&e.settings.chartAnnotationPath){Y=X[e.settings.chartAnnotationPath];Z=Y&&Y.ChartType&&Y.ChartType.EnumMember;if(Z&&Z.split("/")[1]==="Donut"){e.template="sap.ovp.cards.charts.analytical";}else{e.template="sap.ovp.cards.charts.smart.chart";}}}}return e;},_getTemplateForChartFromVisualization:function(e,i,j,k,l){if(/^@/.test(e)){e=e.slice(1);}i.settings.presentationAnnotationPath=e;var X=l[e]&&l[e].Visualizations;var Y;var Z;var $;var _=false;if(X&&X.length>0){for(Y=0;Y<X.length;Y++){var a1=X[Y].AnnotationPath;if(!a1){return{oCard:i,bTemplateUpdated:_};}a1.trim();if(a1.startsWith("@")){a1=a1.slice(1);}if(a1.indexOf("Chart")!=-1){i.settings.chartAnnotationPath=a1;Z=l[a1];$=Z&&Z.ChartType&&Z.ChartType.EnumMember;if($&&$.split("/")[1]==="Donut"){i.template="sap.ovp.cards.charts.analytical";}else{i.template="sap.ovp.cards.charts.smart.chart";}}_=true;}}return{oCard:i,bTemplateUpdated:_};},_createModelViewMap:function(e){if(!e||!e.settings||!e.model){return;}if(!e.settings.entitySet||e.settings.entitySet===""){return;}if(!(e.template.startsWith("sap.ovp.cards"))){return;}var i=e.model;if(!this.oModelViewMap[i]){this.oModelViewMap[i]={};}this.oModelViewMap[i][e.id]=true;},setTabIndex:function(e){if(typeof e=="object"){this.oTabIndexList=e;}else{this.oTabIndexList={};}},getTabIndex:function(){return this.oTabIndexList;},fGetViewSwitchIndex:function(e){var j=this.getGlobalFilter();var k=j&&j.getUiState();var l=k?JSON.stringify(k.getSelectionVariant()):"{}";var X=JSON.parse(l);var Y=Q.extend(true,{},X);var Z=[];if(e&&e.length>0){for(var i=0;i<e.length;i++){var $=Q.extend(true,{},e[i]);Z.push($);}}this.onBeforeRebindPageExtension(Z,Y);return this.getTabIndex();},changeViewSwitchForVisibleCard:function(){var e=this.aOrderedCards;if(e&&e.length>0){var j=[],k=[];for(var i=0;i<e.length;i++){j.push(this._getCardFromManifest(e[i].id));}var l=this.fGetViewSwitchIndex(j);if(l&&typeof l=="object"){k=Object.keys(l);}if(k&&k.length>0){for(var i=0;i<e.length;i++){if(e[i]&&e[i].visibility==true){var X=this._getCardFromManifest(e[i].id);if(X&&X.settings&&X.settings.tabs&&X.settings.hasOwnProperty("selectedKey")){var Y=l&&l.hasOwnProperty(X.id)?l[X.id]:"";var Z=X.settings.selectedKey;if(Y&&typeof Y=="number"&&Y<=X.settings.tabs.length&&Y!==Z){this.setOrderedCardsSelectedKey(X.id,Y);var $={};$=X.settings.tabs[Y-1];var _={cardId:X.id,selectedKey:Y};for(var a1 in $){_[a1]=$[a1];}this.recreateCard(_);}}}}}}},setOrderedCardsSelectedKey:function(e,j){var k=this.aOrderedCards;for(var i=0;i<k.length;i++){if(k[i]&&k[i].id==e){this.aOrderedCards[i].selectedKey=j;break;}}},getOrderedCardsSelectedKey:function(e){var j=this.aOrderedCards;for(var i=0;i<j.length;i++){if(j[i]&&j[i].id==e){return this.aOrderedCards[i].selectedKey;}}},initializeTabbedCard:function(e,i){if(e.template=="sap.ovp.cards.charts.analytical"||e.template=="sap.ovp.cards.charts.smart.chart"){e.settings.chartAnnotationPath=e.settings.tabs[i].chartAnnotationPath;e.settings.colorPalette=e.settings.tabs[i].colorPalette;e.settings.bEnableStableColors=e.settings.tabs[i].bEnableStableColors;if(e.settings.tabs[i].navigation){e.settings.navigation=e.settings.tabs[i].navigation;}}if(e.settings.tabs[i].entitySet){e.settings.entitySet=e.settings.tabs[i].entitySet;}e.settings.annotationPath=e.settings.tabs[i].annotationPath;e.settings.dynamicSubtitleAnnotationPath=e.settings.tabs[i].dynamicSubtitleAnnotationPath;e.settings.presentationAnnotationPath=e.settings.tabs[i].presentationAnnotationPath;e.settings.selectionAnnotationPath=e.settings.tabs[i].selectionAnnotationPath;e.settings.selectionPresentationAnnotationPath=e.settings.tabs[i].selectionPresentationAnnotationPath;e.settings.kpiAnnotationPath=e.settings.tabs[i].kpiAnnotationPath;e.settings.dataPointAnnotationPath=e.settings.tabs[i].dataPointAnnotationPath;e.settings.identificationAnnotationPath=e.settings.tabs[i].identificationAnnotationPath;e.settings.params=e.settings.tabs[i].params;e.settings.selectedKey=i+1;},_getLibraryResourceBundle:function(){if(!this.oLibraryResourceBundle){this.oLibraryResourceBundle=sap.ui.getCore().getLibraryResourceBundle("sap.ovp");}return this.oLibraryResourceBundle;},_getOvplibResourceBundle:function(){return this.getOwnerComponent()._getOvpLibResourceBundle();},_getCardsModel:function(){if(!this.oCards){var e=this.getUIModel();this.oCards=e.getProperty("/cards");}return this.oCards;},_getBaseUrl:function(){var e=this.getUIModel();if(!this.sBaseUrl){this.sBaseUrl=e.getProperty("/baseUrl");}return this.sBaseUrl;},_getApplicationId:function(){var e=this.getUIModel();return e.getProperty("/applicationId");},_getCardFromManifest:function(e){var j=this._getCardsModel();for(var i=0;i<j.length;i++){if(j[i].id===e){return j[i];}}G.error("Card id "+e+" is not available in the manifest");return null;},_getCardArrayAsVariantFormat:function(e){var j=[];for(var i=0;i<e.length;i++){var k=this._getCardId(e[i].getId());j.push({id:k,visibility:e[i].getVisible()});var l;if(this.getView()&&this.getView().byId){if(this.getView().byId(k).getComponentInstance()){l=this.getView().byId(k).getComponentInstance().getComponentData().settings.selectedKey;}}if(l){j[j.length-1].selectedKey=l;}}return j;},_checkForAuthorization:function(e,X){if(!this.oContainer){return;}var Y=this;var Z=[];var $=b.getNavigationHandler();if($&&$.oCrossAppNavService){$.oCrossAppNavService.isIntentSupported(X).done(function(_){for(var i=0;i<e.length;i++){if(_[e[i].cardIntent].supported===false){Z.push(e[i].id);for(var j=0;j<Y.aManifestOrderedCards.length;j++){if(e[i].id===Y.aManifestOrderedCards[j].id){Y.aManifestOrderedCards.splice(j,1);break;}}}}Y.aOrderedCards=Y._mergeLREPContent(Y.aManifestOrderedCards);function a1(b1,c1,d1){if(b1.id===Z[this.unsupportedCardIndex]){d1.splice(c1,1);}}for(var k=0;k<Z.length;k++){for(var l=0;l<Y.aOrderedCards.length;l++){if(Y.aOrderedCards[l].id==Z[k]){Y.aOrderedCards.splice(l,1);if(Y.getLayout().getMetadata().getName()==="sap.ovp.ui.DashboardLayout"){Y.getLayout().dashboardLayoutUtil.aCards.map(a1,{unsupportedCardIndex:k});Y.getLayout().dashboardLayoutUtil.dashboardLayoutModel.oLayoutVars.map(a1,{unsupportedCardIndex:k});}break;}}}Y.organizeCards(Y.aOrderedCards);}).fail(function(){G.error("Could not get authorization from isIntentSupported");Y.aOrderedCards=Y._mergeLREPContent(Y.aOrderedCards);Y.organizeCards(Y.aOrderedCards);});}},_mergeLREPContent:function(l){var e=[];var i=false;if(this.bDeltaChangesEnabled&&Array.isArray(this.deltaCardsInfo)&&this.deltaCardsInfo.length>0){l=P.addMissingCardsFromManifest(l,this.deltaCardsInfo);i=true;}if(this.getLayout().getMetadata().getName()==="sap.ovp.ui.DashboardLayout"){if(!i){l=this.getLayout().getLayoutDataJSON();}e=P.mergeChanges(l,this.deltaChanges);this._bDashboardLayoutLrepActive=true;this.getLayout().getDashboardLayoutModel().setLayoutVars(e);}else{e=P.mergeChanges(l,this.deltaChanges);}return e?e:[];},_updateLayoutWithOrderedCards:function(){var l=this.getLayout();var e=this.aOrderedCards;l.removeAllContent();var k,X=false;if(this.getView().getModel("ui")&&this.getView().getModel("ui").getProperty("/cards")){k=this.getView().getModel("ui").getProperty("/cards");for(var i=0;i<k.length;i++){X=false;for(var j=0;j<e.length;j++){if(k[i].id==e[j].id){X=true;break;}}if(!X&&this.getView().byId(k[i].id)){this.getView().byId(k[i].id).destroy();}}}for(var i=0;i<e.length;i++){var Y=this.getView().byId(e[i].id);if(Y){Y.setVisible(e[i].visibility);l.addContent(Y);}}},_updateErrorCardsArray:function(e){var i;for(i=0;i<e.length;i++){var j=this.aErrorCards.indexOf(e[i].id);if((j>-1)&&e[i].visibility==false){this.aErrorCards.splice(j,1);}}},_updateDashboardLayoutCards:function(e){if(this.getLayout().getMetadata().getName()==="sap.ovp.ui.DashboardLayout"){if(this.getLayout().getDashboardLayoutUtil()){this.getLayout().getDashboardLayoutUtil().updateCardVisibility(e);}}},_resetDashboardLayout:function(){if(this.getLayout().getMetadata().getName()==="sap.ovp.ui.DashboardLayout"){if(this.getLayout().getDashboardLayoutUtil()){this.getLayout().getDashboardLayoutUtil().resetToManifest();}this.getLayout().rerender();}},_getCardArrayAsVariantFormatDashboard:function(){var e=[],j=[],k=[],l=[];var X=this.getLayout();var Y=X.dashboardLayoutUtil.aCards;for(var i=0;i<Y.length;i++){var Z=Y[i];if(Z&&Z.settings&&Z.settings.requireAppAuthorization){j.push({id:Z.id,cardIntent:Z.settings.requireAppAuthorization});k.push(Z.settings.requireAppAuthorization);}}var $=b.getNavigationHandler();if($&&$.oCrossAppNavService){return $.oCrossAppNavService.isIntentSupported(k).then(function(_){for(var i=0;i<j.length;i++){if(_[j[i].cardIntent].supported===false){l.push(j[i].id);}}var a1=[];for(var i=0;i<Y.length;i++){if(l.indexOf(Y[i].id)===-1){a1.push(Y[i]);}}this.getLayout().dashboardLayoutUtil.dashboardLayoutModel._sortCardsByRow(a1);a1.forEach(function(b1){e.push({id:b1.id,visibility:b1.dashboardLayout.visible});});return e;}.bind(this));}},verifyGlobalFilterLoaded:function(){var e=this.getGlobalFilter();var i=true;var j=e.determineMandatoryFilterItems();var k,l=e.getFilterData(),X;if(j&&l){var Y=j.length;while(Y--){k=j[Y];X=e.determineControlByFilterItem(k,true);if(X){if(!e._checkForValues(l,k,X)){i=false;break;}}}}if(i&&e.search()){if(e.validateMandatoryFields()){E.loadingState.GLOBALFILTERFILLED=true;return true;}}this.getView().byId("ovpMain").setHeaderExpanded(true);this.getView().byId("ovpFilterNotFulfilledPage").setVisible(true);E.loadingState.GLOBALFILTERFILLED=false;return false;},onGlobalFilterChange:function(e){this.filterChanged=true;if(this.bGlobalFilterInitialized){var i=this.getGlobalFilter();var l=i.getLiveMode();var j=this.getLayout();var k=e.getParameter("afterFilterDataUpdate");if(!l&&j&&!k){j.setActive(false);}else{this.changeViewSwitchForVisibleCard();}}},destroyErrorCardsAndReplaceWithOriginal:function(){if(this.isModelRefreshTriggered||this.filterChanged||this.bGoButtonPressed||this.bSearchButtonPressed){var k;var e=Q.sap.extend({},this.aErrorCards);for(k in e){var i=this.getView().byId(e[k]);var j=i&&i.getComponentInstance();var l=j&&j.getComponentData();var X=l&&l.cardId;var Y=this._getCardFromManifest(X);j.destroy();var Z=this.aErrorCards.indexOf(X);if((Z>-1)){this.aErrorCards.splice(Z,1);}this.createCard(Y);}this.isModelRefreshTriggered=false;}},onGlobalFilterSearch:function(){if(this.filterChanged||this.bGoButtonPressed||this.bSearchButtonPressed){var e=this.getGlobalFilter();var k=this.getLayout();if(k){k.setActive(true);}if(this.aErrorCards&&this.aErrorCards.length>0){this.destroyErrorCardsAndReplaceWithOriginal();}if(e&&!e.isDialogOpen()){this._storeCurrentAppStateAndAdjustURL();}this._clearStoredEntities();var l=[];if(this.oGlobalFilter['_aFields'].length>0){l=this.oGlobalFilter["_aFields"];}else{var X=this.oGlobalFilter['_aFilterBarViewMetadata'];for(var i=0;i<X.length;i++){var Y=X[i];for(var j=0;j<Y.fields.length;j++){l.push(Y.fields[j]);}}}for(var i=0;i<l.length;i++){if(l[i].control){var Z=document.getElementById(l[i].control.sId);if(Q(Z).hasClass('sapMFocus')){this.filterItemInFocus=l[i].control;break;}}}var $="ovp-"+new Date().getTime();for(var _ in this.oCardsModels){if(this.oCardsModels.hasOwnProperty(_)){try{this.oCardsModels[_].refresh(false,false,$);}catch(a1){G.warning(a1);}}}this.filterChanged=false;this.bGoButtonPressed=false;this.bSearchButtonPressed=false;this._clearStoredEntities();}},_clearStoredEntities:function(){if(this.sPreviousEntityType){this.sPreviousEntityType="";}if(this.sCurrentEntityType){this.sCurrentEntityType="";}},_processFilters:function(){this.aFilters=[];var e=this.getGlobalFilter();if(!e){return;}var i=e.getFilters();var j=this.getCustomFilters();var k=true;var l;var X=function($,_){if(!($ instanceof A)){throw new Error("State must always be set with respect to a ControllerExtension");}if(!k){throw new Error("State must always be provided synchronously");}if(_){l=_;}};this.templateBaseExtension.addFilters(X);k=false;var Y=[];if(j&&(j instanceof F)){Y.push(j);}if(l&&(l instanceof F)){Y.push(l);}if(Y.length!==0){var Z=[];if(i&&i.length>0){Y.push(i[0]);}Z.push(new F(Y,true));if(Z.length>0){i=Z;}}this.aFilters=i;},_processSearch:function(){var e,i;var j=this.getGlobalFilter();if(!j){return;}var k=j.getParameters();var i=k&&k["custom"];if(!i){return;}for(var l in i){e=l+"="+I(i[l]);}return e;},_initGlobalFilter:function(){var e=this.getGlobalFilter();if(!e){this.bGlobalFilterLoaded=true;this._parseNavigationVariant();return;}e.attachFiltersDialogClosed(this._storeCurrentAppStateAndAdjustURL.bind(this));var i=e.getVariantManagement();if(i){i.attachAfterSave(function(j){this._storeCurrentAppStateAndAdjustURL();}.bind(this));}this.oGlobalFilterLoadedPromise=new Promise(function(j,k){e.attachInitialized(function(){this._parseNavigationVariant();if(this.oParseNavigationPromise){var _;this.oParseNavigationPromise.done(function(l,X,Y){if(l){_=Promise.resolve(this._setNavigationVariantToGlobalFilter(l,X,Y)).then(function(){this.filterChanged=false;}.bind(this));}}.bind(this));this.oParseNavigationPromise.fail(function(){G.error("Could not parse navigation variant from URL");});this.oParseNavigationPromise.always(function(){Promise.all([_]).then(function(){this.bGlobalFilterInitialized=true;if(e&&this.verifyGlobalFilterLoaded()){j();}}.bind(this));}.bind(this));}else if(e&&this.verifyGlobalFilterLoaded()){j();}},this);e.attachSearch(function(){if(!this.bGlobalFilterLoaded){j();this.bGlobalFilterLoaded=true;if(!e.isDialogOpen()){this._storeCurrentAppStateAndAdjustURL();}var l=this.getLayout();if(l){l.setActive(true);}return;}this.onGlobalFilterSearch();},this);e.attachFilterChange(this.onGlobalFilterChange,this);e._oSearchButton&&e._oSearchButton.attachPress(function(){this.bGoButtonPressed=true;var l=this.getLayout();if(l){l.setActive(true);}}.bind(this));}.bind(this));this.oGlobalFilterLoadedPromise.then(function(j){this.bGlobalFilterLoaded=true;e._oBasicSearchField&&e._oBasicSearchField.attachSearch(function(){this.bSearchButtonPressed=true;}.bind(this));}.bind(this));},onShareButtonPress:function(e){var l=this._getLibraryResourceBundle();var i=this.getUIModel();var j=i&&i.getProperty("/title");if(!this._oShareActionButton){this._oShareActionButton=sap.ui.xmlfragment("sap.ovp.app.SharePage",{shareEmailPressed:function(){S.URLHelper.triggerEmail(null,l.getText("Email_Subject",[j]),document.URL);},shareJamPressed:function(){var k=sap.ui.getCore().createComponent({name:"sap.collaboration.components.fiori.sharing.dialog",settings:{object:{id:document.URL,share:j}}});k.open();}});this.getView().addDependent(this._oShareActionButton);}this._oShareActionButton.openBy(e.getSource());},_checkJamAuth:function(){var e=K.get("sap.ushell.Container.getUser");var i=this.getUIModel();if(i){i.setProperty("/jamVisible",!!e&&e().isJamActive());}},_createModelForTile:function(){var e=this.getUIModel();var i,j=e&&e.getProperty("/title");var k={tileTitle:j,tileCustomURL:function(){i=t.getHash();return i?("#"+i):window.location.href;}};if(e){e.setProperty("/tileInfo",k);}},_loadCardComponent:function(e){var i=e.replace(/\./g,'/');var j=sap.ui.require.toUrl(i);if(!this.oLoadedComponents[e]){this.oLoadedComponents[e]=sap.ui.component.load({name:e,url:j,async:true});}},_initCardModel:function(e){var i=false;if(this.oCardsModels[e]||!e){return;}this.oCardsModels[e]=this.getView().getModel(e);if(!this.oCardsModels[e].bUseBatch){this.oCardsModels[e].setUseBatch(false);}else{this.oCardsModels[e].setUseBatch(true);}if(this.getGlobalFilter()){i=true;}this._overrideCardModelRead(this.oCardsModels[e],i);},getVisibleCustomFields:function(){var e=this.getGlobalFilter();var i=e.getAllFilterItems(true);var l,j,k=[];if(i){l=i.length;while(l--){j=i[l];if(j&&j.getVisibleInFilterBar()){k.push(j.getName());}}}var X,Y,Z,$=e.getFilterBarViewMetadata();var _=[];if($){X=$.length;while(X--){Z=$[X].fields;if(Z){Y=Z.length;while(Y--){if(Z[Y].isCustomFilterField&&k.indexOf(Z[Y].fieldName)>-1){_.push({name:Z[Y].fieldName});}}}}}return _;},_showErrorPage:function(e){if(this.bDisableErrorPage){return;}var i=this.getView().byId('ovpErrorPage');var j=this.getView().byId('ovpMain');if(e){i.setVisible(true);j.setVisible(false);return;}i.setVisible(false);j.setVisible(true);},_isValueHelpCall:function(e,j){var k=this.getGlobalFilter();if(!e||!k||!k._oFilterProvider){return false;}if(e.getId()!==k.getModel().getId()){return false;}var l=k._oFilterProvider;var X=l.getAssociatedValueHelpProviders().concat(l.getAssociatedValueListProviders());var Y;for(var i=0;i<X.length;i++){Y=X[i]&&X[i].oPrimaryValueListAnnotation;if(Y&&Y.valueListEntitySetName===j){return true;}}return false;},_removeFilter:function(e,i){var l=e.lastIndexOf(i);var j=e.indexOf(i);if(l===-1||j===-1){return e;}var k="%20and%20";var X=e.substring(l).indexOf(k);X=(X!==-1)?l+X:X;var Y=e.substring(0,j).lastIndexOf(k);if(X===-1&&Y===-1){if(e.lastIndexOf("$filter=")===0){return e.slice(0,8);}else{return"";}}else if(Y===-1){if(e.lastIndexOf("$filter=")===0){return e.slice(0,8)+e.slice(X+k.length);}else{return e.slice(X+k.length);}}else if(X===-1){return e.slice(0,Y);}else{return e.slice(0,Y)+e.slice(X);}},_removeRelevantFilterRecursively:function(e,j){if(!e._bMultiFilter){if(e.sPath===j){return undefined;}return e;}else{e.aFilters.forEach(function(k,l){e.aFilters[l]=this._removeRelevantFilterRecursively(k,j);}.bind(this));for(var i=0;i<e.aFilters.length;i++){if(!e.aFilters[i]){e.aFilters.splice(i,1);i--;}}if(e.aFilters.length>0){return e;}else{return undefined;}}},_removeRelevantFilter:function(e,i){if(!e||e.length===0){return e;}e[0]=this._removeRelevantFilterRecursively(e[0],i);return(!e[0])?undefined:e;},_getFilterPreference:function(e){var i;var j=this._getCardFromManifest(e);if(j){if(j.settings.tabs){var k=0;var l=j.settings.selectedKey;if(l&&j.settings.tabs.length>=l){k=l-1;}i=j.settings.tabs[k].mFilterPreference;}else{i=j.settings.mFilterPreference;}}return i;},_getFilterPreferenceFromUrlParams:function(e){var i=e.urlParameters;var j;var k="cardId=";var l=-1;if(i){for(var X=0;X<i.length;X++){if((i[X]).lastIndexOf(k)>=0){l=X;break;}}if(l>=0){var Y=(i[l]).lastIndexOf(k);var Z=i[l].slice(Y+k.length);j=this._getFilterPreference(Z);if(Y>0){i[l]=i[l].slice(0,Y-1);}else{i.splice(l,1);}}}return j;},_addRelevantFilters:function(e,i,j,k){var l=e.urlParameters;var X=-1;if(l){for(var Y=0;Y<l.length;Y++){if((l[Y]).lastIndexOf("$filter=",0)===0){X=Y;break;}}}if(this.aRelevantFilters&&this.aRelevantFilters.length>0){if(X>=0){var Z=O.createFilterParams(this.aRelevantFilters,i.oMetadata,j).substr(8);if(k&&k.filterAll==="card"){l[X]=l[X];}else if(k&&k.filterAll==="global"){l[X]=l[X].slice(0,8)+Z;}else if(k&&(k.cardFilter||k.globalFilter)){if(Array.isArray(k.cardFilter)&&k.cardFilter.length>0){k.cardFilter.forEach(function($){Z=this._removeFilter(Z,$);}.bind(this));}if(Array.isArray(k.globalFilter)&&k.globalFilter.length>0){k.globalFilter.forEach(function($){l[X]=this._removeFilter(l[X],$);}.bind(this));}if(Z===""&&l[X].length===8){l.splice(X,1);}else if(Z===""){l[X]=l[X];}else if(l[X].length===8){l[X]=l[X]+Z;}else{if(this.aRelevantFilters.length===1){Z="("+Z+")";}l[X]=l[X].slice(0,8)+"("+l[X].slice(8,l[X].length)+")%20and%20"+Z;}}else{if(this.aRelevantFilters.length===1){Z="("+Z+")";}l[X]=l[X].slice(0,8)+"("+l[X].slice(8,l[X].length)+")%20and%20"+Z;}}else{if(k&&k.filterAll==="card"){e.filters=undefined;}else if(k&&k.filterAll==="global"){e.filters=this.aRelevantFilters;}else if(k&&(k.cardFilter||k.globalFilter)){if(Array.isArray(k.cardFilter)&&k.cardFilter.length>0){k.cardFilter.forEach(function($){this.aRelevantFilters=this._removeRelevantFilter(this.aRelevantFilters,$);}.bind(this));}if(this.aRelevantFilters&&this.aRelevantFilters.length>0){e.filters=this.aRelevantFilters;}}else{e.filters=this.aRelevantFilters;}}}else{if(X>=0){if(k&&k.filterAll==="card"){l[X]=l[X];}else if(k&&k.filterAll==="global"){l.splice(X,1);}else if(k&&k.globalFilter){if(Array.isArray(k.globalFilter)&&k.globalFilter.length>0){k.globalFilter.forEach(function($){l[X]=this._removeFilter(l[X],$);}.bind(this));}if(l[X].length===8){l.splice(X,1);}}}}return e;},_overrideCardModelRead:function(e,j){var k=e.read;var l=this;e.read=function(){var X=arguments[1];if(!X){X={};Array.prototype.push.call(arguments,X);}var Y=l._getEntityTypeFromPath(e,arguments[0],X.context,false);var Z=l._getEntitySetFromEntityType(e,Y);if(l._isValueHelpCall(e,Z.name)){return k.apply(e,arguments);}var $=l._getFilterPreferenceFromUrlParams(X);if(j){l._processFilters();var _=l.getGlobalFilter();if(!l.aFilters){l.aFilters=[];}var a1=false;var b1;var c1=Z["Org.OData.Capabilities.V1.SearchRestrictions"];if(Z["sap:searchable"]==="true"||(c1&&c1.Searchable&&c1.Searchable.Bool&&c1.Searchable.Bool==="true")){b1=l._processSearch();}l.sCurrentEntityType=Y.entityType;if(l.sPreviousEntityType!==l.sCurrentEntityType){l.sPreviousEntityType=l.sCurrentEntityType;a1=true;}if(!l.aRelevantFilters){l.aRelevantFilters=[];a1=true;}if(a1){l.aRelevantFilters=[];if(Y){l.aRelevantFilters=l._getEntityRelevantFilters(Y,l.aFilters,e,_.getModel());}}X=l._addRelevantFilters(X,e,Y,$);var d1=X.urlParameters;if(b1){d1[d1.length]=b1;}if(_&&_.getConsiderAnalyticalParameters()){var e1=_.getAnalyticBindingPath();var f1,g1,h1;if(e1&&e1.length>0){if(Y.entityType===_.getEntityType()){g1=arguments[0];f1=arguments[0].indexOf('$');if(f1>0){g1=arguments[0].substring(0,f1-1);}h1=e1;if(g1!==h1){arguments[0]=arguments[0].replace(g1,h1);}}else{var i1=l._getParametersFromEntityPath(arguments[0]);var j1=l._getParametersFromEntityPath(e1);var k1,l1,m1;if(i1&&i1.length>0){var n1=l._getEntityTypeFromPath(e,arguments[0],X.context,true);for(var i=0;i<j1.length;i++){k1=l._getPropertyMapping(i1,j1[i].name,n1.name,_.getEntityType(),e,_.getModel());if(k1){l1=k1+"=.*?[,\)]";m1=arguments[0].match(new RegExp(l1));if(m1&&m1.length>0){g1=m1[0].slice(0,-1);h1=k1+"="+j1[i].sValue;if(g1!==h1){arguments[0]=arguments[0].replace(g1,h1);}}}}}}}}}var o1=e.getMetaModel();var p1=o1.getODataEntityType(Z.entityType);d1=l._getExpandPropertiesForSmartCharts(d1,o1,p1);var q1=arguments[1].success;arguments[1].success=(function(t1,l){return function(){if(!l.errorHandlingObject.atLeastOneRequestSuccess){l.errorHandlingObject.atLeastOneRequestSuccess=true;l._showErrorPage(false);}if(l.filterItemInFocus!=null){l.filterItemInFocus.focus();l.filterItemInFocus=null;}if(l.nRefreshInterval!==0){if(l.oRefreshTimer!==null){clearTimeout(l.oRefreshTimer);}l.attachRefreshInterval(l.nRefreshInterval);}return t1.apply(this,arguments);};})(q1,l);var r1=arguments[1].error;arguments[1].error=(function(t1,l){return function(){if(!l.errorHandlingObject.atLeastOneRequestSuccess){clearTimeout(l.errorHandlingObject.errorLoadingTimeout);l.errorHandlingObject.errorLoadingTimeout=setTimeout(function(){if(!l.errorHandlingObject.atLeastOneRequestSuccess){l._showErrorPage(true);}},9000);}return t1.apply(this,arguments);};})(r1,l);var s1=k.apply(e,arguments);return s1;};},showErrorCardForMissingParam:function(e,j){var k=e[0];var l=e[1].urlParameters;for(var i in l){k=k+l[i];}var X=new sap.ui.base.Event();X.mParameters={"url":k,"response":{"statusText":y.getText("Missing_Param_Text")}};X.oSource=j;setTimeout(function(){this.fVerifyAndSetErrorOrCustomMessageCard(X,false);}.bind(this),0);},_checkMandatoryParams:function(e,j,k){var l=new u.Model(u.Model.ReferenceByModel(e));var X=l.findQueryResultByName(j);var Y=X&&X.getParameterization();if(!Y){return true;}var Z=Y.getAllParameterNames();var $=k.match(/\(.*\)/g);if(Z.length>0&&$===null){return false;}var _=$[0].replace("(","").replace(")","").split(",");if(_.length===Z.length){for(var i in _){var a1=_[i].split("=")[1];if(a1.indexOf("%27")>-1){a1=a1.split("%27")[1];}if(a1.length===0){return false;}}}else{return false;}},_getExpandPropertiesForSmartCharts:function(e,i,X){var Y;var Z="";var $;var _;var a1;var b1="$expand";var c1=false;var d1=false;var e1;var f1;var g1;var h1="com.sap.vocabularies.Common.v1.Text";var i1=X&&X.property;if(!e||!(e.length>0)){return e;}for(var l=0;l<e.length;l++){if(e[l].indexOf("$expand")>-1){return e;}}for(var j1=0;j1<e.length;j1++){if(e[j1].indexOf("$select")>-1){d1=true;f1=e[j1];a1=e[j1].split("$select=");if(a1&&a1[1]){e1=decodeURIComponent(a1[1]);Y=e1.split(",");if(!Y||!(Y.length>1)){return e;}}break;}}if(!d1){return e;}if(!Y||!(Y.length>0)||!i1||!(i1.length>0)){return e;}for(var j=0;j<Y.length;j++){for(var k=0;k<i1.length;k++){if(Y[j]==(i1[k]&&i1[k].name)){if(i1[k]&&i1[k]["sap:aggregation-role"]&&i1[k]["sap:aggregation-role"]=="dimension"){if(!i1[k][h1]||!i1[k][h1].Path||!(i1[k][h1].Path.indexOf("/")>0)){break;}Z=i1[k][h1].Path;$=Z.split("/");if(!$.length){break;}_=i.getODataAssociationEnd(X,$[0]);if(!_){break;}if(!c1){b1=b1+"="+$[0];c1=true;}else if(c1){b1=b1+","+$[0];}g1=f1+","+Z;}break;}}}if(g1&&b1){e[j1]=g1;e.push(b1);}return e;},attachRefreshInterval:function(e){this.oRefreshTimer=setTimeout(function(){var l=this.getLayout();if(l&&l.getActive()){for(var i in this.oCardsModels){this.isModelRefreshTriggered=true;this.oCardsModels[i].refresh(false,false);}}}.bind(this),e);},_getEntityTypeFromPath:function(e,i,j,k){var l=q.prototype._normalizePath.apply(e,[i,j]);if(k){l=i.replace(/^\/|\/$/g,"").split("/")[0];if(l.indexOf("(")!=-1){l=l.substring(0,l.indexOf("("));}}var X=r.prototype._getEntityTypeByPath.apply(e.oMetadata,[l]);return X;},_getEntitySetFromEntityType:function(e,j){if(!e||!j){return;}var k=e.getMetaModel();var l=k&&k.getODataEntityContainer();var X=l&&l.entitySet;if(!X||!Array.isArray(X)){return;}var Y=X.length;for(var i=0;i<Y;i++){if(X[i].entityType===j.entityType){return X[i];}}},_getPropertyMapping:function(e,j,k,l,X,Y){var i,Z;for(i=0;i<e.length;i++){if(e[i].name===j){Z=e[i].name;return Z;}if((("P_"+e[i].name)===j)||(e[i].name===("P_"+j))){Z=e[i].name;return Z;}}if(!k||!l||!X||!Y){return;}var $=X.oMetadata._getEntityTypeByName(k);var _=Y.oMetadata._getEntityTypeByName(l);if(!$||!_){return;}var a1="com.sap.vocabularies.Common.v1.SemanticObject";var b1="com.sap.vocabularies.Common.v1.SemanticObjectMapping";var c1=X.oAnnotations.getAnnotationsData();if(!c1||!c1.propertyAnnotations){return;}var d1=c1.propertyAnnotations[$.namespace+"."+$.name];var e1=Y.oAnnotations.getAnnotationsData();if(!e1||!e1.propertyAnnotations){return;}var f1=e1.propertyAnnotations[_.namespace+"."+_.name];var g1=f1&&f1[j];if(!g1||!g1[a1]){return;}var h1,i1,j1,k1,l1;for(h1 in d1){i1=d1[h1];if(i1[a1]&&i1[a1].String===g1[a1].String){j1=i1[b1];if(!j1){continue;}k1=j1.length;l1="";while(k1--){if(j1[k1].SemanticObjectProperty.String===j){l1=j1[k1].LocalProperty.PropertyPath;break;}}if(l1!==""){for(i=0;i<e.length;i++){if(e[i].name===l1){Z=e[i].name;return Z;}}}}}return Z;},_getParametersFromEntityPath:function(e){e=e.split("?")[0];var j=e.match(/\(.*=.*\)/);var k=[];if(!j){return k;}var l=j[0].slice(1,-1).trim().split(/\=|\,/);for(var i=0;i<l.length;i=i+2){k.push({name:l[i],sValue:l[i+1]});}return k;},_checkRelevantFiltersRecursive:function(e,j,k,l,X,Y){if(!j._bMultiFilter){j.sPath=j.sPath.split('/').pop();var Z=this._getPropertyMapping(e,j.sPath,k,l,X,Y);if(Z){j.sPath=Z;return j;}}else{var $=j.aFilters;var _,a1=[];if($){for(var i=0;i<$.length;i++){_=this._checkRelevantFiltersRecursive(e,$[i],k,l,X,Y);if(_){a1.push(_);}}if(a1.length>0){return(new F(a1,j.bAnd));}}}},_getEntityRelevantFilters:function(e,i,j,k){var l=[];if(i.length>0&&e){var X=this._checkRelevantFiltersRecursive(e.property,i[0],e.name,this.getGlobalFilter().getEntityType(),j,k);if(X){l.push(X);}}return l;},_checkIsCardValid:function(e){var i=e+".Component";var j,k;sap.ui.require(i);var l=K.get(i);if(!l){return false;}if((l!==a)&&!(l.prototype instanceof a)){return false;}if((j=l.getMetadata())&&(k=j.getCustomizing())){if(k["sap.ui.viewReplacements"]&&k["sap.ui.viewReplacements"]["sap.ovp.cards.generic.Card"]){return false;}}if(l.prototype.createContent!=a.prototype.createContent){return false;}if(l.prototype.getPreprocessors!=a.prototype.getPreprocessors){return false;}return true;},_createCardComponent:function(e,i,j){var k=e.getModel("@i18n");if(j.template&&this._checkIsCardValid(j.template)){var l={async:true,name:j.template,componentData:{model:i,modelName:j.model,i18n:k,cardId:j.id,settings:j.settings,appComponent:this.getOwnerComponent(),mainComponent:this}};var X=this.getGlobalFilter();if(j.errorReason){l.componentData.errorReason=j.errorReason;}if(X){l.componentData.globalFilter={getUiState:X.getUiState.bind(X)};}var Y=e;sap.ui.component(l).then(function(Z){var $=Y.byId(Z.getComponentData().cardId);$.setPropagateModel(true);var _=$.getComponentInstance();$.setComponent(Z);if(_){setTimeout(function(){_.destroy();},0);}});}else{G.error("Could not create Card from '"+j.template+"' template. Card is not valid.");}},createErrorCard:function(e,i){var j=Q.extend(true,{},e,{template:"sap.ovp.cards.error"});j.errorReason=Q.extend({},i);j.settings.oldTemplate=e.template;j.settings.template="sap.ovp.cards.error";this._createCardComponent(this.getView(),undefined,j);},createCard:function(e){var i=this.getView();var j=i.getModel(e.model);Promise.all([j.getMetaModel().loaded(),this.oGlobalFilterLoadedPromise,this.oLoadedComponents[e.template]]).then(function(){this._createCardComponent(i,j,e);}.bind(this),function(k){G.error("Can't load card with id:'"+e.id+"' and type:'"+e.template+"', reason:"+k);});},_getCardId:function(e){var i=this.getView().getId()+"--";if(e.indexOf(i)!=-1){var j=e.indexOf(i)+i.length;return e.substr(j);}return e;},_initFlexibilityPersonalization:function(){this.oFlexibilityPersonalizationPromise=new Promise(function(e,i){var l=this.getLayout();this.oFlexController=s.createForControl(l);this.oFlexController.getComponentChanges().then(function(j){this.deltaChanges=j;if(j.length>0){this.bDeltaChangesEnabled=true;}e();}.bind(this),function(j){e();});}.bind(this));},layoutChanged:function(e){var j=e.getParameter("positionChanges");var k=[],l=[];var X,Y;if(this.getLayout().getMetadata().getName()==="sap.ovp.ui.DashboardLayout"){var Z=this.getLayout().dashboardLayoutUtil.dashboardLayoutModel.iColCount;if(j){for(var i=j.length-1;i>=0;i--){X=j[i];Y=X.content.cardId;if(X.content.dashboardLayout.oldRow===X.content.dashboardLayout.row&&X.content.dashboardLayout.oldColumn===X.content.dashboardLayout.column&&X.content.dashboardLayout.oldRowSpan===X.content.dashboardLayout.rowSpan&&X.content.dashboardLayout.oldColSpan===X.content.dashboardLayout.colSpan){continue;}if(l[Y]){l[Y].content.dashboardLayout.oldRow=X.content.dashboardLayout.oldRow;continue;}l[Y]=X;}Object.keys(l).forEach(function(_){var X=l[_];if(X.content.dashboardLayout.oldRow===X.content.dashboardLayout.row&&X.content.dashboardLayout.oldColumn===X.content.dashboardLayout.column&&X.content.dashboardLayout.oldRowSpan===X.content.dashboardLayout.rowSpan&&X.content.dashboardLayout.oldColSpan===X.content.dashboardLayout.colSpan){return;}k.push(l[_]);});k.forEach(function(X){var _=X.content.dashboardLayout;X.content.dashboardLayout={};X.content.dashboardLayout["C"+Z]=_;});}}else{var $=this.getLayout().getContent();this.aOrderedCards=this._getCardArrayAsVariantFormat($);k=j;}if(k.length>0){this.savePersonalization(k);}},saveVariant:function(e){var i=this;this.smartVariandManagement.getVariantsInfo(function(j){var k=null;if(j&&j.length>0){k=j[0].key;}var l=k!==null;var X={name:"Personalisation",global:false,overwrite:l,key:k,def:true};i.smartVariandManagement.fireSave(X);});},savePersonalization:function(e){var l=this.getLayout();var i=[],j=[],k=[];if(!Array.isArray(e)){e=[e];}e.forEach(function(X){var Y=X.content.cardId;X.jsOnly=true;i.push({selectorControl:this.getView().byId(Y),changeSpecificData:X});j.push(this.getView().byId(Y));k.push(X.changeType);}.bind(this));c.resetChanges(j,k).finally(function(){c.addPersonalizationChanges({controlChanges:i},true).then(function(i){c.saveChanges(i,l).then(function(){},function(){G.error("Personalization changes are not being saved by 'saveChanges' function");});},function(){G.error("Personalization changes are not being added by 'addPersonalizationChanges' function");});});},getLayout:function(){return this.getView()?this.getView().byId("ovpLayout"):null;},_initShowHideCardsButton:function(){var e=sap.ushell.Container.getRenderer("fiori2");if(e){var i={controlType:"sap.ushell.ui.launchpad.ActionItem",bCurrentState:false,oControlProperties:{icon:"sap-icon://dimension",text:y.getText("hideCardsBtn_title"),tooltip:y.getText("hideCardsBtn_title"),press:this._onManageCardsMenuButtonPress.bind(this)},bIsVisible:true,aStates:["app"]};e.addUserAction(i);}},createOrDestroyCards:function(e,k,l){var X=-1,Y=[],Z=[];for(var i=0;i<k.length;i++){if(e[i].id==k[i].id){X=i;}else{X=this.getCardIndexInArray(e,k[i].id);}var $=this.getView().byId(k[i].id);var _=$.getComponentInstance();if(l){if(_){_.destroy();}}if(k[i].visibility!=e[X].visibility||l){if(k[i].visibility===true){var a1=this._getCardFromManifest(k[i].id);Y.push({oCard:a1,sCreateOrDestroy:"create"});Z.push(a1);}else if(_){Y.push({oCard:_,sCreateOrDestroy:"destroy"});}}}var b1=this.fGetViewSwitchIndex(Z);if(Y&&Y.length>0){for(var j=0;j<Y.length;j++){if(Y[j]&&Y[j].oCard&&Y[j].hasOwnProperty("sCreateOrDestroy")&&Y[j].sCreateOrDestroy=="create"){var c1=Y[j].oCard;if(c1){c1.settings.baseUrl=this._getBaseUrl();this._clearStoredEntities();this._initCardModel(c1.model);c1=this._getTemplateForChart(c1);this._loadCardComponent(c1.template);this._createModelViewMap(c1);if(c1.settings.tabs){var d1=0;var e1=[];e1.push(c1);var f1=b1&&b1.hasOwnProperty(c1.id)?b1[c1.id]:"";var g1=this.getOrderedCardsSelectedKey(c1.id);if(f1&&typeof f1=="number"&&f1<=c1.settings.tabs.length&&f1!==g1){d1=f1>=1?f1-1:f1;this.setOrderedCardsSelectedKey(c1.id,f1);}else if(this.aOrderedCards[j].selectedKey&&c1.settings.tabs.length>=this.aOrderedCards[j].selectedKey){d1=this.aOrderedCards[j].selectedKey-1;}this.initializeTabbedCard(c1,d1);}this.createCard(c1);}}else if(Y[j]&&Y[j].oCard&&Y[j].hasOwnProperty("sCreateOrDestroy")&&Y[j].sCreateOrDestroy=="destroy"){Y[j].oCard.destroy();}}}},getCardIndexInArray:function(e,j){for(var i=0;i<e.length;i++){if(e[i].id==j){return i;}}return-1;},rerenderCards:function(e){var j=e;this.createOrDestroyCards.apply(this,[this.aOrderedCards,j,false]);this.aOrderedCards=j;this._updateDashboardLayoutCards(this.aOrderedCards);this._updateLayoutWithOrderedCards();this.savePersonalization(this.visibilityChanges);for(var i=0;i<this.aOrderedCards.length;i++){var k=this.aOrderedCards[i];var l=this.aErrorCards.indexOf(k.id);if(l>-1&&k.visibility==false){this.aErrorCards.splice(l,1);}}},_onManageCardsMenuButtonPress:function(){this.visibilityChanges=[];if(!this.manageCardsDialog){this.manageCardsDialog=sap.ui.xmlfragment("sap.ovp.app.ManageCard",this);}var l=this.getLayout().getMetadata().getName();var e;if(l==="sap.ovp.ui.DashboardLayout"){this._getCardArrayAsVariantFormatDashboard().done(function(j){e=Q.extend(true,[],j);var i=new J({cards:e});this.manageCardsDialog.setModel(i);this.getView().addDependent(this.manageCardsDialog);this.manageCardsDialog.open();}.bind(this));}else{e=Q.extend(true,[],this.aOrderedCards);var i=new J({cards:e});this.manageCardsDialog.setModel(i);this.getView().addDependent(this.manageCardsDialog);this.manageCardsDialog.open();}},onManagecardCancelButtonPressed:function(){this.manageCardsDialog.close();},onManageCardOkButtonPressed:function(){var e=this.manageCardsDialog.getModel().getProperty('/cards');this.createOrDestroyCards.apply(this,[this.aOrderedCards,e,false]);this.aOrderedCards=e;this._updateDashboardLayoutCards(this.aOrderedCards);this._updateLayoutWithOrderedCards();this.savePersonalization(this.visibilityChanges);this.manageCardsDialog.close();for(var i=0;i<this.aOrderedCards.length;i++){var j=this.aOrderedCards[i];var k=this.aErrorCards.indexOf(j.id);if(k>-1&&j.visibility==false){this.aErrorCards.splice(k,1);}}},onManageCardResetButtonPressed:function(){var l=this.getLayout().getMetadata().getName();M.show(y.getText("reset_cards_confirmation_msg"),{id:"resetCardsConfirmation",icon:M.Icon.QUESTION,title:y.getText("reset_cards_confirmation_title"),actions:[M.Action.OK,M.Action.CANCEL],onClose:function(e){if(e===M.Action.OK){this.manageCardsDialog.setBusy(true);this.createOrDestroyCards.apply(this,[this.aOrderedCards,this.aManifestOrderedCards,(l==="sap.ovp.ui.DashboardLayout")?true:false]);this.aOrderedCards=this.aManifestOrderedCards;this._resetDashboardLayout();this._updateDashboardLayoutCards(this.aOrderedCards);this._updateLayoutWithOrderedCards();this.oFlexController.getComponentChanges().then(function(i){this.oFlexController.discardChanges(i,true).then(function(){this.manageCardsDialog.setBusy(false);this.manageCardsDialog.close();}.bind(this),function(){this.manageCardsDialog.setBusy(false);this.manageCardsDialog.close();G.error("Discarding all personalization changes failed");}.bind(this));}.bind(this));}}.bind(this)});},afterManageCardsDialogOpen:function(){var l=this.getLayout().getMetadata().getName();var e=(l==="sap.ovp.ui.DashboardLayout")?true:this.isValidForReset();var j=this.manageCardsDialog.getButtons();var k;for(var i=0;i<j.length;i++){if(j[i].sId==='manageCardsResetBtn'){k=j[i];}}k.setEnabled(e);this.manageCardsDialog.setProperty('stretch',o.system.phone);},afterManageCardsDialogClose:function(){this.visibilityChanges=[];this.manageCardsDialog.close();},onAfterManageCardsTableUpdated:function(e){var j=e.oSource.mAggregations.items;if(j){for(var i=0;i<j.length;i++){if(!j[i].getCells()[1].getState()){j[i].addStyleClass('sapOVPHideCardsTableItem');j[i].getCells()[0].addStyleClass('sapOVPHideCardsDisabledCell');}}}setTimeout(function(){Q('.sapMListTblRow').first().focus();},200);},onCardVisibilityChange:function(e){var i=e.oSource.getParent();i.toggleStyleClass('sapOVPHideCardsTableItem');i.getCells()[0].toggleStyleClass('sapOVPHideCardsDisabledCell');var j=e.getSource().getBindingContext().getObject();var k;this.visibilityChanges.forEach(function(l,X){if(l.content.cardId===j.id){k=X;}});if(k&&k>-1){this.visibilityChanges.splice(k,1);}else{this.visibilityChanges.push({changeType:"visibility",content:{cardId:j.id,visibility:e.getParameter("state")},isUserDependent:true});}},cardTitleFormatter:function(i){var e=this._getCardFromManifest(i);if(e){var j=e.settings;return j.title||j.category||j.subTitle;}return i;},isValidForReset:function(){for(var i=0;i<this.aManifestOrderedCards.length;i++){if(this.aManifestOrderedCards[i].id!==this.aOrderedCards[i].id||this.aManifestOrderedCards[i].visibility!==this.aOrderedCards[i].visibility){return true;}}return false;},isDragAndDropEnabled:function(){return!o.system.phone;},getGlobalFilter:function(){if(!this.oGlobalFilter){this.oGlobalFilter=this.getView().byId("ovpGlobalFilter");}return this.oGlobalFilter;},getUIModel:function(){if(!this.oUIModel){var e=this.getOwnerComponent();this.oUIModel=e&&e.getModel("ui");}return this.oUIModel;},_parseNavigationVariant:function(){if(!this.oContainer){this.oParseNavigationPromise=Q.Deferred().resolve();return;}this.oParseNavigationPromise=this.oNavigationHandler.parseNavigation();},_setUiStateToGlobalFilter:function(e,i,j){var k=this.getGlobalFilter();var l=new U({selectionVariant:e.toJSONObject()});k.setUiState(l,{replace:j,strictMode:false});i=i.concat(e.getParameterNames().concat(e.getSelectOptionsPropertyNames()));i=i.filter(function(X,Y,Z){return Z.indexOf(X)==Y;});return i;},_processModifyStartupExtension:function(e){if(!e){e=[];}var i=this.getGlobalFilter();var j=i.getUiState();var k=new d(j.getSelectionVariant());var l=JSON.parse(JSON.stringify(k));return new Promise(function(X,Y){Promise.all([this.modifyStartupExtension(k),this.templateBaseExtension.provideStartupExtension(k)]).then(function(){if(JSON.stringify(k)!==JSON.stringify(l)){try{e=this._setUiStateToGlobalFilter(k,e,true);}catch(Z){G.error("Error with modifyStartupExtension, falling back to default behavior"+Z);e=this._setUiStateToGlobalFilter(l,e,true);}}X(e);}.bind(this));}.bind(this));},_addFieldsToSFBAdvancedArea:function(e){var l;var i=this.getGlobalFilter();if(e&&e.length>0){l=e.length;while(l--){i.addFieldToAdvancedArea(e[l]);}}},_restoreAppState:function(e){this.restoreCustomAppStateDataExtension(e._CUSTOM);var i=e._EXTENSION;if(!i){return;}var j=true;var k=function(l){if(!(l instanceof A)){throw new Error("State must always be retrieved with respect to a ControllerExtension");}var X=l.getMetadata().getNamespace();if(!j){throw new Error("State must always be restored synchronously");}return i[X];};this.templateBaseExtension.restoreExtensionAppStateData(k);j=false;},_setNavigationVariantToGlobalFilter:function(e,j,k){return new Promise(function(l,X){var Y=this.getGlobalFilter();if(!Y){return;}switch(k){case"iAppState":if(e.selectionVariant){var Z,$,_,a1=false;var b1,c1,d1,e1;var f1,g1,h1;Y.clearVariantSelection();Z=JSON.parse(e.selectionVariant);Y.setCurrentVariantId(Z.SelectionVariantID);g1=Y.getUiState({allFilters:false});c1=g1&&JSON.stringify(g1.getSelectionVariant());e1=Y.getFilterData()._CUSTOM;e1=((typeof e1=='undefined')?{}:e1);f1=new U({selectionVariant:e.oSelectionVariant.toJSONObject()});Y.setUiState(f1,{replace:true,strictMode:false});$=new d(e.selectionVariant);_=$.getParameterNames().concat($.getSelectOptionsPropertyNames());for(var i=0;i<_.length;i++){Y.addFieldToAdvancedArea(_[i]);}h1=Y.getUiState({allFilters:false});b1=h1&&JSON.stringify(h1.getSelectionVariant());if(c1!==b1){a1=true;}if(e.customData&&Object.keys(e.customData).length>0){var d1=e.customData;this._restoreAppState(d1);if(JSON.stringify(e1)!==JSON.stringify(d1)){a1=true;}}Y.getSmartVariant().currentVariantSetModified(a1);Y._updateToolbarText();}l();break;case"xAppState":case"URLParams":var i1=[];var j1=new d(e.oSelectionVariant.toJSONObject());var k1=new d(e.oDefaultedSelectionVariant.toJSONObject());if(!e.bNavSelVarHasDefaultsOnly&&!j1.isEmpty()){Y.clearVariantSelection();Y.clear();i1=this._setUiStateToGlobalFilter(j1,i1,true);}if(e.bNavSelVarHasDefaultsOnly&&!k1.isEmpty()&&Y.getCurrentVariantId()===""){Y.clear();i1=this._setUiStateToGlobalFilter(k1,i1,true);}if(Y.getCurrentVariantId()!==""){this._setDisplayCurrency(k1);}Promise.resolve(this._processModifyStartupExtension(i1)).then(function(i1){this._addFieldsToSFBAdvancedArea(i1);l();}.bind(this));break;case"initial":Promise.resolve(this._processModifyStartupExtension()).then(function(i1){this._addFieldsToSFBAdvancedArea(i1);l();}.bind(this));break;default:break;}}.bind(this));},_setDisplayCurrency:function(e){var i=this.getGlobalFilter();if(!i){return;}var l,j;var k=i.getAnalyticalParameters();if(k&&k.length>0){l=k.length;while(l--){if((k[l].name==="P_DisplayCurrency")||(k[l].name==="DisplayCurrency")){j=k[l];break;}}}if(!j){return;}var X=i.getFilters([j.fieldName]);var Y=X&&X[0]&&X[0].oValue1;if(Y&&Y!==" "){return;}var Z,$;if(j.name.indexOf("P_")===0){$=j.name;Z=j.name.substr(2);}else{$="P_"+j.name;Z=j.name;}if(e&&!e.isEmpty()){var _;Y=e.getParameter(Z);if(!Y||Y===" "){Y=e.getParameter($);}if(!Y||Y===" "){_=e.getSelectOption(Z);Y=_&&_[0]&&_[0].Low;}if(!Y||Y===" "){_=e.getSelectOption($);Y=_&&_[0]&&_[0].Low;}}if(!Y||Y===" "){Y=j.defaultPropertyValue;}if(!Y||Y===" "){return;}var a1=new d();a1.addParameter(j.name,Y);var b1=new U({selectionVariant:a1.toJSONObject()});i.setUiState(b1,{replace:false,strictMode:false});},_getCustomAppState:function(){var e={},i={};this.getCustomAppStateDataExtension(e);if(!(Q.isEmptyObject(e))){i[R]=e;}var j;var k=true;var l=function(X,Y){if(!(X instanceof A)){throw new Error("State must always be set with respect to a ControllerExtension");}if(!k){throw new Error("State must always be provided synchronously");}if(Y){j=j||Object.create(null);var Z=X.getMetadata().getNamespace();j[Z]=Y;}};this.templateBaseExtension.provideExtensionAppStateData(l);k=false;if(j){i[W]=j;}return i;},onBeforeSFBVariantSave:function(){var e=this._getCustomAppState();this.getGlobalFilter().setFilterData({_CUSTOM:e[R],_EXTENSION:e[W]});},onAfterSFBVariantLoad:function(){var e=this.getGlobalFilter().getFilterData();if(e){this._restoreAppState(e);}},onAssignedFiltersChanged:function(e){if(e.getSource()&&this.getView().byId("ovpFilterText")){this.getView().byId("ovpFilterText").setText(e.getSource().retrieveFiltersWithValuesAsText());}},_CustomFilterField:function(e,i){for(var k in e){if(e.hasOwnProperty(k)){i[k]=e[k];}}},_getCurrentAppState:function(){var e=this.getGlobalFilter();if(!e){return;}var i={};var j=this._getCustomAppState();var k={_CUSTOM:j[R],_EXTENSION:j[W]};if(k._CUSTOM){this._CustomFilterField(k._CUSTOM,i);}if(k._EXTENSION){var l=Object.keys(k._EXTENSION);if(l){this._CustomFilterField(k._EXTENSION[l],i);}}if(!Q.isEmptyObject(i)){var X=this.getGlobalFilter().getFilterData();X._CUSTOM=i;this.getGlobalFilter().setFilterData(X,true);}var Y=e.getUiState({allFilters:false});var Z=Y&&Y.getSelectionVariant();if(e.getSmartVariant().currentVariantGetModified()){Z.SelectionVariantID="";}var $=Z&&JSON.stringify(Z);var _=new d($);return{selectionVariant:_.toJSONString(),customData:k};},_storeCurrentAppStateAndAdjustURL:function(e){if(e&&!e.oSource._bDirtyViaDialog){return;}if(!this.bGlobalFilterLoaded){return;}if(!this.oNavigationHandler){return;}if(this.oAppStatePromise){this.rejectPreviousPromise&&this.rejectPreviousPromise("skip");}this.oAppStatePromise=new Promise(function(k,l){this.rejectPreviousPromise=l;var X=this._getCurrentAppState();var Y=this.oNavigationHandler.storeInnerAppStateWithImmediateReturn(X);Y.promise.then(function(Z){k(Z);},function(Z){l(Z.getErrorCode());});}.bind(this));var i=function(k){this.oAppStatePromise=null;if(k&&k.length>0){this.oNavigationHandler.replaceHash(k);return;}throw"AppState key is empty";};var j=function(k){this.oAppStatePromise=null;if(k==="skip"){throw k;}throw("Something went wrong while storing AppState - "+k);};this.oAppStatePromise.then(i.bind(this),j.bind(this)).catch(function(k){if(k==="skip"){return;}G.error(k);});}});});

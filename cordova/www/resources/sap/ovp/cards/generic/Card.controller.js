sap.ui.define(["sap/ui/core/mvc/Controller","sap/ovp/cards/ActionUtils","sap/ui/generic/app/navigation/service/SelectionVariant","sap/ui/generic/app/navigation/service/PresentationVariant","sap/ovp/cards/CommonUtils","sap/ovp/cards/OVPCardAsAPIUtils","sap/ui/core/ResizeHandler","sap/ui/core/format/NumberFormat","sap/ovp/cards/AnnotationHelper","sap/ui/model/odata/AnnotationHelper","sap/m/MessageBox","sap/ui/generic/app/navigation/service/NavError","sap/ui/core/CustomData","sap/ui/model/FilterOperator","sap/ui/model/json/JSONModel","sap/m/Dialog","sap/m/Button","sap/m/MessageToast","sap/ui/core/TextDirection","sap/ui/generic/app/library","sap/ui/thirdparty/jquery","sap/ovp/app/resources","sap/ovp/app/OVPUtils","sap/base/Log","sap/ui/events/KeyCodes","sap/base/util/merge","sap/base/util/isPlainObject"],function(C,A,S,P,a,O,R,N,b,c,M,d,e,F,J,D,B,f,T,G,q,g,h,L,K,m,k){"use strict";return C.extend("sap.ovp.cards.generic.Card",{initKeyboardNavigation:function(){var j=function(i){this.init(i);};j.prototype.layoutItemFocusHandler=function(){var l=q(document.activeElement);if(l){var n=l.find("[aria-label]");var i,s="";if(l.find('.valueStateText').length==1){var t=l.find('.valueStateText').find('.sapMObjectNumberText').text();var v=l.find('.valueStateText').find('.sapUiInvisibleText').text();l.find('.valueStateText').attr('aria-label',t+" "+v);l.find('.valueStateText').attr('aria-labelledby',"");}l.find("[role='listitem']").attr('aria-label',"");if(l.hasClass('sapOvpCardHeader')&&!l.hasClass('sapOvpStackCardContent')){var o="";var p=l.find('.cardHeaderType');if(p.length===0){var r=g.getText("CardHeaderType");o="cardHeaderType_"+new Date().getTime();var u='<div id="'+o+'" class="cardHeaderType" aria-label="'+r+'" hidden></div>';l.append(u);}else{o=p[0].id;}s+=o+" ";}for(i=0;i<n.length;i++){if(n[i].getAttribute("role")==="heading"){s+=n[i].id+" ";}}if(l.hasClass('sapOvpCardHeader')){var w=l.find('.cardHeaderText');if(w.length!==0){for(var i=0;i<w.length;i++){if(s.indexOf(w[i].id)===-1){s+=w[i].id+" ";}}}}if(s.length){l.attr("aria-labelledby",s);}if(l.prop('nodeName')==="LI"&&l.find('.linkListHasPopover').length!==0){if(l.find('#hasDetails').length===0){l.append("<div id='hasDetails' hidden>"+g.getText("HAS_DETAILS")+"</div>");l.attr('aria-describedby',"hasDetails");}}var x=l.attr("id");if((x&&x.indexOf("ovpTable")!=-1)&&l.find("[role='Link']")&&!l.hasClass('sapUiCompSmartLink')){var y=l.closest("td").attr("data-sap-ui-column"),z=l.closest("tbody").siblings().children().filter("tr").children();for(var i=0;i<z.length;i++){if(z[i].getAttribute("data-sap-ui")==y&&z[i].hasChildNodes("span")){var E=z[i].firstElementChild.getAttribute("id");l.attr("aria-labelledby",E);}}}}};j.prototype.init=function(i){this.cardLayout=i;this.keyCodes=K;this.jqElement=q(i.getView().$());this.jqElement=this.jqElement.parent().parent().parent();this.jqElement.on("focus.keyboardNavigation",this.layoutItemFocusHandler.bind(this));};this.keyboardNavigation=new j(this);},onInit:function(){this.oCardComponent=this.getOwnerComponent();this.oCardComponentData=this.oCardComponent&&this.oCardComponent.getComponentData();this.oMainComponent=this.oCardComponentData&&this.oCardComponentData.mainComponent;this.sCardId=this.oCardComponentData.cardId;var s=this.getView().mPreprocessors.xml[0].ovpCardProperties.oData.state;if(s!=="Error"){var H=this.getView().byId("ovpCardHeader");if(!!H){H.attachBrowserEvent("click",this.onHeaderClick.bind(this));H.addEventDelegate({onkeydown:function(E){if(!E.shiftKey&&E.keyCode==13){E.preventDefault();this.onHeaderClick(E);}else if(!E.shiftKey&&E.keyCode==32){E.preventDefault();}}.bind(this)});H.addEventDelegate({onkeyup:function(E){if(!E.shiftKey&&E.keyCode==32){E.preventDefault();this.onHeaderClick(E);}}.bind(this)});}}var n=this.getView().byId("kpiNumberValue");if(n){n.addEventDelegate({onAfterRendering:function(){var $=n.$();var i=$.find(".sapMNCValueScr");var j=$.find(".sapMNCScale");i.attr("aria-label",i.text());j.attr("aria-label",j.text());var l=this.getView().byId("ovpCardHeader").getDomRef();var o=this.getOwnerComponent().getComponentData();if(!!o&&!!o.appComponent){var p=o.appComponent;if(!!p.getModel("ui")){var u=p.getModel("ui");if(!!u.getProperty("/containerLayout")&&u.getProperty("/containerLayout")==="resizable"){var r=o.appComponent.getDashboardLayoutUtil();if(!!r){r.setKpiNumericContentWidth(l);}}}}}.bind(this)});}},exit:function(){if(this.resizeHandlerId){R.deregister(this.resizeHandlerId);}},onAfterRendering:function(){var o=this.getCardPropertiesModel();this.enableClick=true;var s=o.getProperty("/contentFragment");var i=this.getOwnerComponent().getComponentData();this._handleCountHeader();this._handleKPIHeader();var j=o.getProperty("/selectedKey");if(j&&o.getProperty("/state")!=='Loading'){var l=this.getView().byId("ovp_card_dropdown");if(l){l.setSelectedKey(j);}}try{var i=this.getOwnerComponent().getComponentData();if(i&&i.appComponent){var n=i.appComponent;if(n.getModel('ui')){var u=n.getModel('ui');if(u.getProperty('/containerLayout')==='resizable'){var p=n.getDashboardLayoutUtil();if(p){this.oDashboardLayoutUtil=p;this.cardId=i.cardId;if(p.isCardAutoSpan(i.cardId)){this.resizeHandlerId=R.register(this.getView(),function(X){L.info('DashboardLayout autoSize:'+X.target.id+' -> '+X.size.height);p.setAutoCardSpanHeight(X);});}}}}}}catch(r){L.error("DashboardLayout autoSpan check failed.");}if(this.oDashboardLayoutUtil&&this.oDashboardLayoutUtil.isCardAutoSpan(this.cardId)){var $=q("#"+this.oDashboardLayoutUtil.getCardDomId(this.cardId));if(this.oView.$().outerHeight()>$.innerHeight()){this.oDashboardLayoutUtil.setAutoCardSpanHeight(null,this.cardId,this.oView.$().height());}}var I=0;if(i&&i.mainComponent){var t=i.mainComponent;if(t.bGlobalFilterLoaded){I=this.checkNavigation();}}else if(O.checkIfAPIIsUsed(this)){I=this.checkAPINavigation();}var v=this.getCardPropertiesModel();var w=v.getProperty("/state");if(w!=="Loading"&&w!=="Error"){var x=v.getProperty("/template");if(x==="sap.ovp.cards.stack"){if(!I){var y=this.getView().byId('ViewAll');if(y){y=y.getDomRef();q(y).remove();}}}}if(I){if(s?s!=="sap.ovp.cards.quickview.Quickview":true){if(s==="sap.ovp.cards.stack.Stack"){var z=this.getView().getDomRef();var E=q(z).find('.sapOvpCardContentRightHeader');if(E.length!==0){E.addClass('sapOvpCardNavigable');}}else{this.getView().addStyleClass("sapOvpCardNavigable");}}if(s&&s==="sap.ovp.cards.quickview.Quickview"){var H=this.byId("ovpCardHeader");if(H){H.addStyleClass("sapOvpCardNavigable");}}}else{if(s){this.getView().addStyleClass("ovpNonNavigableItem");var H=this.byId("ovpCardHeader");if(H){H.$().removeAttr('role');H.addStyleClass('ovpNonNavigableItem');}var Q=this.checkLineItemNavigation();if(!Q){switch(s){case"sap.ovp.cards.list.List":var U=this.getView().byId("listItem");if(U){U.setType("Inactive");}break;case"sap.ovp.cards.table.Table":var U=this.getView().byId("tableItem");if(U){U.setType("Inactive");}break;case"sap.ovp.cards.linklist.LinkList":if(!this.checkNavigationForLinkedList()){var U=this.getView().byId("ovpCLI");if(U){U.setType("Inactive");}}break;}}}}var V=this.getView().byId("ovp_card_dropdown");var W=this.getView().byId("ovp_card_dropdown_label");if(V){V.addAriaLabelledBy(W.getId());}if(O.checkIfAPIIsUsed(this)){this.initKeyboardNavigation();}},checkNavigation:function(){var o=this.getCardPropertiesModel();if(this.checkHeaderNavForChart()){return 0;}var E=this.getEntityType();if(E){if(o){var i=o.getProperty("/identificationAnnotationPath");var s=i;var j=o.getProperty("/contentFragment");if(j&&(j==="sap.ovp.cards.stack.Stack"||j==="sap.ovp.cards.quickview.Quickview")){var l=(i)?i.split(","):[];if(l&&l.length>1){if(j==="sap.ovp.cards.stack.Stack"){s=l[0];}else{s=l[1];}}}var r=E[s];if(this.isNavigationInAnnotation(r)){return 1;}if(o&&o.getProperty("/template")==="sap.ovp.cards.charts.analytical"){var n=o.getProperty("/kpiAnnotationPath");if(E&&n){var p=E[n];if(p&&p.Detail){var t=p.Detail.SemanticObject&&p.Detail.SemanticObject.String;var u=p.Detail.Action&&p.Detail.Action.String;if(t&&u){return 1;}}}}}}else if(o&&o.getProperty("/template")==="sap.ovp.cards.linklist"&&o.getProperty("/staticContent")&&o.getProperty("/targetUri")){return 1;}return 0;},checkNavigationForLinkedList:function(){if(this.getEntityType()){var E=this.getEntityType();var l=E['com.sap.vocabularies.UI.v1.LineItem'];if(l&&(l[0].RecordType==="com.sap.vocabularies.UI.v1.DataFieldForAction"||l[0].RecordType==="com.sap.vocabularies.UI.v1.DataFieldWithUrl")){return true;}}return false;},checkLineItemNavigation:function(){if(this.getEntityType()){var E=this.getEntityType();var o=this.getCardPropertiesModel();if(o){var s=o.getProperty("/annotationPath");var r=E[s];return this.isNavigationInAnnotation(r);}}},isNavigationInAnnotation:function(r){if(r&&r.length){for(var i=0;i<r.length;i++){var I=r[i];if(I.RecordType==="com.sap.vocabularies.UI.v1.DataFieldForIntentBasedNavigation"||I.RecordType==="com.sap.vocabularies.UI.v1.DataFieldForAction"||I.RecordType==="com.sap.vocabularies.UI.v1.DataFieldWithUrl"){return 1;}}}return 0;},checkAPINavigation:function(){var o=this.getOwnerComponent().getComponentData(),i=o.fnCheckNavigation&&typeof o.fnCheckNavigation==="function",j=i?o.fnCheckNavigation:null;if(j){if(j()){return true;}}else{if(this.checkNavigation()){return true;}}return false;},onHeaderClick:function(E){var n=E.ctrlKey||E.metaKey?h.constants.explace:h.constants.inplace;if(O.checkIfAPIIsUsed(this)){if(this.checkAPINavigation()){a.onHeaderClicked();}}else{var o=this.getCardPropertiesModel();var t=o.getProperty("/template");var s=o.getProperty("/targetUri");if(t=="sap.ovp.cards.linklist"&&o.getProperty("/staticContent")!==undefined&&s){window.location.href=s;}else if(o.getProperty("/staticContent")!==undefined&&s===""){return;}else if(this.checkHeaderNavForChart()){return;}else{this.doNavigation(this.getView().getBindingContext(),null,n);}}},checkHeaderNavForChart:function(){var o=this.getCardPropertiesModel();var t=o.getProperty("/template");var n=o.getProperty("/navigation");if(n=="noHeaderNav"&&(t=="sap.ovp.cards.charts.analytical"||"sap.ovp.cards.charts.smart.chart")){return true;}else{return false;}},resizeCard:function(i){L.info(i);if(this.resizeHandlerId){R.deregister(this.resizeHandlerId);this.resizeHandlerId=null;}},_handleCountHeader:function(){var i=this.getView().byId("ovpCountHeader");if(i){var I=this.getCardItemsBinding();if(I){this.setHeaderCounter(I,i);I.attachDataReceived(function(){this.setHeaderCounter(I,i);}.bind(this));I.attachChange(function(){this.setHeaderCounter(I,i);}.bind(this));}}},setHeaderCounter:function(i,j){var t=i.getLength();var l=i.getCurrentContexts().length;var o,n="";var p=N.getIntegerInstance({minFractionDigits:0,maxFractionDigits:1,decimalSeparator:".",style:"short"});l=parseFloat(l,10);var r=this.getOwnerComponent().getComponentData();if(r&&r.appComponent){var s=r.appComponent;if(s.getModel('ui')){var u=s.getModel('ui');if(u.getProperty('/containerLayout')!=='resizable'){if(t!==0){t=p.format(Number(t));}if(l!==0){l=p.format(Number(l));}}else{o=s.getDashboardLayoutUtil().dashboardLayoutModel.getCardById(r.cardId);}}}if(l===0){n="";}else if(o&&o.dashboardLayout.showOnlyHeader){n=g.getText("Count_Header_Total",[t]);}else if(t!=l){n=g.getText("Count_Header",[l,t]);}j.setText(n);var v=j.$();v.attr("aria-label",n);},_handleKPIHeader:function(){var i,s;if(this.getView()&&this.getView().getDomRef()){i=this.getView().getDomRef().getElementsByClassName("numericContentHbox");s=this.getView().getDomRef().getElementsByClassName("noDataSubtitle");}else{return;}if(i||s){var o=this.getKPIBinding();if(o){o.attachDataReceived(function(E){var U=E.getParameter("data")&&E.getParameter("data").results&&E.getParameter("data").results[0];var t=o.getLength();if(i[0]){i[0].style.visibility=null;if(t===0){i[0].style.visibility='hidden';}else{this._setSubTitleWithUnitOfMeasure(U);i[0].style.visibility='visible';}}if(s.length!==0){s[0].style.display="none";if(t===0){s[0].style.display="flex";}}}.bind(this));}}},getKPIBinding:function(){var n=this.byId("kpiHBoxNumeric"),o=n&&n.getBindingInfo("items")&&n.getBindingInfo("items").binding;return o;},_setSubTitleWithUnitOfMeasure:function(U){var o=this.getCardPropertiesModel();if(!!o){var i=o.getData();var s=this.getView().byId("SubTitle-Text");if(!!s){s.setText(i.subTitle);if(!!i&&!!i.entityType&&!!i.dataPointAnnotationPath){var E=o.getData().entityType;var j=i.dataPointAnnotationPath.split("/");var l=j.length===1?E[i.dataPointAnnotationPath]:E[j[0]][j[1]];var n;if(l&&l.Value&&l.Value.Path){n=l.Value.Path;}else if(l&&l.Description&&l.Description.Value&&l.Description.Value.Path){n=l.Description.Value.Path;}if(!!n){var p=a.getUnitColumn(n,E);var u;if(!!p&&!!U){u=U[p];}else{u=a.getUnitColumn(n,E,true);}var r=g.getText("SubTitle_IN");if(!!i.subTitle&&!!r&&!!u){s.setText(i.subTitle+" "+r+" "+u);var t=s.getAggregation("customData");if(t){var v;for(v in t){var w=t[v];if(w.getKey()==="aria-label"){w.setValue(i.subTitle+" "+r+" "+u);break;}}}}}}}}},getCardItemsBinding:function(){},onActionPress:function(E){var s=E.getSource(),o=this._getActionObject(s),i=s.getBindingContext();if(o.type.indexOf("DataFieldForAction")!==-1){this.doAction(i,o);}else{this.doNavigation(i,o);}},_getActionObject:function(s){var j=s.getCustomData();var o={};for(var i=0;i<j.length;i++){o[j[i].getKey()]=j[i].getValue();}return o;},doNavigation:function(o,n,s){if(!s){s=h.constants.inplace;}if(!this.enableClick){return;}this.enableClick=false;setTimeout(function(){this.enableClick=true;}.bind(this),1000);if(!this.oMainComponent){return;}if(!n){n=this.getEntityNavigationEntries(o)[0];}var i=q.extend(true,{},o);var j=q.extend(true,{},n);var l=this.oMainComponent.doCustomNavigation&&this.oMainComponent.doCustomNavigation(this.sCardId,i,j);var E=this.oMainComponent.templateBaseExtension&&this.oMainComponent.templateBaseExtension.provideExtensionNavigation&&this.oMainComponent.templateBaseExtension.provideExtensionNavigation(this.sCardId,i,j);var p;if(l){p=l;}if(E){p=E;}if(p){var t=p.type;if(t&&typeof t==="string"&&t.length>0){t=t.split(".").pop().split("/").pop().toLowerCase();switch(t){case"datafieldwithurl":p.type="com.sap.vocabularies.UI.v1.DataFieldWithUrl";break;case"datafieldforintentbasednavigation":p.type="com.sap.vocabularies.UI.v1.DataFieldForIntentBasedNavigation";break;}n=p;}}function r(s){if(!s){s=h.constants.inplace;}if(n){switch(n.type){case"com.sap.vocabularies.UI.v1.DataFieldWithUrl":this.doNavigationWithUrl(o,n,s);break;case"com.sap.vocabularies.UI.v1.DataFieldForIntentBasedNavigation":this.doIntentBasedNavigation(o,n,false,s);break;case"com.sap.vocabularies.UI.v1.KPIDetailType":this.doIntentBasedNavigation(o,n,false,s);break;}}}if(!this.oMainComponent.oAppStatePromise){r.call(this,s);}else{this.oMainComponent.oAppStatePromise.then(r.bind(this,s));}},doNavigationWithUrl:function(o,n,s){if(!s){s=h.constants.inplace;}if(!sap.ushell.Container){return;}var p=sap.ushell.Container.getService("URLParsing");if(!(p.isIntentUrl(n.url))){window.open(n.url);}else{var i=p.parseShellHash(n.url);var w=i.appSpecificRoute?true:false;this.doIntentBasedNavigation(o,i,w,s);}},fnHandleError:function(E){if(E instanceof d){if(E.getErrorCode()==="NavigationHandler.isIntentSupported.notSupported"){M.show(g.getText("OVP_NAV_ERROR_NOT_AUTHORIZED_DESC"),{title:g.getText("OVP_GENERIC_ERROR_TITLE")});}else{M.show(E.getErrorCode(),{title:g.getText("OVP_GENERIC_ERROR_TITLE")});}}},doCrossApplicationNavigation:function(I,n){var s="#"+I.semanticObject+'-'+I.action;if(I.params){var o=this.oCardComponent&&this.oCardComponent.getComponentData();var l=o&&o.appComponent;if(l){var p=l._formParamString(I.params);s=s+p;}}var t=this;if(!sap.ushell.Container){return;}sap.ushell.Container.getService("CrossApplicationNavigation").isIntentSupported([s]).done(function(r){if(r[s].supported===true){if(!!n.params){if(typeof n.params=='string'){try{n.params=JSON.parse(n.params);}catch(u){L.error("Could not parse the Navigation parameters");return;}}}var o=t.getOwnerComponent().getComponentData();var v=o?o.globalFilter:undefined;var U=v&&v.getUiState({allFilters:false});var w=U?JSON.stringify(U.getSelectionVariant()):"{}";v=q.parseJSON(w);var x=t._getFilterPreference();v=t._removeFilterFromGlobalFilters(x,v);if(!n.params){n.params={};}if(!!v&&!!v.SelectOptions){for(var i=0;i<v.SelectOptions.length;i++){var y=v.SelectOptions[i].Ranges;if(!!y){var z=[];for(var j=0;j<y.length;j++){if(y[j].Sign==="I"&&y[j].Option==="EQ"){z.push(y[j].Low);}}n.params[v.SelectOptions[i].PropertyName]=z;}}}sap.ushell.Container.getService("CrossApplicationNavigation").toExternal(n);}else{var E=new d("NavigationHandler.isIntentSupported.notSupported");t.fnHandleError(E);}}).fail(function(){L.error("Could not get authorization from isIntentSupported");});},doIntentBasedNavigation:function(o,i,u,n){if(!n){n=h.constants.inplace;}if(sap.ushell&&!sap.ushell.Container){return;}var p,j,l,E=o?o.getObject():null;var r=this.getCardPropertiesModel(),s=r.getProperty("/customParams");if(o&&typeof o.getAllData==="function"&&s){l=o.getAllData();}else if(r.getProperty("/staticContent")){l={iStaticLinkListIndex:i.iStaticLinkListIndex,bStaticLinkListIndex:true};}if(E&&E.__metadata){delete E.__metadata;}var t=a.getNavigationHandler();if(t){if(i){p=this._getEntityNavigationParameters(E,l,o);j={target:{semanticObject:i.semanticObject,action:i.action},appSpecificRoute:i.appSpecificRoute,params:p.sNavSelectionVariant};var v={};if(p.sNavPresentationVariant){v.presentationVariant=p.sNavPresentationVariant;}if(u){if(i&&i.semanticObject&&i.action){var w=this.getCardPropertiesModel().getProperty("/staticParameters");j.params=(!!w)?w:{};this.doCrossApplicationNavigation(i,j);}}else{t.navigate(j.target.semanticObject,j.target.action,j.params,null,this.fnHandleError,v,n);}}}},doAction:function(o,i){this.actionData=A.getActionInfo(o,i,this.getEntityType());if(this.actionData.allParameters.length>0){this._loadParametersForm();}else{this._callFunction();}},getEntityNavigationEntries:function(o,s){var n=[];var E=this.getEntityType();var j=this.getCardPropertiesModel();var l=j.getProperty("/template");if(!E){return n;}if(!s&&!o){if(!this.oCardComponentData.settings.identificationAnnotationPath){var p=j.getProperty("/kpiAnnotationPath");if(p&&l==="sap.ovp.cards.charts.analytical"){s=p;var r=E[s];var t=r&&r.Detail;var u=t.SemanticObject&&t.SemanticObject.String;var v=t.Action&&t.Action.String;if(t.RecordType==="com.sap.vocabularies.UI.v1.KPIDetailType"){if(u&&v){n.push({type:t.RecordType,semanticObject:u,action:v,label:""});}else{L.error("Invalid Semantic object and action configured for annotation "+t.RecordType);}}}}}if(!s){var I=j.getProperty("/identificationAnnotationPath");var w=(I)?I.split(","):[];if(w&&w.length>1){s=w[0];}else{s=I;}}var x=E[s];if(Array.isArray(x)){x=b.sortCollectionByImportance(x);for(var i=0;i<x.length;i++){if(x[i].RecordType==="com.sap.vocabularies.UI.v1.DataFieldForIntentBasedNavigation"){n.push({type:x[i].RecordType,semanticObject:x[i].SemanticObject.String,action:x[i].Action.String,label:x[i].Label?x[i].Label.String:null});}if(x[i].RecordType==="com.sap.vocabularies.UI.v1.DataFieldWithUrl"&&!x[i].Url.UrlRef){var y=this.getView().getModel();var z=y.oMetaModel;var H=z.createBindingContext(E.$path);var Q=c.format(H,x[i].Url);var U=new e({key:"url",value:Q});if(o&&l==="sap.ovp.cards.charts.analytical"){y=o.getModel();}U.setModel(y);U.setBindingContext(o);var V=U.getValue();n.push({type:x[i].RecordType,url:V,value:x[i].Value.String,label:x[i].Label?x[i].Label.String:null});}}}return n;},getModel:function(){return this.getView().getModel();},getMetaModel:function(){if(this.getModel()){return this.getModel().getMetaModel();}},getCardPropertiesModel:function(){if(!this.oCardPropertiesModel||q.isEmptyObject(this.oCardPropertiesModel)){this.oCardPropertiesModel=this.getView().getModel("ovpCardProperties");}return this.oCardPropertiesModel;},getEntitySet:function(){if(!this.entitySet){var E=this.getCardPropertiesModel().getProperty("/entitySet");this.entitySet=this.getMetaModel().getODataEntitySet(E);}return this.entitySet;},getEntityType:function(){if(!this.entityType){if(this.getMetaModel()&&this.getEntitySet()){this.entityType=this.getMetaModel().getODataEntityType(this.getEntitySet().entityType);}}return this.entityType;},getCardContentContainer:function(){if(!this.cardContentContainer){this.cardContentContainer=this.getView().byId("ovpCardContentContainer");}return this.cardContentContainer;},_processCustomParameters:function(o,s,j){var l=this.getCardPropertiesModel();if(!this.oMainComponent||!l){return;}var n;if(o&&o.bStaticLinkListIndex){var p=l.getProperty("/staticContent");n=p[o.iStaticLinkListIndex]["customParams"];o=null;}else{n=l.getProperty("/customParams");}if(!n||!this.oMainComponent.templateBaseExtension.provideCustomParameter||!this.oMainComponent.onCustomParams){return;}var r=this.oMainComponent.templateBaseExtension.provideCustomParameter(n)?this.oMainComponent.templateBaseExtension.provideCustomParameter(n):this.oMainComponent.onCustomParams(n);if(!r||!q.isFunction(r)){return;}var t=q.extend(true,{},o);var u=q.extend(true,{},s);var v=r(t,u);if(!v||(!Array.isArray(v)&&!k(v))){return;}var I=k(v);if(I&&q.isEmptyObject(v)){return;}var w=I&&(v.bIgnoreEmptyString||v.ignoreEmptyString);var x=I?(v.aSelectionVariant||v.selectionVariant):v;if(!Array.isArray(x)){return;}var i,y,z,E,V,H;y=x.length;for(i=0;i<y;i++){z=x[i];if(!z){continue;}E=z.path;V=z.value1;H=z.value2;if(!E||typeof E!=="string"||E===""){L.error("Custom Variant property path '"+E+"' should be valid string");continue;}if(!(V||V===0||(V===""&&w))){continue;}V=V.toString();H=H&&H.toString();if(V===""&&w){s.removeSelectOption(E);}if(o){delete o[E];}if(j){delete j[E];}s.addSelectOption(E,z.sign,z.operator,V,H);}if(w){this._removeEmptyStringsFromSelectionVariant(s);}return w;},_getEntityNavigationParameters:function(E,o,j){var l={};var s,p,n;var r=this.getOwnerComponent().getComponentData();var t=r?r.globalFilter:undefined;var u=this.getCardPropertiesModel();var v=u&&u.getProperty("/staticContent");if(!v){var w=b.getCardSelections(this.getCardPropertiesModel());var x=w.filters;var y=w.parameters;var z=this.getEntityType();x&&x.forEach(function(f1){f1.path=f1.path.replace("/",".");switch(f1.operator){case F.NE:f1.operator=F.EQ;f1.sign="E";break;case F.Contains:f1.operator="CP";var g1=f1.value1;f1.value1="*"+g1+"*";break;case F.EndsWith:f1.operator="CP";var g1=f1.value1;f1.value1="*"+g1;break;case F.StartsWith:f1.operator="CP";var g1=f1.value1;f1.value1=g1+"*";}});w.filters=x;if(j&&E&&E.hasOwnProperty("$isOthers")){var H=j.getOtherNavigationDimensions();for(var I in H){var Q=H[I];for(var i=0;i<Q.length;i++){w.filters.push({path:I,operator:"EQ",value1:Q[i],sign:"E"});}}}y&&y.forEach(function(f1){f1.path=f1.path.replace("/",".");});w.parameters=y;var U=b.getCardSorters(this.getCardPropertiesModel());if(E){var I;for(var i=0;z.property&&i<z.property.length;i++){I=z.property[i].name;var V=E[I];if(E.hasOwnProperty(I)){if(Array.isArray(E[I])&&E[I].length===1){l[I]=E[I][0];}else if(q.type(V)!=="object"){l[I]=V;}}}}var W=u&&u.getProperty("/kpiAnnotationPath");var X=u&&u.getProperty("/template");if(W&&X==="sap.ovp.cards.charts.analytical"){var Y=z[W];var Z=Y&&Y.Detail;if(Z&&Z.RecordType==="com.sap.vocabularies.UI.v1.KPIDetailType"){l["kpiID"]=Y.ID.String;}}p=U&&new P(U);s=this._buildSelectionVariant(t,w);n=u&&u.getProperty("/staticParameters");}else{var $=t&&t.getUiState({allFilters:false});var _=$?JSON.stringify($.getSelectionVariant()):"{}";s=new S(_);var a1=this._getFilterPreference();s=this._removeFilterFromGlobalFilters(a1,s);if(v[o.iStaticLinkListIndex].params){n=v[o.iStaticLinkListIndex].params;}else if(v[o.iStaticLinkListIndex].staticParameters){n=v[o.iStaticLinkListIndex].staticParameters;}}var b1;if(o&&!o.bStaticLinkListIndex){b1=this._processCustomParameters(o,s,l);}else if(o&&o.bStaticLinkListIndex){b1=this._processCustomParameters(o,s);}else{b1=this._processCustomParameters(l,s);}var c1=b1?G.navigation.service.SuppressionBehavior.ignoreEmptyString:undefined;if(n){for(var I in n){if(!l.hasOwnProperty(I)){l[I]=n[I];}}}var d1=a.getNavigationHandler();var e1=d1&&d1.mixAttributesAndSelectionVariant(l,s.toJSONString(),c1);if(!v){this._removeSensitiveAttributesFromNavSelectionVariant(z,e1);}return{sNavSelectionVariant:e1?e1.toJSONString():null,sNavPresentationVariant:p?p.toJSONString():null};},_removeSensitiveAttributesFromNavSelectionVariant:function(E,n){for(var i=0;i<E.property.length;i++){if(E.property[i]["com.sap.vocabularies.PersonalData.v1.IsPotentiallySensitive"]&&E.property[i]["com.sap.vocabularies.PersonalData.v1.IsPotentiallySensitive"].Bool){delete n._mSelectOptions[E.property[i].name];}}},_removeEmptyStringsFromSelectionVariant:function(s){var p=s.getParameterNames();for(var i=0;i<p.length;i++){if(s.getParameter(p[i])===""){s.removeParameter(p[i]);}}var l=s.getSelectOptionsPropertyNames();for(i=0;i<l.length;i++){var n=s.getSelectOption(l[i]);for(var j=0;j<n.length;j++){if(n[j].Low===""&&!n[j].High){n.splice(j,1);j--;}}if(n.length===0){s.removeSelectOption(l[i]);}}return s;},_checkIfCardFiltersAreValid:function(i,p){var j=true;if(i&&i.filterAll==="global"){j=false;}else if(i&&i.globalFilter){if(i.globalFilter.indexOf(p)>=0){j=false;}}return j;},_getFilterPreference:function(){var o=this.getOwnerComponent()?this.getOwnerComponent().getComponentData():null;var i;if(o&&o.mainComponent){i=o.mainComponent._getFilterPreference(o.cardId);}return i;},_removeFilterFromGlobalFilters:function(i,s){var j=[];if(i&&i.filterAll==="card"){j=s.getSelectOptionsPropertyNames();}else if(i&&i.cardFilter){j=i.cardFilter;}j.forEach(function(p){if(p!=="$.basicSearch"){s.removeSelectOption(p);}});return s;},_buildSelectionVariant:function(o,l){var u=o&&o.getUiState({allFilters:false});var s=u?JSON.stringify(u.getSelectionVariant()):"{}";var n=new S(s);var p,v,V,r;var t=this._getFilterPreference();n=this._removeFilterFromGlobalFilters(t,n);var w=l.filters;var x=l.parameters;for(var i=0;i<w.length;i++){p=w[i];if(p.path&&p.operator&&typeof p.value1!=="undefined"){v=p.value1.toString();V=(typeof p.value2!=="undefined")?p.value2.toString():undefined;if(this._checkIfCardFiltersAreValid(t,p.path)){n.addSelectOption(p.path,p.sign,p.operator,v,V);}}}var y,z,E;for(var j=0;j<x.length;j++){r=x[j];if(!r.path||!r.value){continue;}y=r.path.split("/").pop();y=y.split(".").pop();if(y.indexOf("P_")===0){z=y;E=y.substr(2);}else{z="P_"+y;E=y;}if(n.getParameter(z)){continue;}if(n.getParameter(E)){continue;}n.addParameter(y,r.value);}return n;},_loadParametersForm:function(){var p=new J();p.setData(this.actionData.parameterData);var t=this;var o=new D('ovpCardActionDialog',{title:this.actionData.sFunctionLabel,afterClose:function(){o.destroy();}}).addStyleClass("sapUiNoContentPadding");var i=new B({text:this.actionData.sFunctionLabel,press:function(E){var r=A.getParameters(E.getSource().getModel(),t.actionData.oFunctionImport);o.close();t._callFunction(r,t.actionData.sFunctionLabel);}});var j=new B({text:"Cancel",press:function(){o.close();}});o.setBeginButton(i);o.setEndButton(j);var l=function(E){var r=A.mandatoryParamsMissing(E.getSource().getModel(),t.actionData.oFunctionImport);i.setEnabled(!r);};var n=A.buildParametersForm(this.actionData,l);o.addContent(n);o.setModel(p);o.open();},_callFunction:function(u,i){var p={batchGroupId:"Changes",changeSetId:"Changes",urlParameters:u,forceSubmit:true,context:this.actionData.oContext,functionImport:this.actionData.oFunctionImport};var t=this;var o=new Promise(function(r,j){var l=t.actionData.oContext.getModel();var s;s="/"+p.functionImport.name;l.callFunction(s,{method:p.functionImport.httpMethod,urlParameters:p.urlParameters,batchGroupId:p.batchGroupId,changeSetId:p.changeSetId,headers:p.headers,success:function(n,v){r(v);},error:function(n){n.actionText=i;j(n);}});});o.then(function(r){return f.show(g.getText("Toast_Action_Success"),{duration:1000});},function(E){var j=a.showODataErrorMessages(E);if(j===""&&E.actionText){j=g.getText("Toast_Action_Error")+' "'+E.actionText+'"'+".";}return M.error(j,{title:g.getText("OVP_GENERIC_ERROR_TITLE"),onClose:null,styleClass:"",initialFocus:null,textDirection:T.Inherit});});},setErrorState:function(){var o=this.getOwnerComponent();if(!o||!o.oContainer){return;}var i=o.oContainer;var j=this.getCardPropertiesModel();var l={name:"sap.ovp.cards.loading",componentData:{model:this.getView().getModel(),settings:{category:j.getProperty("/category"),title:j.getProperty("/title"),description:j.getProperty("/description"),entitySet:j.getProperty("/entitySet"),state:h.loadingState.ERROR,template:j.getProperty("/template")}}};var n=sap.ui.component(l);i.setComponent(n);setTimeout(function(){o.destroy();},0);},changeSelection:function(s,i,o){if(!i){var j=this.getView().byId("ovp_card_dropdown");s=parseInt(j.getSelectedKey(),10);}var t={};if(!i){t=this.getCardPropertiesModel().getProperty("/tabs")[s-1];}else{t=o.tabs[s-1];}var u={cardId:this.getOwnerComponent().getComponentData().cardId,selectedKey:s};for(var p in t){u[p]=t[p];}if(O.checkIfAPIIsUsed(this)){O.recreateCard(u,this.getOwnerComponent().getComponentData());}else{this.getOwnerComponent().getComponentData().mainComponent.recreateCard(u);this.getOwnerComponent().getComponentData().mainComponent.setOrderedCardsSelectedKey(this.getOwnerComponent().getComponentData().cardId,s);}},getItemHeight:function(o,s,i){if(!!o){var j=o.getView().byId(s);var H=0;if(!!j){if(i){if(j.getItems()[0]&&j.getItems()[0].getDomRef()){H=q(j.getItems()[0].getDomRef()).outerHeight(true);}}else{if(j.getDomRef()){H=q(j.getDomRef()).outerHeight(true);}}}return H;}},getHeaderHeight:function(){var H=this.getItemHeight(this,'ovpCardHeader'),o=this.getOwnerComponent()?this.getOwnerComponent().getComponentData():null;if(o&&o.appComponent){var i=o.appComponent.getDashboardLayoutUtil(),j=i.getDashboardLayoutModel().getCardById(o.cardId);if(H!==0){j.dashboardLayout.headerHeight=H;}}return H;}});});

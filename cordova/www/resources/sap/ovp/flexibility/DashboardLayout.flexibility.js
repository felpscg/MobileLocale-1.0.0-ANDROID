sap.ui.define(["sap/ui/thirdparty/jquery","sap/ovp/flexibility/changeHandler/CardChangeHandler","sap/ovp/flexibility/changeHandler/RemoveCardContainer","sap/ui/dt/OverlayRegistry","sap/ui/core/ComponentContainer","sap/m/MessageToast","sap/ovp/cards/rta/SettingsDialogConstants","sap/ovp/cards/SettingsUtils","sap/ovp/cards/CommonUtils","sap/ovp/app/resources","sap/base/util/merge"],function(q,C,R,O,a,M,S,b,c,d,m){"use strict";return{"moveControls":{"changeHandler":"default","layers":{"CUSTOMER_BASE":true,"CUSTOMER":true,"USER":true}},"unhideControl":C.UnhideControlConfig,"unhideCardContainer":C.UnhideCardContainer,"hideCardContainer":C.HideCardContainer,"removeCardContainer":R,"editCardSettings":{changeHandler:{applyChange:function(o,e,p){var f=p.appComponent.getRootControl(),g=f.getController(),h=o.getContent(),i=h.newAppDescriptor,j=f.byId(i.id),k=g.getLayout(),l=k.getDashboardLayoutModel(),L=k.getDashboardLayoutUtil(),n=l.getCardById(i.id),r=L.calculateCardProperties(i.id),N=i.settings.defaultSpan&&i.settings.defaultSpan.rows,s=i.settings.defaultSpan&&i.settings.defaultSpan.cols,t=l.getColCount()+1,u=[],F=false;o.setRevertData(h.oldAppDescriptor);if(j){if(i.settings.tabs){var D=i.settings.selectedKey;if(!D||D<1){D=1;}S.tabFields.forEach(function(w){var x=i.settings.tabs[D-1][w];if(w!=='entitySet'||(w==='entitySet'&&x)){delete i.settings[w];}if(x){i.settings[w]=x;}});}if(typeof N==='number'){if(N===0){n.dashboardLayout.showOnlyHeader=true;N=Math.ceil((r.headerHeight+2*L.CARD_BORDER_PX)/L.getRowHeightPx());}else{n.dashboardLayout.showOnlyHeader=false;if(i.template==='sap.ovp.cards.list'||i.template==='sap.ovp.cards.table'){n.dashboardLayout.noOfItems=N;}}}if(s){if(n.dashboardLayout.column+s>t){n.dashboardLayout.maxColSpan=s;s=t-n.dashboardLayout.column;}F=true;}if(F){l._arrangeCards(n,{row:N,column:s},'resize',u);l._removeSpaceBeforeCard(u);L._positionCards(l.aCards);F=false;}var v=j.getComponentInstance();v.destroy();}g.recreateRTAClonedCard(i);return true;},revertChange:function(o,e,p){var f=p.appComponent.getRootControl(),g=f.getController(),h=o.getRevertData(),i=f.byId(h.id),j=g.getLayout(),l=j.getDashboardLayoutModel(),L=j.getDashboardLayoutUtil(),k=l.getCardById(h.id),n=h.settings.defaultSpan&&h.settings.defaultSpan.rowSpan,r=h.settings.defaultSpan&&h.settings.defaultSpan.colSpan,s=h.settings.defaultSpan&&h.settings.defaultSpan.showOnlyHeader,t=[];if(i){k.dashboardLayout.rowSpan=n;k.dashboardLayout.colSpan=r;k.dashboardLayout.showOnlyHeader=s;l._arrangeCards(k,{row:n,column:r},'resize',t);l._removeSpaceBeforeCard(t);L._positionCards(l.aCards);var u=i.getComponentInstance();u.destroy();}g.recreateRTAClonedCard(h);o.resetRevertData();return true;},completeChangeContent:function(o,s,p){return;}},layers:{"CUSTOMER_BASE":true,"CUSTOMER":true,"USER":true}},"newCardSettings":{changeHandler:{applyChange:function(o,e,p){var f=p.appComponent.getRootControl(),g=f.getController(),h=o.getContent();o.setRevertData(h.id);var n=new a(f.getId()+"--"+h.id),A=p.appComponent,u=g.getUIModel(),j=u.getProperty("/cards"),k=g.getLayout(),l=k.getDashboardLayoutUtil(),L=k.getDashboardLayoutModel(),N=(h.id.indexOf("newStaticLinkListCard_N")!==-1)&&!b.checkClonedCard(h.id),r=(h.id.indexOf("newKPICard_N")!==-1)&&!b.checkClonedCard(h.id),s=(h.id.indexOf("newCard_N")!==-1)&&!b.checkClonedCard(h.id),t=b.newDataSource;if(r){var v=h.settings.selectedKPI,w=new sap.ui.model.odata.v2.ODataModel(v.ODataURI,{'annotationURI':v.ModelURI,'defaultCountMode':sap.ui.model.odata.CountMode.None}),x=h.model;if(h.settings["sAnnoKey"]){b.setDataSources(h.settings["sAnnoKey"],v.ModelURI);}f.setModel(w,x);A.setModel(w,x);}if(t&&!A.getModel(h.model)){var y=new sap.ui.model.odata.v2.ODataModel(b.newDataSourceModel.serviceURI,{'annotationURI':b.newDataSourceModel.serviceAnnotationURI,'defaultCountMode':sap.ui.model.odata.CountMode.None}),x=h.model;b.setDataSources(b.newDataSourceModel.serviceAnnotation,b.newDataSourceModel.serviceAnnotationURI);f.setModel(y,x);A.setModel(y,x);}h.settings.baseUrl=g._getBaseUrl();if(N||r||s){h.settings.newCard=true;L._setCardSpanFromDefault(h);h.dashboardLayout.row=1;h.dashboardLayout.column=1;}else{h.settings.cloneCard=true;}var I=-1,i;for(i=0;i<j.length;i++){if(h.id.lastIndexOf(c._getLayerNamespace()+"."+j[i].id,0)===0){I=i;var z=L.getCardById(j[i].id);h.dashboardLayout=q.extend(true,{},z.dashboardLayout);var B=h.dashboardLayout.column+h.dashboardLayout.colSpan;h.dashboardLayout.column=B<L.getColCount()?B:1;break;}}j.splice(I+1,0,h);l.getCards().splice(I+1,0,h);u.setProperty("/cards",j);k.insertContent(n,I+1);setTimeout(function(){var D=O.getOverlay(n);D.setSelected(true);D.focus();var E=(N||r||s)?d.getText("OVP_KEYUSER_TOAST_MESSAGE_FOR_NEW"):d.getText("OVP_KEYUSER_TOAST_MESSAGE_FOR_CLONE");M.show(E,{duration:10000});},0);g.recreateRTAClonedCard(h);return true;},revertChange:function(o,e,p){var f=p.appComponent.getRootControl(),A=p.appComponent,g=f.getController(),s=o.getRevertData(),h=o.getContent();var k=f.byId(s),u=g.getUIModel(),l=u.getProperty("/cards"),n=g.getLayout(),L=n.getDashboardLayoutUtil(),r=n.getDashboardLayoutModel(),t=L.getCards();var I=-1,i,j,v=-1;for(i=0;i<l.length;i++){if(s===l[i].id){I=i;break;}}l.splice(I,1);for(j=0;j<t.length;j++){if(s===t[j].id){v=j;break;}}t.splice(v,1);r._removeSpaceBeforeCard();u.setProperty("/cards",l);if(k){var w=k.getComponentInstance(),x=w.getComponentData(),N=(x.cardId.indexOf("newKPICard_N")!==-1)&&!b.checkClonedCard(s);if(N){var y=x.modelName,z=f.getModel(y);z.destroy();if(h.settings["sAnnoKey"]){b.removeDataSources(h.settings["sAnnoKey"]);}f.setModel(null,y);A.setModel(null,y);}w.destroy();}n.removeContent(I);k.destroy();o.resetRevertData();return true;},completeChangeContent:function(o,s,p){return;}},layers:{"CUSTOMER_BASE":true,"CUSTOMER":true,"USER":true}},"dragAndDropUI":{changeHandler:{applyChange:function(o,p,P){var e=P.appComponent.getRootControl().getController(),f=o.getContent(),g=e.getLayout(),l=g.getDashboardLayoutUtil(),L=g.getDashboardLayoutModel(),h=L.getCardById(f.cardId),s='C'+L.getColCount(),i=[];o.setRevertData(f);L._arrangeCards(h,{row:f.dashboardLayout[s].row,column:f.dashboardLayout[s].column},'drag',i);L._removeSpaceBeforeCard(i);l._positionCards(L.aCards);return true;},revertChange:function(o,e,p){var f=p.appComponent.getRootControl().getController(),g=o.getContent(),h=f.getLayout(),l=h.getDashboardLayoutUtil(),L=h.getDashboardLayoutModel(),i=L.getCardById(g.cardId),s='C'+L.getColCount(),j=[];L._arrangeCards(i,{row:g.dashboardLayout[s].oldRow,column:g.dashboardLayout[s].oldColumn},'drag',j);if(g.dashboardLayout[s].oldColSpan){L._arrangeCards(i,{row:g.dashboardLayout[s].rowSpan,column:g.dashboardLayout[s].oldColSpan},'resize',j);}L._removeSpaceBeforeCard(j);l._positionCards(L.aCards);o.resetRevertData();return true;},completeChangeContent:function(o,s,p){return;}},layers:{"CUSTOMER_BASE":true,"CUSTOMER":true,"USER":true}},"viewSwitch":C.PersonalizationConfigEmpty,"visibility":C.PersonalizationConfigEmpty,"dragOrResize":C.PersonalizationConfigEmpty};},true);

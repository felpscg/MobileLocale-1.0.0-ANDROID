/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)
        (c) Copyright 2009-2017 SAP SE. All rights reserved
    
 */
sap.ui.define(["sap/m/MessageBox","sap/m/Dialog","sap/ui/model/json/JSONModel","sap/ui/core/XMLTemplateProcessor","sap/ui/core/util/XMLPreprocessor","sap/ui/core/Fragment","sap/fe/actions/messageHandling"],function(M,D,J,X,a,F,m){"use strict";function g(C){var i,j,l;i=C.getBinding().getDependentBindings();j=i&&i[0];if(j&&j.getPath()===""){l=j.getBoundContext();if(l.getObject()){return l;}}return C;}function c(A,i,j,P){if(!i||i.length===0){return Promise.reject("Bound actions always requires at least one context");}P=P||{};if(Array.isArray(i)){P.bReturnAsArray=true;}else{i=g(i);i=[i];}var l=j.getMetaModel(),n=l.getMetaPath(i[0].getPath())+"/"+A,B=l.createBindingContext(n+"/@$ui5.overload/0");P.aContexts=i;return d(A,j,B,P);}function b(A,i,P){if(!i){return Promise.reject("Action expects a model/context for execution");}var j=i.getMetaModel(),l=i.bindContext("/"+A).getPath(),n=j.createBindingContext("/"+j.createBindingContext(l).getObject("$Action")+"/0");return d(A,i,n,P);}function d(A,i,j,P){return new Promise(function(r,l){P=P||{};var n=P.actionParameters||[],q={},I,t,u,v=P.label,S=P.showActionParameterDialog,C=P.aContexts,w=P.bIsCreateAction;if(!j){l("Action not found");}I=h(A,i);if(S||n.length>0){n=p(j,n);if(!n||n.length===0){S=false;}}if(S){t=s;}else if(I){t=e;}q={fnOnSubmitted:P.onSubmitted,actionName:A,model:i,aActionParameters:n,ownerComponent:P.ownerComponent};if(j.getObject("$IsBound")){q.aContexts=C;q.mBindingParameters=P.mBindingParameters;q.additionalSideEffect=P.additionalSideEffect;q.bGrouped=P.invocationGrouping==="ChangeSet";q.bReturnAsArray=P.bReturnAsArray;}if(w){q.bIsCreateAction=w;}if(t){u=t(v,n,j,P.parentControl,q);}else{u=_(q);}return u.then(function(O){if(!O){l(O);}r(O);}).catch(function(O){l(O);});});}function e(A,i){return new Promise(function(r,j){var R=sap.ui.getCore().getLibraryResourceBundle("sap.fe"),C;if(R.hasText("SAPFE_ACTION_CONFIRM|"+A)){C=R.getText("SAPFE_ACTION_CONFIRM|"+A);}else{C=R.getText("SAPFE_ACTION_CONFIRM");}M.confirm(C,{onClose:function(l){if(l===M.Action.OK){r(true);}r(false);},title:i||R.getText("SAPFE_ACTION_CONFIRM_TITLE")});});}function s(A,j,l,P,n){var q="/"+l.getPath().split("/")[1],r=l.getModel().oModel.getMetaModel(),t=r.createBindingContext(q),u=l.getObject("$IsBound")?l.getPath().split("/@$ui5.overload/0")[0]:l.getPath().split("/0")[0],v=r.createBindingContext(u),w=Promise.resolve();return new Promise(function(x,y){var z=X.loadTemplate("sap/fe/controls/ActionParameterDialog","fragment"),R=sap.ui.getCore().getLibraryResourceBundle("sap.fe"),B=new J({$valueState:{},$valueStateText:{},$displayMode:{}}),C={handleChange:function(E,i){var G=E.getParameter("promise");w=w.then(function(){return G.then(function(V){if(!!V){B.setProperty("/$valueState/"+i,"None");B.setProperty("/$valueStateText/"+i,"");}});}).catch(function(){return Promise.resolve();});}};return a.process(z,{},{bindingContexts:{action:l,actionName:v,entitySet:t},models:{action:l.getModel(),actionName:v.getModel(),entitySet:t.getModel()}}).then(function(z){return k(n.ownerComponent,j,B).then(function(){F.load({definition:z,controller:C}).then(function(E){var G=new D({title:A||R.getText("SAPFE_ACTION_PARAMETER_DIALOG_TITLE"),content:[E],escapeHandler:function(i){G.close();G.destroy();x(false);},beginButton:{text:A||R.getText("SAPFE_OK"),type:"Emphasized",press:function(H){var I=H.getSource();I.setEnabled(false);G.setBusy(true);w.then(function(){var K,i,L,N=E.getAggregation("form").getAggregation("formContainers")[0].getAggregation("formElements");var O=function(T){var U=[];for(i=0;i<T.length;i++){var V=T[i].getFields()[0];if(V.getProperty("required")&&V.mBindingInfos.value.binding){U.push(V.mBindingInfos.value.binding.getPath());}}return U;};var Q=O(N);var S;for(i=0;i<j.length;i++){S="/"+j[i].$Name;L=B.getProperty(S);if(!L&&Q.indexOf(S)>=0){K=true;B.setProperty("/$valueState/"+j[i].$Name,"Error");B.setProperty("/$valueStateText/"+j[i].$Name,R.getText("SAPFE_ACTION_PARAMETER_REQUIRED"));G.setBusy(false);I.setEnabled(true);}else{j[i].value=L;}}if(!K){m.removeUnboundTransitionMessages();return _(n).then(function(T){G.close();if(P){P.removeDependent(G);}x(T);}).catch(function(T){G.setBusy(false);I.setEnabled(true);m.showUnboundMessages();});}});}},endButton:{text:R.getText("SAPFE_ACTION_PARAMETER_DIALOG_CANCEL"),press:function(){G.close();if(P){P.removeDependent(G);}x(false);}},afterClose:function(){G.destroy();}});G.setModel(l.getModel().oModel);G.setModel(B,"paramsModel");G.bindElement({path:"/",model:"paramsModel"});if(P){P.addDependent(G);}G.open();});});});});}function p(A,P){var i=f(A);P=P||[];if(P.length>0){}return i;}function f(A){var P=A.getObject("$Parameter")||[];if(P&&P.length){if(A.getObject("$IsBound")){return P.slice(1,P.length)||[];}}return P;}function h(A,i){return i.getMetaModel().getObject("/"+A+"@com.sap.vocabularies.Common.v1.IsActionCritical");}function _(P){var C=P.aContexts||[],l=P.model,A=P.aActionParameters||[],n=P.actionName,O=P.fnOnSubmitted,I=P.bIsCreateAction,q=false,r;function t(i){return i.then(function(j){return{response:j,status:"resolved"};},function(j){return{response:j,status:"rejected"};});}function u(){if(A&&A.length){q=true;for(var j=0;j<A.length;j++){if(!A[j].value&&A[j].$Nullable===false){switch(A[j].$Type){case"Edm.String":A[j].value="";break;case"Edm.Boolean":A[j].value=false;break;case"Edm.Byte":case"Edm.Int16":case"Edm.Int32":case"Edm.Int64":A[j].value=0;break;default:break;}}r.setParameter(A[j].$Name,A[j].value);}}}if(C.length){return new Promise(function(j,w){var B=P.mBindingParameters,G=P.bGrouped,R=P.bReturnAsArray,x=[],i,y,E=function(r,z){u();y=z&&!G?"$auto."+z:undefined;x.push(r.execute(y));};for(i=0;i<C.length;i++){r=l.bindContext(n+"(...)",C[i],B);E(r,C.length<=1?null:i);}if(P.additionalSideEffect){C[0].requestSideEffects(P.additionalSideEffect).then(function(){},function(){});}(O||jQuery.noop)(x);Promise.all(x.map(t)).then(function(z){var H=[],K=[],L;for(L=0;L<z.length;L++){if(z[L].status==="rejected"){H.push(z[L].response);}if(z[L].status==="resolved"){if(I&&q){z[L].bConsiderDocumentModified=true;K.push(z[L]);}else{K.push(z[L].response);}}}if(!z||(z&&z.length===0)){w(true);}if(H.length===0){if(R){j(K);}else{j(K[0]);}}else{w({resolvedItems:K,rejectedItems:H});}});});}else{var v;r=l.bindContext("/"+n+"(...)");u();v=r.execute("actionImport");l.submitBatch("actionImport");(O||jQuery.noop)(v);return v;}}function k(A,i,P){return new Promise(function(r,j){var S=A.getComponentData().startupParameters,C=sap.ushell.Container.getService("CrossApplicationNavigation")||{};if(!C.getStartupAppState){i.map(function(l){if(S[l.$Name]){P.setProperty(l.$Name,S[l.$Name][0]);}});return r(true);}return C.getStartupAppState(A).then(function(l){var n=l.getData()||{},E=(n.selectionVariant&&n.selectionVariant.SelectOptions)||[];i.map(function(q){if(S[q.$Name]){P.setProperty("/"+q.$Name,S[q.$Name][0]);}else if(E.length>0){var t;E.some(function(u){if(u.PropertyName===q.$Name){t=u.Ranges;return true;}});if(t&&t.length===1&&t[0].Sign==="I"&&t[0].Option==="EQ"){P.setProperty("/"+q.$Name,t[0].Low);}}});return r(true);});});}var o={callBoundAction:c,callActionImport:b};return o;});

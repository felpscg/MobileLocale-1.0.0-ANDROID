/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)
        (c) Copyright 2009-2017 SAP SE. All rights reserved
    
 */
sap.ui.define(["sap/ui/model/Filter","sap/ui/model/FilterOperator","sap/ui/core/mvc/ControllerExtension","sap/m/MessagePage","sap/m/Link","sap/m/MessageBox","sap/ui/core/routing/HashChanger","sap/base/Log","sap/fe/core/CommonUtils"],function(F,a,C,M,L,b,H,c,d){"use strict";var u,D,A,t,o=[];var E=C.extend("sap.fe.controllerextensions.Routing",{navigateToContext:function(e,p){p=p||{};var n=this._getOwnerComponent().getRootControl(),P,r,f=this;if(e.isA("sap.ui.model.odata.v4.ODataListBinding")){if(p.asyncContext){p.asyncContext.then(function(e){f.navigateToContext(e,{noHistoryEntry:true,noHashChange:p.noHashChange,useCanonicalPath:p.useCanonicalPath,editable:p.editable});});A=p.asyncContext;}else if(p.deferredContext){D=true;}else{throw"navigation to a list binding is not yet supported";}}else{if(e.getBinding().isA("sap.ui.model.odata.v4.ODataListBinding")){if(d.hasTransientContext(e.getBinding())){r=sap.ui.getCore().getLibraryResourceBundle("sap.fe");b.show(r.getText("NAVIGATION_DISABLED_MESSAGE"),{icon:b.Icon.WARNING,title:r.getText("NAVIGATION_DISABLED_TITLE"),actions:[b.Action.CLOSE],details:r.getText("TRANSIENT_CONTEXT_DESCRIPTION"),contentWidth:"100px"});return;}}u=e;}t=p.editable;if(p.noHashChange){this._bindTargetPage(n,null,null,true);return;}if(!p.noHistoryEntry&&n&&n.isA("sap.m.NavContainer")){n.setBusy(true);}if(p.useCanonicalPath){P=e.getCanonicalPath();}else if(e.isA("sap.ui.model.odata.v4.ODataListBinding")&&e.isRelative()){P=e.getHeaderContext().getPath();}else{P=e.getPath();}if(p.asyncContext||p.deferredContext){P+="(...)";}while(P.indexOf("/")===0){P=P.substr(1);}if(p.transient&&p.editable==true){P=P.indexOf("(...)")>-1?P:P+"?i-action=create";H.getInstance().replaceHash(P);}else if(p.noHistoryEntry){H.getInstance().replaceHash(P);}else{H.getInstance().setHash(P);}return Promise.resolve();},setBreadcrumbLinks:function(e,l){if(l.length&&e!==null){if(e===undefined&&l[0].getBindingContext()!==null){l.forEach(function(g){g.setBindingContext(null);});return;}else if(e&&e.getPath()){var n=e.getPath();var s=l[l.length-1].getElementBinding()&&l[l.length-1].getElementBinding().getPath();if(s&&n.indexOf(s)>-1){return;}var f=H.getInstance().hrefForAppSpecificHash("");var p="",P=n.split("/");f=f.split("/")[0];P.shift();P.splice(-1,1);for(var i=0;i<l.length;i++){var g=l[i];p=p+"/"+P[i];g.setHref(f+p);g.bindElement({path:p,parameters:{$$groupId:"$auto.associations"}});}}}},navigateOutbound:function(O,e){var f=this._getOutbounds(),g=f[O];if(g){var p={};if(g.parameters){for(var P in g.parameters){if(g.parameters[P].value.format==="binding"){p[P]=e.getProperty(g.parameters[P].value.value);}}}var h=sap.ushell&&sap.ushell.Container&&sap.ushell.Container.getService("CrossApplicationNavigation");h&&h.toExternal({target:{semanticObject:g.semanticObject,action:g.action},params:p});return Promise.resolve();}else{throw new Error("outbound target "+O+" not found in cross navigation definition of manifest");}},navigateToMessagePage:function(e,p){if(H.getInstance().getHash().indexOf("i-action=create")>-1){var f=this._getOwnerComponent();var s=this.getEntitySet(f);var h=s+"(...)";H.getInstance().replaceHash(h);return;}var n=p.navContainer||this._getOwnerComponent().getRootControl();if(!this.oMessagePage){this.oMessagePage=new M({showHeader:false,icon:"sap-icon://message-error"});n.addPage(this.oMessagePage);}this.oMessagePage.setText(e);if(p.technicalMessage){this.oMessagePage.setCustomDescription(new L({text:p.description||p.technicalMessage,press:function(){b.show(p.technicalMessage,{icon:b.Icon.ERROR,title:p.title,actions:[b.Action.OK],defaultAction:b.Action.OK,details:p.technicalDetails||"",contentWidth:"60%"});}}));}else{this.oMessagePage.setDescription(p.description||"");}n.to(this.oMessagePage);},setDirtyState:function(e,f){if(typeof e==="string"){E.mAppDirtyState[e]=f;}else{var p=e.getPath();if(p){if(p.indexOf("/-1")!==-1){p=p.substring(0,p.indexOf("/-1"));}else{p=p.substring(0,p.lastIndexOf("("));}if(p.lastIndexOf("/")!==-1){p=p.substring(0,p.lastIndexOf("/"));}E.mAppDirtyState[p]=f;}else{c.error(p+" could not be marked dirty");}}},resetDirtyState:function(){E.mAppDirtyState={};},getDirtyState:function(p){return p?E.mAppDirtyState[p]:E.mAppDirtyState;},initializeRouting:function(e){var r=e.getRouter(),R,n=false,f=this,s=this.getEntitySet(e),P,g=e.getComponentData(),S=g&&g.startupParameters,m=e.getModel(),h=S!==undefined&&Object.keys(S).length!==0;u=null;D=false;A=null;t=false;o=[];R=function(i){var l=i.getParameters().arguments,T="",K,q;f.fireOnAfterNavigation();var N=e.getRootControl();if(!n&&N&&N.getMetadata().getName()==="sap.m.NavContainer"){N.attachAfterNavigate(function(){N.setBusy(false);});n=true;}if(Object.keys(l).length>0){T=i.getParameters().config.pattern;T=T.replace(":?query:","");for(var p in l){K=l[p];if(K==="..."){q=true;t=true;}T=T.replace("{"+p+"}",K);}T=T&&"/"+T;}f._bindTargetPage(N,T,q);};function j(K,l,p){var P=s+"(";var q;var v=[];if(K.length===1){q=K[0].$PropertyPath||K[0];P=l[q].$Type==="Edm.String"?P+"'"+S[q][0]+"'":P+S[q][0];}else{for(var i=0;i<K.length;i++){q=K[i].$PropertyPath||K[i];if(S[q]){P=l[q].$Type==="Edm.String"?P+K[i]+"='"+S[q][0]+"'":P+q+"="+S[q][0];if(i!==K.length-1){P=P+",";}}else{P=undefined;break;}}}if(P&&!K[0].$PropertyPath){P=P+")";H.getInstance().replaceHash(P);}if(K[0].$PropertyPath){for(i=0;i<K.length;i++){q=K[i].$PropertyPath;if(S[q]){var w=K[i].$PropertyPath;var V=S[w][0];v.push(new F(w,a.EQ,V));}else{P=undefined;break;}}if(p){var x=new F({filters:[new F("IsActiveEntity","EQ",false),new F("SiblingEntity/IsActiveEntity","EQ",null)],and:false});v.push(x);}var y=new F(v,true);var z=m.bindList("/"+s,undefined,undefined,y);z.requestContexts().then(function(B){if(B&&B.length===1){P=B[0].getPath();if(P.indexOf("/")===0){P=P.split("/")[1];}H.getInstance().replaceHash(P);}else if(P){P=P+")";H.getInstance().replaceHash(P);}r.attachRouteMatched(R);r.initialize();});}}if(h){if(S.preferredMode&&S.preferredMode[0]==="create"&&!H.getInstance().getHash()){if(s){P=s+"(...)";}else{c.error("Cannot handle this App");}H.getInstance().replaceHash(P);r.attachRouteMatched(R);r.initialize();}else{var k=[];k.push(m.getMetaModel().requestObject("/$EntityContainer/"+s+"/"));k.push(m.getMetaModel().requestObject("/$EntityContainer/"+s+"/@"));k.push(m.getMetaModel().requestObject("/$EntityContainer/"+s+"@"));Promise.all(k).then(function(v){var i=v[0];var l=v[1];var p=v[2]["@com.sap.vocabularies.Common.v1.DraftRoot"];var q=l["@com.sap.vocabularies.Common.v1.SemanticKey"];var T=i["$Key"];if(S){if(q&&q.length&&S[q[0].$PropertyPath]){j(q,i,p);}else if(T&&S[T[0]]){j(T,i);r.attachRouteMatched(R);r.initialize();}else{r.attachRouteMatched(R);r.initialize();}}}).catch(function(i){c.error("Metadata not loaded");});}}else{r.attachRouteMatched(R);r.initialize();}},_bindTargetPage:function(n,T,e,N){var f=n.getCurrentPage(),O=(f.getComponentInstance().onBeforeBinding||Promise.resolve).bind(f.getComponentInstance()),g=(f.getComponentInstance().onAfterBinding||Promise.resolve).bind(f.getComponentInstance()),B,s,p;if(e){O(null,{editable:t});if(D||!A){if(f.getMetadata().getName()==="sap.ui.core.ComponentContainer"&&f.getComponentInstance().createDeferredContext){f.getComponentInstance().createDeferredContext(T);}}A=null;D=false;if(f.getBindingContext()&&f.getBindingContext().hasPendingChanges()){f.getBindingContext().getBinding().resetChanges();}f.setBindingContext(null);return false;}if(!N){B=f.getBindingContext();s=B&&B.getPath();}if(N||s!==T){if(T||N){if(!u||u.getBinding().isA("sap.ui.model.odata.v4.ODataListBinding")){p=u&&u.getBinding().sId;var h=f.getModel().bindContext(T,undefined,{$$patchWithoutSideEffects:true,$$groupId:"$auto"});u=h.getBoundContext();}B=u;O(B,{editable:t});f.setBindingContext(B);g(B,{listBindingId:p});u=null;}else if(T===""){O(null);g(null);}}else if(Object.keys(E.mAppDirtyState).length>0){this._refreshBindingContext(B);}},_refreshBindingContext:function(B){var n=[],p=[],s=[],e;var g=function(f){var h,P=f.getPath();if(f.isA("sap.ui.model.odata.v4.ODataContextBinding")){if(P===""){h=f.getDependentBindings();if(h.length>0){for(var i=0;i<h.length;i++){g(h[i]);}}}else{if(n.indexOf(P)===-1){n.push(P);}}}else if(f.isA("sap.ui.model.odata.v4.ODataListBinding")){if(n.indexOf(P)===-1){n.push(P);}}else if(f.isA("sap.ui.model.odata.v4.ODataPropertyBinding")){if(p.indexOf(P)===-1){p.push(P);}}};e=d.getContextForSideEffects(B);g(e.getBinding());for(var i=0;i<n.length;i++){s.push({$NavigationPropertyPath:n[i]});}for(var i=0;i<p.length;i++){s.push({$PropertyPath:p[i]});}e.requestSideEffects(s);},attachOnAfterNavigation:function(h){o.push(h);},detachOnAfterNavigation:function(h){for(var i=0;i<o.length;i++){if(o[i]===h){o.splice(i,1);}}},fireOnAfterNavigation:function(){for(var i=0;i<o.length;i++){o[i]();}},_getOutbounds:function(){if(!this.outbounds){if(!this.manifest){this.manifest=this._getOwnerComponent().getMetadata().getManifest();}this.outbounds=this.manifest["sap.app"]&&this.manifest["sap.app"].crossNavigation&&this.manifest["sap.app"].crossNavigation.outbounds;}return this.outbounds;},_getOwnerComponent:function(){return this.base.getView().getController().getOwnerComponent();},getEntitySet:function(e){var s;var m=e.getManifest();var r=m["sap.ui5"].routing.routes;var T=m["sap.ui5"].routing.targets;var p;for(var i=0;i<r.length;i++){p=r[i].pattern;if(p===""||":?query:"){s=T[r[i].target].options&&T[r[i].target].options.settings&&T[r[i].target].options.settings.entitySet;break;}}for(var j=0;j<r.length;j++){p=r[i].pattern;if((p!==""||":?query:")&&(T[r[j].target].options&&T[r[j].target].options.settings&&T[r[j].target].options.settings.entitySet===s)&&T[r[j].target].name==="sap.fe.templates.ObjectPage"){return s;}}if(s==undefined){if(r.length===1){s=r[0].pattern.split("(")[0];return s;}}}});E.mAppDirtyState={};return E;});

/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)
        (c) Copyright 2009-2017 SAP SE. All rights reserved
    
 */
sap.ui.define(["sap/ui/core/mvc/ControllerExtension","sap/ui/model/json/JSONModel","sap/ui/core/routing/HashChanger","sap/fe/controllerextensions/AppState"],function(C,J,H,A){"use strict";var E=C.extend("sap.fe.controllerextensions.AppState",{initializeAppState:function(a){var t=this;var r=a.getRouter();var o=(A.mAppContainer[a.getId()]={appStateModels:{}});o.oInnerAppStatePromise=new jQuery.Deferred();r.attachRouteMatched(function(e){var q=e.getParameters().arguments["?query"];var s=q&&q["sap-iapp-state"];if(s){if(o.oAppState&&s===o.oAppState.getKey()){o.oInnerAppStatePromise.resolve();s=undefined;}if(s){sap.ushell.Container.getService("CrossApplicationNavigation").getAppState(a,s).done(function(S){o.oAppState=S;t._updateAppStateModels(o,S);o.oInnerAppStatePromise.resolve();});}}else{o.oInnerAppStatePromise.resolve();if(o.oAppState){o.oAppState=null;t._updateAppStateModels(o,null);}}});},cleanupAppState:function(a){if(A.mAppContainer[a.getId()]){delete A.mAppContainer[a.getId()];}},requestAppStateModel:function(i){var t=this;var a=this._getAppContainer(),o;return a.oInnerAppStatePromise.then(function(){if(!a.appStateModels[i]){a.appStateModels[i]=new J(null,true);a.appStateModels[i].bindList("/").attachChange(t._updateAppState.bind(t,i));}if(a.oAppState){o=a.oAppState.getData();if(o&&o[i]){a.appStateModels[i].setData(o[i]);}}return a.appStateModels[i];});},_updateAppState:function(i){var a={};var o=this._getAppContainer();var n=o.appStateModels[i].getJSON();if(o.oAppState){a=o.oAppState.getData()||{};}if(a&&a[i]&&a[i]===n){return;}o.oAppState=sap.ushell.Container.getService("CrossApplicationNavigation").createEmptyAppState(this._getOwnerComponent());var h=this._getHashChanger();var c=h.getAppHash();var p=c.split("?");var s=p[0];s+="?sap-iapp-state="+o.oAppState.getKey();h.replaceHash(s);a[i]=n;o.oAppState.setData(a);return o.oAppState.save();},_getHashChanger:function(){if(!this.oHashChanger){this.oHashChanger=H.getInstance();}return this.oHashChanger;},_getOwnerComponent:function(){return this.base.getView().getController().getOwnerComponent();},_updateAppStateModels:function(a,o){var d=(o&&o.getData())||{};for(var p in a.appStateModels){if(d&&d[p]){a.appStateModels[p].setData(d[p]);}else{a.appStateModels[p].setData(null);}}},_getAppContainer:function(){return A.mAppContainer[this._getOwnerComponent().getId()];}});A.mAppContainer={};return E;});

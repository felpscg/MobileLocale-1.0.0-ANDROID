/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)
        (c) Copyright 2009-2017 SAP SE. All rights reserved
    
 */
sap.ui.define(["sap/ui/core/mvc/ControllerExtension","sap/fe/actions/draft","sap/fe/actions/sticky","sap/fe/actions/operations","sap/fe/model/DraftModel","sap/ui/model/json/JSONModel","sap/fe/actions/messageHandling","sap/m/Popover","sap/m/VBox","sap/m/CheckBox","sap/m/Text","sap/m/Button","sap/m/MessageToast","sap/m/Dialog","sap/ui/model/BindingMode","sap/base/Log","sap/ui/core/message/Message","sap/fe/core/CommonUtils"],function(C,d,s,o,D,J,m,P,V,a,T,B,M,b,c,L,e,f){"use strict";var I=false,g=false;function h(p){if(p&&p.getMetadata&&p.getMetadata().getName()==="sap.ui.base.Event"){p={};}return p||{};}var E=C.extend("sap.fe.controllerextensions.Transaction",{getProgrammingModel:function(i){var t=this,j=i.getModel(),k=i.getModel().getMetaModel().getMetaPath(i.getPath()),l;if(!this.sProgrammingModel){return D.upgradeOnDemand(j).then(function(n){if(n){t.sProgrammingModel="Draft";}else{if(j.getMetaModel().getObject(k+"@com.sap.vocabularies.Session.v1.StickySessionSupported")){t.sProgrammingModel="Sticky";}else{l=i.getModel().getMetaModel().getObject("/");for(var p in l){if(l[p].$kind==="EntitySet"){if(j.getMetaModel().getObject("/"+p+"@com.sap.vocabularies.Session.v1.StickySessionSupported")){t.sProgrammingModel="Sticky";return t.sProgrammingModel;}}}t.sProgrammingModel="NonDraft";j.sUpdateGroupId="nondraft";}}return t.sProgrammingModel;});}else{return Promise.resolve(this.sProgrammingModel);}},getUIStateModel:function(){if(!this.uiModel){this.uiModel=new J({editable:"Display",busy:false,busyLocal:{},draftStatus:"Clear"});this.uiModel.setDefaultBindingMode(c.OneWay);}return this.uiModel;},setUIStateModel:function(u){this.uiModel=u;},isBusy:function(i,l){var u=this.getUIStateModel();return u.getProperty("/busy")||u.getProperty("/busyLocal/"+l);},busyHandler:function(i,l,O){var u;if(i==="Global"){u=this.getUIStateModel();u.setProperty("/busy",O);}else if(i==="Local"){u=this.getUIStateModel();u.setProperty("/busyLocal/"+l,O);}},busyOn:function(i,l){this.busyHandler(i,l,true);},busyOff:function(i,l){this.busyHandler(i,l,false);},createDocument:function(l,p){var n,t=this,S,j,k=l.getModel(),q=k.getMetaModel(),r=q.getMetaPath(l.getPath()),N=!l.isRelative()&&(q.getObject(r+"@com.sap.vocabularies.Session.v1.StickySessionSupported/NewAction")||q.getObject(r+"@com.sap.vocabularies.Common.v1.DraftRoot/NewAction")),n,R=sap.ui.getCore().getLibraryResourceBundle("sap.fe"),u;p=h(p);if(!l){return Promise.reject("Binding required for new document creation");}if(p.busyMode==="Local"){j=l.sId;}if(this.isBusy(p.busyMode,j)){return Promise.reject("Action can only be called once at a time");}S=!p.refreshList;if(!p.parentControl){p.parentControl=t.base.getView();}t.busyOn(p.busyMode,j);if(N){u=this.onCallAction(N,{contexts:l.getHeaderContext(),showActionParameterDialog:true,label:R.getText("SAPFE_ACTION_CREATE"),bindingParameters:{$$patchWithoutSideEffects:true},parentControl:p.parentControl,bIsCreateAction:true});}else{n=l.create(p.data,S,p.createAtEnd);u=n.created();var v=function(w){var x=w.getParameter("context"),y=sap.ui.getCore().getMessageManager(),z,A,F,G,R;if(x===n){l.detachCreateCompleted(v);if(!w.getParameter("success")){if(p.keepTransientContextOnFailed){z=n.getPath();A=y.getMessageModel().getData();G=false;for(var i=0;i<A.length;i++){if(A[0].target===z){G=true;break;}}if(!G){R=sap.ui.getCore().getLibraryResourceBundle("sap.fe");F=new e({message:R.getText("TRANSIENT_CONTEXT_MESSAGE"),description:R.getText("TRANSIENT_CONTEXT_DESCRIPTION"),target:z,persistent:false,type:"Error"});y.addMessages(F);n.created().then(function(){y.removeMessages(F);},function(){y.removeMessages(F);});}var H=function(w){if(w.getParameter("context")===n){t.busyOn(p.busyMode,j);}};var K=function(w){if(w.getParameter("context")===n){t.busyOff(p.busyMode,j);m.showUnboundMessages();if(w.getParameter("success")){l.detachCreateSent(H);l.detachCreateCompleted(K);}}};l.attachCreateSent(H);l.attachCreateCompleted(K);m.showUnboundMessages();}else{x.created().then(undefined,function(){L.trace("transient creation context deleted");});x.delete();}}}};l.attachCreateCompleted(v);}return u.then(function(i){g=true;n=n||(i&&i.response);t.busyOff(p.busyMode,j);if(i&&i.bConsiderDocumentModified){t.handleDocumentModifications();}return m.showUnboundMessages().then(function(){return n;});}).catch(function(i){t.busyOff(p.busyMode,j);return m.showUnboundMessages().then(function(){return Promise.reject(i);});});},deleteDocument:function(v,p,l){var u=this.getUIStateModel(),r,R,i=[],j=false,k=false,n=false,q;if(u.getProperty("/busy")){return Promise.reject("Action can only be called once at a time");}var t=sap.ui.getCore().getLibraryResourceBundle("sap.fe"),w,x={title:t.getText("OBJECT_PAGE_DELETE")};u.setProperty("/busy",true);if(p){if(!p.numberOfSelectedContexts){p=h(p);if(p.title){if(p.description){w=[p.title,p.description];x.text=t.getText("OBJECT_PAGE_CONFIRM_DELETE_WITH_OBJECTINFO",w);}else{x.text=t.getText("OBJECT_PAGE_CONFIRM_DELETE_WITH_OBJECTTITLE_SINGULAR");}}else{x.text=t.getText("OBJECT_PAGE_CONFIRM_GENERIC_DELETE");}var y=v.getBinding().getDependentBindings();var z=y&&y[0];if(z&&z.getPath()===""){var A=z.getBoundContext();if(A.getObject()){i=A;}else{i=v;}}else{i=v;}}else{x={title:t.getText("OBJECT_PAGE_DELETE")};if(p.numberOfSelectedContexts===1&&p.numberOfSelectedContexts===v.length){i=v;x.text=t.getText("OBJECT_PAGE_CONFIRM_DELETE_WITH_OBJECTTITLE_SINGULAR");}else if(p.numberOfSelectedContexts===1&&p.unSavedContexts.length===1){i=p.unSavedContexts;var F=i[0].getObject()["DraftAdministrativeData"]?i[0].getObject()["DraftAdministrativeData"]["LastChangedByUserDescription"]:"";w=[F];x.text=t.getText("OBJECT_PAGE_CONFIRM_DELETE_WITH_UNSAVED_CHANGES",w);}else if(p.numberOfSelectedContexts===p.unSavedContexts.length){i=p.unSavedContexts;x.text=t.getText("OBJECT_PAGE_CONFIRM_DELETE_WITH_UNSAVED_CHANGES_MULTIPLE_OBJECTS");}else if(p.numberOfSelectedContexts===v.concat(p.unSavedContexts.concat(p.lockedContexts)).length){i=v.concat(p.unSavedContexts);x.text=i.length===1?t.getText("OBJECT_PAGE_CONFIRM_DELETE_WITH_OBJECTTITLE_SINGULAR"):t.getText("OBJECT_PAGE_CONFIRM_DELETE_WITH_OBJECTTITLE_PLURAL");}else{i=v.concat(p.unSavedContexts);n=true;x.text=i.length===1?t.getText("OBJECT_PAGE_CONFIRM_DELETE_WITH_OBJECTTITLE_PLURAL"):t.getText("OBJECT_PAGE_CONFIRM_DELETE_WITH_OBJECTTITLE_SINGULAR");x.nonDeletableText=t.getText("OBJECT_PAGE_CONFIRM_DELETE_WITH_OBJECTINFO_AND_FEW_OBJECTS_NON_DELETABLE",[p.numberOfSelectedContexts-v.concat(p.unSavedContexts).length,p.numberOfSelectedContexts]);}if(p.lockedContexts.length>0){k=true;x.nonDeletableText=t.getText("OBJECT_PAGE_CONFIRM_DELETE_WITH_OBJECTINFO_AND_FEW_OBJECTS_LOCKED",[p.lockedContexts.length,p.numberOfSelectedContexts]);}if(p.unSavedContexts.length>0&&p.unSavedContexts.length!==p.numberOfSelectedContexts){if((n||k)&&i.length===p.unSavedContexts.length){j=false;i=p.unSavedContexts;if(p.unSavedContexts.length===1){x.text=t.getText("OBJECT_PAGE_CONFIRM_DELETE_WITH_UNSAVED_AND_FEW_OBJECTS_LOCKED_SINGULAR");}else{x.text=t.getText("OBJECT_PAGE_CONFIRM_DELETE_WITH_UNSAVED_AND_FEW_OBJECTS_LOCKED_PLURAL");}}else{if(p.unSavedContexts.length===1){x.checkBoxText=t.getText("OBJECT_PAGE_CONFIRM_DELETE_WITH_OBJECTINFO_AND_FEW_OBJECTS_UNSAVED_SINGULAR");}else{x.checkBoxText=t.getText("OBJECT_PAGE_CONFIRM_DELETE_WITH_OBJECTINFO_AND_FEW_OBJECTS_UNSAVED_PLURAL");}j=true;}}if(n&&k){x.nonDeletableText=t.getText("OBJECT_PAGE_CONFIRM_DELETE_WITH_OBJECTINFO_AND_FEW_OBJECTS_LOCKED_AND_NON_DELETABLE",[p.numberOfSelectedContexts-v.concat(p.unSavedContexts).length-p.lockedContexts.length,p.lockedContexts.length,p.numberOfSelectedContexts]);}}}var G=new V({items:[new T({text:x.nonDeletableText,visible:k||n}),new T({text:x.text}),new a({text:x.checkBoxText,selected:true,select:function(N){var O=N.getSource().getSelected();if(O){i=v.concat(p.unSavedContexts);q=true;}else{i=v;q=false;}},visible:j})]});var H=p.numberOfSelectedContexts?t.getText("OBJECT_PAGE_DELETE_DIALOG",[p.numberOfSelectedContexts]):t.getText("OBJECT_PAGE_DELETE");var K=new b({title:H,state:"Warning",content:[G],beginButton:new B({text:t.getText("OBJECT_PAGE_DELETE"),type:"Emphasized",press:function(){u.setProperty("/busy",true);var N=Array.isArray(i)?i:[i];K.close();return Promise.all(N.map(function(O){O.delete().then(function(){u.setProperty("/busy",false);if(l.getProperty("/$contexts/"+p.id+"/deleteEnabled")!=undefined){if(j===true&&q===false){l.setProperty("/$contexts/"+p.id+"/deleteEnabled",true);var Q=Object.assign(l.getProperty("/$contexts/"+p.id),{});Q.selectedContexts=Q.selectedContexts.filter(function(S){return Q.deletableContexts.indexOf(S)===-1;});Q.deletableContexts=[];Q.selectedContexts=[];Q.numberOfSelectedContexts=Q.selectedContexts.length;l.setProperty("/$contexts/"+p.id,Q);}else{l.setProperty("/$contexts/"+p.id+"/deleteEnabled",false);l.setProperty("/$contexts/"+p.id+"/selectedContexts",[]);l.setProperty("/$contexts/"+p.id+"/numberOfSelectedContexts",0);}}N.length===1?M.show(t.getText("OBJECT_PAGE_DELETE_TOAST_SINGULAR")):M.show(t.getText("OBJECT_PAGE_DELETE_TOAST_PLURAL"));m.removeBoundTransitionMessages();return m.showUnboundMessages().then(R);}).catch(function(Q){u.setProperty("/busy",false);return m.showUnboundMessages().then(r);});}));}}),endButton:new B({text:t.getText("OBJECT_PAGE_CANCEL"),press:function(){u.setProperty("/busy",false);K.close();}}),afterClose:function(){K.destroy();}});K.addStyleClass("sapUiContentPadding");u.setProperty("/busy",false);K.open();return new Promise(function(N,O){r=O;R=N;});},editDocument:function(i){var t=this;var u=this.getUIStateModel();if(u.getProperty("/busy")){return Promise.reject("Action can only be called once at a time");}if(!i){return Promise.reject(new Error("Binding context to active document is required"));}return this.getProgrammingModel(i).then(function(p){switch(p){case"Draft":t.activeContext=i;u.setProperty("/busy",true);return d.createDraftFromActiveDocument(i,{bPreserveChanges:true});case"NonDraft":return i;case"Sticky":u.setProperty("/busy",true);return s.editDocumentInStickySession(i);}}).then(function(n){u.setProperty("/editable","Editable");u.setProperty("/busy",false);g=false;return m.showUnboundMessages().then(function(){return n;});}).catch(function(j){u.setProperty("/busy",false);return m.showUnboundMessages().then(function(){return Promise.reject(j);});});},updateDocument:function(){return Promise.resolve();},cancelDocument:function(i,p){var t=this,u=t.getUIStateModel(),j;if(u.getProperty("/busy")){return Promise.reject("Action can only be called once at a time");}if(!i){return Promise.reject("No context exists. Pass a meaningful context");}var p=h(p),k=i,l=p.cancelButton,n=k.getModel(),q;return this.getProgrammingModel(i).then(function(r){j=r;if(r==="Draft"){var v=n.bindContext(k.getPath()+"/DraftAdministrativeData").getBoundContext();if(!I){u.setProperty("/busy",true);return v.requestObject().then(function(w){u.setProperty("/busy",false);I=!(w.CreationDateTime===w.LastChangeDateTime);});}}else if(r==="NonDraft"){I=k.hasPendingChanges();}}).then(function(){return t._showDiscardPopover(l,I);}).then(function(){u.setProperty("/busy",true);switch(j){case"Draft":return k.requestObject("HasActiveEntity").then(function(H){if(!H){k.delete();return false;}else{var A=t.activeContext||n.bindContext(k.getPath()+"/SiblingEntity").getBoundContext();return A.requestCanonicalPath().then(function(r){q=r;k.delete();}).then(function(){if(A.getPath()!==q){A=n.bindContext(q).getBoundContext();}return A;});}});case"Sticky":return s.discardDocument(i).then(function(i){i=g?false:i;if(i){i.refresh();}return i;});case"NonDraft":if(k===i&&I){i.getBinding().resetChanges();}break;}}).then(function(r){I=false;u.setProperty("/editable","Display");u.setProperty("/busy",false);m.removeBoundTransitionMessages();return m.showUnboundMessages().then(function(){return r;});}).catch(function(r){u.setProperty("/busy",false);return m.showUnboundMessages().then(function(){return Promise.reject(r);});});},saveDocument:function(i){var u=this.getUIStateModel(),j;var l=sap.ui.getCore().getLibraryResourceBundle("sap.fe");if(u.getProperty("/busy")){return Promise.reject("Action can only be called once at a time");}if(!i){return Promise.reject(new Error("Binding context to draft document is required"));}u.setProperty("/busy",true);m.removeBoundTransitionMessages();return this.getProgrammingModel(i).then(function(p){switch(p){case"Draft":return d.activateDocument(i);case"Sticky":return s.activateDocument(i);case"NonDraft":j=i.getModel();j.submitBatch(j.getUpdateGroupId());return i;}}).then(function(A){I=false;u.setProperty("/editable","Display");u.setProperty("/busy",false);M.show(l.getText("OBJECT_SAVED"));return m.showUnboundMessages().then(function(){return A;});}).catch(function(k){u.setProperty("/busy",false);return m.showUnboundMessages().then(function(){return Promise.reject(k);});});},onCallAction:function(A,p){p=h(p);var u=this.getUIStateModel(),t=this,i,j,k,n;if(u.getProperty("/busy")){return Promise.reject("Action can only be called once at a time");}if(!A){return Promise.reject("Provide name of action to be executed");}n=A.split("/")[1];A=n||A;i=n?undefined:p.contexts;if(i&&((Array.isArray(i)&&i.length)||!Array.isArray(i))){i=Array.isArray(i)?i[0]:i;j=i.getModel();}if(p.model){j=p.model;}if(!j){Promise.reject("Pass a context for a bound action or pass the model for an unbound action");}var S=t._getBindingParameters(A,i)||{},l=t._getAppComponent();if(i&&j){k=o.callBoundAction(A,p.contexts,j,{invocationGrouping:p.invocationGrouping,label:p.label,showActionParameterDialog:true,mBindingParameters:S.mBindingParameters,additionalSideEffect:S.aAdditionalPropertyPaths,onSubmitted:function(){u.setProperty("/busy",true);},parentControl:p.parentControl,ownerComponent:l,bIsCreateAction:p.bIsCreateAction});}else{k=o.callActionImport(A,j,{label:p.label,showActionParameterDialog:true,bindingParameters:S.mBindingParameters,onSubmitted:function(){u.setProperty("/busy",true);},parentControl:p.parentControl,ownerComponent:l});}return k.then(function(r){u.setProperty("/busy",false);return m.showUnboundMessages().then(function(){return r;});}).catch(function(q){u.setProperty("/busy",false);return m.showUnboundMessages().then(function(){return Promise.reject(q);});});},_getBindingParameters:function(A,i){var j=i&&i.getModel().getMetaModel(),S=j&&j.getObject("/"+A+"@com.sap.vocabularies.Common.v1.SideEffects");if(!S){return;}var p={},t=S.TargetProperties||[],k=S.TargetEntities||[],l=j.getMetaPath(i.getPath()),n=[];n=n.concat(t).concat(k);t.forEach(function(q){var r=j.getObject(l+"/"+q["$PropertyPath"]+"@com.sap.vocabularies.Common.v1.Text");if(r&&r["$Path"]){n.push({"$PropertyPath":r["$Path"]});}});return{aAdditionalPropertyPaths:n,mBindingParameters:p};},_showDiscardPopover:function(i,I){var t=this,r=sap.ui.getCore().getLibraryResourceBundle("sap.fe");t._bContinueDiscard=false;return new Promise(function(j,k){if(!i){k("Cancel button not found");}if(I){var O=function(){i.setEnabled(true);if(t._bContinueDiscard){j();}else{k("Discard operation was rejected. Document has not been discarded");}t._oPopover.detachAfterClose(O);};if(!t._oPopover){t._oPopover=new P({showHeader:false,placement:"Top",content:[new V({items:[new T({text:r.getText("SAPFE_DRAFT_DISCARD_MESSAGE")}),new B({text:r.getText("SAPFE_DRAFT_DISCARD_BUTTON"),width:"100%",press:function(){t._bContinueDiscard=true;t._oPopover.close();}})]})],beforeOpen:function(){i.setEnabled(false);}});t._oPopover.addStyleClass("sapUiContentPadding");}t._oPopover.attachAfterClose(O);t._oPopover.openBy(i);}else{j();}});},handleDocumentModifications:function(){I=true;},_getAppComponent:function(){return this.base.getView().getController().getOwnerComponent();}});return E;});

sap.ui.define(["sap/ui/thirdparty/jquery","./library","sap/ui/core/Control","sap/m/ResponsivePopover","sap/m/List","sap/ui/model/json/JSONModel","sap/m/ListMode","sap/m/PlacementType","sap/m/StandardListItem","sap/ui/core/CustomData","sap/ui/model/Sorter","sap/rules/ui/parser/infrastructure/util/utilsBase","sap/rules/ui/services/AstExpressionLanguage","sap/rules/ui/ExpressionAdvanced","sap/rules/ui/AutoCompleteSuggestionContent","sap/rules/ui/ExpressionBase","sap/rules/ui/ast/constants/Constants","sap/rules/ui/ast/util/AggregateFunctionDialog","sap/rules/ui/ast/util/SelectFunctionDialog","sap/rules/ui/ast/provider/TermsProvider","sap/rules/ui/ast/parser/bundlelibrary"],function(q,l,C,R,L,J,a,P,S,b,c,d,A,E,f,g,h,j,k,T,m){"use strict";var n=g.extend("sap.rules.ui.AstExpressionBasic",{metadata:{properties:{library:"sap.rules.ui",value:{type:"string",defaultValue:""},dataObjectInfo:{type:"string",bindable:"bindable",defaultValue:""},resultDataObjectId:{type:"string",defaultValue:""},conditionContext:{type:"boolean",defaultValue:false},operationsContext:{type:"boolean",defaultValue:false},jsonData:{type:"array",bindable:"bindable",defaultValue:[]},enableAggregateFunctionVocabulary:{type:"boolean",defaultValue:false},enableAggregateFunctionWhereClause:{type:"boolean",defaultValue:false},isAttributeContext:{type:"boolean",defaultValue:false},countFunctionSelected:{type:"boolean",defaultValue:false},placeholder:{type:"string",defaultValue:""},isAssociationContext:{type:"boolean",defaultValue:false}},aggregations:{},events:{"change":{},"liveChange":{}}},init:function(){this.infraUtils=new sap.rules.ui.parser.infrastructure.util.utilsBase.lib.utilsBaseLib();this.oBundle=sap.ui.getCore().getLibraryResourceBundle("sap.rules.ui.i18n");this.aggregateFunctionCallBack=q.proxy(this._updateAggregateFunction,this);this.functionCallBack=q.proxy(this._updateSelectFunction,this);this._reference=q.proxy(this.callback,this);this._isDialogOpenedCallbackReference=q.proxy(this.isDialogOpenedCallback,this);this._uiModel=[];this._cursorPostion=0;this._selectedSpans=null;this._hasTextContent=false;this._createPopver();this._attributeContext=false;this._bCtrlSpacePressed=false;this.bShiftPressed=false;this.shiftKey="";this.isDialogOpen=false;this._focusedOut=false;this._jsonArray=[];this.functionClicked=false;this.isAutoSuggestionRequired=true;this.isDotRequired=true;this.aggregateFunctionDialog=j.getInstance();this.selectFunctionDialog=k.getInstance();this.astLibInstance=m.getInstance();this.bTypingFlow=false;},onBeforeRendering:function(){this._enableAggregateFunctionVocabulary=this.getEnableAggregateFunctionVocabulary();this._enableAggregateFunctionWhereClause=this.getEnableAggregateFunctionWhereClause();this.isCountFunctionSelected=this.getCountFunctionSelected();},callback:function(e,o){this._setTextOnCursorPosition(e);},isDialogOpenedCallback:function(i){this.isDialogOpen=i;if(!i){this.functionClicked=false;}},onAfterRendering:function(){this.referenceId="";this.isAutoSuggestionRequired=true;this.dotInOperationsContext=false;this._oAstExpressionLanguage=sap.ui.getCore().byId(this.getAstExpressionLanguage());this._input=this.$("input");this._validateControl();this._input[0].contentEditable=this.getEditable();this._input[0].classList.add("sapAstExpressionInput");if(!this.getEditable()){this._input[0].classList.add("sapAstExpressionInputNotEditable");}else{this._input[0].classList.remove("sapAstExpressionInputNotEditable");}if(this.aCustomStyleClasses&&this.aCustomStyleClasses.length>0){this._input[0].classList.add(this.aCustomStyleClasses[0]);}if(this.getJsonData()){this._jsonArray=this.getJsonData();}if(this.getValue()&&this.getValue().trim()){var e=this.markerString?this.markerString.trim():"";if(e===this.getValue()){this.setValue("");}this._uiModel=this._convertInputToUiModel(this.getValue());this._uiModelToSpan(this._uiModel);this._selectedSpans=[];this._selectedSpans.push(this._input.children()[this._input.children().length-1]);if(!this.bTypingFlow&&this._selectedSpans[0]&&!this._selectedSpans[0].textContent.endsWith(h.DOT)&&this._selectedSpans[0].getAttribute(h.TOKEN_TYPE)!==h.WS&&this._selectedSpans[0].getAttribute(h.TOKEN_TYPE)!==h.UNDEFINED&&!this.dotInOperationsContext&&!(this._enableAggregateFunctionVocabulary&&this.isCountFunctionSelected&&this._jsonArray.length===0)){this._createSpaceSpanItem();}this.bTypingFlow=false;if(!this.dataObjectInfo){this.dataObjectInfo=this.getDataObjectInfo()+this.relString;}this._hasTextContent=true;}else{this.relString="";this._uiModel=[];this._uiModelToSpan(this._uiModel);this.dataObjectInfo="";}this._cursorPostion=this._getCaretPosition();this._setCurrentCursorPosition(this._cursorPostion);this._setUpEventHandlers();},_convertInputToUiModel:function(i){if(i){this.astNodesString=this._oAstExpressionLanguage.getAstNodesString(i);this.relString=this._oAstExpressionLanguage.getRelStringForGivenAstString(this.astNodesString).relString;this._tokens=this._oAstExpressionLanguage.getTokensForGivenStringInput(i);try{this.astresponseNodes=JSON.parse(this.astNodesString);}catch(e){q.sap.log.error("Error in parsing string to JSON: "+e.message);}if(this.astresponseNodes&&this.astresponseNodes[0]&&(this.astresponseNodes[0].Function||(this.astresponseNodes[0].Type&&this.astresponseNodes[0].Type!=="I"))){this.displayString=this._oAstExpressionLanguage._astBunldeInstance.ASTUtil.toAstExpressionString(astNodes);this._jsonArray=this.displayString.JSON;}return this._oAstExpressionLanguage.convertTokensToUiModel(this._tokens,this._jsonArray);}return[];},_generateIDStringFromUIModel:function(){var i="";for(var t in this._uiModel){if(this._uiModel[t].reference!==null){if(this._uiModel[t].text.length>0){i=i+this._uiModel[t].reference;}}else{i=i+this._uiModel[t].text;}}return i;},_getSuggestionsForTheGivenInput:function(i){var _=this._attributeContext;var e=false;var o=false;var p=this.getIsAssociationContext();if(this.getDataObjectInfo()&&!this.functionClicked){i=this.dataObjectInfo;}if(this.getHeaderInfo()&&this.getHeaderInfo().headerValue){i=this.getHeaderInfo().headerValue+" "+i;}if(this.getAttributeInfo()&&i===""){i=this.getAttributeInfo()+" "+h.EQUAL+" ";}if(!this._oAstExpressionLanguage){this._oAstExpressionLanguage=sap.ui.getCore().byId(this.getAstExpressionLanguage());}if(this.getDataObjectInfo()&&this.getIsAttributeContext()){_=this.getIsAttributeContext();i=i.replace(/\./g,"");}if(this.isCountFunctionSelected){_=false;p=true;}if(this.getOperationsContext()&&!this._enableAggregateFunctionVocabulary){e=true;}if(this.getOperationsContext()&&i!==""){if(this.dotInOperationsContext&&this._selectedSpans[0]&&this._selectedSpans[0].textContent.endsWith(h.DOT)){_=true;}else if(!_){_=false;o=this._addDotToMiscellaneousSuggestions();}}var t=this._oAstExpressionLanguage.getTokensForGivenStringInput(i);var u=this._oAstExpressionLanguage.convertTokensToUiModelForAutoSuggestion(t);var s={};s.AttributeContext=_;s.OperationsContext=e;s.AssociationContext=p;var r=this._oAstExpressionLanguage.getSuggesstions(u,s);if(o){var v={name:h.DOT,label:this.oBundle.getText("DOTLABEL")};r.autoComplete.categories.operators=r.autoComplete.categories.operators?r.autoComplete.categories.operators:{};var w=r.autoComplete.categories.operators;if(!("miscellaneous"in w)){w.miscellaneous=[];}w.miscellaneous.push(v);}r.autoComplete.businessDataTypeList=r.businessDataTypeList;return r;},_addDotToMiscellaneousSuggestions:function(){if(this._uiModel&&this._uiModel[0]&&"getText"in this._uiModel[0]&&this._uiModel[0].getText().toUpperCase()===h.UPDATE){var u=this._uiModel.length;var e=this._uiModel[u-1];var i=e.dataObjectType;var o=e.getReference();var p=o?o.split("/"):[];if(!o){return false;}if(i===h.ASSOCIATIONDOTYPE){return true;}else if(p&&p.length>2){return false;}else{o=p[1];o=this._oAstExpressionLanguage._astBunldeInstance.TermsProvider.TermsProvider.getTermByTermId(o);if(o&&o._isDataObjectElement){return false;}else{return true;}}}return false;},_constructExpandedRelString:function(e){var i="";if(e.function===h.AVG||e.function===h.SUM||e.function===h.MIN||e.function===h.MAX){i=this._hasAssociationId(e.vocabulary,e.function)?this._returnAttributeBasedOnCardinality(e.vocabulary):this._fetchAttributes(e.vocabulary);return e.function+"("+this.getTable(e)+","+i+this.getGroupByAttributes(e.groupBy)+")";}else if(e.function===h.COUNTDISTINCT||e.function===h.DISTINCT){i=this._hasAssociationId(e.vocabulary,e.function)?this._returnAttributeBasedOnCardinality(e.vocabulary):this._fetchAttributes(e.vocabulary);return e.function+"("+this.getTable(e)+","+i+")";}else if(e.function===h.COUNT){return e.function+"("+this.getTable(e)+this.getGroupByAttributes(e.groupBy)+")";}else if(e.function===h.TOP||e.function===h.BOTTOM||e.function===h.SELECT){return this._constructExpandedRelStringForSelect(e);}},_getAttributesSelectQuery:function(e){var s=",";var i="";if(e&&!q.isEmptyObject(e.attributes)){for(var o in e.attributes){i+=s+o;}}return i;},_constructSelectQuery:function(e){var i="";if(e.doVocabId){i=e.doVocabId;}else{i=e.dataObject;}if(this._getAttributesSelectQuery(e)){return h.SELECT+"("+this._constructSortQuery(e)+this._getAttributesSelectQuery(e)+")";}else if(e.filter){return h.FILTER+"("+i+","+e.filter+")"}else{return i;}},_constructSortQuery:function(e){var i="";var o="";if(e.doVocabId){o=e.doVocabId;}else{o=e.dataObject;}if(!e.filter){i=o;}else{i=h.FILTER+"("+o+","+e.filter+")";}if(!q.isEmptyObject(e.attributes)){for(var p in e.attributes){if(e.attributes[p]!==h.NOSORT){i=e.attributes[p]+"("+i+","+p+")";}}}return i;},_constructExpandedRelStringForSelect:function(e){if(e.function===h.TOP||e.function===h.BOTTOM){return e.function+"("+this._constructSelectQuery(e)+","+e.count+")";}else if(e.function===h.SELECT){return this._constructSelectQuery(e);}},getTable:function(e){var i=e.dataObject;if(this._hasAssociationId(e.vocabulary,e.function)){i=this._returnDataObjectBasedOnCardinality(e.vocabulary);}if(!e.filter&&(typeof e.vocabulary==="object"||e.vocabulary instanceof Object)){return this._constructExpandedRelStringForSelect(e.vocabulary);}else if(e.filter&&(typeof e.vocabulary==="object"||e.vocabulary instanceof Object)){return h.FILTER+"("+this._constructExpandedRelStringForSelect(e.vocabulary)+","+e.filter+")";}else if(!e.filter){return i;}else{return h.FILTER+"("+i+","+e.filter+")";}},_hasAssociationId:function(v,e){var i="";if((typeof v==="object"||v instanceof Object)){if(v&&v.attributes){for(var o in v.attributes){i=v.doVocabId+o.replace(h.DOT,"");break;}}}else{i=v;}if(i){var s=i.split("/");var p=s[1];if(e===h.COUNT&&s.length>2){for(var r=2;r<s.length;r++){p+=h.DOT+s[r];}}else if(s.length>3){for(var r=2;r<s.length-1;r++){p+=h.DOT+s[r];}}if(this._oAstExpressionLanguage._astBunldeInstance.TermsProvider.TermsProvider.getTermByTermId(p)&&this._oAstExpressionLanguage._astBunldeInstance.TermsProvider.TermsProvider.getTermByTermId(p)._dataObjectType==="AO"){return true;}}return false;},_returnAttributeBasedOnCardinality:function(v){var e="";if((typeof v==="object"||v instanceof Object)){if(v&&v.attributes){for(var i in v.attributes){e=v.doVocabId+i.replace(h.DOT,"");break;}}}else{e=v;}if(e){var s=e.split("/");var o=s[1];var p=0;var t;var r="";if(s.length>2){for(var u=2;u<s.length;u++){o+=h.DOT+s[u];t=this._oAstExpressionLanguage._astBunldeInstance.TermsProvider.TermsProvider.getTermByTermId(o);if(t&&t._dataObjectType==="AO"&&t._cardinality==="1..n"){p=u;}}if(p>0){for(var u=p+1;u<s.length;u++){r+="/"+s[u];}}if(p===0){for(var u=2;u<s.length;u++){r+="/"+s[u];}}}if(r){return h.DOT+r;}else{return"./"+s[s.length-1];}}},_returnDataObjectBasedOnCardinality:function(v){var e="";if((typeof v==="object"||v instanceof Object)){if(v&&v.attributes){for(var i in v.attributes){e=v.doVocabId+i.replace(h.DOT,"");break;}}}else{e=v;}if(e){var s=e.split("/");var o=s[1];var p=0;var t;var r="";if(s.length>2){for(var u=2;u<s.length;u++){o+=h.DOT+s[u];t=this._oAstExpressionLanguage._astBunldeInstance.TermsProvider.TermsProvider.getTermByTermId(o);if(t&&t._dataObjectType==="AO"&&t._cardinality==="1..n"){p=u;}}if(p>0){for(var u=1;u<=p;u++){r+="/"+s[u];}}}if(r){return r;}else{return"/"+s[1];}}},getGroupByAttributes:function(e){var s=",";var o="";if(e&&e.length>0){for(var i=0;i<e.length;i++){o+=(s+e[i]);}}return o;},_fetchAttributes:function(v){if(typeof v==="string"||v instanceof String){var s=v.split("/");var e="";if(s.length>3){for(var i=2;i<s.length;i++){e+="/"+s[i];}return h.DOT+e;}else{return"./"+s[2];}}else if(Object.keys(v.attributes).length===1){for(var o in v.attributes){return o;}}else{}},_createUUID:function(){return this.infraUtils.createUUID();},_createSpanItem:function(i){var p=this.getId();this.ruleWithElementDO=false;if(i.tokenType===h.TERM){this.termsProvider=this._oAstExpressionLanguage._astBunldeInstance.TermsProvider.TermsProvider;var t=i.reference.split("/")[1];var e=this.termsProvider.getTermByTermId(t);if(e&&e.Type==="Rule"&&e.ResultDataObjectId!==""&&e.ResultDataObjectId!==undefined){var o=this.termsProvider.getTermByTermId(e.ResultDataObjectId);if(o&&o.getIsDataObjectElement()){e=o;this.ruleWithElementDO=true;}}if(e&&i&&(e._isDataObjectElement||i.dataObjectType==="ruleWithElementDO")){t="/"+t;}else{t=i.reference;}var r=this.termsProvider.getTermNameFromASTNodeReference(t);if(r){if("dataObjectType"in i&&i.dataObjectType!=h.Element&&!this.isCountFunctionSelected&&!this.ruleWithElementDO){i.text=r;if(this._addDotToReferenceText(i)){i.text=r+h.DOT;}}else if((i.resultDataObjectId!==""&&i.resultDataObjectId!==undefined&&!this.ruleWithElementDO)||(i.tokenType===h.TERM&&i.dataObjectType!=h.Element&&!this.ruleWithElementDO&&!this.isCountFunctionSelected)){i.text=r;if(this._addDotToReferenceText(i)){i.text=r+h.DOT;}}else{i.text=r;}}}if(i.tokenType===h.FUNCTION&&i.json){this.termsProvider=this._oAstExpressionLanguage._astBunldeInstance.TermsProvider.TermsProvider;var r=this.termsProvider.getTermNameFromASTNodeReference(i.json.dataObject);i.text=i.text.replace(i.json.dataObject,r)}var s=i.id.replace("/","");var N=q('<span>',{id:p+"-"+s,class:i.cssClass,reference:i.reference,resultDataObjectId:i.resultDataObjectId,json:JSON.stringify(i.json),tokenType:i.tokenType})["text"](i.text);return N;},_isFirstTokenAnOperation:function(){if(this._uiModel&&this._uiModel.length>0&&"getText"in this._uiModel[0]&&this._uiModel[0].getText().toUpperCase()===h.UPDATE&&this._uiModel[0].getTokenType()===h.FUNCTION){return true;}return false;},_addDotToReferenceText:function(i){var o=this._isFirstTokenAnOperation()&&this.dotInOperationsContext;if(o||(!o&&this._attributeContext)||(!o&&i.dataObjectType==="AO")){return true;}return false;},_uiModelToSpan:function(u){var t="";var H="";for(var i=0;i<u.length;i++){H+=this._createSpanItem(u[i])[0].outerHTML;}this._input.html(H);return t;},_closeAutoSuggestionPopup:function(){if(this._oAutoSuggestionPopUp)this._oAutoSuggestionPopUp.close();},_setUpEventHandlers:function(){var t=this,i=q(this._input),o=[16,17,18,93,13,9,46,35,36,45,34,33,40,37,38,39,27,44,145,19,112,113,114,115,116,117,118,119,120,121,122,123,124,125,126,127,128,129,130,131,132,133,134,135];if(!this._focusedOut){t._setCurrentCursorPosition(t._cursorPostion);}this._input.on('keydown',function(e){if(e.keyCode===40||e.keyCode===38){t._handleArrowNavigation(e);}else if(e.key==="Control"){t.ctrlPressed=true;}else if(t.ctrlPressed&&e.key===" "){t._initializeCursorSpan();t.ctrlPressed=false;t._bCtrlSpacePressed=true;if(!t.dataObjectInfo){t.dataObjectInfo=t.getDataObjectInfo();}if(!t.relString){t.relString="";}}else if(e.key==="Shift"){t.bShiftPressed=true;}else if(t.bShiftPressed&&o.indexOf(e.keyCode)===-1){t.shiftKey=e.key;t.bShiftPressed=false;}else if(e.key==="Tab"){t._closeAutoSuggestionPopup();}else if(o.indexOf(e.keyCode)!==-1&&e.keyCode!==35&&e.keyCode!==36&&e.keyCode!==37&&e.keyCode!==39){e.preventDefault();}});this._input.on("click",function(p){t.ctrlPressed=false;t.forceFireChange=false;t._initializeCursorSpan();var r;if(!t.getEditable()){return;}if(t._selectedSpans&&t._selectedSpans[0]&&t._selectedSpans[0].getAttribute(h.JSON)){t.functionClicked=true;var _=t._getSuggestionsForTheGivenInput(t._contextForPerviousSpans(t._selectedSpans));t.isDialogOpen=true;try{r=JSON.parse(t._selectedSpans[0].getAttribute(h.JSON));if(r.function===h.TOP||r.function===h.BOTTOM||r.function===h.SELECT){t.selectFunctionDialog._createSelectFunctionDialog(_.autoComplete.categories.functions,t.functionCallBack,t._oAstExpressionLanguage,t._isDialogOpenedCallbackReference,r);}else{r.selectExpression=typeof r.vocabulary==="object"||r.vocabulary instanceof Object?t._constructExpandedRelStringForSelect(r.vocabulary):"";t.aggregateFunctionDialog._createAggregationFunctionDialog(_.autoComplete.categories.functions,t.aggregateFunctionCallBack,t._oAstExpressionLanguage,t._isDialogOpenedCallbackReference,r);}}catch(e){q.sap.log.error("Error in parsing string to JSON: "+e.message);}}t._closeAutoSuggestionPopup();});this._input.on('keyup',function(e){var p=q(this);var r=false;t._initializeCursorSpan();if(!t.dataObjectInfo){t.dataObjectInfo=t.getDataObjectInfo();}if(e.key==="Control"){return;}if(t._bCtrlSpacePressed){t._suggestionsList=t._getSuggestionsForTheGivenInput(t.relString);var s=t._input.children()[t._input.children().length-1];if(s){t._selectedSpans=[];t._selectedSpans.push(s);}if(t._selectedSpans[0]&&t._selectedSpans[0].getAttribute(h.TOKEN_TYPE)===h.UNDEFINED&&t._selectedSpans[0].textContent.startsWith(h.SINGLE_QUOTE)){t._suggestionsList.autoComplete.showLiteral=true;}t._showAutoSuggestion(t._suggestionsList);t._bCtrlSpacePressed=false;return;}else if(e.keyCode===8){if(t._selectedSpans[0]&&(t._selectedSpans[0].className==="sapAstObjectClass"||(t._selectedSpans[0].className==="sapAstFunctionClass"&&t._selectedSpans[0].getAttribute(h.JSON)))){t._removeSpans();}t._updateUiModel();}var u=p.data('before');var v=this.textContent;if(v&&e.key!==" "){v=v.trim();}if(u){u=u.trim();}if(v!==u){t.bTypingFlow=true;if((e.keyCode!==8&&o.indexOf(e.keyCode)===-1)||(e.key==="Shift"&&t.shiftKey!=="")){var w=e.key==="Shift"?t.shiftKey:e.key;t._updateUIModelForFreeFlow(w);r=true;t.shiftKey="";}t._handleKeyUpEvent(v,e,r);p.data('before',v);t._bCtrlSpacePressed=false;}});this._input.on('focusout',function(e){t._focusedOut=true;if(!t.isDialogOpen&&!t._oAutoSuggestionPopUp.isOpen()){t._validateControl();}t._handlePopupFocusOut(e);});this._input.on('focus',function(e){t._focusedOut=false;var p=q(this);p.data('before',p.context.textContent);});},_handlePopupFocusOut:function(e){var i=e.currentTarget.id;var r=e.relatedTarget?e.relatedTarget.id:null;var o=sap.ui.getCore().byId(r);if(r&&i!==r){if(!r.startsWith("__item")&&!r.startsWith("__panel")&&!r.startsWith("__link")&&!r.startsWith("__input")&&!r.startsWith("__popover")){this._closeAutoSuggestionPopup();this._fireChange(this.textContent);}else if(r.startsWith("__item")&&(o.getParent().getId()==="idPredefinedTable")||o.getParent().getId().startsWith("__table")){this._closeAutoSuggestionPopup();this._fireChange(this.textContent);}}},_initializeCursorSpan:function(){this._selectedSpans=this._getSelectedSpans();this._cursorPostion=this._getCaretPosition();},_handleArrowNavigation:function(e){e.preventDefault();this._bPopUpFocused=true;var s=this._oAutoSuggestionPopUp.getContent()[0];var i=s.getAggregation("mainLayout").getItems()[0];$(i).focus();},_handleKeyUpEvent:function(e,i,p){var t=this;var o=t._oAstExpressionLanguage.getTokensForGivenStringInput(t._uiModeltoString());var r=t._getStringForFilterAndTempRelString(o);if(i.keyCode===8){t.dataObjectInfo=t.getDataObjectInfo()+r.tempRelString;}if(this._jsonArray.length>0){o=this._convertInputToUiModel(this.relString);}t._uiModel=t._oAstExpressionLanguage.convertTokensToUiModelForAutoSuggestion(o);t._uiModelToSpan(t._uiModel);t._uiModeltoString();if(!t._bCtrlSpacePressed&&p&&t.getDataObjectInfo()&&o[o.length-2].type!==this.astLibInstance.IDPParser.ALL_STRING){t.dataObjectInfo=t.getDataObjectInfo()+r.tempRelString;}t._setCaretPosition(t._cursorPostion);if(e!==""&&i.key!=='Backspace'){t._suggestionsList=t._getSuggestionsForTheGivenInput(r.tempRelString);t._selectedSpans=[];t._selectedSpans.push(t._input.children()[t._input.children().length-1]);var s=r.filterText;var F=t._bRequiredFilteredSuggestion(s)?t._filterSuggestionList(s):t._suggestionsList;if(t._selectedSpans[0]&&t._selectedSpans[0].getAttribute(h.TOKEN_TYPE)===h.UNDEFINED&&t._selectedSpans[0].textContent.startsWith(h.SINGLE_QUOTE)){F.autoComplete.showLiteral=true;}var u=i.key!==" ";t._showAutoSuggestion(F,u);}else{t._closeAutoSuggestionPopup();}},_setCaretPosition:function(p){var s=window.getSelection(),e=this.$("input"),o,r,I,F,t;var u=function(t){var v=e.children(),w,x,y=0;for(var i=0;i<v.length;i++){w=v[i];x=w.innerText||"";if(y+x.length>t){return{spanIndex:i,position:y+x.length-t};}y+=x.length;}return{spanIndex:Math.max(i-1,0),position:100};};if(typeof p==="number"){p=u(p);}I=p&&p.span;if(p){o=e[0];if(!I){I=o&&o.children&&o.children.length>p.spanIndex?o.childNodes[p.spanIndex]:null;}if(I){r=document.createRange();F=I.firstChild?I.firstChild:I;t=Math.min(F.length,p.position);r.setStart(F,t);r.collapse(true);s.removeAllRanges();s.addRange(r);}}},_getStringForFilterAndTempRelString:function(t){var s="";var i="";var e;var o;var p;var r;for(var u in t){e=t[u];r=t[u-1];o=e.type?e.type:e._type;p=r?(r.type?r.type:r._type):null;if(o===this.astLibInstance.IDPParser.EOF||o===this.astLibInstance.IDPParser.DOT){continue;}else if(o===this.astLibInstance.IDPParser.ALL_STRING||(p&&p===this.astLibInstance.IDPParser.ALL_STRING)){i+=e.text;}else{s+=e.text;}}return{tempRelString:s,filterText:i};},_getSpanPosition:function(s){var e=this.getDomRef("input").children;for(var i=0;i<e.length;i++){if(s.id===e[i].id){return i;}}return-1;},_isEmptySpace:function(s){return s===String.fromCharCode(160)||s===" ";},_bRequiredFilteredSuggestion:function(t){return!(this._isEmptySpace(t)||t===""||this._selectedSpans[0].className==="sapAstLiteralClass");},_updateUIModelForFreeFlow:function(s){var t=this;var e=this._selectedSpans[0];if(this._uiModel.length===0){var i={id:t._createUUID(),tokenType:h.UNDEFINED,text:s};var o=this._createSpanItem(i);this._uiModel.push(i);this._uiModelToSpan(this._uiModel);}else if(e.className==="sapAstObjectClass"){if(s===h.DOT&&this.getOperationsContext()){this.dotInOperationsContext=true;this._attributeContext=true;}else{e.setAttribute(h.REFERENCE,e.getAttribute(h.REFERENCE)+s);}}this._updateUiModel();},_filterSuggestionList:function(t){var F={autoComplete:{categories:{functions:{},operators:{},terms:[]},showLiteral:this._suggestionsList.autoComplete.showLiteral,businessDataTypeList:this._suggestionsList.autoComplete.businessDataTypeList},businessDataTypeList:this._suggestionsList.autoComplete.businessDataTypeList};var s=this._suggestionsList.autoComplete.categories;var e=function(I){var K=[];var M,N;for(var i=0;i<I.length;i++){M=(I[i].label||I[i].name).toLowerCase();N=t.toLowerCase();if(((" "+M).indexOf(" "+N)!==-1)){K.push(I[i])}}return K;};if(s){if(s.terms){F.autoComplete.categories.terms=e(s.terms);}if(s.operations){F.autoComplete.categories.operations=e(s.operations);}if(s.functions){var o=s.functions.advanced;if(o&&o.length>0){var p=e(o);if(p&&p.length>0){F.autoComplete.categories.functions.advanced=p;}}var r=s.functions.aggregate;if(r&&r.length>0){var p=e(r);if(p&&p.length>0){F.autoComplete.categories.functions.aggregate=p;}}var u=s.functions.selection;if(u&&u.length>0){var p=e(u);if(p&&p.length>0){F.autoComplete.categories.functions.selection=p;}}var w=s.functions.window;if(w&&w.length>0){var p=e(w);if(p&&p.length>0){F.autoComplete.categories.functions.window=p;}}var v=s.functions.time_duration;if(v&&v.length>0){var p=e(v);if(p&&p.length>0){F.autoComplete.categories.functions.time_duration=p;}}}if(s.operators){var x=s.operators.arithmetic;if(x&&x.length>0){var p=e(x);if(p&&p.length>0){F.autoComplete.categories.operators.arithmetic=p;}}var y=s.operators.comparision;if(y&&y.length>0){var p=e(y);if(p&&p.length>0){F.autoComplete.categories.operators.comparision=p;}}var z=s.operators.logical;if(z&&z.length>0){var p=e(z);if(p&&p.length>0){F.autoComplete.categories.operators.logical=p;}}var B=s.operators.array;if(B&&B.length>0){var p=e(B);if(p&&p.length>0){F.autoComplete.categories.operators.array=p;}}var D=s.operators.range;if(D&&D.length>0){var p=e(D);if(p&&p.length>0){F.autoComplete.categories.operators.range=p;}}var G=s.operators.miscellaneous;if(G&&G.length>0){var p=e(G);if(p&&p.length>0){F.autoComplete.categories.operators.miscellaneous=p;}}var H=s.operators.functional;if(H&&H.length>0){var p=e(H);if(p&&p.length>0){F.autoComplete.categories.operators.functional=p;}}}}return F;},_fireChange:function(t){if(this.isDialogOpen&&!this.forceFireChange){return;}var e="";if(!this.relString&&t){this.relString=t;}if(!this.relString){this.relString="";}if(this.markerString){this.markerRelString=this.markerString+this.relString;e=this._oAstExpressionLanguage.getAstNodesString(this.markerRelString);}else{e=this._oAstExpressionLanguage.getAstNodesString(this.relString);}this.astresponseNodes=JSON.parse(e);if(this.astresponseNodes.length>=0&&this.getValue().replace(/\s/g,"")!==this.relString.replace(/\s/g,"")){this.setValue(this.relString);this.setJsonData(this._jsonArray);this.fireChange({newValue:this.relString,astNodes:this.astresponseNodes,displayText:this._input[0].textContent.trim()});}},_contextForPerviousSpans:function(s){var i="";var o;var p=this.getDomRef("input").children;for(var r=0;r<p.length;r++){var t=$("#"+p[r].id);if(p[r].id!==s[0].id){if(t[0].getAttribute(h.JSON)){try{o=JSON.parse(t[0].getAttribute(h.JSON));if(o.expandedText){i+=o.expandedText;}}catch(e){q.sap.log.error("Error in parsing string to JSON: "+e.message);}}else if(t[0].getAttribute(h.REFERENCE)){i+=t[0].getAttribute(h.REFERENCE);}else{i+=t[0].textContent}}else{i+="";break;}}return i;},_updateSelectFunction:function(e){this.isDialogOpen=false;this._selectedSpans[0].setAttribute(h.JSON,JSON.stringify(e.getSource().mProperties.jsonData));this._selectedSpans[0].textContent=e.getSource().mProperties.value;this._updateUiModel();this._uiModel=this._convertInputToUiModel(this.relString);this._input.empty();this._uiModelToSpan(this._uiModel);this._setCurrentCursorPosition(this._cursorPostion);},_updateAggregateFunction:function(e){this.isDialogOpen=false;this._selectedSpans[0].setAttribute(h.JSON,JSON.stringify(e.getSource().mProperties.jsonData));this._selectedSpans[0].textContent=e.getSource().mProperties.value;this._updateUiModel();this._uiModel=this._convertInputToUiModel(this.relString);this._input.empty();this._uiModelToSpan(this._uiModel);this._setCurrentCursorPosition(this._cursorPostion);},_createSpaceSpanItem:function(){var i={};i.id=this._createUUID();i.text=" ";i.tokenType=h.WS;i.cssClass="sapAstAuxilaryNodeClass";var e=this._createSpanItem(i);var s=this._selectedSpans[0]?this._selectedSpans[0].id:"";var o="#"+s;$(e[0]).insertAfter(o);this._updateUiModel();this._cursorPostion+=e[0].textContent.length;this._selectedSpans=e;this._uiModel=this._convertInputToUiModel(this.relString);this._hasTextContent=true;},_addSpace:function(){this._createSpaceSpanItem();this._setCaretPosition(this._cursorPostion);this._suggestionsList=this._getSuggestionsForTheGivenInput(this._uiModeltoString());this._showAutoSuggestion(this._suggestionsList);},_removeSpans:function(){var e=false;if(this._uiModel.length===0||this._input.children().length===0){return e;}this._selectedSpans=this._getSelectedSpans();this._prevNodeofRemovedNode=null;for(var i=0;i<this._selectedSpans.length;i++){this._prevNodeofRemovedNode=$("#"+this._selectedSpans[i].id).prev()[0];if(this._selectedSpans[i]instanceof HTMLSpanElement&&this._selectedSpans[i].textContent){this._cursorPostion-=this._selectedSpans[i].textContent.length;this._selectedSpans[i].remove();e=true;}if("getAttribute"in this._selectedSpans[i]&&this._selectedSpans[i].getAttribute("class")==="sapAstObjectClass"){this._attributeContext=false;}}if(this.getDomRef("input")&&this.getDomRef("input").textContent&&!this.getDomRef("input").textContent.length>0){this._hasTextContent=false;}return e;},_showAutoSuggestion:function(s,e){var i=q(this._selectedSpans);var x=0;if(i&&i[0]instanceof HTMLPreElement){x=12;}else{if("position"in i){x=parseInt(i.position().left,10);}x+=parseInt(i.width(),10);}var y=3;x+=10;var t=this;if(this._oAutoSuggestionPopUp&&!this._oAutoSuggestionPopUp.isOpen()){this._oAutoSuggestionPopUp.destroyContent();this._oAutoSuggestionPopUp.addContent(new sap.rules.ui.AutoCompleteSuggestionContent({content:s.autoComplete,reference:t._reference,enableAggregateFunctionVocabulary:t._enableAggregateFunctionVocabulary,enableAggregateFunctionWhereClause:t._enableAggregateFunctionWhereClause,dialogOpenedCallbackReference:t._isDialogOpenedCallbackReference,vocabularyInfo:t._oAstExpressionLanguage,expand:e}));this._oAutoSuggestionPopUp.setOffsetX(x);this._oAutoSuggestionPopUp.setOffsetY(y);this._oAutoSuggestionPopUp.openBy(this.getDomRef("input"));}else{this._oAutoSuggestionPopUp.destroyContent();this._oAutoSuggestionPopUp.addContent(new sap.rules.ui.AutoCompleteSuggestionContent({content:s.autoComplete,reference:t._reference,enableAggregateFunctionVocabulary:t._enableAggregateFunctionVocabulary,enableAggregateFunctionWhereClause:t._enableAggregateFunctionWhereClause,dialogOpenedCallbackReference:t._isDialogOpenedCallbackReference,vocabularyInfo:t._oAstExpressionLanguage,expand:e}));this._oAutoSuggestionPopUp.setOffsetX(x);this._oAutoSuggestionPopUp.setOffsetY(y);}if(!this._oAutoSuggestionPopUp.isOpen()){this._oAutoSuggestionPopUp.setOffsetX(x);this._oAutoSuggestionPopUp.setOffsetY(y);this._oAutoSuggestionPopUp.openBy(this.getDomRef("input"));}},_isLastTokenSpaceItem:function(){var i=true;var o;if(this._uiModel&&this._uiModel.length>0){o=this._uiModel[this._uiModel.length-1];if(o&&(o.tokenType===h.WS||o.tokenType===h.UNDEFINED)){return true;}if(o&&o.tokenType!==h.WS&&o.dataObjectType&&o.dataObjectType!=="S"&&o.dataObjectType!=="T"&&o.dataObjectType!=="AO"&&(o.tokenType===h.TERM&&!o.getText().endsWith(h.DOT))){i=false;}else if(o&&o.tokenType!==h.WS&&o.tokenType!==h.TERM&&o.reference===undefined){i=false;}else if(o&&o.tokenType!==h.WS&&this._uiModel[0]&&"getText"in this._uiModel[0]&&this._uiModel[0].getText().toUpperCase()===h.UPDATE&&!this._attributeContext){i=false;}else if(o&&(o.tokenType==="D"||o.tokenType==="T")&&this._uiModel[0]&&"getText"in this._uiModel[0]){i=false;}}return i;},_setTextOnCursorPosition:function(e){this.dotInOperationsContext=false;if(!this._isLastTokenSpaceItem()&&e.getSource().mProperties&&e.getSource().mProperties.label&&e.getSource().mProperties.label!==h.DOT){this._createSpaceSpanItem();}var i;var s="#"+this._selectedSpans[0].id;var o=$(s);var p;this.ruleContext=false;this.forceFireChange=false;if(e&&e.getSource()&&e.getSource().mProperties.forceFireChange){this.forceFireChange=true;}if(this._uiModel.length===0){p=this._getItemFromSuggestionModel(e,"");if(p.resultDataObjectId&&p.resultDataObjectId!==""&&p.tokenType===h.TERM){this.ruleContext=true;}i=this._createSpanItem(p);this._uiModel.push(p);this._uiModeltoString();this._uiModel=this._convertInputToUiModel(this.relString);this._cursorPostion=p.text.length;this._uiModelToSpan(this._uiModel);this._selectedSpans=i;if(this.getIsAttributeContext()&&!this.isAssociation&&!p.json&&this._oAutoSuggestionPopUp){this.isAutoSuggestionRequired=false;this._oAutoSuggestionPopUp.close();}}else{var r=this._selectedSpans[0].getAttribute("tokenType")===h.WS?"":this._selectedSpans[0].id;p=this._getItemFromSuggestionModel(e,r);if(this._selectedSpans[0].getAttribute(h.TOKEN_TYPE)===h.UNDEFINED){if(this._selectedSpans[0].textContent.startsWith(h.SINGLE_QUOTE)){this._selectedSpans[0].textContent+=p.text;this._cursorPostion+=p.text.length;}else{var t=o[0].textContent.length;this._selectedSpans[0].textContent=p.text;this._cursorPostion+=p.text.length-t;if(p.tokenType===h.TERM){this._cursorPostion+=1;}this._replacePreviousUndefinedTokens();}if(p.reference){this._selectedSpans[0].setAttribute(h.REFERENCE,p.reference);}if(p.json){this._selectedSpans[0].setAttribute(h.JSON,JSON.stringify(p.json));}}else if(p.json){i=this._createSpanItem(p);$(i[0]).insertAfter(s);this._selectedSpans=i;this._cursorPostion+=i[0].textContent.length;}else if(this._selectedSpans[0].getAttribute("tokenType")===h.WS){i=this._createSpanItem(p);$(i[0]).insertAfter(s);this._selectedSpans=i;this._cursorPostion+=i[0].textContent.length;}else{this._selectedSpans[0].textContent+=p.text;if(p.text===h.DOT&&this._attributeContext){this.isAutoSuggestionRequired=true;this.dotInOperationsContext=true;this._cursorPostion=this._cursorPostion+1;}else{if(p.reference){var u=this._selectedSpans[0].getAttribute(h.REFERENCE)?this._selectedSpans[0].getAttribute(h.REFERENCE)+p.reference:p.reference;this._selectedSpans[0].setAttribute(h.REFERENCE,u);}if(p.json){this._selectedSpans[0].setAttribute(h.JSON,JSON.stringify(p.json));}}this._cursorPostion+=p.text.length;}this._updateUiModel();this._uiModel=this._convertInputToUiModel(this.relString);this._uiModelToSpan(this._uiModel);this._hasTextContent=true;if(this.getIsAttributeContext()&&!this.isAssociation&&!p.json&&this._oAutoSuggestionPopUp){this.isAutoSuggestionRequired=false;this._oAutoSuggestionPopUp.close();}}if(this.isAssociation){this._cursorPostion+=1;}if(this._bPopUpFocused){this._input.focus();this._bPopUpFocused=false;}this._setCaretPosition(this._cursorPostion);if(this.isAutoSuggestionRequired){if(p.bAddSpaceAutoMatically){this._selectedSpans=[];this._selectedSpans.push(this._input.children()[this._input.children().length-1]);this._addSpace();}else{this._suggestionsList=this._getSuggestionsForTheGivenInput(this.relString);this._selectedSpans=[];this._selectedSpans.push(this._input.children()[this._input.children().length-1]);this._showAutoSuggestion(this._suggestionsList);}}},_replacePreviousUndefinedTokens:function(){var e=this._selectedSpans[0];var p=e.previousSibling;var r;while(p&&p.previousSibling){if((p.getAttribute(h.TOKEN_TYPE)===h.WS&&p.previousSibling.getAttribute(h.TOKEN_TYPE)===h.UNDEFINED)||p.getAttribute(h.TOKEN_TYPE)===h.UNDEFINED){r=p;p=p.previousSibling;r.remove();}else{break;}}if(p&&!p.previousSibling&&p.getAttribute(h.TOKEN_TYPE)===h.UNDEFINED){p.remove();}},_getItemFromSuggestionModel:function(e,p){this._attributeContext=false;this.isAssociation=false;var i={};var s=e.getSource();i.id=this._createUUID();if(s&&s.getBindingContext()){var B=s.getBindingContext().getObject();i.dataObjectType=B.type;if(B.ResultDataObjectId){i.resultDataObjectId=B.ResultDataObjectId;if(B.displayType&&B.displayType==="Rule"||i.resultDataObjectId){var t=this._oAstExpressionLanguage._astBunldeInstance.TermsProvider.TermsProvider;var r=t.getTermByTermId(B.ResultDataObjectId);if(r&&r.getIsDataObjectElement()){this.ruleWithElementDO=true;i.dataObjectType="ruleWithElementDO";i.cssClass="sapAstObjectClass";i.tokenType=h.TERM;i.text=(B.label!==null&&B.label!=="")?B.label:B.name;i.bAddDotAutomatically=false;i.bAddSpaceAutoMatically=true;i.id=B.id?"/"+B.id:"";i.reference=B.id?"/"+B.id:"";}else{var i=this._createObjectSpanItem(i,p,B);}}}else if(B.type===h.Element){i.tokenType=h.TERM;i.cssClass="sapAstObjectClass";i.id="";i.text=(B.label!==null&&B.label!=="")?B.label:B.name;if(this.getDataObjectInfo()&&this.isDotRequired){i.reference=B.id?"./"+B.id:"";}else{this.isDotRequired=true;i.reference=B.id?"/"+B.id:"";}i.bAddDotAutomatically=false;i.bAddSpaceAutoMatically=true;if(p&&p.indexOf("-")>0){p=p.substring(p.indexOf("-")+1)}i.id=p!==''?p+h.DOT+B.id:B.id;var o=T.getInstance();var u=o.getTermByTermId(i.id);if(u&&u._isDataObjectElement){i._isDataObjectElement=true;}}else if("type"in B){var i=this._createObjectSpanItem(i,p,B);}else{i.text=B.name;if(B&&"noOfMandatoryArgs"in B){if(B.noOfMandatoryArgs==="0"){i.text+=" ( )";}else{i.text+=" (";}}i.bAddDotAutomatically=false;i.bAddSpaceAutoMatically=true;}}else if(e.getParameter("tokens")){var v=e.getParameter("tokens")[0].data("row");;i.text=v.Value;i.bAddDotAutomatically=false;i.bAddSpaceAutoMatically=true;i.cssClass="sapAstLiteralClass";}else if(e.getSource().mProperties.jsonData){i.text=e.getSource().mProperties.value;i.json=e.getSource().mProperties.jsonData;i.bAddDotAutomatically=false;i.bAddSpaceAutoMatically=true;}else{i.text=e.getSource().mProperties.value.trim();i.bAddDotAutomatically=false;i.bAddSpaceAutoMatically=true;}if(this.getDataObjectInfo()){if(i.json){this.dataObjectInfo+=this._constructExpandedRelString(i.json);}else{this.dataObjectInfo+=i.reference?i.reference:i.text;}if((i.dataObjectType&&i.dataObjectType!=="AO")||!i.dataObjectType){this.dataObjectInfo+=" ";}}if(e.getSource().mProperties.label===h.DOT){i.bAddDotAutomatically=false;i.bAddSpaceAutoMatically=false;this._attributeContext=true;}return i;},_createObjectSpanItem:function(i,p,B){i.tokenType=h.TERM;i.cssClass="sapAstObjectClass";i.id="";i.text=(B.label!==null&&B.label!=="")?B.label:B.name;if(B.type!==h.ASSOCIATIONDOTYPE){i.reference=B.id?"/"+B.id:"";if(p&&p.indexOf("-")>0){p=p.substring(p.indexOf("-")+1)}i.id=p!==''?p+h.DOT+B.id:B.id;}else{this.isAssociation=true;if(this.getDataObjectInfo()&&this.isDotRequired){i.reference=B.id?"./"+B.id:"";this.isDotRequired=false;}else{i.reference=B.id?"/"+B.id:"";}i.id+=B.id;}if(this.getDataObjectInfo()){this.isDotRequired=false;}this._attributeContext=true;i.bAddDotAutomatically=true;i.bAddSpaceAutoMatically=false;if(this._uiModel&&this._uiModel.length>0&&this._uiModel[0]&&"getText"in this._uiModel[0]&&this._uiModel[0].getText().toUpperCase()===h.UPDATE&&this.getOperationsContext()&&!this.getConditionContext()){this._attributeContext=false;i.bAddDotAutomatically=false;i.bAddSpaceAutoMatically=false;this.isDotRequired=false;}return i;},_createPopver:function(){var t=this;if(!this._oAutoSuggestionPopUp){this._oAutoSuggestionPopUp=new R({content:new sap.rules.ui.AutoCompleteSuggestionContent(),showArrow:false,placement:P.Vertical,horizontalScrolling:true,showHeader:false,contentWidth:"400px",initialFocus:t,afterOpen:function(){t._setCaretPosition(t._cursorPostion);}});}},_getCaretPosition:function(I,s){var r,o,p,t=0;var u=function(N){return(I&&N===I)||(!I&&(N===o.anchorNode||N===o.anchorNode.parentNode));};var v=function(N){var w;if(u(N)){return false;}if(N.nodeType===3){t+=N.textContent.length;}else{for(var i=0;i<N.childNodes.length;i++){w=N.childNodes[i];if(u(w)){return false;}t+=w.textContent.length;}}return true;};try{if(window.getSelection&&window.getSelection().getRangeAt){r=window.getSelection().getRangeAt(0);o=window.getSelection();p=this._input[0].childNodes;for(var i=0;i<p.length;i++){if(!v(p[i])){break;}}return(s||r.startOffset)+t;}}catch(e){return this._cursorPostion;}return 0;},_getSelectedSpans:function(){var s=window.getSelection();var e=new Array();if("getRangeAt"in s){var r=s.getRangeAt(0);if(r.startContainer==r.endContainer){e.push(r.startContainer.parentNode);}else{var i=$(r.startContainer.parentNode);var o=$(r.endContainer.parentNode);e.push(i);$(r.startContainer.parentNode).nextAll().each(function(){var p=$(this).attr('id');if(p!=$(o).attr('id')){e.push($(this));}else{e.push(o);return false;}});}}else{e.push(s.anchorNode.parentNode);}return e;},_createRange:function(e,i,r){if(!r){r=document.createRange();r.selectNode(e);r.setStart(e,0);}if(i.count===0){r.setEnd(e,i.count);}else if(e&&i.count>0){if(e.nodeType===Node.TEXT_NODE){if(e.textContent!=undefined&&e.textContent.length<i.count){i.count-=e.textContent.length;}else{r.setEnd(e,i.count);i.count=0;}}else{for(var o=0;o<e.childNodes.length;o++){r=this._createRange(e.childNodes[o],i,r);if(i.count===0){break;}}}}return r;},_setCurrentCursorPosition:function(e){if(e>=0){var s=window.getSelection();var r=this._createRange($("#"+this.getDomRef("input").id)[0],{count:e});if(r){r.collapse(false);s.removeAllRanges();s.addRange(r);}}},_updateUiModel:function(){var t=this;if(this.getDomRef("input")){var i=this.getDomRef("input").children;t._uiModel=[];for(var o=0;o<i.length;o++){var p=$("#"+i[o].id);var r=p.data("customData");if(r&&i[o]){r.text=i[o].textContent;var s=i[o].getAttribute(h.REFERENCE);if(s){r.reference=r.tokenType!==h.GEOBUSINESSDATATYPE?s:undefined;}}if(p&&p[0]){var u={"id":p[0].getAttribute("id"),"cssClass":p[0].className,"reference":p[0].getAttribute(h.REFERENCE),"tokenType":p[0].getAttribute(h.TOKEN_TYPE),"text":p[0].textContent};if(p[0].getAttribute(h.JSON)){try{u.json=JSON.parse(p[0].getAttribute(h.JSON));}catch(e){q.sap.log.error("Error in parsing string to JSON: "+e.message);}}this._uiModel.push(u);}}t._uiModeltoString();}},_uiModeltoString:function(){var t=this;t.relString="";t._jsonArray=[];this._uiModel.forEach(function(i,e){if(i.reference){t.relString+=i.reference;}else if(i.json){t.relString+=t._constructExpandedRelString(i.json);t._jsonArray.push(i.json);}else{t.relString+=i.text;}});return t.relString;},_isChildOf:function(e,p){while(e!==null){if(e.id===p){return true;}e=e.parentNode;}return false;},_getCurrentCursorPosition:function(){var p=this.getDomRef("input").id;var s=window.getSelection(),e=-1,i;if(s.focusNode){if(this._isChildOf(s.focusNode,p)){i=s.focusNode;e=s.focusOffset;while(i){if(i.id===p){break;}if(i.previousSibling){i=i.previousSibling;e+=i.textContent.length;}else{i=i.parentNode;if(i===null){break}}}}}return e;},_validateControl:function(){var v=this.getValueState();var e=this.getValueStateText();if((this.astresponseNodes&&this.astresponseNodes.length===1&&this.astresponseNodes[0].Type==="I")&&this.astresponseNodes[0].Value!==""||(v==="Error")){this._input[0].classList.add("sapAstExpressionInputError");if(e){this._input[0].title=e;}else{this._input[0].title=this.oBundle.getText("invalidExpression");}}else{this._input[0].classList.remove("sapAstExpressionInputError");}}});return n;},true);

sap.ui.define(["sap/rules/ui/ast/autoComplete/dataStructure/Stack","sap/rules/ui/ast/provider/TermsProvider","sap/rules/ui/ast/provider/OperatorProvider","sap/rules/ui/ast/provider/FunctionProvider","sap/rules/ui/ast/parser/bundlelibrary","sap/rules/ui/ast/constants/Constants","sap/rules/ui/ast/autoComplete/node/TermNode","sap/rules/ui/ast/autoComplete/dataStructure/ComparisionOperatorStack","sap/rules/ui/ast/autoComplete/dataStructure/FunctionalStack","sap/rules/ui/ast/autoComplete/node/OperatorNode","sap/rules/ui/ast/autoComplete/dataStructure/ArrayAndRangeStack"],function(S,T,O,F,a,C,b,c,d,e,A){'use strict';var f=a.getInstance();var g=function(){this._autoCompleteStack=new S();this.oBundle=sap.ui.getCore().getLibraryResourceBundle("sap.rules.ui.i18n");};g.prototype._getAutoSuggestionSkeleton=function(){var o={"autoComplete":{"categories":{},"showLiteral":false}};this._aValueSources={};return o;};g.prototype._getResultDOIdForTheGivenText=function(t){var r=t;for(var h in this._aRules){if(this._aRules[h].Id===t){r=this._aRules[h].ResultDataObjectId;return r;}}return r;};g.prototype.getSuggestions=function(t,E,s,D){var o=this._getAutoSuggestionSkeleton();var r;var h;var i;var I=s.AttributeContext;var j=s.AssociationContext;var k=s.OperationsContext;this._aValueSources=D.ValueSources;this._aDataObjects=D.DataObjects;this._aRules=D.Rules;this._autoCompleteStack.empty();if(E&&E.length>0){if(t&&t.length>0){var l=t[t.length-1].getText();if(I||j){l=l.replace(".","");l=l.replace(/\//g,".");l=l.replace(".","");}r=this._pushTokensToAutoCompleteStack(t);h=this._getTopNodeOfAutomCompleteStack();i=this._getTopStackofAutoCompleteStack();o["autoComplete"]["categories"]["terms"]=[];var m=[];var n;var p;if((I||j)&&r&&r.errorCode==1){n=r.expectedBusinessDataTypeList;if(i&&"getTermPrefixId"in i&&i.getTermPrefixId()){l=i.getTermPrefixId()+C.DOT+l;}if(I){for(p=0;p<n.length;p++){m=m.concat(T.getInstance()._getAllAttributesByPrefixIdAndBusinessType(l,n[p]));}}m=m.concat(T.getInstance().getAssociationsGivenPrefixId(l));o["autoComplete"]["categories"]["terms"]=this._transformTermsToUiModel(m);return o;}if(r){return o;}else if(I||j){if(i&&"getTermPrefixId"in i&&i.getTermPrefixId()){l=i.getTermPrefixId()+C.DOT+l;}var q=this._getResultDOIdForTheGivenText(l);if(I){m=m.concat(T.getInstance()._getAttributesGivenPrefixId(q));}m=m.concat(T.getInstance().getAssociationsGivenPrefixId(q));o["autoComplete"]["categories"]["terms"]=this._transformTermsToUiModel(m);return o;}else{}}for(var u=0;u<E.length;u++){this._updateAutoCompleteJsonBasedOnTokenCandidate(E[u],o,h,i,k,I);}}return o;};g.prototype._getTopNodeOfAutomCompleteStack=function(){var n;if(this._autoCompleteStack.getSize()>0){n=this._getNodeRecursively(this._autoCompleteStack.getTop());}return n;};g.prototype._getTopStackofAutoCompleteStack=function(){var t;if(this._autoCompleteStack.getSize()>0){t=this._getTopStackRecursively(this._autoCompleteStack.getTop());}return t;};g.prototype._updateAutoCompleteJsonBasedOnTokenCandidate=function(h,o,t,i,I,j){var l=this._getLastFunctionStack();var k;if(l){k=this._getNodeRecursively(l.peek(0));}var m;var n;var p=o["autoComplete"]["categories"];switch(h){case f.IDPLexer.LROUNDB:if(I&&!l){break;}this._constructMiscellaneousTokens(o,C.LEFTPARENTHESISTEXT,this.oBundle.getText("LEFTPARENTHESISLABEL"));break;case f.IDPLexer.LSQUAREB:this._constructMiscellaneousTokens(o,C.LEFTSQUAREPARENTHESISTEXT,this.oBundle.getText("LEFTSQUAREPARENTHESISLABEL"));break;case f.IDPLexer.RROUNDB:if(l&&!this._hasAnyOfStackContainsLeftParenthesis()){m=l.getSize();n=l.getFunction();if(n&&m<n.getNoOfMandatoryArgs()){break;}}this._constructMiscellaneousTokens(o,C.RIGHTPARENTHESISTEXT,this.oBundle.getText("RIGHTPARENTHESISLABEL"));break;case f.IDPLexer.RSQUAREB:this._constructMiscellaneousTokens(o,C.RIGHTSQUAREPARENTHESISTEXT,this.oBundle.getText("RIGHTSQUAREPARENTHESISLABEL"));break;case f.IDPLexer.COMMA:if(l&&!this._hasAnyOfStackContainsGivenStackType(A)){m=l.getSize();n=l.getFunction();if(n&&n.getNumberOfArguments()!="*"&&m>=n.getNumberOfArguments()){break;}}this._constructMiscellaneousTokens(o,C.COMMATEXT,this.oBundle.getText("COMMALABEL"));break;case f.IDPLexer.RANGE_DOTS:this._constructMiscellaneousTokens(o,C.RANGETEXT,this.oBundle.getText("RANGELABEL"));break;case f.IDPLexer.ARRAY_OPERATOR:this._constructFunctionalArrayAndRangeOperatorsAutoComplete(o,C.ARRAY,t,i,I);break;case f.IDPLexer.RANGE_OPERATOR:this._constructFunctionalArrayAndRangeOperatorsAutoComplete(o,C.RANGE,t,i,I);break;case f.IDPLexer.WINDOW_FUNCTION_NAME:case f.IDPLexer.ADVANCED_FUNCTION_NAME:case f.IDPLexer.FUNCTION_NAME:case f.IDPLexer.DATE_TIME_FUNCTION_NAME:this._constructFunctionsAutocomplete(o,t,i,I);break;case f.IDPLexer.AND:this._constructOperatorsAutocomplete(o,C.LOGICAL,C.AND,t,i,I);break;case f.IDPLexer.OR:this._constructOperatorsAutocomplete(o,C.LOGICAL,C.OR,t,i,I);break;case f.IDPLexer.ID:if(I&&l&&l.getFunction().getCategory()=="operations"&&l.getSize()<1){break;}if(I&&!l){break;}if(p["terms"]==undefined){p["terms"]=[];}if(t&&"getTermPrefixId"in t&&t.getTermPrefixId()&&t.getTermPrefixId()!=""){p["terms"]=this._transformTermsToUiModel(T.getInstance()._getAllAttrsAndAssocsForDataObject(t.getTermPrefixId()));}else if(i&&"getTermPrefixId"in i&&i.getTermPrefixId()&&i.getTermPrefixId()!=""){p["terms"]=this._transformTermsToUiModel(T.getInstance()._getAllAttrsAndAssocsForDataObject(i.getTermPrefixId()));}else{p["terms"]=this._transformTermsToUiModel(T.getInstance()._getAllDataObjects());var v=T.getInstance()._getAllVocabularyRules();if(v.length>0){var q=this._transformTermsToUiModel(v);for(var r in q){p["terms"].push(q[r]);}}}break;case f.IDPLexer.NUMERIC_LITERAL_UNIT:case f.IDPLexer.BOOL:case f.IDPLexer.NUMERIC_LITERAL:case f.IDPLexer.STRING:case f.IDPLexer.PARTIALTIME:case f.IDPLexer.FULLTIME:case f.IDPLexer.DATETIME:case f.IDPLexer.GEOJSON_POINT:case f.IDPLexer.GEOJSON_POLYGON:if(I&&l&&l.getFunction().getCategory()=="operations"&&(l.getSize()<=1||k&&"getDataObjectType"in k&&k.getDataObjectType()=="T")){break;}if(I&&!l){break;}o.autoComplete.showLiteral=true;var s="";var u;if(i&&i instanceof c&&i.getPrevious()){s=O.getInstance().getOperatorByName(i.getName()).getReturnValueBussinessDataTypeCollection();if("getId"in i.getPrevious()){u=i.getPrevious().getId();}}if(t&&"getProbableBusinessDataReturnTypeList"in t){s=t.getProbableBusinessDataReturnTypeList();if(t.getPrevious()){var P=this._getNodeRecursively(t.getPrevious());if(P instanceof b&&P.getId()){u=P.getId();}}}o.businessDataTypeList=s;if(u===undefined){u=i&&i._previous?i._previous._id:undefined;}if(u){var w=T.getInstance().getTermByTermId(u);if(w.getIsDataObjectElement()){u=u+"."+u;w=T.getInstance().getTermByTermId(u);}if(w&&w.getHasValueSource()){var V={};var x;V.vocabularyId=w.getVocaId();var y=w.getTermId().split(".");var D=y[y.length-2];var z=y[y.length-1];V.dataObjectId=D;V.attributeId=z;V.attributeName=w._label;V.attributeDataType=w._bussinessDataType;for(var B=0;B<this._aValueSources.length;B++){x=this._aValueSources[B];if(x.AttributeId==z){V.sourceType=x.SourceType;break;}}o.autoComplete.valuehelp=V;}}break;case f.IDPLexer.FUNCTIONAL_OPERATOR:this._constructFunctionalArrayAndRangeOperatorsAutoComplete(o,C.FUNCTIONAL,t,i,I);break;case f.IDPLexer.LESS_THAN:this._constructOperatorsAutocomplete(o,C.COMPARISION,C.LESS_THAN,t,i,I);break;case f.IDPLexer.GREATER_THAN:this._constructOperatorsAutocomplete(o,C.COMPARISION,C.GREATER_THAN,t,i,I);break;case f.IDPLexer.LESS_THAN_EQUAL:this._constructOperatorsAutocomplete(o,C.COMPARISION,C.LESS_THAN_EQUAL,t,i,I);break;case f.IDPLexer.GREATER_THAN_EQUAL:this._constructOperatorsAutocomplete(o,C.COMPARISION,C.GREATER_THAN_EQUAL,t,i,I);break;case f.IDPLexer.NOT_EQUAL:this._constructOperatorsAutocomplete(o,C.COMPARISION,C.NOT_EQUAL,t,i,I);break;case f.IDPLexer.EQUAL:this._constructOperatorsAutocomplete(o,C.COMPARISION,C.EQUAL,t,i,I);break;case f.IDPLexer.MULT:this._constructOperatorsAutocomplete(o,C.ARITHMETIC,C.MULT,t,i,I);break;case f.IDPLexer.LOGICAL_NOT:break;case f.IDPLexer.DIV:this._constructOperatorsAutocomplete(o,C.ARITHMETIC,C.DIV,t,i,I);break;case f.IDPLexer.ADD:this._constructOperatorsAutocomplete(o,C.ARITHMETIC,C.ADD,t,i,I);break;case f.IDPLexer.MINUS:this._constructOperatorsAutocomplete(o,C.ARITHMETIC,C.MINUS,t,i,I);break;case f.IDPLexer.OPERATION_FUNCTION_NAME:if(I){this._constructOperationsAutocomplete(o,t,i);}break;default:break;}};g.prototype._constructMiscellaneousTokens=function(o,n,l){var h=null;var i=o["autoComplete"]["categories"];if(i["operators"]==undefined){i["operators"]={};}h=i["operators"];if(h["miscellaneous"]==undefined){h["miscellaneous"]=[];}h["miscellaneous"].push({name:n,label:l});};g.prototype._pushTokensToAutoCompleteStack=function(t){var r;for(var l=0;l<t.length;l++){r=this._autoCompleteStack.push(t[l]);if(r&&r.bTokenPushed==false){return r;}}};g.prototype._getNodeRecursively=function(n){while(n&&"getTop"in n&&n.getTop()){n=n.getTop();}return n;};g.prototype._getTopStackRecursively=function(n){var p=n;while(n&&"getTop"in n&&n.getTop()){p=n;n=n.getTop();}return p;};g.prototype._hasAnyOfStackContainsLeftParenthesis=function(){var n=this._autoCompleteStack;while(n&&"getTop"in n&&n.getTop()){if(n&&!(n instanceof d)&&!(n instanceof A)&&n.getHasOpenParenthesis()){return true;}n=n.getTop();}return false;};g.prototype._hasAnyOfStackContainsGivenStackType=function(s){var n=this._autoCompleteStack;while(n&&"getTop"in n&&n.getTop()){if(n instanceof s){return true;}n=n.getTop();}return false;};g.prototype._constructFunctionalArrayAndRangeOperatorsAutoComplete=function(o,h,t,i,I){var j=O.getInstance().getAllOperatorsByCategory(h);for(var l=0;l<j.length;l++){this._constructOperatorsAutocomplete(o,h,j[l].getName(),t,i,I);}};g.prototype._constructOperatorsAutocomplete=function(o,h,i,t,j,I){var l=this._getLastFunctionStack();var k;if(l){k=this._getNodeRecursively(l.peek(0));}if(I&&l&&l.getFunction().getCategory()=="operations"&&(l.getSize()<=1||k&&"getDataObjectType"in k&&k.getDataObjectType()=="T")){return;}if(I&&!l){return;}var m=false;var n;var p=o["autoComplete"]["categories"];var q=null;var B=null;var D=null;var r=false;if(p["operators"]==undefined){p["operators"]={};}q=p["operators"];if(q[h]==undefined){q[h]=[];}n=O.getInstance().getOperatorByName(i);if(h===C.LOGICAL||h===C.COMPARISION){if(j&&j instanceof S&&"isContextComparision"in j&&j.isContextComparision()&&t&&t.getBusinessDataType()==j.getComparisionLeftOperandBusinessType()){q[h].push(this._transformOperatorsToUiModel(n));r=true;}}if(t&&!r){if("getProbableBusinessDataReturnTypeList"in t&&t.getProbableBusinessDataReturnTypeList()&&t.getProbableBusinessDataReturnTypeList().length>0){m=true;var s=t.getProbableBusinessDataReturnTypeList();for(var u=0;u<s.length;u++){var v=s[length];if(v==C.NUMBERBUSINESSDATATYPE){m=false;}}}if("getBusinessDataType"in t){B=t.getBusinessDataType();D=t.getDataObjectType();m=true;}}if(!m&&!r){q[h].push(this._transformOperatorsToUiModel(n));}if(B&&D&&n&&n.getReturnValueBussinessDataTypeCollection()[B]&&n.getReturnValueDataObjectTypeCollection()[D]&&!r){q[h].push(this._transformOperatorsToUiModel(n));}};g.prototype._constructFunctionsAutocomplete=function(o,t,h,i,s){var j=o["autoComplete"]["categories"];var B=[];var D=[];var k;var l,m,n;if(j["functions"]==undefined){j["functions"]={};}var p=[];var p=F.getInstance().getAllFunctions(s);var q=this._getLastFunctionStack();if(q){var r=q.getSize();var u=q.getFunction().getArgumentsMetadata();if(u==undefined||u.length==0){return;}if(h.getSize()!=0){this._categorizeFunctionsWhenPreviousNodeIsOperator(t,p,h,j,i);}else{var v=u[r-1];if(r==0||!("referenceIndex"in v)){if("businessDataTypeList"in v){B=v.dataObjectTypeList;D=v.businessDataTypeList;for(var m=0;m<B.length;m++){for(var n=0;n<D.length;n++){this._categorizeFunctionsByCatgory_BusinessDataType_DataObjectType(j,s,B[m],D[n],i);}}}else{D=v.businessDataTypeList;for(var w=0;w<D.length;w++){p=F.getInstance().getAllFunctionsGivenCategoryAndDataObjectType(sCategory,D[w]);for(l=0;l<p.length;l++){k=p[l];this._categorizeFunctions(k,j["functions"],i);}}}}else if("referenceIndex"in v&&v.referenceIndex!=-1){var x=this._getNodeRecursively(q.peek(v.referenceIndex));var y=x.getBusinessDataType();var z=x.getDataObjectType();B=v["referenceBusinessDataTypeCollection"][y]?Object.keys(v["referenceBusinessDataTypeCollection"][y]):[];D=v["referenceDataObjectTypeCollection"][z]?Object.keys(v["referenceDataObjectTypeCollection"][z]):[];for(var m=0;m<B.length;m++){for(var n=0;n<D.length;n++){this._categorizeFunctionsByCatgory_BusinessDataType_DataObjectType(j,s,B[m],D[n],i);}}}else{}}}else if(t&&t.getPrevious()){this._categorizeFunctionsWhenPreviousNodeIsOperator(t,p,h,j,i);}else{for(l=0;l<p.length;l++){k=p[l];this._categorizeFunctions(k,j["functions"],i);}}};g.prototype._categorizeFunctionsByCatgory_BusinessDataType_DataObjectType=function(o,s,B,D,i){var h=F.getInstance().getAllFunctionsGivenCategoryAndDataObjectAndBusinessDataType(s,D,B);for(var l=0;l<h.length;l++){oFunction=h[l];this._categorizeFunctions(oFunction,o["functions"],i);}};g.prototype._getLastFunctionStack=function(){var o;var n=this._autoCompleteStack;var p=n;while(n&&"getTop"in n&&n.getTop()){if(n instanceof d){o=n;}n=n.getTop();}if(n&&n instanceof d){o=n;}return o;};g.prototype._constructOperationsAutocomplete=function(o,t,h){if(!t){var i=null;var j=o["autoComplete"]["categories"];if(j["operations"]==undefined){j["operations"]=[];}i=j["operations"];i.push({name:C.UPDATE,label:this.oBundle.getText("UPDATELABEL")});}var k=i;if(t&&t.getPrevious()){var p=t.getPrevious();p=this._getNodeRecursively(p);var B=[];}};g.prototype._checkPreviousOperatorHasSupportedFunctions=function(t){if(t&&"getOperator"in t){var o=t.getOperator();if(o&&"getSupportedFunctions"in o&&o.getSupportedFunctions()){return true}}return false;};g.prototype._checkOperatorCompatitbilityWithFunction=function(o,t){if(t&&"getOperator"in t){var h=t.getOperator();if(h&&"getSupportedFunctions"in h&&h.getSupportedFunctions()){var s=h.getSupportedFunctions();for(var l=0;l<s.length;l++){if(s[l].name.toUpperCase()===o.getName()){return true;}}}}return false;};g.prototype._categorizeFunctions=function(o,h,i){var l=this._getLastFunctionStack();if(l&&l.getFunction().getCategory()=="operations"&&l.getSize()<=1){return;}if(i&&!(o.getContext().toUpperCase()=="RESULT")&&!(l)){return;}var j=o.getCategory();var t={};if(h[j]==undefined){h[j]=[];}t.name=o.getName();t.label=o.getLabel();t.noOfMandatoryArgs=o.getNoOfMandatoryArgs();var k=h[j];for(var m=0;m<k.length;m++){var s=k[m].name;if(t.name.toUpperCase()==s.toUpperCase()){return;}}h[j].push(t);};g.prototype._transformTermsToUiModel=function(t){var h=[];var i;var u;var n;var j;var l;for(var k=0;k<t.length;k++){i=t[k];u={};n=i.getTermName();if(n){l=n.split(".").length;if(l>0){n=n.split(".")[l-1];}}u.name=n;j=i.getTermId();if(j){j=i.getTermId();l=j.split(".").length;if(l>0){j=j.split(".")[l-1];}}u.isParentEntity=i._bussinessDataType===null?true:false;if(i.ResultDataObjectId){u.ResultDataObjectId=i.ResultDataObjectId;u.isParentEntity=true;}u.id=j;u.label=i.getLabel();u.type=i.getDataObjectType();h.push(u);}return h;};g.prototype._transformOperatorsToUiModel=function(o){var t={};t.name=o.getName();t.label=o.getLabel();return t;};g.prototype._getCandidateName=function(o){for(var t in f.IDPLexer){if(f.IDPLexer[t]==o){return t;}}};g.prototype._catgorizeAggregate=function(B,o,D,h,i){for(var l=0;l<B.length;l++){if(this._checkBusinessDataTypeCompatibilityWithFunctionArgs(o,B[l])){for(var j=0;j<D.length;j++){if(this._checkDataObjectCompatibilityWithFunctionArgs(o,D[j])){this._categorizeFunctions(o,h["functions"],i);}}}}};g.prototype._categorizeFunctionsWhenPreviousNodeIsOperator=function(t,h,o,i,I){var B=[];var D=[];var p=this._getNodeRecursively(t.getPrevious());var j;var l=this._getLastFunctionStack();if(p){if(t&&"getProbableBusinessDataReturnTypeList"in t){B=t.getProbableBusinessDataReturnTypeList();}else if("getBusinessDataType"in p){B.push(p.getBusinessDataType());}if(B===undefined||B===null||B.length==0){if("getBusinessDataType"in p){B=[];B.push(p.getBusinessDataType());}}if(t&&"getProbableDataObjectReturnTypeList"in t){D=t.getProbableDataObjectReturnTypeList();}else if("getDataObjectType"in p){D.push(p.getDataObjectType());}if(D===undefined||D===null||D.length==0){if("getDataObjectType"in p){D=[];D.push(p.getDataObjectType());}}if(B.length>0||D.length>0){for(var k=0;k<h.length;k++){j=h[k];if(this._checkPreviousOperatorHasSupportedFunctions(o)){if(this._checkOperatorCompatitbilityWithFunction(j,o)){this._categorizeFunctions(j,i["functions"],I);}}else if(B==undefined||B.length==0){for(var m=0;m<D.length;m++){if("getProbableDataObjectTypeList"in j&&j.getProbableDataObjectTypeList()&&j.getProbableDataObjectTypeList().includes(D[m])){this._categorizeFunctions(j,i["functions"],I);}}}else if((j.getCategory().toUpperCase()=="SELECTION"||j.getCategory().toUpperCase()=="AGGREGATE")&&!(l&&l.getFunction().getCategory()=="operations"&&l.getSize()!=2)){this._categorizeFunctions(j,i["functions"],I);}else{for(var n=0;n<B.length;n++){if("getProbableBusinessDataTypeList"in j&&j.getProbableBusinessDataTypeList()&&j.getProbableBusinessDataTypeList().includes(B[n])){for(var m=0;m<D.length;m++){if("getProbableDataObjectTypeList"in j&&j.getProbableDataObjectTypeList()&&j.getProbableDataObjectTypeList().includes(D[m])){this._categorizeFunctions(j,i["functions"],I);}}}}}}}else{for(var k=0;k<h.length;k++){j=h[k];this._categorizeFunctions(j,i["functions"],I);}}}};return g;});

/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)

        (c) Copyright 2009-2015 SAP SE. All rights reserved
    
 */
sap.ui.define(["sap/base/Log","./Billboard","./Callout","./PerspectiveCamera","./OrthographicCamera","./DetailView","../totara/TotaraUtils","./AnimationHelper","./Thrustline","../BillboardCoordinateSpace","../BillboardTextEncoding","../BillboardStyle","../BillboardBorderLineStyle","../BillboardHorizontalAlignment","../LeaderLineMarkStyle","../DetailViewType","../DetailViewShape","../AnimationPlayback","../RenderMode","../View"],function(L,B,C,P,O,D,T,A,a,c,d,f,g,h,j,k,m,n,R,V){"use strict";var S=function(b,e,i,l){this._id=S._nextId++;S.add(this);this._parentNode=b;this._contentResource=e;this._resolve=i;this._reject=l;this._nodes=new Map();this._meshes=new Map();this._callouts=new Map();this._cameras=new Map();this._materials=new Map();this._images=new Map();this._viewportGroups=new Map();this._modelViews=new Map();this._modelViewThumbnails=new Map();this._animations=new Map();this._animationTracks=new Map();this._parentNode.userData.skipIt=!e.name;var I=e.getNodeProxy();var J=I.getNodeHierarchy();this._vkScene=J.getScene();this._thrustlines=new Map();this._trackIdSequenceNodeMap=new Map();var K=this._parentNode;while(K.parent){K=K.parent;}if(!K.userData){K.userData={};}K.userData.animations=this._animations;K.userData.animationTracks=this._animationTracks;this._animationHelper=new A();};S._nextId=1;S._map=new Map();S.add=function(b){this._map.set(b.getId(),b);return this;};S.getById=function(i){return this._map.get(i);};S.prototype.getId=function(){return this._id;};var r=[R.Default,R.Default,R.Default,R.LineIllustration,R.SolidOutline,R.ShadedIllustration];S.prototype.setScene=function(i){if(i.result!==1){this._reject(i.result);}else{var b=this._cameras.get(i.cameraRef);this._resolve({node:this._parentNode,camera:b,backgroundTopColor:i.backgroundTopColor,backgroundBottomColor:i.backgroundBottomColor,renderMode:r[i.renderMethod],contentResource:this._contentResource,builder:this});}};S.prototype._addDynamicObject=function(b,e){if(!this._parentNode.userData._vkDynamicObjects){this._parentNode.userData._vkDynamicObjects=[];}this._parentNode.userData._vkDynamicObjects.push(b);b._vkUpdate=e;};S.prototype.createNode=function(i){var b=this._nodes.get(i.parentRef)||null;var e=new THREE.Group();e.name=i.name;e.visible=i.visible;e.matrix.fromArray(i.matrix);e.matrix.decompose(e.position,e.quaternion,e.scale);e.userData.closed=i.closed;e.userData.selectable=i.selectable;e.userData.metadata=i.metadata;e.userData.veids=i.veids;if(i.visualisable===false){e.userData.skipIt=true;}(b||this._parentNode).add(e);if(e.visible){while(b){b.visible=e.visible;b=b.parent;}}this._nodes.set(i.nodeRef,e);if(i.transformType){e.userData.transformType=i.transformType;switch(i.transformType){case 1:this._addDynamicObject(e,B.prototype._billboardViewUpdate);break;case 257:this._addDynamicObject(e,B.prototype._lockToViewportUpdate);break;default:break;}}};var o=new Float32Array([0.0,0.0,1.0,0.0,0.0,1.0,0.0,0.0,1.0,0.0,0.0,1.0,0.0,0.0,-1.0,0.0,0.0,-1.0,0.0,0.0,-1.0,0.0,0.0,-1.0,0.0,1.0,0.0,0.0,1.0,0.0,0.0,1.0,0.0,0.0,1.0,0.0,0.0,-1.0,0.0,0.0,-1.0,0.0,0.0,-1.0,0.0,0.0,-1.0,0.0,1.0,0.0,0.0,1.0,0.0,0.0,1.0,0.0,0.0,1.0,0.0,0.0,-1.0,0.0,0.0,-1.0,0.0,0.0,-1.0,0.0,0.0,-1.0,0.0,0.0]);var p=new Uint16Array([0,1,2,2,1,3,4,6,5,5,6,7,8+0,8+1,8+2,8+2,8+1,8+3,8+4,8+6,8+5,8+5,8+6,8+7,16+0,16+1,16+2,16+2,16+1,16+3,16+4,16+6,16+5,16+5,16+6,16+7]);S.prototype.createMesh=function(i){var b=i.boundingBox;var e=new Float32Array([b[0],b[1],b[5],b[3],b[1],b[5],b[0],b[4],b[5],b[3],b[4],b[5],b[0],b[1],b[2],b[3],b[1],b[2],b[0],b[4],b[2],b[3],b[4],b[2],b[0],b[4],b[5],b[3],b[4],b[5],b[0],b[4],b[2],b[3],b[4],b[2],b[0],b[1],b[5],b[3],b[1],b[5],b[0],b[1],b[2],b[3],b[1],b[2],b[3],b[1],b[5],b[3],b[1],b[2],b[3],b[4],b[5],b[3],b[4],b[2],b[0],b[1],b[5],b[0],b[1],b[2],b[0],b[4],b[5],b[0],b[4],b[2]]);var l=new THREE.BufferGeometry();l.setIndex(new THREE.BufferAttribute(p,1));l.addAttribute("position",new THREE.BufferAttribute(e,3));l.addAttribute("normal",new THREE.BufferAttribute(o,3));var I=new THREE.Mesh(l,this._materials.get(i.materialRef));this._meshes.set(i.meshRef,I);if(i.matrix){I.matrix.fromArray(i.matrix);I.matrix.decompose(I.position,I.quaternion,I.scale);}};S.prototype.setMeshGeometry=function(b){var e=this._meshes.get(b.meshRef);var I=b.data;var J=new THREE.BufferGeometry();J.setIndex(new THREE.BufferAttribute(I.index,1));J.addAttribute("position",new THREE.BufferAttribute(I.position,3));if(I.normal){J.addAttribute("normal",new THREE.BufferAttribute(I.normal,3));}if(I.uv){J.addAttribute("uv",new THREE.BufferAttribute(I.uv,2));}if(b.flags&1){for(var i=0,l=e.parent.children.length;i<l;i++){if(e.parent.children[i]===e){var K=new THREE.LineSegments(J,new THREE.LineBasicMaterial({color:e.material.color}));e.parent.children[i]=K;K.parent=e.parent;e.parent=null;break;}}}else{e.geometry.copy(J);if(!I.normal&&e.material&&e.material.emissive){e.material.emissive.copy(e.material.color);}}if(this._fireSceneUpdated){this._fireSceneUpdated();}};S.prototype.insertMesh=function(b,e){var i=this._nodes.get(b);var l=this._meshes.get(e);i.add(l.parent?l.clone():l);};var q=[d.PlainText,d.HtmlText];var s=[f.RectangularShape,f.CircularShape,f.None,f.TextGlow];var t=[g.None,g.Solid,g.Dash,g.Dot,g.DashDot,g.DashDotDot];var u=[h.Left,h.Center,h.Right];var v=[j.None,j.Point,j.Arrow];function w(b){var e=b.toString(16);return"#"+"000000".substring(e.length)+e;}function x(b){for(var i=0,l=b.length;i<l;i++){if(!isFinite(b[i])){return false;}}return true;}S.prototype.createTextAnnotation=function(i){if(!x(i.position)){return;}var b=this._nodes.get(i.nodeRef);if(b){var e=new B({node:b,coordinateSpace:c.Viewport,renderOrder:3,position:new THREE.Vector3().fromArray(i.position),encoding:q[i.encoding],font:i.font,fontSize:i.fontSize,fontWeight:Math.min(i.fontWeight,900),fontItalic:i.fontItalic,style:s[i.style],width:i.width,height:i.height,textColor:w(i.textColor),backgroundColor:w(i.backgroundColor),backgroundOpacity:i.backgroundOpacity,borderColor:w(i.borderColor),borderOpacity:i.borderOpacity,borderWidth:i.borderWidth,borderLineStyle:t[i.borderLineStyle],horizontalAlignment:u[i.horizontalAlignment],link:i.link});e.setText(i.text);this._addDynamicObject(b,e._update.bind(e));}};S.prototype.createImageNote=function(i){var b=this._nodes.get(i.nodeRef);if(b){var e=this._materials.get(i.materialRef);var l=new B({node:b,coordinateSpace:c.Screen,renderOrder:2,position:new THREE.Vector3().fromArray(i.position),width:i.width,height:i.height,texture:e?e.emissiveMap:null});this._addDynamicObject(b,l._update.bind(l));}};S.prototype.createTextNote=function(i){var b=this._nodes.get(i.nodeRef);if(b){var e=new C({node:b,anchorNode:this._nodes.get(i.targetNodeRef)||this._parentNode,coordinateSpace:c.World,position:new THREE.Vector3().fromArray(i.position),renderOrder:i.alwaysOnTop?1:0,depthTest:!i.alwaysOnTop,encoding:q[i.encoding],font:i.font,fontSize:i.fontSize,fontWeight:Math.min(i.fontWeight,900),fontItalic:i.fontItalic,style:s[i.style],width:i.width,height:i.height,textColor:w(i.textColor),backgroundColor:w(i.backgroundColor),backgroundOpacity:i.backgroundOpacity,borderColor:w(i.borderColor),borderOpacity:i.borderOpacity,borderWidth:i.borderWidth,borderLineStyle:t[i.borderLineStyle],horizontalAlignment:u[i.horizontalAlignment],link:i.link});e.setText(i.text);this._callouts.set(b,e);this._addDynamicObject(b,e._update.bind(e));}};S.prototype.insertLeaderLine=function(b){var e=this._nodes.get(b.nodeRef);var l=this._nodes.get(b.targetNodeRef)||this._parentNode;var I=this._materials.get(b.materialRef);var J=this._callouts.get(e);if(J){var K=[];for(var i=0;i<b.points.length;i+=3){K.push(new THREE.Vector3().fromArray(b.points,i));}J.addLeaderLine(K,l,I,v[b.startPointStyle],v[b.endPointStyle],b.styleConstant,b.extensionLength);}};S.prototype.createCamera=function(i){var b=null;if(i.projection==="perspective"){b=new P();b.setFov(i.fov);}else if(i.projection==="orthographic"){b=new O();b.setZoomFactor(i.orthoZoomFactor);}if(b){b.setNearClipPlane(i.nearClip);b.setFarClipPlane(i.farClip);b.setUsingDefaultClipPlanes(i.autoEvaluateClipPlanes);var e=new THREE.Vector3().fromArray(i.origin);var l=new THREE.Vector3().fromArray(i.target).sub(e);var I=new THREE.Vector3().fromArray(i.up).sub(e);b.setUpDirection(I.toArray());b.setPosition(e.toArray());b.setTargetDirection(l.toArray());}this._parentNode.userData.camera=b;this._cameras.set(i.cameraRef,b);};S.prototype.insertCamera=function(b,e){var i=this._nodes.get(b);var l=this._cameras.get(e);l=l?l.getCameraRef():null;if(i&&l){(i||this._parentNode).add(l.parent?l.clone():l);}};S.prototype.createViewportGroup=function(i){var b=this._parentNode;while(b.parent){b=b.parent;}var e={name:i.name,type:i.type,description:i.description,metadata:i.metadata,veids:i.veids,originalId:i.viewportGroupRef,modelViews:[]};b.userData.viewportGroups=b.userData.viewportGroups||[];b.userData.viewportGroups.push(e);this._viewportGroups.set(i.viewportGroupRef,e);};S.prototype.insertModelView=function(i){var b=new V({name:i.name,description:i.description?"<pre style=\"white-space: pre-wrap;\">"+i.description+"</pre>":i.description});b.camera=this._cameras.get(i.cameraRef);b.type=i.type;b.flyToTime=i.flyToTime;b.preDelay=i.preDelay;b.postDelay=i.postDelay;b.navigationMode=i.navigationMode;b.topColor=i.topColor;b.bottomColor=i.bottomColor;b.renderMode=r[i.renderMethod];b.dimension=i.dimension;b.query=i.query;b.metadata=i.metadata;b.veids=i.veids;b.visibleNodes=[];b.highlights=[];b.viewGroupId=i.viewportGroupRef;b.id=i.modelViewRef.toString();var e=this._viewportGroups.get(i.viewportGroupRef);if(e){e.modelViews.push(b);}this._modelViews.set(i.modelViewRef,b);this._modelViewThumbnails.set(i.thumbnail,b);};S.prototype.setModelViewVisibilitySet=function(i){var b=this._modelViews.get(i.modelViewRef);var e=new Set();i.visibleNodes.forEach(function(l){var I=this._nodes.get(l);if(I){while(I&&!e.has(I)){e.add(I);I=I.parent;}}else{}}.bind(this));b.visibleNodes=Array.from(e);};S.prototype.insertModelViewHighlight=function(i){var b=this._modelViews.get(i.modelViewRef);if(b){var e=[];i.highlightNodes.forEach(function(K){var M=this._nodes.get(K);if(M){e.push(M);}else{}}.bind(this));var l={highlightNodes:e,color1:i.color1,color2:i.color2,opacity1:i.opacity1,opacity2:i.opacity2,duration:i.duration,cycles:i.cycles};if(i.duration===0){l.type="STATIC";}else if(i.duration>0&&i.cycles===0){l.type="INFINITE";}else{l.type="FINITE";}var I=new THREE.Color(i.color1).toArray();var J=new THREE.Color(i.color2).toArray();I[3]=((i.color1>>>24)&255)/255;J[3]=((i.color2>>>24)&255)/255;l.colours=[I,J];l.opacities=[i.opacity1,i.opacity2];this._animationHelper.addAnimationTracksToHighlight(l);b.highlights.push(l);}};S.prototype.createThumbnail=function(i){var b=this._modelViewThumbnails.get(i.imageRef);if(b){b.thumbnailData="data:image/"+"jpeg"+";base64,"+window.btoa(String.fromCharCode.apply(null,i.data));if(this._fireThumbnailLoaded){this._fireThumbnailLoaded({modelView:b});}}};var y=[k.DetailView,k.Cutaway];var z=[m.Box,m.Circle,m.CircleLine,m.CirclePointer,m.CircleArrow,m.CircleBubbles,m.BoxLine,m.BoxNoOutline,m.SolidPointer,m.SolidArrow];S.prototype.createDetailView=function(i){var b=this._nodes.get(i.nodeRef);if(b){var e=new D({name:i.name,camera:this._cameras.get(i.cameraRef),type:y[i.type],shape:z[i.shape],borderWidth:i.borderWidth,backgroundColor:w(i.backgroundColor),borderColor:w(i.borderColor),origin:new THREE.Vector2().fromArray(i.origin),size:new THREE.Vector2().fromArray(i.size),attachmentPoint:new THREE.Vector3().fromArray(i.attachmentPoint),metadata:i.metadata,veId:i.veid});if(!this._parentNode.userData._vkDetailViews){this._parentNode.userData._vkDetailViews=[];}this._parentNode.userData._vkDetailViews.push({detailView:e,node:b,renderOrder:i.renderOrder||0});}};S.prototype.createMaterial=function(i){var b;var l=i.linestyle;if(l.width>0){b=new THREE.LineBasicMaterial({color:new THREE.Color(l.color[0],l.color[1],l.color[2]),linewidth:l.width});b.userData.lineStyle=l;}else{if(i.textures){i.textures.forEach(function(e){var I=new THREE.Texture(this._images.get(e.imageRef),e.type==="reflection"?THREE.SphericalReflectionMapping:THREE.UVMapping,e.repeatX?THREE.RepeatWrapping:THREE.ClampToEdgeWrapping,e.repeatY?THREE.RepeatWrapping:THREE.ClampToEdgeWrapping,e.filterMode===1?THREE.NearestFilter:THREE.LinearFilter,e.filterMode===1?THREE.NearestFilter:THREE.LinearMipMapLinearFilter,undefined,undefined,4);I.offset.set(e.offsetX,e.offsetX);I.repeat.set(e.scaleX,e.scaleY);i[e.type+"Texture"]=I;I.needsUpdate=true;I.influence=e.amount;},this);}b=new THREE.MeshPhongMaterial({name:i.name,opacity:i.opacity,color:new THREE.Color(i.diffuse[0],i.diffuse[1],i.diffuse[2]),shininess:i.glossiness*2+i.specularLevel*3,emissive:new THREE.Color(i.emissive[0]+i.ambient[0]*0.2,i.emissive[1]+i.ambient[1]*0.2,i.emissive[2]+i.ambient[2]*0.2),specular:new THREE.Color(i.specular[0],i.specular[1],i.specular[2]),map:i.diffuseTexture?i.diffuseTexture:null,specularMap:i.specularTexture?i.specularTexture:null,emissiveMap:i.emissiveTexture?i.emissiveTexture:null,envMap:i.reflectionTexture?i.reflectionTexture:null,alphaMap:i.opacityTexture?i.opacityTexture:null,bumpMap:i.bumpTexture?i.bumpTexture:null,transparent:i.opacity<1||!!i.opacityTexture||(i.diffuseTexture&&i.diffuseTexture.image.hasAlpha)||false});if(b.map){b.color.lerp(new THREE.Color(1,1,1),b.map.influence?b.map.influence:0);}if(b.bumpMap){b.bumpScale=b.bumpMap.influence?b.bumpMap.influence:0;}if(b.envMap){b.mapping=THREE.SphericalReflectionMapping;b.combine=THREE.AddOperation;b.reflectivity=b.envMap.influence?b.envMap.influence:0;}}this._materials.set(i.materialRef,b);};S.prototype.createImage=function(i){var b=window.btoa(i.data.reduce(function(b,l){return b+String.fromCharCode(l);},""));var e=new THREE.ImageLoader().load("data:image/"+i.format+";base64,"+b);this._images.set(i.imageRef,e);e.hasAlpha=i.format==="png"&&i.data[25]===6;};S.prototype.insertThrustline=function(i){var b=this._nodes.get(i.thrustlineRef);if(b&&!this._thrustlines.get(i.thrustlineRef)){var e=new a({node:b,principleAxis:new THREE.Vector3().fromArray(i.principleAxis),material:this._materials.get(i.material)});var l=[];var I=0;var J=0;var K=0;for(var M=0;M<i.itemCount;M++){var N={};N.target=this._nodes.get(i.targets[M]);N.majorAxisIndex=i.itemMajorAxisesIndices[M];var Q;N.basisAxises=[];K=I+i.itemBasisAxisesCounts[M];for(Q=I;Q<K;Q++){var U={};U.x=i.itemBasisAxisesCoordinates[Q*3];U.y=i.itemBasisAxisesCoordinates[Q*3+1];U.z=i.itemBasisAxisesCoordinates[Q*3+2];N.basisAxises.push(U);}I=K;N.dimension={};N.dimension.x=i.itemDimensionsCoordinates[M*3];N.dimension.y=i.itemDimensionsCoordinates[M*3+1];N.dimension.z=i.itemDimensionsCoordinates[M*3+2];N.center={};N.center.x=i.itemCentersCoordinates[M*3];N.center.y=i.itemCentersCoordinates[M*3+1];N.center.z=i.itemCentersCoordinates[M*3+2];N.boundPoints=[];K=J+i.itemBoundPointsCounts[M];for(Q=J;Q<K;Q++){var W={};W.x=i.itemBoundPointsCoordinates[Q*3];W.y=i.itemBoundPointsCoordinates[Q*3+1];W.z=i.itemBoundPointsCoordinates[Q*3+2];N.boundPoints.push(W);}J=K;l.push(N);}e.setItems(l);var X=0;var Y=[];for(var Z=0;Z<i.segmentCount;Z++){var $={};$.startItemIndex=i.segmentsStartItemIndices[Z];$.endItemIndex=i.segmentsEndItemIndices[Z];$.startBoundIndex=i.segmentsStartBoundIndices[Z];$.endBoundIndex=i.segmentsEndBoundIndices[Z];$.ratios=[];K=X+i.segmentRatioCounts[Z];for(var _=0;_<K;_++){var a1={};a1.x=i.segmentRatiosCoordinates[_*2];a1.y=i.segmentRatiosCoordinates[_*2+1];$.ratios.push(a1);}X=K;Y.push($);}e.setSegments(Y);this._thrustlines.set(i.thrustlineRef,e);this._addDynamicObject(b,e._update.bind(e));}};S.prototype.insertAnimationGroup=function(i){var b=this._vkScene.getAnimationSequence(i.animationGroupRef.toString());if(!b){var e;if(i.endTime){if(!i.startTime){i.startTime=0;}e=i.endTime-i.startTime;}b=this._vkScene.createAnimationSequence(i.animationGroupRef.toString(),i.name,e);if(!b.userData){b.userData={};}b.userData.animations=[];}if(i.modelViewRef){var l=this._modelViews.get(i.modelViewRef);if(l){var I=new n({sequenceId:i.animationGroupRef.toString(),timeScale:i.playbackSpeed?i.playbackSpeed:1,preDelay:i.playbackPreDelay?i.playbackPreDelay:0,postDelay:i.playbackPostDelay?i.playbackPostDelay:0,repeat:i.playbackRepeat?Math.abs(i.playbackRepeat):0,reversed:i.playbackReversed?true:false,startTime:0});var J=l.getPlaybacks();if(!J){J=[];}J.push(I);l.setPlaybacks(J);}}};S.prototype.insertAnimation=function(i){var b=this._animations.get(i.animationRef);if(!b){b={};b.type=i.animationType;b.targetRefs=[];b.targetPivots=[];b.sequenceId=i.animationGroupRef.toString();b.animationTracks=new Set();this._animations.set(i.animationRef,b);}if(i.animationGroupRef){var e=this._vkScene.getAnimationSequence(i.animationGroupRef.toString());if(!e.userData.animations.includes(i.animationRef)){e.userData.animations.push(i.animationRef);}}};S.prototype.insertAnimationTarget=function(i){var b=this._animations.get(i.animationRef);if(b){if(!b.targetRefs.includes(i.targetRef)){b.targetRefs.push(i.targetRef);b.targetPivots.push({x:i.targetPivotX,y:i.targetPivotY,z:i.targetPivotZ});}}};S.prototype.insertAnimationTrack=function(i){var b=this._animationTracks.get(i.animationTrackRef);var e=i.animationRef;if(!b){delete i.animationRef;b=i;this._animationTracks.set(i.animationTrackRef,b);}if(!e){return;}var l=this._animations.get(e);if(!l||!l.sequenceId){return;}if(l.animationTracks.has(b.animationTrackRef)){return;}else{l.animationTracks.add(b.animationTrackRef);}var I=this._vkScene.getAnimationSequence(l.sequenceId);if(!I){return;}if(!I.userData){I.userData={};}if(!I.userData.tracks){I.userData.tracks=[];}for(var J=0;l.targetRefs&&J<l.targetRefs.length;J++){var K=l.targetRefs[J];var M=l.targetPivots[J];var N=this._nodes.get(K);if(!N){continue;}var Q;if(M.x!==0||M.y!==0||M.z!==0){Q=[M.x,M.y,M.z];}var U=["OPACITY","COLOUR","TRANSLATE","SCALE","ROTATE"][b.type]||"";T.pushElementIntoMapArray(this._trackIdSequenceNodeMap,i.animationTrackRef,{sequenceId:l.sequenceId,targetId:K,type:U,pivot:Q});var W={};W.times=Array.prototype.slice.call(b.times);W.values=Array.prototype.slice.call(b.values);W.id=i.animationTrackRef;W.cyclicInfo={};W.cyclicInfo.cyclicStart=b.cyclicStart;W.cyclicInfo.cyclicEnd=b.cyclicEnd;var X;if(l.type===0){if(b.dataType===0){if(b.values.length!==b.keyCount||b.times.length!==b.keyCount){continue;}if(b.type===3){W.values=[];for(X=0;X<b.keyCount;X++){W.values.push(b.values[X]);W.values.push(b.values[X]);W.values.push(b.values[X]);}}}else if(b.dataType===1||b.dataType===3){if(b.values.length!==3*b.keyCount||b.times.length!==b.keyCount){continue;}}else if(b.dataType===4||b.dataType===5||b.dataType===6){if(b.values.length!==4*b.keyCount||b.times.length!==b.keyCount){continue;}if(b.dataType===4){W.rotateType="angleAxis";}else if(b.dataType===6){W.rotateType="euler";}else{W.rotateType="quaternion";for(var Y=3;Y<W.values.length;Y=Y+4){W.values[Y]=-W.values[Y];}}}}I.userData.tracks.push(W);}};S.prototype.finalizeAnimation=function(b){var e=this._animations.get(b);if(!e||!e.sequenceId){return;}var i=this._vkScene.getAnimationSequence(e.sequenceId);if(i){if(i.userData&&i.userData.tracks){this._animationHelper.insertTracks(i.userData.tracks,this._trackIdSequenceNodeMap,this._nodes,this._vkScene);}}};S.prototype.finalizePlaybacks=function(i){var b=this._viewportGroups.get(i.viewportGroupRef);for(var e=0;e<b.modelViews.length;e++){var l=b.modelViews[e];this._animationHelper.processHighlights(l,l.id,this._vkScene);}this._animationHelper.setInitialNodePositionsFromSubsequentViews(b.modelViews,this._vkScene);this._animationHelper.setInitialNodePositionsFromPreviousViews(b.modelViews,this._vkScene);this._animationHelper.setInitialNodePositionsFromCurrenetViews(b.modelViews,this._vkScene);this._animationHelper.setPlaybackStartTimes(b.modelViews,this._vkScene);};S.prototype.progress=function(b){L.log("reading progress:",b);};S.prototype.loadingFinished=function(i){if(this._fireLoadingFinished){this._fireLoadingFinished(i);}};var E=function(e){var b=e.data;if(b.ready){E.resolve();}else{var i=S.getById(b.sceneBuilderId);i[b.method].apply(i,b.args);}};var F=function(e){L.error("Error in WebWorker",e);};var G=(function(){var b;return function(){return b||(b=new Promise(function(e){var i=new Worker(sap.ui.require.toUrl("sap/ui/vk/threejs/MataiLoaderWorker.js"));E.resolve=e.bind(null,i);i.onmessage=E;i.onerror=F;}));};})();var H=function(b,e,i,l,I,J){G().then(function(K){var M=new S(i,l,I,J);K.postMessage({method:"loadSceneFromArrayBuffer",sceneBuilderId:M.getId(),buffer:b,fileName:e,sourceLocation:"remote"},[b]);});};return function(b,i){return new Promise(function(l,I){if(typeof i.getSource()==="string"){var J=i.getSource();fetch(J).then(function(e){if(e.ok){return e.arrayBuffer();}throw(new Error(e.statusText));}).then(function(e){H(e,J,b,i,l,I);}).catch(function(e){I(e);});}else if(i.getSource()instanceof File){var K=new FileReader();K.onload=function(e){H(e.target.result,i.getSource().name,b,i,l,I);};K.onerror=function(e){I(e);};K.readAsArrayBuffer(i.getSource());}});};});

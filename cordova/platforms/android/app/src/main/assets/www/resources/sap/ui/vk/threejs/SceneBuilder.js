/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)

        (c) Copyright 2009-2015 SAP SE. All rights reserved
    
 */
sap.ui.define(["jquery.sap.global","./thirdparty/three","./BBoxSubdivider","./UsageCounter","../totara/TotaraUtils","./OrthographicCamera","./PerspectiveCamera","./DetailView","./AnimationHelper","../View","./Billboard","./Callout","../BillboardCoordinateSpace","../BillboardTextEncoding","../BillboardStyle","../BillboardBorderLineStyle","../LeaderLineMarkStyle","../DetailViewType","../DetailViewShape","./AnimationSequence","../AnimationPlayback","./Material","../ObjectType"],function(q,t,B,U,T,O,P,D,A,V,a,C,b,c,d,f,L,g,h,j,k,M,m){"use strict";var S=function(e){this._id=S._nextId++;S._add(this);this._callouts=new Map();this._cameras=new Map();this._images=new Map();this._geometries=new Map();this._meshNodes=new Map();this._meshSubmeshes=new Map();this._geometryMeshes=new Map();this._materialMeshes=new Map();if(e){this._rootNode=e;this._nodes=new Map();this._tracks=new Map();this._trackIdSequenceNodeMap=new Map();this._viewGroups=new Map();this._views=new Map();}else{this._rootNode=null;this._nodes=null;this._tracks=null;this._trackIdSequenceNodeMap=null;this._viewGroups=null;this._views=null;}this._currentSceneId=null;this._sceneIdTreeNodesMap=new Map();this._sceneIdRootNodeMap=new Map();this._sceneIdViewGroupMap=new Map();this._sceneIdViewMap=new Map();this._highlightStyles=new Map();this._animationHelper=new A(this);};S._nextId=1;S._map=new Map();S.prototype.getId=function(){return this._id;};S._add=function(e){S._map.set(e.getId(),e);return this;};S.prototype.setRootNode=function(e,i,l,N){this._rootNode=e;this._nodes=new Map();this._nodes.set(i,e);if(!this._rootNode.userData){this._rootNode.userData={};}this._tracks=new Map();this._trackIdSequenceNodeMap=new Map();this._viewGroups=new Map();this._views=new Map();if(l){this._sceneIdTreeNodesMap.set(l,this._nodes);this._sceneIdRootNodeMap.set(l,e);this._sceneIdViewGroupMap.set(l,this._viewGroups);this._sceneIdViewMap.set(l,this._views);this._currentSceneId=l;}if(N){this._vkScene=N;}return this;};S.prototype._resetCurrentScene=function(e){if(e&&e!==this._currentSceneId){var i=this._sceneIdTreeNodesMap.get(e);if(i){this._nodes=i;}else{this._nodes=null;}var l=this._sceneIdRootNodeMap.get(e);if(l){this._rootNode=l;}else{this._rootNode=null;}this._currentSceneId=e;}};S.prototype.getNode=function(e,i){if(i){this._resetCurrentScene(i);if(this._nodes){return this._nodes.get(e);}}else{var l=this._sceneIdTreeNodesMap.values();var N=l.next();while(!N.done){var Q=N.value.get(e);if(Q){return Q;}N=l.next();}}return null;};S.prototype.setNodePersistentId=function(e,i,l){if((e.userData.treeNode&&e.userData.treeNode.sid)||this.getNode(i,l)){return false;}this._resetCurrentScene(l);if(!e.userData.treeNode){e.userData.treeNode={};}e.userData.treeNode.sid=i;if(this._nodes){this._nodes.set(i,e);}return true;};var n=function(e){var i=new THREE.Matrix4();if(e.length===3){i.setPosition(new THREE.Vector3().fromArray(e));}else if(e.length===12){i.set(e[0],e[3],e[6],e[9],e[1],e[4],e[7],e[10],e[2],e[5],e[8],e[11],0.0,0.0,0.0,1.0);}else if(e.length===16){i.set(e[0],e[4],e[8],e[12],e[1],e[5],e[9],e[13],e[2],e[6],e[10],e[14],e[3],e[7],e[11],e[15]);}else{throw"Invalid matrix format";}return i;};var o={r:0.0235,g:0.0235,b:0.0235};var p={r:0.0602,g:0.0602,b:0.0602};S.prototype._createTemporaryMaterial=function(e){var i=new THREE.MeshPhongMaterial({color:0xaaaaaa});i.userData.defaultHighlightingEmissive=o;i.userData.defaultHighlightingSpecular=p;i.userData.materialUsed=0;i.userData.materialId=e;i.userData.toBeUpdated=true;var l=new M();l.setMaterialRef(i);this._vkScene.setMaterial(e,l);return i;};S.prototype._getMaterialRef=function(e){var i=this._vkScene.getMaterial(e);var l;if(i){l=i.getMaterialRef();}return l;};S.prototype._addDynamicObject=function(e,i){if(!this._rootNode.userData._vkDynamicObjects){this._rootNode.userData._vkDynamicObjects=[];}this._rootNode.userData._vkDynamicObjects.push(e);e._vkUpdate=i;};S.prototype.createNode=function(e,i,l){this._resetCurrentScene(l);var N=new THREE.Group();N.userData.treeNode=e;if(e.name){N.name=e.name;}if(e.visible!==undefined){N.visible=e.visible;}if(e.renderOrder){N.renderOrder=e.renderOrder;}if(e.visualisable===false){N.userData.skipIt=true;}if(e.opacity!==undefined){N.userData.opacity=e.opacity;}if(e.transform){N.applyMatrix(n(e.transform));}if(e.transformType){N.userData.transformType=e.transformType;switch(e.transformType){case"BILLBOARD_VIEW":this._addDynamicObject(N,a.prototype._billboardViewUpdate);break;case"LOCK_TOVIEWPORT":this._addDynamicObject(N,a.prototype._lockToViewportUpdate);break;default:break;}}if(e.meshId){T.pushElementIntoMapArray(this._meshNodes,e.meshId,N);var Q=this._meshSubmeshes.get(e.meshId);if(Q){Q.forEach(function(R){N.add(R.parent?R.clone():R);});z(N);}}(this._nodes.get(i)||this._rootNode).add(N);this._nodes.set(e.sid,N);if(N.parent.userData.objectType===m.Hotspot){N.userData.objectType=m.Hotspot;}else if(N.parent.userData.objectType===m.PMI){N.userData.objectType=m.PMI;}else if(e.contentType==="HOTSPOT"){N.userData.objectType=m.Hotspot;}else if(e.contentType==="PMI"){N.userData.objectType=m.PMI;}return N;};function r(e,i,l){var N;if(e.isPolyline){var Q=new THREE.LineBasicMaterial({color:0xff0000,linewidth:1});if(i){Q.color.copy(i.color);}N=new THREE.LineSegments(e,Q);}else{N=new THREE.Mesh(e,i);}if(e.isPositionQuantized){w(N,l.boundingBox);}U.increaseGeometryUsed(e);return N;}S.prototype.getChildNodeIds=function(e,l,N){this._resetCurrentScene(l);var Q=this._nodes.get(e);var R=[];if(!Q){return R;}if(Q&&Q.children){for(var i=0;i<Q.children.length;i++){var W=Q.children[i];if(W.userData.treeNode&&W.userData.treeNode.sid){R.push(W.userData.treeNode.sid);}else if(N&&W.userData.submeshInfo&&W.userData.submeshInfo.id){R.push(W.userData.submeshInfo.id);}}}return R;};function s(e){var l=atob(e);var N=l.length;var Q=new Uint8Array(N);for(var i=0;i<N;i++){Q[i]=l.charCodeAt(i);}return Q;}function u(l){for(var i=0;i<l.length;i++){if(l[i].type==="box"&&l[i].data){return l[i];}}return null;}function v(l){if(Array.isArray(l)){for(var i=0;i<l.length;i++){if(l[i].type===undefined||l[i].type==="mesh"||l[i].type==="line"){return l[i];}}}return null;}function w(e,i){if(Array.isArray(i)&&i.length===6){e.position.set((i[3]+i[0])*0.5,(i[4]+i[1])*0.5,(i[5]+i[2])*0.5);e.scale.set(Math.max(i[3]-i[0],Number.EPSILON),Math.max(i[4]-i[1],Number.EPSILON),Math.max(i[5]-i[2],Number.EPSILON));}else{e.position.setScalar(0);e.scale.setScalar(1);}}S.prototype.insertSubmesh=function(i,l){var N=v(l.lods);if(!N){return false;}var Q=this._getMaterialRef(l.materialId)||this._createTemporaryMaterial(l.materialId);var R;var W=this._geometries.get(N.id);if(W){R=r(W,Q,N);if(W.userData&&W.userData.noNormal&&l.materialId){this.updateMaterialForGeometryWithoutNormal(l.materialId);}}else{var X;try{var Y=u(l.lods);if(Y&&Y.data){var Z=s(Y.data);var $=B.unpackSubDividedBoundingBox(Z);X=B.makeSubDividedBoundingBoxGeometry($);}}catch(e){}R=new THREE.Mesh(X?X:new THREE.BoxBufferGeometry(1,1,1),Q);w(R,N.boundingBox);}R.userData.initialMaterialId=l.materialId;R.userData.meshId=i;R.userData.submeshId=l.id;R.userData.geometryId=N.id;R.userData.materialId=l.materialId;R.userData.submeshInfo=l;R.userData.lodInfo=N;T.pushElementIntoMapArray(this._geometryMeshes,N.id,i);T.pushElementIntoMapArray(this._materialMeshes,l.materialId,i);T.pushElementIntoMapArray(this._meshSubmeshes,i,R);var _=this._meshNodes.get(i);if(_){_.forEach(function(a1){a1.add(R.parent?R.clone():R);z(a1,l.materialId);});}return true;};function x(e,l,N){for(var i=0;i<e.length;i++){var Q=e[i];if(Q.userData.geometryId===l&&Q.geometry!==N){if(Q.type==="Mesh"&&!N.isPolyline){Q.geometry=N;w(Q,N.isPositionQuantized?Q.userData.lodInfo.boundingBox:null);U.increaseGeometryUsed(N);}else{var R=r(N,Q.material,Q.userData.lodInfo);R.userData=Q.userData;R.parent=Q.parent;e[i]=R;Q.parent=null;}}}}function y(e,i,l){var N=e.userData.opacity!==undefined?e.userData.opacity:1;var Q=e.children;Q.forEach(function(R){if(R.userData.materialId===i){U.increaseMaterialUsed(l);R.userData.opacity=N;R.userData.originalMaterial=l;R.material=l.clone();R.material.opacity*=N;R.material.transparent=R.material.opacity<0.99;}});}function z(e,i){var l=e.userData.opacity!==undefined?e.userData.opacity:1;e.children.forEach(function(N){if(N.material&&(!i||i===N.material.userData.materialId)){if(N.userData.opacity===undefined){N.userData.opacity=l;if(!N.userData.originalMaterial){N.userData.originalMaterial=N.material;N.material=N.material.clone();}N.material.opacity=N.userData.originalMaterial.opacity*l;N.material.transparent=N.material.opacity<0.99;}}});}S.prototype.setGeometry=function(e){var i=new THREE.BufferGeometry();var l=new THREE.BufferAttribute(new Uint16Array(e.data.indices),1);var N=new THREE.BufferAttribute(new Float32Array(e.data.points),3);i.setIndex(l);i.addAttribute("position",N);if(!i.userData){i.userData={};}if(!e.isPolyline){if(e.data.normals.length===e.data.points.length){var Q=new THREE.BufferAttribute(new Float32Array(e.data.normals),3);i.addAttribute("normal",Q);}else{i.userData.noNormal=true;}if(e.data.uvs&&e.data.uvs.length*3===e.data.points.length*2){i.addAttribute("uv",new THREE.BufferAttribute(new Float32Array(e.data.uvs),2));}}else{i.isPolyline=true;}try{i.computeBoundingSphere();}catch(R){return this;}i.isPositionQuantized=e.isPositionQuantized;i.userData.geometryId=e.id;i.userData.geometryUsed=0;this._geometries.set(e.id,i);var W=this._geometryMeshes.get(e.id);if(W){for(var X=0;X<W.length;X++){var Y=W[X];var Z=this._meshNodes.get(Y);if(Z){for(var $=0;$<Z.length;$++){x(Z[$].children,e.id,i);}}var _=this._meshSubmeshes.get(Y);if(_){x(_,e.id,i);}}}return this;};S.prototype.getGeometry=function(e){return this._geometries.get(e);};var E=[d.RectangularShape,d.CircularShape,d.None,d.TextGlow];var F=[b.Viewport,b.Screen,b.World];var G=[f.None,f.Solid,f.Dash,f.Dot,f.DashDot,f.DashDotDot];var H=[L.None,L.Point,L.Arrow];function I(e){var i=(((e[0]*255)<<16)|((e[1]*255)<<8)|(e[2]*255)).toString(16);return"#"+"000000".substring(i.length)+i;}S.prototype.createAnnotation=function(e,i,l){this._resetCurrentScene(e);var N=this._nodes.get(i);var Q=l.position;l.coordinateSpace|=0;var R={node:N,coordinateSpace:F[l.coordinateSpace],style:E[l.shape||0],width:l.width,height:l.height,backgroundColor:l.backgroundColour?I(l.backgroundColour):"#fff",backgroundOpacity:l.backgroundColour?l.backgroundColour[3]:0,borderColor:l.borderColour?I(l.borderColour):"#000",borderOpacity:l.borderColour?l.borderColour[3]:0,borderWidth:l.borderWidth,borderLineStyle:G[l.borderLineStyle]};if(l.fontFace){R.encoding=c.PlainText;R.font=l.fontFace;R.fontSize=Math.abs(l.fontSize);R.fontWeight=Math.min(l.fontWeight,900);R.textColor=I(l.textColour);}else{R.encoding=c.HtmlText;}if(l.coordinateSpace<2){R.position=new THREE.Vector3(Q[0]*2-1,Q[1]*-2+1,Q[2]);R.renderOrder=(l.order|0)+1000;var W=new a(R);W.setText(l.text);this._addDynamicObject(N,W._update.bind(W));}else{R.anchorNode=this._nodes.get(l.sid);R.position=new THREE.Vector3().fromArray(Q);R.depthTest=false;R.renderOrder=l.order|0;var X=new C(R);X.setText(l.text);this._callouts.set(l.id,X);this._addDynamicObject(N,X._update.bind(X));}};S.prototype.createImageNote=function(e,i,l){this._resetCurrentScene(e);var N=this._nodes.get(i);N.updateMatrix();var Q=new THREE.Vector3().fromArray(l.position);Q.x+=l.width*0.5;Q.y+=l.height*0.5;Q.applyMatrix4(N.matrix);var R=new a({node:N,coordinateSpace:b.Screen,renderOrder:(l.order|0)+1000,position:Q,width:l.width*0.5*N.matrix.elements[0],height:l.height*0.5*N.matrix.elements[5]});var W=this._getMaterialRef(l.labelMaterialId);R.setMaterial(W);this._addDynamicObject(N,R._update.bind(R));};S.prototype.insertLeaderLine=function(e,N,Q){var R=this._callouts.get(N);if(R){var W=[];for(var i=0,l=Q.points.length;i<l;i++){W.push(new THREE.Vector3().fromArray(Q.points[i]));}var X=this._getMaterialRef(Q.materialId);var Y=this._nodes.get(Q.startPointSid);R.addLeaderLine(W,Y,X,H[Q.startPointHeadStyle],H[Q.endPointHeadStyle],Q.pointHeadConstant,Q.extensionLength);}};S.prototype.createDetailView=function(e,i,l){this._resetCurrentScene(e);var N=this._nodes.get(i);if(N){if(!l.shape){l.shape=l.leaderStyle?h.BoxLine:h.Box;}else{l.shape=[h.Circle,h.CircleLine,h.CirclePointer,h.CircleArrow,h.CircleBubbles][l.leaderStyle||0];}var Q=new D({name:l.name,camera:l.camera?this.createCamera(l.camera):null,type:l.cutaway?g.Cutaway:g.DetailView,shape:l.shape,borderWidth:l.borderWidth||0,backgroundColor:I(l.backgroundColour),borderColor:I(l.borderColour),origin:new THREE.Vector2(N.position.x*2-1+N.scale.x,N.position.y*-2+1-N.scale.x),size:new THREE.Vector2(N.scale.x,N.scale.y),attachmentPoint:new THREE.Vector3().fromArray(l.attachment)});if(!this._rootNode.userData._vkDetailViews){this._rootNode.userData._vkDetailViews=[];}this._rootNode.userData._vkDetailViews.push({detailView:Q,node:N,renderOrder:N.renderOrder});}};S.prototype._decrementResourceCounters=function(e){e.traverse(function(i){if(i.isMesh){U.decreaseMaterialUsed(i.material);U.decreaseGeometryUsed(i.geometry);}});};S.prototype.decrementResourceCountersForDeletedTreeNode=function(e,i){this._resetCurrentScene(i);var l=this;e=[].concat(e);e.forEach(function(N){var Q=l._nodes.get(N);if(Q){l._decrementResourceCounters(Q);l._nodes.delete(N);}});return this;};S.prototype.remove=function(e,l){this._resetCurrentScene(l);var N=this;e=[].concat(e);e.forEach(function(Q){var R=N._nodes.get(Q);if(R){N._decrementResourceCounters(R);if(R.parent){R.parent.remove(R);}N._nodes.delete(Q);for(var i=0;i<R.children.length;i++){var W=R.children[i];if(W.userData&&W.userData.treeNode&&W.userData.treeNode.sid){N.remove(W.userData.treeNode.sid,l);}}}});return this;};S.prototype.resourcesCleanUp=function(){var e=this._geometries;e.forEach(function(i){var l=i.userData.geometryUsed;if(l<=0){i.dispose();}});return this;};S.prototype.createCamera=function(e,i){this._resetCurrentScene(i);var l;if(e.ortho){l=new THREE.OrthographicCamera(-1,1,1,-1,e.near,e.far);}else{l=new THREE.PerspectiveCamera(e.fov*180/Math.PI,1,e.near,e.far);}if(e.origin){var N=new THREE.Vector3().fromArray(e.origin);l.position.copy(N);}if(e.up){var Q=new THREE.Vector3().fromArray(e.up).normalize();l.up.copy(Q);}if(e.target){l.lookAt((new THREE.Vector3().fromArray(e.target)).add(l.position));}if(e.ortho){l.zoom=e.zoom||0.02;}this._rootNode.userData.camera=l;var R=null;if(l.isOrthographicCamera){R=new O();}else if(l.isPerspectiveCamera){R=new P();}R.setCameraRef(l);R.setUsingDefaultClipPlanes(true);if(e.zoom===-1){R.setZoomNeedRecalculate(true);}R.cameraInfo=e;var W=e.id;if(W){this._cameras.set(W,R);}return R;};S.prototype.insertCamera=function(e,i,l){this._resetCurrentScene(l);var N=this._nodes.get(e);var Q=this._cameras.get(i);if(N&&Q){N.add(Q.parent?Q.clone():Q);}return this;};S.prototype.getCamera=function(e){return this._cameras.get(e);};S.prototype.updateMaterialForGeometryWithoutNormal=function(e){var i=this._getMaterialRef(e);if(i&&i.emissive){i.emissive.copy(i.color);i.side=THREE.DoubleSide;}return this;};S.prototype.createMaterial=function(e){var i=[];var l=this._getMaterialRef(e.id);if(e.lineWidth>0){if(!l||!l.isLineBasicMaterial){l=new THREE.LineBasicMaterial();var N=new M(true);N.setMaterialRef(l);this._vkScene.setMaterial(e.id,N);}l.color=new THREE.Color(e.lineColour[0],e.lineColour[1],e.lineColour[2]);l.linewidth=e.lineWidth;l.userData.lineStyle={width:e.lineWidth,haloWidth:e.lineHaloWidth||0,endCapStyle:e.lineEndRound?1:0,dashPattern:e.lineDashPattern||[],dashPatternScale:e.lineDashPatternScale};l.userData.materialInfo=e;l.userData.materialId=e.id;return i;}if(!l){l=this._createTemporaryMaterial(e.id);}if(l.userData&&l.userData.toBeUpdated){delete l.userData.toBeUpdated;}l.userData.materialInfo=e;if(e.diffuseColour){l.color.fromArray(e.diffuseColour);}if(e.specularColour){l.specular.fromArray(e.specularColour);}var Q=true;if(e.emissiveColour){l.emissive.fromArray(e.emissiveColour);if(l.emissive.r!==0||l.emissive.g!==0||l.emissive.b!==0){Q=false;}}if(Q&&e.ambientColour){l.emissive.fromArray(e.ambientColour);l.emissive.multiplyScalar(0.2);}if(l.opacity!==undefined){l.opacity=e.opacity;l.transparent=e.opacity<1;if(l.transparent){l.side=THREE.DoubleSide;}}var R=l.glossiness?l.glossiness:0;var W=l.specularLevel?l.specularLevel:0;l.shininess=R*2+W*3;l.userData.defaultHighlightingEmissive=o;l.userData.defaultHighlightingSpecular=p;i=this.updateTextureMaps(e.id);var X=this._materialMeshes.get(e.id);if(X){for(var Y=0;Y<X.length;Y++){var Z=X[Y];var $=this._meshNodes.get(Z);if($){for(var _=0;_<$.length;_++){y($[_],e.id,l);}}}}return i;};S.prototype.getMaterial=function(e){return this._getMaterialRef(e);};var J=function(i){var l="";try{var N=0x8000;var Q=0;var R=i.length;var W;while(Q<R){W=i.slice(Q,Math.min(Q+N,R));l+=String.fromCharCode.apply(null,W);Q+=N;}}catch(e){l="";}return l;};S.prototype.createImage=function(i){var e=new DataView(i.binaryData.buffer);var l=true;if(e.getUint8(0,true)===parseInt("0xFF",16)&&e.getUint8(1,true)===parseInt("0xD8",16)){l=false;}var N=J(i.binaryData);var Q="data:image/"+(l?"png":"jpeg")+";base64,"+btoa(N);this._images.set(i.id,Q);return this;};var K=new THREE.TextureLoader();S.TextureType={Diffuse:0,Bump:1,Opacity:2,Reflection:3,Refraction:4,Specular:5,Ambient:6,Emissive:7,SpecularLevel:8,Glosiness:9,AmbientOcclusion:10,Decal:11};S.prototype.updateTextureMaps=function(e){var i=[];var l=this._getMaterialRef(e);if(!l){return i;}var N=l.userData.materialInfo;if(!N){return i;}if(N.textureDiffuse){var Q=this.updateTextureMap(N.id,S.TextureType.Diffuse);if(Q.imageId){i.push(Q);}}if(N.textureBump){var R=this.updateTextureMap(N.id,S.TextureType.Bump);if(R.imageId){i.push(R);}}if(N.textureOpacity){var W=this.updateTextureMap(N.id,S.TextureType.Opacity);if(W.imageId){i.push(W);}}if(N.textureEmissive){var X=this.updateTextureMap(N.id,S.TextureType.Emissive);if(X.imageId){i.push(X);}}if(N.textureAmbientOcclusion){var Y=this.updateTextureMap(N.id,S.TextureType.AmbientOcclusion);if(Y.imageId){i.push(Y);}}if(N.textureReflection){var Z=this.updateTextureMap(N.id,S.TextureType.Reflection);if(Z.imageId){i.push(Z);}}return i;};S.prototype.updateTextureMap=function(e,i){var l={textureType:i,imageId:null};var N=this._getMaterialRef(e);if(!N){return l;}var Q=N.userData.materialInfo;if(!Q){return l;}var R=null;switch(i){case S.TextureType.Diffuse:R=Q.textureDiffuse;break;case S.TextureType.Bump:R=Q.textureBump;break;case S.TextureType.Opacity:R=Q.textureOpacity;break;case S.TextureType.Reflection:R=Q.textureReflection;break;case S.TextureType.Emissive:R=Q.textureEmissive;break;case S.TextureType.AmbientOcclusion:R=Q.textureAmbientOcclusion;break;default:break;}if(!R){return l;}var W=R[0];var X=this._images.get(W.imageId);if(!X){l.imageId=W.imageId;return l;}var Y=K.load(X);Y.wrapS=W.uvHorizontalTilingEnabled?THREE.RepeatWrapping:THREE.ClampToEdgeWrapping;Y.wrapT=W.uvVerticalTilingEnabled?THREE.RepeatWrapping:THREE.ClampToEdgeWrapping;Y.magFilter=W.filterMode===1?THREE.NearestFilter:THREE.LinearFilter;Y.minFilter=W.filterMode===1?THREE.NearestFilter:THREE.LinearMipMapLinearFilter;Y.anisotropy=4;var Z=W.influence!==undefined?W.influence:0;var $=W.uvHorizontalScale!==undefined?W.uvHorizontalScale:1;var _=W.uvVerticalScale!==undefined?W.uvVerticalScale:1;var a1=W.uvHorizontalOffset!==undefined?W.uvHorizontalOffset:0;var b1=W.uvVerticalOffset!==undefined?W.uvVerticalOffset:0;Y.repeat.set($,_);Y.center.set(-a1,-b1);Y.offset.set(a1,b1);Y.rotation=-W.uvRotationAngle;switch(i){case S.TextureType.Diffuse:N.map=Y;N.transparent|=X.startsWith("data:image/png");break;case S.TextureType.Bump:N.bumpMap=Y;N.bumpScale=Z;break;case S.TextureType.Opacity:N.alphaMap=Y;break;case S.TextureType.Reflection:Y.mapping=THREE.SphericalReflectionMapping;N.envMap=Y;N.combine=THREE.AddOperation;N.reflectivity=Z;break;case S.TextureType.Emissive:N.emissiveMap=Y;N.emissive.setRGB(1,1,1);break;case S.TextureType.AmbientOcclusion:N.aoMap=Y;break;default:}N.userData.textureAdded=true;N.needsUpdate=true;return l;};S.prototype.insertPlayback=function(e,i,l){this._resetCurrentScene(l);var N=new k({pid:e.id,sequenceId:e.sequenceId,timeScale:e.speed?e.speed:1,preDelay:e.preDelay?e.preDelay:0,postDelay:e.postDelay?e.postDelay:0,repeat:e.repeat?Math.abs(e.repeat):0,reversed:e.reversed?true:false,startTime:e.start?e.start:0});var Q=this._views.get(i);if(Q){var R=Q.getPlaybacks();if(!R){R=[];}R.push(N);Q.setPlaybacks(R);}return this;};S.prototype.insertSequence=function(i){var e;if(i.endTime){e=i.endTime;}else{e=1.0;}this._vkScene.createAnimationSequence(i.id,i.name,e);if(i.nodes&&i.nodes.length>0){for(var l=0;l<i.nodes.length;l++){var N=i.nodes[l];T.pushElementIntoMapArray(this._trackIdSequenceNodeMap,N.trackId,{sequenceId:i.id,targetId:N.sid,type:N.binding,pivot:N.pivot});}}return this;};S.prototype.insertTracks=function(e){this._animationHelper.insertTracks(e,this._trackIdSequenceNodeMap,this._nodes,this._vkScene);return this;};S.prototype.finalizeAnimation=function(){var e=this._rootNode;if(e){while(e.parent){e=e.parent;}if(!e.userData){e.userData={};}e.userData.tracks=this._tracks;}return this;};S.prototype.finalizePlaybacks=function(){var e=this._rootNode;if(e){while(e.parent){e=e.parent;}if(!e.userData){e.userData={};}}else{return this;}if(!e.userData.animationNodeOriginalData){e.userData.animationNodeOriginalData=new Map();}var i;var l=this._viewGroups.entries();var N=l.next();while(!N.done){i=N.value[1];N=l.next();var Q=[];for(var R=0;R<i.views.length;R++){if(i.views[R].id){var W=this._views.get(i.views[R].id);if(W){Q.push(W);}}}}return this;};S.prototype.finalizeViewGroups=function(e){this._resetCurrentScene(e);var i=this._rootNode;if(i){while(i.parent){i=i.parent;}if(!i.userData){i.userData={};}}else{return this;}var l=[];var N=this._viewGroups.entries();var Q=N.next();while(!Q.done){var R=Q.value[1];var W=Q.value[0];if(!R||!R.views||!R.views.length){Q=N.next();continue;}var X=[];for(var Y=0;Y<R.views.length;Y++){var Z=R.views[Y].id;var $=this._views.get(Z);if($&&$.userData.viewInfo.thumbnailId&&!$.thumbnailData){var _=this._images.get($.userData.viewInfo.thumbnailId);if(_){$.thumbnailData=_;}}if($){$.viewGroupId=W;X.push($);}}var a1={};a1.originalId=Q.value[0];a1.name=R.name;a1.modelViews=X;a1.sceneId=Q.value[1].sceneId;l.push(a1);Q=N.next();}i.userData.viewportGroups=l;return this;};S.prototype.insertViewGroup=function(i,e){this._resetCurrentScene(e);this._viewGroups.set(i.id,i);return this;};S.prototype.getViewGroup=function(e,i){this._resetCurrentScene(i);var l=this._viewGroups.get(e);var N=[];if(l&&l.views){for(var Q=0;Q<l.views.length;Q++){var R=l.views[Q].id;var W=this._views.get(R);if(W){N.push(W);}}}return N;};S.prototype.insertView=function(e,i){this._resetCurrentScene(i);var l=new V({name:e.name,description:e.description?"<pre style=\"white-space: pre-wrap;\">"+e.description+"</pre>":e.description});l.userData={};l.userData.viewInfo=e;if(e.thumbnailId){var N=this._images.get(e.thumbnailId);if(N){l.thumbnailData=N;}}this._views.set(e.viewId,l);return this;};S.prototype.recordHighlightedNodeInView=function(e,i,l,N){this._resetCurrentScene(N);var Q=this._views.get(l);if(!Q){return this;}var R=this._nodes.get(i);if(!R){return this;}if(!Q.highlightIdNodesMap){Q.highlightIdNodesMap=new Map();}var W=Q.highlightIdNodesMap.get(e);if(!W){W=[];}W.push(R);Q.highlightIdNodesMap.set(e,W);return this;};S.prototype.insertHighlightStyle=function(i){var e=this._highlightStyles.get(i.id);if(e){return this;}e=i;this._animationHelper.addAnimationTracksToHighlight(e);this._highlightStyles.set(i.id,e);return this;};S.prototype.highlightStyleExists=function(i){var e=this._highlightStyles.get(i);return e!==undefined;};S.prototype.finalizeHighlightsInViews=function(){var e,i;var l=this._views.entries();var N=l.next();while(!N.done){e=N.value[1];i=N.value[0];N=l.next();if(e&&e.highlightIdNodesMap){e.highlights=[];var Q=e.highlightIdNodesMap.entries();var R=Q.next();while(!R.done){var W=R.value[1];var X=R.value[0];var Y=this._highlightStyles.get(X);if(Y){Y.highlightNodes=W;e.highlights.push(Y);}R=Q.next();}this._animationHelper.processHighlights(e,i,this._vkScene);this._animationHelper.setInitialNodePositionsOnView(e,this._vkScene,true);}}var Z=this._viewGroups.entries();var $=Z.next();while(!$.done){var _=$.value[1];$=Z.next();if(!_||!_.views||!_.views.length){continue;}var a1=[];for(var vi=0;vi<_.views.length;vi++){e=this._views.get(i);if(e){a1.push(e);}}if(a1.length>0){this._animationHelper.setInitialNodePositionsFromSubsequentViews(a1,this._vkScene,true);this._animationHelper.setInitialNodePositionsFromPreviousViews(a1,this._vkScene,true);}}return this;};S.prototype.getView=function(e,i){this._resetCurrentScene(i);return this._views.get(e);};S.prototype.getSequence=function(e){return this._vkScene.getAnimationSequence(e);};S.prototype.setViewCamera=function(e,i,l){this._resetCurrentScene(l);var N=this._cameras.get(e);var Q=this._views.get(i);if(N&&Q){Q.camera=N;var R=N.getCameraRef();if(N.cameraInfo&&R){var W=true;var X=false;if(N.cameraInfo.zoom===-1){X=true;}var Y=new THREE.Vector3();R.getWorldDirection(Y);if(R.type==="PerspectiveCamera"){Q.setCameraInfo({type:R.type,fov:N.cameraInfo.fov*180/Math.PI,position:R.position.toArray(),nearClipPlane:R.near,farClipPlane:R.far,upDirection:R.up.toArray(),targetDirection:Y.toArray(),usingDefaultClipPlanes:W});}if(R.type==="OrthographicCamera"){Q.setCameraInfo({type:R.type,zoomFactor:R.zoom,position:R.position.toArray(),nearClipPlane:R.near,farClipPlane:R.far,upDirection:R.up.toArray(),targetDirection:Y.toArray(),usingDefaultClipPlanes:W,zoomNeedRecalculate:X});}}}return this;};S.prototype.setViewNodeInfos=function(e,i,l){this._resetCurrentScene(l);var N=this._views.get(i);N.setNodeInfos(e);return this;};S.prototype.setViewThumbnail=function(i,e,l){this._resetCurrentScene(l);var N=this._views.get(e);var Q=this._images.get(i);if(N&&Q){N.thumbnailData=Q;}return this;};S.prototype.cleanup=function(){this._rootNode=null;if(this._nodes){this._nodes.clear();}if(this._submeshes){this._submeshes.clear();}if(this._callouts){this._callouts.clear();}if(this._cameras){this._cameras.clear();}if(this._vkScene){this._vkScene.clearMaterials();}if(this._images){this._images.clear();}if(this._geometries){this._geometries.clear();}if(this._meshNodes){this._meshNodes.clear();}if(this._meshSubmeshes){this._meshSubmeshes.clear();}if(this._geometryMeshes){this._geometryMeshes.clear();}if(this._materialMeshes){this._materialMeshes.clear();}if(this._sceneIdTreeNodesMap){this._sceneIdTreeNodesMap.clear();}if(this._sceneIdRootNodeMap){this._sceneIdRootNodeMap.clear();}if(this._tracks){this._tracks.clear();}if(this._trackIdSequenceNodeMap){this._trackIdSequenceNodeMap.clear();}if(this._viewGroups){this._viewGroups.clear();}if(this._views){this._views.clear();}if(this._sceneIdViewGroupMap){this._sceneIdViewGroupMap.clear();}if(this._sceneIdViewMap){this._sceneIdViewMap.clear();}if(this._highlightStyles){this._highlightStyles.clear();}this._currentSceneId=null;S._map.delete(this._id);};return S;});

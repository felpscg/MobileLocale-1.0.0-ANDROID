sap.ui.define(["sap/base/Log","./SceneContext","./CallbackHandler","./Command","./TotaraUtils","../threejs/SceneBuilder","sap/ui/thirdparty/URI"],function(L,S,C,a,T,b,U){"use strict";var c=T.mark;var d=function(){this._pushMesh=false;this._url=null;this._cid=null;this._performanceTimingMsg=[];this._isPostable=true;this.currentSceneInfo={};this.sceneBuilder=new b();this.contextMap=new Map();this.tokenContextMap=new Map();this.onErrorCallbacks=new C();this.onImageFinishedCallbacks=new C();this.onMaterialFinishedCallbacks=new C();this.onSetGeometryCallbacks=new C();this.onSetSequenceCallbacks=new C();this.onSetTrackCallbacks=new C();this.onViewGroupUpdatedCallbacks=new C();this.onLoadingFinishedCallbacks=new C();};d.prototype.init=function(e,f){this._url=e;this._cid=f;var t=this;return new Promise(function(r){if(!t._worker){var u=new U(sap.ui.require.toUrl("sap/ui/vk/totara/TotaraLoaderWorker.js"));if(u.is("relative")){u=u.absoluteTo(new U(location.href));}var g="'"+u.toString()+"'";if(sap.ui.Device.browser.internet_explorer){var p=new U(sap.ui.require.toUrl("sap/ui/thirdparty/es6-promise.js"));var h=new U(sap.ui.require.toUrl("sap/ui/thirdparty/es6-string-methods.js"));if(p.is("relative")){p=p.absoluteTo(new U(location.href));h=h.absoluteTo(new U(location.href));}g="'"+p.toString()+"','"+h.toString()+"',"+g;}t._worker=new Worker((window.URL||window.webkitURL).createObjectURL(new Blob(["importScripts("+g+");"],{"type":"application/javascript"})));t._worker.onmessage=function(i){var j;var k=i.data;if(k.ready){return;}if(k.name==="getAuthorization"){if(k.sceneId){j=t.getContext(k.sceneId);}if(j&&j.authorizationHandler){j.authorizationHandler(k.jsonContent.url).then(function(m){t.postMessage({"method":"setAuthorization","authorizationToken":m});}).catch(function(m){t.postMessage({"method":"setAuthorization","authorizationToken":null,"error":m.toString()});});}else{t.postMessage({"method":"setAuthorization","authorizationToken":null});}return;}if(k.name==="protocol"){t.protocolVersion=k.jsonContent.version.split(".").map(function(s){return parseInt(s,10);});return;}j=t.processCommand(k.name,k.jsonContent,k.binaryContent);if(j){t.sendRequest(j.requestQueue);}};t._worker.onerror=function(i){};}});};d.prototype.dispose=function(){this.contextMap.forEach(function(e){e.dispose();});this.contextMap.clear();this.tokenContextMap.clear();this.postMessage({method:"close"});this._worker=undefined;this.currentSceneInfo=null;this.sceneBuilder.cleanup();this.sceneBuilder=null;this.onErrorCallbacks=null;this.onMaterialFinishedCallbacks=null;this.onImageFinishedCallbacks=null;this.onSetGeometryCallbacks=null;this.onSetTrackCallbacks=null;this.onSetSequenceCallbacks=null;};d.prototype.cleanup=function(){this.currentSceneInfo={};this.contextMap.clear();this.tokenContextMap.clear();this.sceneBuilder.cleanup();};d.prototype.enablePushMesh=function(e){this._pushMesh=e;};d.prototype.getUrl=function(){return this._url;};d.prototype.getSceneBuilder=function(){return this.sceneBuilder;};d.prototype.getContext=function(s){return this.contextMap.get(s);};d.prototype.createContext=function(s,p){var e=new S(s,p,this);this.contextMap.set(s,e);this.tokenContextMap.set(e.requestQueue.token,e);if(e.onActiveCamera){e.onActiveCameraCallbacks.attach(e.onActiveCamera);delete e.onActiveCamera;}if(e.onInitialSceneFinished){e.onInitialSceneFinishedCallbacks.attach(e.onInitialSceneFinished);delete e.onInitialSceneFinished;}if(e.onPartialRetrievalFinished){e.onPartialRetrievalFinishedCallbacks.attach(e.onPartialRetrievalFinished);delete e.onPartialRetrievalFinished;}if(e.onViewPartialRetrievalFinished){e.onViewPartialRetrievalFinishedCallbacks.attach(e.onViewPartialRetrievalFinished);delete e.onViewPartialRetrievalFinished;}if(e.onViewFinished){e.onViewFinishedCallbacks.attach(e.onViewFinished);delete e.onViewFinished;}if(e.onSceneCompleted){e.onSceneCompletedCallbacks.attach(e.onSceneCompleted);delete e.onSceneCompleted;}if(e.onProgressChanged){e.setOnProgressChanged(e.onProgressChanged);delete e.onProgressChanged;}if(e.onLoadingFinished){this.onLoadingFinishedCallbacks.detachAll();this.onLoadingFinishedCallbacks.attach(e.onLoadingFinished);delete e.onLoadingFinished;}return e;};d.prototype.isLoadingFinished=function(){var e=this.contextMap.values();var f=e.next();while(!f.done){if(!f.value.isLoadingFinished()){return false;}f=e.next();}return true;};d.prototype.decrementResourceCountersForDeletedTreeNode=function(e,n){if(e){this.sceneBuilder.decrementResourceCountersForDeletedTreeNode(n,e.sceneId);}};function l(e,n,t){if(e.progressLogger&&t){e.progressLogger.logPerformance(n,t);}}d.prototype.request=function(s,e,f){if(!e.root){throw"context must include root where three js objects are attached to";}var g=this.createContext(s,e);g.token=g.requestQueue.token;this.currentSceneInfo.id=s;g.retrievalType=S.RetrievalType.Initial;g.authorizationHandler=f;g.initialRequestTime=Date.now();if(g.enableLogger){T.createLogger(s,g,this);}var i=e.includeHidden!==undefined?e.includeHidden:true;var h=e.includeAnimation!==undefined?e.includeAnimation:true;var j=e.$select!==undefined?e.$select:"name,transform,meshId,annotationId,materialId,contentType,visible,opacity,renderOrder,entityId,highlightStyleId";var p=e.pushViewGroups!==undefined?e.pushViewGroups:true;var v={pushMaterials:true,pushMeshes:this._pushMesh,sceneId:s,token:g.token,includeHidden:i,includeAnimation:h,pushViewGroups:p,pushPMI:e.pushPMI||false,metadataFilter:e.metadataFilter,$select:j};v.context=s;var k;if(e.activateView){v.id=e.activateView;g.initialViewId=e.activateView;g.currentViewId=e.activateView;g.initialViewDecided=true;}k=T.createCommand(a.getView,v);l(g,"modelRequested",g.token);c("modelRequested");this.postMessage({method:"initializeConnection",url:this._url,cid:this._cid,useSecureConnection:e.useSecureConnection,token:g.token,command:k,sceneId:s});};d.prototype.postMessage=function(m){if(this._worker){this._worker.postMessage(m);}};d.prototype.update=function(s,e,v){this.currentSceneInfo.id=s;var f=this.getContext(s);if(!f){return Promise.reject("no context for ${sceneVeId}");}var t=this;return new Promise(function(r,g){f.nodeSidsForPartialTree=new Set(e);f.retrievalType=S.RetrievalType.Partial;var i=f.includeHidden!==undefined?f.includeHidden:true;var h=f.includeAnimation!==undefined?f.includeAnimation:true;var j=f.$select!==undefined?f.$select:"name,transform,meshId,annotationId,materialId,contentType,visible,opacity,renderOrder,entityId";var p=f.pushViewGroups!==undefined?f.pushViewGroups:true;var o={pushMaterials:true,pushMeshes:t._pushMesh,filter:e.join(),includeAnimation:h,includeHidden:i,pushPMI:f.pushPMI||false,metadataFilter:f.metadataFilter,pushViewGroups:p,$select:j,breadcrumbs:true};var k;if(f.progressLogger){k=T.generateToken();f.token=k;}o.sceneId=s;o.context=s;if(v){o.activateView=v;}var m=T.createCommand(a.getTree,o);var n=function(){f.onPartialRetrievalFinishedCallbacks.detach(n);l(f,"updateFinished(mesh)",k);var q=[];var u=[];f.replacedNodes.forEach(function(y,z){u.push(y);q.push(z);});var w=q;var x=u;r({sceneVeId:s,sids:e,replacedNodeRefs:w,replacementNodeRefs:x});};f.onPartialRetrievalFinishedCallbacks.attach(n);l(f,"updateRequested",k);t.postMessage({method:"update",command:m});});};d.prototype.requestViewGroup=function(s,v,i){if(!v){return Promise.reject("invalid arg: viewGroupId undefined");}var e=this.getContext(s);if(!e){return Promise.reject("no context for ${sceneVeId}");}if(i!==undefined){e.includeAnimation=i;}var t=this;var p=new Promise(function(r,f){var g=t.sceneBuilder.getViewGroup(v,s);if(g&&g.length){r(g);return;}var h;if(e.progressLogger){h=T.generateToken();e.token=h;}var o={sceneId:s,id:v,token:h};var j=function(){e.onViewGroupFinishedCallbacks.detach(j);l(e,"onViewGroupFinished",h);var k=t.sceneBuilder.getViewGroup(v,s);if(k&&k.length){r(k);}else{f("no view ground data");}};e.onViewGroupFinishedCallbacks.attach(j);e.currentViewGroupId=v;t.postMessage(T.createRequestCommand(a.getViewGroups,o));});return p;};d.prototype.requestView=function(s,v,e,p,i){this.currentSceneInfo.id=s;if(v!=="static"&&v!=="dynamic"){return Promise.reject("invalid arg: supported type - static, dynamic");}if(!e){return Promise.reject("invalid arg: viewId undefined");}var f=this.getContext(s);if(!f){return Promise.reject("no context for ${sceneVeId}");}f.currentViewId=e;var t;if(f.progressLogger){t=T.generateToken();f.token=t;}var g=f.includeHidden!==undefined?f.includeHidden:false;var h;if(i){h=i;}else{h=f.includeAnimation!==undefined?f.includeAnimation:true;}var j=f.$select!==undefined?f.$select:undefined;this.hasAnimation=false;var k=this;var m=new Promise(function(r,n){var o,q;if(v==="static"){o=a.getView;q={sceneId:s,id:e,token:t,includeHidden:g,includeAnimation:h,$select:j};if(p&&p.length){q.$expand="playback";f.playbackIds=p;}}else{o=a.getDynamicView;q={sceneId:s,type:e,token:t};}f.onSetPlaybackCallbacks.detachAll();var u=function(z){f.onSetPlaybackCallbacks.detach(u);l(f,"onSetPlayback",t);if(z){r(z);}else{n("no view data");}};f.onSetPlaybackCallbacks.attach(u);f.onViewFinishedCallbacks.detachAll();var w=function(z){f.onViewFinishedCallbacks.detach(w);l(f,"onViewFinished",t);if(!k.hasAnimation){if(z){r(z);}else{n("no view data");}}else{f.currentView=z;}};f.onViewFinishedCallbacks.attach(w);k.onSetSequenceCallbacks.detachAll();var x=function(){k.onSetSequenceCallbacks.detach(x);l(f,"onSetSequence",t);if(f.currentView){r(f.currentView);}else{n("no view data");}};k.onSetSequenceCallbacks.attach(x);k.onSetTrackCallbacks.detachAll();var y=function(z){k.onSetTrackCallbacks.detach(y);l(f,"onSetTrack",t);if(f.currentView){r(f.currentView);}else{n("no view data");}};k.onSetTrackCallbacks.attach(y);l(f,"viewRequested",t);k.postMessage(T.createRequestCommand(o,q));});return m;};d.prototype.requestMaterial=function(s,e){if(!e){return Promise.reject("invalid arg: materialId undefined");}var f=this.getContext(s);if(!f){return Promise.reject("no context for ${sceneVeId}");}var t=this;var p=new Promise(function(r,g){var h=f.sceneBuilder.getMaterial(e);if(h){r(h);return;}f.requestQueue.materials.push(e);var i=function(k){var m=t.sceneBuilder.getMaterial(e);if(m&&m.userData&&m.userData.idsOfImagesToRead){if(!m.userData.idsOfImagesToRead.has(k.id)){return;}else{m.userData.idsOfImagesToRead.delete(k.id);}if(m.userData.idsOfImagesToRead.size){return;}else{r(m);}}else{g("no material data");}t.onImageFinishedCallbacks.detach(i);};var j=function(n){if(e!=n){return;}t.onMaterialFinishedCallbacks.detach(j);var m=t.sceneBuilder.getMaterial(e);if(m&&m.userData&&m.userData.idsOfImagesToRead&&m.userData.idsOfImagesToRead.size){return;}t.onImageFinishedCallbacks.detach(i);if(m!=null){r(m);}else{g("no material data");}};t.onMaterialFinishedCallbacks.attach(j);t.onImageFinishedCallbacks.attach(i);t.sendRequest(f.requestQueue);});return p;};d.prototype.sendRequest=function(r){if(!this._worker){return false;}var s=false;while(!r.isEmpty()){var n=r.generateRequestCommand();this.postMessage(n);s=true;}return s;};d.prototype.timestamp=function(j){};d.prototype.performanceTiming=function(j){};d.prototype.checkError=function(j){if(!j){return true;}var r=j.result==="failure";if(r){if(j.message){j.error=j.message;delete j.message;}else{j.error="Unknown error";}}return r;};d.prototype.reportError=function(e,f){this.onErrorCallbacks.execute({error:f,context:e});};d.prototype.processContextCommand=function(e,n,j,f){if(!e){var g=n+" error: unknown context - "+JSON.stringify(j);this.contextMap.forEach(function(e){e[n].call(e,j,f);});return{error:g};}return e[n].call(e,j,f);};d.prototype.processCommand=function(n,j,e){if(this.checkError(j)){if(n===a.setTree){if(j.events&&j.events.length){var f=j.events[0];if(f.values&&f.values.id){this.contextMap.delete(f.values.id);}}}this.onErrorCallbacks.execute(j);return null;}var g=null;if(j.sceneId!==undefined){g=this.getContext(j.sceneId);}else if(j.token!==undefined){g=this.tokenContextMap.get(j.token);}if(g){this.currentSceneInfo.id=g.sceneId;}this.setPerformance(n,j,g?g.sceneId:null);var r;switch(n){case a.setTree:case a.setTreeNode:case a.notifyFinishedTree:case a.setView:case a.setViewNode:case a.setViewGroup:case a.notifyFinishedView:case a.setCamera:case a.setMesh:case a.notifyFinishedMesh:case a.setMaterial:case a.notifyFinishedMaterial:case a.setGeometry:case a.notifyFinishedGeometry:case a.setImage:case a.notifyFinishedImage:case a.setAnnotation:case a.setPlayback:case a.setHighlightStyle:case a.setSequence:case a.setTrack:case a.notifyError:r=this.processContextCommand(g,n,j,e);break;case a.timestamp:r=this.timestamp(j);break;case a.performanceTiming:r=this.performanceTiming(j);break;default:r={error:"Unknown command: "+n};break;}if(n!==a.setView&&n!==a.setViewNode&&n!==a.timestamp&&n!==a.performanceTiming&&this.isLoadingFinished()){this.onLoadingFinishedCallbacks.execute();L.info("Loading is finished - all streaming requests are fulfilled.");}if(r&&r.error){L.error(r.error);this.onErrorCallbacks.execute(r);}return g;};d.prototype.setPerformance=function(n,j,s){var i;switch(n){case a.setGeometry:i=j.id;c("setGeometry-"+i);break;case a.setImage:i=j.id;c("setImage-"+i);break;case a.setView:i=j.viewId;c("setView-"+i);break;case a.setViewGroup:i=j.id;c("setViewGroup-"+i);break;case a.setMesh:c("setMesh-"+s);break;case a.setMaterial:c("setMaterial-"+s);break;case a.setTree:c("setTree-"+s);break;case a.performanceTiming:this._isPostable=true;this.postPerformanceTiming();break;default:break;}};d.prototype.postPerformanceTiming=function(m){if(m){this._performanceTimingMsg.push(m);}if(this._isPostable&&this._performanceTimingMsg.length>0){this.postMessage(this._performanceTimingMsg.shift());this._isPostable=false;}};d.prototype.printLogTokens=function(){this.contextMap.forEach(function(e,s){L.info("log tokens for scene => "+s);L.info("---------------------------------------");if(e.progressLogger){e.progressLogger.getTokens().forEach(function(t){L.info(t);});}L.info("---------------------------------------");});};return d;});

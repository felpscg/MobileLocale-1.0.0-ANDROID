// Copyright (c) 2009-2017 SAP SE, All Rights Reserved
sap.ui.define(["sap/ushell/applications/PageComposer/i18n/resources"],function(r){"use strict";var P=function(d){this._oODataModel=d;this._oEtags={};};P.prototype.getPages=function(){return this._readPages().then(function(p){for(var i=0;i<p.results.length;i++){this._storeETag(p.results[i]);}return p;}.bind(this)).then(this._convertODataToPageList).catch(this._rejectWithErrorMessage);};P.prototype.getPage=function(p){return this._readPage(p).then(function(a){this._storeETag(a);return a;}.bind(this)).then(this._convertODataToReferencePage).catch(this._rejectWithErrorMessage);};P.prototype.createPage=function(p){var a=this._convertReferencePageToOData(p);return this._createPage(a).then(this._storeETag.bind(this));};P.prototype.updatePage=function(u){var U=this._convertReferencePageToOData(u);U.modifiedOn=this._oEtags[u.content.id].modifiedOn;return this._createPage(U).then(this._storeETag.bind(this)).catch(this._rejectWithErrorMessage);};P.prototype.deletePage=function(p,t){return new Promise(function(a,b){this._oODataModel.callFunction("/deletePage",{method:"POST",urlParameters:{pageId:p,transportId:t,modifiedOn:this._oEtags[p].modifiedOn},success:a,error:b});}.bind(this));};P.prototype._readPages=function(){return new Promise(function(a,b){this._oODataModel.read("/pageSet",{success:a,error:b});}.bind(this));};P.prototype._readPage=function(p){return new Promise(function(a,b){this._oODataModel.read("/pageSet('"+encodeURIComponent(p)+"')",{urlParameters:{"$expand":"sections/tiles"},success:a,error:b});}.bind(this));};P.prototype._createPage=function(n){return new Promise(function(a,b){this._oODataModel.create("/pageSet",n,{success:a,error:b});}.bind(this));};P.prototype._convertODataToPageList=function(p){return p.results.map(function(o){return{content:{id:o.id,title:o.title,description:o.description,createdBy:o.createdBy,createdOn:o.createdOn,modifiedBy:o.modifiedBy,modifiedOn:o.modifiedOn},metadata:{devclass:o.devclass,transportId:o.transportId}};});};P.prototype._convertODataToReferencePage=function(p){return{content:{id:p.id,title:p.title,description:p.description,createdBy:p.createdBy,createdOn:p.createdOn,modifiedBy:p.modifiedBy,modifiedOn:p.modifiedOn,sections:p.sections.results.map(function(s){return{id:s.id,title:s.title,visualizations:s.tiles.results.map(function(t){return{id:t.id,vizId:t.catalogTile,inboundPermanentKey:t.targetMapping};})};})},metadata:{transportId:p.transportId,devclass:p.devclass}};};P.prototype._convertReferencePageToOData=function(p){var R=p.content,m=p.metadata;var o={id:R.id,title:R.title,description:R.description,devclass:m.devclass,transportId:m.transportId,sections:(R.sections||[]).map(function(s){return{id:s.id,title:s.title,tiles:(s.visualizations||[]).map(function(t){return{id:t.id,catalogTile:t.vizId,targetMapping:t.inboundPermanentKey};})};})};return o;};P.prototype._storeETag=function(p){this._oEtags[p.id]={modifiedOn:p.modifiedOn,etag:p.__metadata.etag};};P.prototype._rejectWithErrorMessage=function(e){var E;if(e.statusCode===412){E=r.i18n.getText("Message.PageIsOutdated");}else{try{E=JSON.parse(e.responseText).error.message.value||e.message;}catch(a){E=e.message;}}return Promise.reject(E);};return P;},true);

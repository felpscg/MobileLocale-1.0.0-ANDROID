sap.ui.define(["sap/ui/base/Object","sap/suite/ui/generic/template/ListReport/controller/MultipleViewsSingleTableModeHelper","sap/suite/ui/generic/template/ListReport/controller/MultipleViewsMultipleTablesModeHelper","sap/ui/model/Filter","sap/suite/ui/generic/template/lib/testableHelper","sap/base/Log"],function(B,M,a,F,t,L){"use strict";var P="/listReport/multipleViews";var b=P+"/selectedKey";var c=P+"/mode";var d=P+"/items";function s(o,I){if(o.getBindings){var e=o.getBindings();for(var i=0;i<e.length;i++){s(e[i],I);}}else{var T=o.getType();o.setType(T,I);}}function g(S,C,T){var I;var q;var m;var e;var o=T.oComponentUtils.getTemplatePrivateModel();var f;var D=T.oServices.oApplication.getBusyHelper().getBusyDelay();function h(){return q&&q.enableAutoBinding;}function r(){if(I&&I.fnRegisterToChartEvents){return I.fnRegisterToChartEvents.apply(null,arguments);}}function k(){if(I&&I.onDetailsActionPress){return I.onDetailsActionPress.apply(null,arguments);}}function l(){if(!I){return;}var i=A();return i.templateSortOrder;}function n(i){var j;if(!i){return"";}if(i.state==="error"){return T.oCommonUtils.getText("SEG_BUTTON_ERROR",i.text);}if(i.state===""||i.state==="busy"){var g1=sap.ui.core.format.NumberFormat.getIntegerInstance({groupingEnabled:true});j=g1.format(i.count);}return T.oCommonUtils.getText("SEG_BUTTON_TEXT",[i.text,i.state==="busyLong"?"...":j]);}function p(){if(I){var i=o.getProperty(b);var j=I.getContentForIappState(i);return{mode:m,state:j};}}function R(i){if(I){var j=I.getSelectedKeyAndRestoreFromIappState(i);if(f[j]){o.setProperty(b,j);}}}function u(i,j,g1){if(I){I.setControlVariant&&I.setControlVariant(i,j,g1);}}function v(){return o.getProperty(b);}function w(g1,h1){var i1=[],j1;var k1=T.oCommonUtils.getElementCustomData(h1).variantAnnotationPath;if(k1){var l1=g1[k1];if(!l1){return[];}if(!l1.SelectOptions&&l1.SelectionVariant){l1=l1.SelectionVariant;if(l1.Path){k1=l1.Path.split("@")[1];l1=k1&&g1[k1];}}if(l1.AnnotationPath){j1=l1.AnnotationPath.split("@")[1];l1=g1[j1];}for(var i in l1.SelectOptions){if(l1.SelectOptions[i].PropertyName){var m1=l1.SelectOptions[i].PropertyName.PropertyPath;for(var j in l1.SelectOptions[i].Ranges){var n1=l1.SelectOptions[i].Ranges[j].Option;n1.EnumMember=n1.EnumMember.replace("com.sap.vocabularies.UI.v1.SelectionRangeOptionType/","");var o1=l1.SelectOptions[i].Ranges[j].Low;var p1=l1.SelectOptions[i].Ranges[j].High;var q1=Object.keys(o1)[0];if(p1){var r1=Object.keys(p1)[0];i1.push(new F(m1,n1.EnumMember,o1[q1],p1[r1]));}else{i1.push(new F(m1,n1.EnumMember,o1[q1]));}}}}}return i1;}function x(j,g1){j.getCustomData().forEach(function(h1){var i1=h1.getKey();if(i1==="text"){var j1=h1.getBinding("value");var k1=!j1&&h1.getBindingInfo("value");if(!j1&&!k1){var l1=Object.assign({},o.getProperty(g1));l1.text=h1.getValue();o.setProperty(g1,l1);return;}var m1=function(n1){var j1=n1.getSource();var l1=Object.assign({},o.getProperty(g1));l1.text=j1.getExternalValue();o.setProperty(g1,l1);};if(j1){j1.attachChangeOnce(m1);s(j1,"string");}else{k1.events={change:m1};for(var i=0;i<k1.parts.length;i++){k1.parts[i].targetType="string";}}}});}function y(i,j,g1){var h1=C.getOwnerComponent().getModel().getMetaModel();var i1=h1.getODataEntitySet(g1);var j1=h1.getODataEntityType(i1.entityType);var k1=w(j1,j);var l1=T.oCommonUtils.getElementCustomData(j);var m1=f[i]||Object.create(null);m1.selectionVariantFilters=k1;m1.templateSortOrder=l1.TemplateSortOrder;m1.implementingControl=j;m1.entitySet=g1;m1.dirtyState=0;f[i]=m1;if(e){var n1=d+"/"+i;var o1=function(q1,r1,s1){if(m1.numberOfUpdates!==r1){return;}var p1=Object.assign({},o.getProperty(n1));if(!p1.state&&q1=="busy"){setTimeout(function(){if(o.getProperty(n1).state==="busy"){p1=Object.assign({},o.getProperty(n1));p1.state="busyLong";o.setProperty(n1,p1);}},D);}p1.state=q1;if(!q1){p1.count=s1;}o.setProperty(n1,p1);};m1.numberOfUpdates=0;m1.updateStartFunction=o1.bind(null,"busy");m1.updateSuccessFunction=o1.bind(null,"");m1.errorFunction=o1.bind(null,"error");var p1={count:0,state:""};o.setProperty(n1,p1);x(j,n1);}}function z(){return m;}function A(){return f[o.getProperty(b)];}function E(i){if(!I){return;}var j=i.getParameter("bindingParams");S.oFiltersWithoutSmartFilterBar=jQuery.extend(true,{},j);if(z()==="multi"){var g1=S.oSmartFilterbar.getFilters();S.oFiltersForCounts=H(j);K(S.oSmartTable,j,g1);}else if(z()==="single"){S.oFiltersForCounts=jQuery.extend(true,{},j);}G(j);}function G(j){var g1=A();if(g1){var h1=g1.selectionVariantFilters;for(var i in h1){j.filters.push(h1[i]);}}}function H(i){var j=jQuery.extend(true,{},i);J(j.filters,S.oMultipleViewsHandler.aTableFilters);return j;}function J(g1,h1){for(var i in h1){var i1=h1[i];for(var j=g1.length;j--;j>=0){if(JSON.stringify(g1[j])===JSON.stringify(i1)){g1.splice(j,1);break;}}}}function U(){var i=S.oSmartTable.getModel();var j=[],g1,h1;var i1=S.oSmartFilterbar.getBasicSearchValue();var j1={};var k1;if(i1){j1={search:i1};}var l1;for(var m1 in f){l1=jQuery.extend(true,{},S.oFiltersForCounts);k1=S.oSmartFilterbar.getFilters();var n1=f[m1];g1=n1.entitySet;if(!g1){g1=S.oSmartTable.getEntitySet();}h1=typeof S.oSmartTable.getTableBindingPath==="function"?S.oSmartTable.getTableBindingPath():S.oSmartTable.getChartBindingPath();n1.numberOfUpdates++;n1.updateStartFunction(n1.numberOfUpdates);if(z()==="multi"){K(n1.implementingControl,l1,k1);}j=l1.filters.concat(n1.selectionVariantFilters);var o1=h1!==""?h1:"/"+g1;i.read(o1+"/$count",{urlParameters:j1,filters:j,groupId:"updateMultipleViewsItemsCounts",success:n1.updateSuccessFunction.bind(null,n1.numberOfUpdates),error:n1.errorFunction.bind(null,n1.numberOfUpdates)});}}function K(i,j,g1){V(i,g1,j);}function N(){if(e){U();}}function O(){return e;}function Q(i){var j=T.oCommonUtils.getMetaModelEntityType(i);return j.navigationProperty;}function V(i,j,g1){var h1=[],i1=[],j1;if(j.length<1){return;}h1=_(i,j);i1=g1.filters&&g1.filters.slice();i1=i1.concat(h1);if(i1.length>0){j1=new F(i1,true);g1.filters=[j1];}}function W(i){var j;for(j in f){if(f[j].implementingControl===i){return f[j].properties;}}}function X(j,g1,h1,i1,j1){var k1,l1,m1,n1,o1;if(j.indexOf("/")!==-1){k1=j.split("/");for(var i=0;i<k1.length-1;i++){l1=k1[i];for(var i in j1){if(j1[i].name===l1){m1=true;break;}}if(!m1){return false;}n1=h1.getODataAssociationEnd(i1,l1);i1=n1&&h1.getODataEntityType(n1.type);j1=i1&&i1.navigationProperty;}o1=i1&&i1.property;}else{o1=W(g1);}return o1;}function Y(i){var j,g1;if(i.indexOf("/")!==-1){j=i.split("/");g1=j.pop();}else{g1=i;}return g1;}function Z(i){var j=T.oCommonUtils.isSmartTable(S.oSmartTable);if(i!==2){S.oSmartTable[j?"rebindTable":"rebindChart"]();}if(i>1){if(j){T.oCommonUtils.refreshModel(S.oSmartTable);T.oCommonUtils.refreshSmartTable(S.oSmartTable);}else{}}}function $(i,j,g1){if(!I){return false;}var h1=Array.isArray(j);if((h1&&j.length===0)||(g1&&jQuery.isEmptyObject(g1))){return true;}var i1=v();var j1=T.oComponentUtils.isComponentActive();if(m==="single"){if(h1?j.indexOf(i1)<0:(j&&j!==i1)){return true;}if(j1){Z(i);return true;}else{j=i1;h1=false;}}var k1=function(l1){if(l1===i1&&j1){Z(i);return;}var m1=f[l1];if(m1.dirtyState>0&&m1.dirtyState!==i){m1.dirtyState=3;}else{m1.dirtyState=i;}};if(j){if(h1){j.forEach(k1);return true;}k1(j);return true;}for(var l1 in f){if(!g1||g1[f[l1].implementingControl.getEntitySet()]){k1(l1);}}return true;}function _(i,g1){var h1,i1,j1,j,k1,l1,m1,n1,o1,p1,o1,q1,r1=[];if(!g1||g1.length<1){return;}m1=i.getModel().getMetaModel();n1=T.oCommonUtils.getMetaModelEntityType(i);l1=Q(i);q1=f[o.getProperty(b)];o1=jQuery.extend(true,[],g1);if(o1[0]&&o1[0].aFilters instanceof Array){k1=o1[0].aFilters;}else{k1=o1;}if(!k1){return;}for(j=k1.length-1;j>=0;j--){i1=false;if(k1[j].aFilters instanceof Array){if(k1[j].aFilters[0].sPath){j1=k1[j].aFilters[0].sPath;}else if(k1[j].aFilters[0].aFilters[0].sPath){j1=k1[j].aFilters[0].aFilters[0].sPath;}else{L.error("MultipleViewsHandler: The filter name could not be determined.");}}else{j1=k1[j].sPath;}h1=X(j1,i,m1,n1,l1);if(!h1){k1.splice(j,1);continue;}p1=Y(j1);h1.some(function(t1){var u1;if(t1.name===p1){u1=t1["com.sap.vocabularies.UI.v1.Hidden"];i1=u1?u1.Bool!=="true":true;return i1;}});if(!i1){if(q1&&q1.entitySet===i.getEntitySet()&&(q1.implementingControl.getMetadata().getElementName()===i.getMetadata().getElementName())){if(!r1.includes(p1)){r1.push(p1);}}k1.splice(j,1);}}if(o1&&o1[0]&&o1[0].aFilters&&o1[0].aFilters.length<1){o1=[];}if(q1&&q1.entitySet===i.getEntitySet()&&(q1.implementingControl.getMetadata().getElementName()===i.getMetadata().getElementName())){if(I&&I.formatNotAppliedFilters){I.formatNotAppliedFilters(r1,i);}if(I&&I.fnCheckForMessageDisplay&&I.fnGetNotAppliedFilter){var s1=I.fnGetNotAppliedFilter();I.fnCheckForMessageDisplay(s1);}}return o1;}function a1(){var j=false;for(var i in q.variants){if(!!q.variants[i].entitySet){j=true;}else{j=false;}}return j;}function b1(){if(I&&I.setActiveButtonState){I.setActiveButtonState();}}function c1(){if(I&&I.restoreActiveButtonState){I.restoreActiveButtonState();}}function d1(){if(I&&I.getActiveButtonStateCustomData){var i=I.getActiveButtonStateCustomData();var j=i?JSON.parse(i.getValue()):false;o.setProperty("/listReport/activeObjectEnabled",j);}}function e1(){if(I&&I.onMessageCloseActionPress){I.onMessageCloseActionPress();}}function f1(i){if(!I){return C.getOwnerComponent().getEntitySet()===i;}for(var j in f){var g1=f[j];if(g1.entitySet===i){return true;}}return false;}(function(){var i,j,g1,h1;i=C.getOwnerComponent().getAppComponent().getConfig();j=i&&i.pages[0]&&i.pages[0].component&&i.pages[0].component.settings;if(!j){return;}g1=j.quickVariantSelectionX;h1=j.quickVariantSelection;if(g1&&h1){throw new Error("Defining both QuickVariantSelection and QuickVariantSelectionX in the manifest is not allowed.");}q=g1||h1;if(!q){return;}if(g1&&a1()){e=q.showCounts===false?false:true;}else{e=q.showCounts;}f=Object.create(null);o.setProperty(P,Object.create(null));o.setProperty(d,Object.create(null));var i1=C.byId("page");var j1=function(k1){o.setProperty(b,k1);var l1=o.bindProperty(b);l1.attachChange(function(m1){if(I&&I.fnSetMessageVisibility&&I.fnSetNotAppliedFilter){I.fnSetNotAppliedFilter([]);I.fnSetMessageVisibility(I.fnGetNotAppliedFilter());}if(i1){i1.setPreserveHeaderStateOnScroll(true);}var n1=m1.getSource().getValue();if(I.onSelectedKeyChanged){I.onSelectedKeyChanged(n1);}d1();var o1=S.oIappStateHandler.areDataShownInTable()||S.oWorklistData.bWorkListEnabled;var p1=(m==="single")?3:f[n1].dirtyState;if(S.oWorklistData.bWorkListEnabled&&p1<2){p1=p1+2;}if(o1&&p1>0){Z(p1);}else{T.oCommonUtils.setEnabledToolbarButtons(S.oSmartTable);if(I&&I.fnUpdateMessageForFilter){I.fnUpdateMessageForFilter(S.oSmartTable);}}f[n1].dirtyState=0;S.oIappStateHandler.changeIappState(true,o1);if(T.oCommonUtils.isSmartTable(S.oSmartTable)){if(i1&&i1.getPreserveHeaderStateOnScroll()){i1.setPreserveHeaderStateOnScroll(false);}}});};if(h1){I=new M(h1,S,C,T,j1,f,y);m="single";L.info("This list supports multiple views with single table");}else{I=new a(g1,S,C,T,j1,f,y);m="multi";L.info("This list supports multiple views with multiple tables/charts");}o.setProperty(c,m);})();var J=t.testable(J,"fnRemoveTableSettingsFromFilters");var _=t.testable(_,"fnCleanupIrrelevantFilters");var W=t.testable(W,"findEntityProperties");var V=t.testable(V,"fnAddFiltersFromSmartFilterbar");var w=t.testable(w,"getSelectionVariantFilters");t.testable(function(){return I;},"getImplementingHelper");return{getEnableAutoBinding:h,fnRegisterToChartEvents:r,onDetailsActionPress:k,determineSortOrder:l,onDataRequested:N,formatItemTextForMultipleView:n,getContentForIappState:p,restoreFromIappState:R,getVariantSelectionKey:v,getMode:z,onRebindContentControl:E,getShowCounts:O,refreshOperation:$,onMessageCloseActionPress:e1,setActiveButtonState:b1,restoreActiveButtonState:c1,setControlVariant:u,hasEntitySet:f1};}return B.extend("sap.suite.ui.generic.template.ListReport.controller.MultipleViewsHandler",{constructor:function(S,C,T){Object.assign(this,g(S,C,T));}});});

// Copyright (c) 2009-2017 SAP SE, All Rights Reserved
sap.ui.define(["sap/ui/performance/trace/FESR","sap/ushell/EventHub","sap/base/Log"],function(F,E,U){"use strict";var S={HOME_INITIAL:"HOME INITIAL",HOME_FROM_APP:"HOME FROM APP",FINDER_INITIAL:"FINDER INITIAL",APP_INITIAL:"APP INITAL",APP_FROM_HOME:"APP FROM HOME",APP_FROM_APP:"APP FROM APP"};var f={_trackedEvents:[],_detachers:[],_fnOriginalOnBeforeCreated:null,init:function(){if(F.getActive()){this._attachToEventHub("AppRendered",this._enhanceAppDataEvent.bind(this));this._fnOriginalOnBeforeCreated=F.onBeforeCreated;F.onBeforeCreated=this._onBeforeCreatedHandler.bind(this);}},reset:function(){F.onBeforeCreated=this._fnOriginalOnBeforeCreated;this._detachers.forEach(function(d){d();});this._trackedEvents=[];this._detachers=[];this._lastFioriIds=undefined;},_getPerformanceEntries:function(e){return performance.getEntriesByName(e);},_trackEvent:function(e,o){var t={name:e};this._trackedEvents.push(t);return t;},_attachToEventHub:function(e,a){var t=this,d=E.on(e),h;if(a){h=function(){var T=t._trackEvent(e);a(T);};}else{h=this._trackEvent.bind(this,e);}d.do(h);this._detachers.push(d.off);},_enhanceAppDataEvent:function(t){var a=this;sap.ushell.Container.getServiceAsync("AppLifeCycle").then(function(A){var m,s,c=A.getCurrentApplication();if(c&&c.applicationType==="UI5"){m=c.componentInstance.getManifest();if(m&&m["sap.fiori"]&&m["sap.fiori"].registrationIds&&m["sap.fiori"].registrationIds.length>0){s=m["sap.fiori"].registrationIds.reduce(function(b,C){if(b){b+=";"+C;}else{b=C;}return b;});}}if(s){t.fioriIds=s;a._setLastTrackedFioriIds(s);}else{a._setLastTrackedFioriIds();}});},_setLastTrackedFioriIds:function(s){this._lastFioriIds=s;},_getLastTrackedFioriIds:function(){return this._lastFioriIds;},_onBeforeCreatedHandler:function(u,o){var d=this._detectScenario(u,o,this._trackedEvents),l=this._getLastTrackedFioriIds();if(l){u.appNameShort=l;}if(!d.scenario){return u;}return this._enhanceRecord(d.scenario,{stepName:u.stepName,appNameLong:u.appNameLong,appNameShort:u.appNameShort,timeToInteractive:u.timeToInteractive},d.relatedEvent);},_detectScenario:function(u,o,t){function c(s,e){var r={scenario:s};if(e){r.relatedEvent=e;}return r;}if(u.stepName==="undetermined_startup"){switch(u.appNameLong){case"sap.ushell.components.homepage":return c(S.HOME_INITIAL);case"sap.ushell.components.appfinder":return c(S.FINDER_INITIAL);default:break;}if(t.length>0&&t[0].name==="AppRendered"){return c(S.APP_INITIAL,t[0]);}}return c(null);},_enhanceRecord:function(d,i,r){switch(d){case S.HOME_INITIAL:return this._enhanceInitialStart(i,"FLP@LOAD","FLP-TTI-Homepage");case S.FINDER_INITIAL:return this._enhanceInitialStart(i,"FLP@LOAD_FINDER","FLP-TTI-AppFinder");case S.APP_INITIAL:return this._enhanceInitialAppStart(i,"FLP@DEEP_LINK",null,r);default:break;}U.warning("Unknown scenario at the end of execution, unnecessary code executed",null,"sap.ushell.performance.FesrEnhancer");return i;},_enhanceInitialStart:function(i,s,p){var m,e={stepName:s,appNameLong:i.appNameLong,appNameShort:"",timeToInteractive:i.timeToInteractive};if(p){m=this._getPerformanceEntries(p)[0];if(m){e.timeToInteractive=m.startTime;return e;}U.warning("Scenario '"+s+"' detected but expected performance mark '"+p+"' does not exist",null,"sap.ushell.performance.FesrEnhancer");}return e;},_enhanceInitialAppStart:function(i,s,p,r){var e=this._enhanceInitialStart(i,s,p);if(r&&r.fioriIds){e.appNameShort=r.fioriIds;}return e;}};return f;},true);

/*
 * ! SAPUI5

		(c) Copyright 2009-2019 SAP SE. All rights reserved
	
 */
sap.ui.define(['sap/ui/mdc/base/FieldValueHelpContentWrapperBase','sap/ui/model/ChangeReason','sap/ui/model/Filter','sap/ui/model/FormatException','sap/ui/model/ParseException','sap/ui/base/ManagedObjectObserver','sap/base/strings/capitalize','sap/m/library','sap/base/util/deepEqual','sap/base/Log'],function(F,C,a,b,P,M,c,l,d,L){"use strict";var e=l.ListMode;var S;var f=F.extend("sap.ui.mdc.field.FieldValueHelpMTableWrapper",{metadata:{library:"sap.ui.mdc",aggregations:{table:{type:"sap.m.Table",multiple:false}},defaultAggregation:"table",events:{dataUpdate:{}}}});f.prototype.init=function(){F.prototype.init.apply(this,arguments);this._oObserver=new M(h.bind(this));this._oObserver.observe(this,{properties:["selectedItems"],aggregations:["table"]});this._oTablePromise=new Promise(function(R){this._oTablePromiseResolve=R;}.bind(this));this._oResourceBundle=sap.ui.getCore().getLibraryResourceBundle("sap.ui.mdc");this._oPromises={};};f.prototype.exit=function(){F.prototype.exit.apply(this,arguments);if(this._oScrollContainer){this._oScrollContainer.destroy();delete this._oScrollContainer;}this._oObserver.disconnect();this._oObserver=undefined;delete this._oTablePromise;delete this._oTablePromiseResolve;};f.prototype.invalidate=function(O){if(O){var T=this.getTable();if(T&&O===T){if(O.bOutput&&!this._bIsBeingDestroyed){var i=this.getParent();if(i){i.invalidate(this);}}return;}}F.prototype.invalidate.apply(this,arguments);};f.prototype.initialize=function(i){if(i||this._oScrollContainer){return this;}if(!S&&!this._bScrollContainerRequested){S=sap.ui.require("sap/m/ScrollContainer");if(!S){sap.ui.require(["sap/m/ScrollContainer"],_.bind(this));this._bScrollContainerRequested=true;}}if(S&&!this._bScrollContainerRequested){this._oScrollContainer=new S(this.getId()+"-SC",{height:"100%",width:"100%",vertical:true});this._oScrollContainer._oWrapper=this;this._oScrollContainer.getContent=function(){var j=[];var T=this._oWrapper&&this._oWrapper.getTable();if(T){j.push(T);}return j;};}return this;};function _(i){S=i;this._bScrollContainerRequested=false;if(!this._bIsBeingDestroyed){this.initialize();this.fireDataUpdate({contentChange:true});}}f.prototype.getDialogContent=function(){return this._oScrollContainer;};f.prototype.getSuggestionContent=function(){return this.getTable();};f.prototype.fieldHelpOpen=function(i){F.prototype.fieldHelpOpen.apply(this,arguments);var T=this.getTable();if(T){n.call(this,T,i);s.call(this);if(i){var j=T.getSelectedItem();if(j&&j.getDomRef()){j.getDomRef().scrollIntoView();}}}return this;};f.prototype.navigate=function(i){var T=this.getTable();if(!v(T)){this._bNavigate=true;this._iStep=i;return;}var j=T.getSelectedItem();var I=T.getItems();var w=I.length;var x=0;if(j){x=T.indexOfItem(j);x=x+i;}else if(i>=0){x=i-1;}else{x=w+i;}if(x<0){x=0;}else if(x>=w-1){x=w-1;}var y=I[x];if(y&&y!==j){y.setSelected(true);var V=t.call(this,y);if(y.getDomRef()){y.getDomRef().scrollIntoView();}this._bNoTableUpdate=true;this.setSelectedItems([{key:V.key,description:V.description,inParameters:V.inParameters,outParameters:V.outParameters}]);this._bNoTableUpdate=false;this.fireNavigate({key:V.key,description:V.description,inParameters:V.inParameters,outParameters:V.outParameters});}};f.prototype.getTextForKey=function(K,I,O){if(K===null||K===undefined){return null;}var T=this.getTable();if(v(T)){var R={key:K,description:""};var j=T.getItems();var w;var x;var y=false;if(I){w=[];for(var z in I){w.push(z);}}if(O){x=[];for(var A in O){x.push(A);}}for(var i=0;i<j.length;i++){var B=j[i];var V=t.call(this,B,w,x);if(V.key===K&&(!V.inParameters||!I||d(I,V.inParameters))&&(!V.outParameters||!O||d(O,V.outParameters))){R.description=V.description;R.inParameters=V.inParameters;R.outParameters=V.outParameters;y=true;break;}}if(y){return R;}}return g.call(this,this._getKeyPath,K,"description",I,O,true);};f.prototype.getKeyForText=function(T,I){if(!T){return null;}var j=this.getTable();if(v(j)){var R={key:undefined,description:T};var w=j.getItems();var x;var y=false;if(I){x=[];for(var z in I){x.push(z);}}for(var i=0;i<w.length;i++){var A=w[i];var V=t.call(this,A,x);if(V.description===T&&(!V.inParameters||!I||d(I,V.inParameters))){R.key=V.key;R.inParameters=V.inParameters;R.outParameters=V.outParameters;y=true;break;}}if(y){return R;}}return g.call(this,this._getDescriptionPath,T,"key",I,undefined,false);};function g(i,V,R,I,O,U){var j=i.call(this);if(this._oPromises[j]&&this._oPromises[j][V]){return this._oPromises[j][V];}if(!this._oPromises[j]){this._oPromises[j]={};}this._oPromises[j][V]=new Promise(function(w,x){this._oTablePromise.then(function(T){var y=j;j=i.call(this);if(!j){x(new Error("missing FieldPath"));}if(j!==y){if(!this._oPromises[j]){this._oPromises[j]={};}this._oPromises[j][V]=this._oPromises[y][V];delete this._oPromises[y][V];}var z=this.getListBinding();var A=z.getModel();var B=z.getPath();var D=new a(j,"EQ",V);var E=z.getContext();var G=[];if(I){for(var H in I){G.push(new a(H,"EQ",I[H]));}}if(O){for(var J in O){if(!I||!I.hasOwnProperty(J)||I[J]!==O[J]){G.push(new a(J,"EQ",O[J]));}}}if(G.length>0){G.push(D);D=new a({filters:G,and:true});}try{var K=A.bindList(B,E);var N=function(){var W=K.getContexts();if(W.length===1){var X=u.call(this,W[0]);var Y={key:X.key,description:X.description,inParameters:X.inParameters,outParameters:X.outParameters};w(Y);}else if(V===""&&W.length===0){w(null);}else{var Z;var $;var a1=false;if(W.length>1){Z=this._oResourceBundle.getText("valuehelp.VALUE_NOT_UNIQUE",[V]);a1=true;}else{Z=this._oResourceBundle.getText("valuehelp.VALUE_NOT_EXIST",[V]);}if(U){$=new b(Z);}else{$=new P(Z);}$._bNotUnique=a1;x($);}K.destroy();delete this._oPromises[j][V];};if(K.isA("sap.ui.model.json.JSONListBinding")){K.filter(D);N.call(this);}else{K.attachEventOnce("dataReceived",N.bind(this));K.initialize();K.filter(D);K.getContexts(0,2);}}catch(Q){x(Q);}}.bind(this));}.bind(this));return this._oPromises[j][V];}f.prototype.getListBinding=function(){var T=this.getTable();var i;if(T){i=T.getBinding("items");}return i;};f.prototype.getAsyncKeyText=function(){return true;};f.prototype.clone=function(i,j){var T=this.getTable();if(T){T.detachEvent("itemPress",o,this);T.detachEvent("selectionChange",p,this);T.detachEvent("updateFinished",r,this);}var w=F.prototype.clone.apply(this,arguments);if(T){T.attachEvent("itemPress",o,this);T.attachEvent("selectionChange",p,this);T.attachEvent("updateFinished",r,this);}return w;};function h(i){if(i.name==="table"){k.call(this,i.mutation,i.child);}if(i.name==="selectedItems"){s.call(this);}}function k(i,T){if(i==="remove"){T.detachEvent("itemPress",o,this);T.detachEvent("selectionChange",p,this);T.detachEvent("updateFinished",r,this);T.detachEvent("modelContextChange",m,this);T=undefined;this._oTablePromise=new Promise(function(R){this._oTablePromiseResolve=R;}.bind(this));}else{T.setMode(e.SingleSelectMaster);T.setRememberSelections(false);T.attachEvent("itemPress",o,this);T.attachEvent("selectionChange",p,this);T.attachEvent("updateFinished",r,this);n.call(this,T,this._bSuggestion);s.call(this);if(this._bNavigate){this._bNavigate=false;this.navigate(this._iStep);}if(this.getListBinding()){this._oTablePromiseResolve(T);}else{T.attachEvent("modelContextChange",m,this);}}this.fireDataUpdate({contentChange:true});}function m(E){if(this.getListBinding()){var T=E.getSource();this._oTablePromiseResolve(T);T.detachEvent("modelContextChange",m,this);}}function n(T,i){if(T&&this.getParent()){if(i){if(this._sTableWidth){T.setWidth(this._sTableWidth);}T.setMode(e.SingleSelectMaster);}else{if(T.getWidth()!=="100%"){this._sTableWidth=T.getWidth();T.setWidth("100%");}if(this._getMaxConditions()===1){T.setMode(e.SingleSelectLeft);}else{T.setMode(e.MultiSelect);}}}}function o(E){var i=E.getParameter("listItem");if(!this._bSuggestion){i.setSelected(!i.getSelected());}q.call(this);}function p(E){if(!this._bSuggestion){q.call(this);}}function q(){var I=[];var T=this.getTable();if(T){var w=this.getSelectedItems();var x=T.getItems();var i=0;var y;var V;if(w.length>0){for(i=0;i<x.length;i++){y=x[i];V=t.call(this,y);if(!V){throw new Error("Key of item cannot be determined"+this);}for(var j=w.length-1;j>=0;j--){var z=w[j];if(z.key===V.key&&(!V.inParameters||!z.inParameters||d(z.inParameters,V.inParameters))&&(!V.outParameters||!z.outParameters||d(z.outParameters,V.outParameters))){w.splice(j,1);break;}}}}if(w.length>0){I=w;}w=T.getSelectedItems();for(i=0;i<w.length;i++){y=w[i];V=t.call(this,y);if(!V){throw new Error("Key of item cannot be determined"+this);}I.push({key:V.key,description:V.description,inParameters:V.inParameters,outParameters:V.outParameters});}}this._bNoTableUpdate=true;this.setSelectedItems(I);this._bNoTableUpdate=false;this.fireSelectionChange({selectedItems:I});}function r(E){if(!this.getParent()){return;}s.call(this);if(this._bNavigate){this._bNavigate=false;this.navigate(this._iStep);}if(E.getParameter("reason")!==c(C.Filter)){this.fireDataUpdate({contentChange:false});}}function s(){if(this._bNoTableUpdate){return;}var T=this.getTable();if(v(T)){var w=this.getSelectedItems();var I=T.getItems();for(var j=0;j<I.length;j++){var x=I[j];var y=false;if(w.length>0){var V=t.call(this,x);for(var i=0;i<w.length;i++){var z=w[i];if(V.key===z.key&&(!V.inParameters||!z.inParameters||d(z.inParameters,V.inParameters))&&(!V.outParameters||!z.outParameters||d(z.outParameters,V.outParameters))){y=true;break;}}}if(x.getSelected()!==y){x.setSelected(y);}}}}function t(i,I,O){var V;var B=i.getBindingContext();if(B){V=u.call(this,B,I,O);}if(!V){var K=this._getKeyPath();var j;var D;if(!K&&i.getCells){var w=i.getCells();if(w.length>0&&w[0].getText){j=w[0].getText();}if(w.length>1&&w[1].getText){D=w[1].getText();}if(j!==undefined){V={key:j,description:D};}}}if(!V){throw new Error("Key could not be determined from item "+this);}return V;}function u(B,I,O){var K=this._getKeyPath();var D=this._getDescriptionPath();var j=B.getObject();var w;var x;if(!I){I=this._getInParameters();}if(!O){O=this._getOutParameters();}var y=I.length>0?{}:null;var z=O.length>0?{}:null;var A;if(j){if(K&&j.hasOwnProperty(K)){w=j[K];}if(D&&j.hasOwnProperty(D)){x=j[D];}var i=0;for(i=0;i<I.length;i++){A=I[i];if(j.hasOwnProperty(A)){y[A]=j[A];}}for(i=0;i<O.length;i++){A=O[i];if(j.hasOwnProperty(A)){z[A]=j[A];}else{L.error("FieldValueHelpMTableWrapper","cannot find out-parameter '"+A+"' in item data!");}}}if(w===null||w===undefined){return false;}return{key:w,description:x,inParameters:y,outParameters:z};}function v(T){if(!T){return false;}var B=T.getBinding("items");if(B&&(B.isSuspended()||B.getLength()===0)){return false;}return true;}return f;},true);

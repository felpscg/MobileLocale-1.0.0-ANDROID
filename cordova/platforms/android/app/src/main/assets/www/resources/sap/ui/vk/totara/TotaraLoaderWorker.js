(function(){"use strict";function H(){var a,b;var d;var o;var e=[];var m=4;var f=0;function h(a){var p=new Promise(function(i,j){var x=new XMLHttpRequest();x.onload=function(){if(this.status>=200&&this.status<300){i(x.response);}else{j({status:this.status,statusText:x.statusText});}};x.onerror=function(){j({status:this.status,statusText:x.statusText});};x.open("GET",a,true);if(d){x.setRequestHeader("Authorization",d);}x.setRequestHeader("X-CorrelationID",b);x.responseType="arraybuffer";x.send();});return p;}this.getUrl=function(){return a;};this.close=function(){};this.send=function(i,j,k){if(!i){return;}e.push({message:i,context:j,onResponse:k||this.onResponse});if(f<m){_();}};function _(){if(!e.length){return;}var i=e.shift();f++;h(encodeURI(a+i.message)).then(function(j){if(i.onResponse){i.onResponse(j);}f--;_();}).catch(function(j){if(o){o({errorText:"Could not connect to server: "+a,error:j.status,reason:j.message?j.message:j,context:i.context});}f--;_();});}this.init=function(s,i,j){return new Promise(function(k,n){a=s;b=j;if(i!=null){i(s).then(function(t){if(t!=null){d=t.token_type+" "+t.access_token;}else{d=null;}k({});}).catch(function(p){return n(p);});}else{k({});}});};this.setOnErrorCallback=function(i){o=i;};this.onResponse=null;}function W(){var a;var t=this;var b;var o;function i(){if(b&&b.readyState===1){return true;}return false;}function d(e,n,p){if(o){o({errorText:e,error:p,context:n});}}this.setOnErrorCallback=function(e){o=e;};this.getUrl=function(){return a;};this.close=function(){if(b){b.close();b=null;}};this.send=function(n,p){if(!n){return;}if(!i()){d("websocket connection lost",p,4);}else{try{b.send(n);}catch(e){d(e,p);}}};var f=0;function k(){var e=60000;if(b==null){clearTimeout(f);return;}if(b.readyState==1){b.send("");}f=setTimeout(k,e);}function h(){if(f){clearTimeout(f);f=0;}}var j=false;var m=function(e){var n=JSON.stringify(e);var p="setStreamingToken"+("["+n.length+"]")+n;return p;};this.init=function(s,n){return new Promise(function(p,q){if(s){a=s;}else{s=a;}b=new WebSocket(s);b.binaryType="arraybuffer";b.onopen=function(){j=true;if(n!=null){n(s).then(function(e){if(e!=null){var v=m({"token":e.access_token});b.send(v);}k();p({});}).catch(function(e){return q(e);});}else{k();p({});}};b.onclose=function(){h();};b.onmessage=function(e){var v=e.data;if(t.onResponse){t.onResponse(v);}};b.onerror=function(e){if(!j){q("error connecting to "+s);}else{d(e);}};});};this.onResponse=null;}function g(a){var b=a.split(",");if(b.length<0||b.length>2){throw"invalid content length";}var j=0;var d=0;try{j=parseInt(b[0],10);if(b.length===2){d=parseInt(b[1],10);}}catch(e){throw"invalid content length";}return{jsonContentLength:j,binaryContentLength:d};}if(!Uint8Array.prototype.slice){Object.defineProperty(Uint8Array.prototype,"slice",{value:function(b,e){return new Uint8Array(Array.prototype.slice.call(this,b,e));}});}function c(a){var b="[".charCodeAt(0);var d="]".charCodeAt(0);var f=[];var s=0;var h=0;var i;var j;var k;var m=new Uint8Array(a);while(h<a.byteLength){h=m.indexOf(b,s);if(h===-1){break;}var n=u(a,s,h).replace(/\n|\r|\s/g,"");s=h+1;h=m.indexOf(d,s);if(h===-1){throw"No matching [] for command length. abort";}i=g(u(a,s,h));s=h+1;h=s+i.jsonContentLength;j=u(a,s,h);try{j=JSON.parse(j);}catch(e){var o=n+": "+e;throw o;}if(i.binaryContentLength){s=h;h=s+i.binaryContentLength;k=a.slice(s,h);}else{k=undefined;}s=h;var p={name:n,jsonContent:j};if(k){p.binaryContent=new Uint8Array(k);}f.push(p);}return f;}function u(a,s,b){var d="";var M=1000;try{while(s<b){var f=Math.min(M,b-s);var h=new Uint8Array(a,s,f);d+=String.fromCharCode.apply(null,h);s+=f;}}catch(e){return"";}return decodeURIComponent(escape(d));}function L(){this.resolveFunctions=[];this.rejectFunctions=[];this.init=function(b,h,d){this._connection=b;this._connectionHTTP=h;this._sceneBuilderId=d;if(!b){throw"no connection provided for loader!";}this._connection.onResponse=function(e){var f=c(e);p(f);};this._connection.send("getVersion[2]{}");};var t=this;function a(v){t.protocolVersion=v.split(".").map(function(s){return parseInt(s,10);});}function p(b){var d;var v,i;var n=false;for(i=0;i<b.length;i++){d=b[i];if(d.name==="setView"){if(!d.jsonContent.viewId){n=true;}}else if(d.name==="setViewNode"){v=d.jsonContent.viewId;}else if(d.name==="notifyFinishedView"||d.name==="notifyFinishedTree"){break;}}if(v&&n){for(i=0;i<b.length;i++){d=b[i];if(d.name==="setView"){d.jsonContent.viewId=v;break;}}}for(i=0;i<b.length;i++){d=b[i];if(d.name==="protocol"){a(d.jsonContent.version);}if(d.binaryContent){self.postMessage({name:d.name,jsonContent:d.jsonContent,binaryContent:d.binaryContent},[d.binaryContent.buffer]);}else{self.postMessage({name:d.name,jsonContent:d.jsonContent});}}}this.getConnection=function(){return this._connection;};this._sendGetImage=function(i,b){this._connectionHTTP.send("images/"+i,b,function(d){p([{name:"setImage",jsonContent:{sceneId:b.sceneId,id:i},binaryContent:new Uint8Array(d)}]);});};this._sendGetGeometries=function(b,d){var e="geometry?";for(var i=0;i<b.length;i++){e+=(i>0?"&id=":"id=")+b[i];}this._connectionHTTP.send(e,d,function(f){var h=new DataView(f);var j=h.getUint16(2,true),o=0;var k=[];while(j-->0){var m={sceneId:d.sceneId,id:h.getUint32(o+4,true).toString(),box:[h.getFloat32(o+14,true),h.getFloat32(o+18,true),h.getFloat32(o+22,true),h.getFloat32(o+26,true),h.getFloat32(o+30,true),h.getFloat32(o+34,true)]};var n=h.getUint16(o+8,true);if(n!==3){m.flags=h.getUint16(o+38,true);m.pointCount=h.getUint16(o+46,true);m.elementCount=h.getUint16(o+48,true);}var q=h.getUint32(o+52,true);var s=new Uint8Array(f,o+56,q);k.push({name:"setGeometry",jsonContent:m,binaryContent:s.slice()});o+=52+q;}p(k);});};this.send=function(b){if(this._connectionHTTP&&b.resources){switch(b.method){case"getImage":for(var i=0;i<b.resources.length;i++){this._sendGetImage(b.resources[i],b);}return;case"getGeometry":this._sendGetGeometries(b.resources,b);return;default:break;}}if(this._connection){this._connection.send(b.command);}};this.setSceneBuilderId=function(i){this._sceneBuilderId=i;};this.getSceneBuilderId=function(){return this._sceneBuilderId;};this.authorizationHandler=function(b){var t=this;return new Promise(function(d,e){var f={name:"getAuthorization",jsonContent:{"url":b},sceneId:t.sceneId};t.resolveFunctions.push(d);t.rejectFunctions.push(e);self.postMessage(f);});}.bind(this);}var l=new L();var r=function(e){self.postMessage({name:"notifyError",jsonContent:{error:e}});};self.onmessage=function(e){var d=e.data;switch(d.method){case"initializeConnection":{if(!d.url){break;}if(d.sceneId){l.sceneId=d.sceneId;}var a="";if(d.url[d.url.length-1]!=="/"){d.url+="/";}if(d.url.toLowerCase().startsWith("ws")){a=d.url+"streaming?";}else if(d.url.toLowerCase().startsWith("http")){a=d.url+"streaming-http?request=";}else{a=(d.useSecureConnection?"wss://":"ws://")+d.url+"streaming?";}var b=d.cid;var f=l.getConnection();if(!f||f.getUrl()!==a){if(f){f.close();}var h;var i=null;if(d.url.toLowerCase().startsWith("ws")){h=new W();}else if(d.url.toLowerCase().startsWith("http")){h=new H();i=d.url;}else{h=new W();i=(d.useSecureConnection?"https://":"http://")+d.url;}h.setOnErrorCallback(function(m){r(m);});h.init(a,l.authorizationHandler,b).then(function(){var m=function(h,n){l.init(h,n,d.sceneBuilderId);if(d.command){l.send(d);}};if(i){var n=new H();n.init(i,l.authorizationHandler,b).then(function(){m(h,n);}).catch(function(o){r(o);});}else{m(h,null);}}).catch(function(m){r(m);});}else if(d.command){l.send(d);}break;}case"setAuthorization":{var j=l.resolveFunctions.shift();var k=l.rejectFunctions.shift();if(d.error==null){j(d.authorizationToken);}else{k(d.error);}break;}case"close":{self.close();break;}default:{if(d.command){l.send(d);}break;}}};self.postMessage({ready:true});})();

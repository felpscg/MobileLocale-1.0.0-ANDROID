sap.ui.define(["sap/ui/thirdparty/jquery","sap/ui/core/mvc/Controller","sap/ui/model/json/JSONModel","sap/ovp/cards/OVPCardAsAPIUtils","sap/ovp/cards/SettingsUtils","sap/ovp/cards/PayLoadUtils","sap/ovp/cards/rta/SettingsDialogConstants","sap/m/MessageBox","sap/ui/model/Filter","sap/ui/model/FilterOperator","sap/ui/model/ChangeReason","sap/ovp/cards/linklist/AnnotationHelper","sap/ovp/cards/AnnotationHelper","sap/ui/core/IconPool","sap/ui/core/mvc/ViewType","sap/m/Dialog","sap/m/Button","sap/ovp/cards/CommonUtils","sap/ui/Device","sap/ovp/app/resources","sap/ovp/app/OVPUtils","sap/base/Log","sap/base/util/deepEqual","sap/base/util/merge"],function(q,C,J,O,s,P,S,M,F,a,b,L,c,I,V,D,B,d,e,f,g,h,k,m){"use strict";return C.extend("sap.ovp.cards.rta.SettingsDialog",{_oCardManifestSettings:{},_aRefreshNotRequired:S._aRefreshNotRequired,_aRefreshRequired:S._aRefreshRequired,_updateManifestProperties:S._updateManifestProperties,aVariantNames:S.aVariantNames,oOvpResourceBundle:f,oMandatoryPropertiesKey:S.oMandatoryPropertiesKey,onInit:function(){s.oSaveButton.attachPress(this.onSaveButtonPress,this);s.oResetButton.attachPress(this.onResetButton,this);s.oMessagePopOverButton.attachPress(this.handleMessagePopoverPress,this);},onAfterRendering:function(){s.dialogBox.addStyleClass("sapOvpSettingsDialogBox");this.setEnablePropertyForResetAndSaveButton(false);this._oCardManifestSettings=this.getView().getModel().getData();this._oOriginalCardManifestSettings=q.extend(true,{},this._oCardManifestSettings);var v=this.getView(),o=v.getModel();if(!this._oCardManifestSettings.addNewCard){var i=v.byId("dialogCard");if(!i.getVisible()){i=v.byId("dialogCardNoPreview");}i.getDomRef().style.minHeight=this._oCardManifestSettings.dialogBoxHeight+"px";v.byId("dialogCardOverlay").getDomRef().style.minHeight=this._oCardManifestSettings.dialogBoxHeight+"px";s.settingFormWidth(v,"calc(100% - "+(this._oCardManifestSettings.dialogBoxWidth+1)+"rem)");setTimeout(function(){var i=this.getView().byId("dialogCard");if(i.getVisible()){i.setBusy(false);}}.bind(this),2000);}if(this._oCardManifestSettings.staticContent){this.handleErrorHandling(o,"title","/staticContent");this.handleErrorHandling(o,"targetUri","/staticContent");}if(s.bNewKPICardFlag){var j=v.getModel();var l=v.byId("sapOvpKPITable").getBinding("items").getLength();j.setProperty("/NoOfKPIItem",l);j.setProperty("/NoKPI",l);}},validateInputField:function(E){var o=E.getSource();var l=o.getValue().trim().length;if(!l){o.setValue(o.getValue().trim());}if(!this._oCardManifestSettings.addNewCard){this.updateCard(E);}else{this.setEnablePropertyForResetAndSaveButton(true);}},addView:function(E){this._oCardManifestSettings.showViewSwitchButton=true;this.setEnablePropertyForResetAndSaveButton(true);var i,o=this._oCardManifestSettings,j=this.getView().getModel();if(!o.addNewCard){if(o.dataPointAnnotationPath&&o.dataPoint&&o.dataPoint.length){i=o.dataPoint[0].value;}}if(o.tabs&&o.tabs.length){o.newViewCounter++;if(!o.addNewCard){if(o.template==="sap.ovp.cards.charts.analytical"||o.template==="sap.ovp.cards.charts.smart.chart"){o.tabs.push({chartAnnotationPath:o.chart[0].value,dataPointAnnotationPath:i,value:this.oOvpResourceBundle&&(this.oOvpResourceBundle.getText("OVP_KEYUSER_LABEL_VIEW_NAME")+" "+o.newViewCounter)});}else{o.tabs.push({annotationPath:o.lineItem[0].value,dataPointAnnotationPath:i,value:this.oOvpResourceBundle&&(this.oOvpResourceBundle.getText("OVP_KEYUSER_LABEL_VIEW_NAME")+" "+o.newViewCounter)});}}else{o.tabs.push({entitySet:"",value:this.oOvpResourceBundle&&(this.oOvpResourceBundle.getText("OVP_KEYUSER_LABEL_VIEW_NAME")+" "+o.newViewCounter)});}var l=o.tabs.length;o.aViews.push({text:this.oOvpResourceBundle&&(this.oOvpResourceBundle.getText("OVP_KEYUSER_LABEL_VIEW_NAME")+" "+o.newViewCounter),key:l,isLaterAddedView:true,isViewResetEnabled:false});if(!o.addNewCard){var n=o.defaultViewSelected;if(o.tabs[n-1].entitySet){o.tabs[l-1].entitySet=o.allEntitySet[0].value;}}this.selectViewSwitch(E,l);}else{o.tabs=[{}];S.tabFields.forEach(function(t){if(!o.addNewCard){if(t!=='entitySet'){o.tabs[0][t]=o[t];}}else{o.tabs[0][t]=o[t];}});o.tabs[0].value=this.oOvpResourceBundle&&(this.oOvpResourceBundle.getText("OVP_KEYUSER_LABEL_VIEW_NAME")+" 1");if(!o.addNewCard){if(o.template==="sap.ovp.cards.charts.analytical"||o.template==="sap.ovp.cards.charts.smart.chart"){o.tabs.push({chartAnnotationPath:o.chart[0].value,dataPointAnnotationPath:i,value:this.oOvpResourceBundle&&(this.oOvpResourceBundle.getText("OVP_KEYUSER_LABEL_VIEW_NAME")+" 2")});}else{o.tabs.push({annotationPath:o.lineItem[0].value,dataPointAnnotationPath:i,value:this.oOvpResourceBundle&&(this.oOvpResourceBundle.getText("OVP_KEYUSER_LABEL_VIEW_NAME")+" 2")});}}else{o.tabs.push({entitySet:"",value:this.oOvpResourceBundle&&(this.oOvpResourceBundle.getText("OVP_KEYUSER_LABEL_VIEW_NAME")+" 2")});}o.selectedKey=1;o.defaultViewSelected=1;o.aViews=[{text:this.oOvpResourceBundle&&this.oOvpResourceBundle.getText("OVP_KEYUSER_LABEL_MAIN_VIEW"),key:0,isLaterAddedView:false,isViewResetEnabled:false},{text:this.oOvpResourceBundle&&(this.oOvpResourceBundle.getText("OVP_KEYUSER_LABEL_VIEW_NAME")+" 1 ("+this.oOvpResourceBundle.getText("OVP_KEYUSER_LABEL_DEFAULT_VIEW")+")"),key:1,initialSelectedKey:1,isLaterAddedView:false,isViewResetEnabled:false},{text:this.oOvpResourceBundle&&(this.oOvpResourceBundle.getText("OVP_KEYUSER_LABEL_VIEW_NAME")+" 2"),key:2,isLaterAddedView:true,isViewResetEnabled:false}];o.newViewCounter=2;this.selectViewSwitch(E,1);}this.handleErrorHandling(j,"value","/tabs");},deleteView:function(E){this.setEnablePropertyForResetAndSaveButton(true);var o=this._oCardManifestSettings,i=parseInt(o.selectedKey,10),j=this.getView().getModel();o.tabs.splice(i-1,1);o.aViews.splice(i,1);if(i===o.defaultViewSelected){o.defaultViewSelected=1;o.aViews[i].text=o.aViews[i].text+" ("+this.oOvpResourceBundle.getText("OVP_KEYUSER_LABEL_DEFAULT_VIEW")+")";}o.aViews.forEach(function(v,l){if(l>=i){v.key--;}});this.handleErrorHandling(j,"value","/tabs");if(o.tabs.length==1){S.tabFields.forEach(function(t){var v=o.tabs[0][t];if(t!=='entitySet'||(t==='entitySet'&&v)){o[t]=v;}});delete o.selectedKey;delete o.defaultViewSelected;delete o.tabs;delete o.aViews;o.aViews=[{text:this.oOvpResourceBundle.getText("OVP_KEYUSER_SHOWS_DIFFERENT_VIEWS"),key:0,initialSelectedKey:0,isLaterAddedView:false,isViewResetEnabled:false}];s.addManifestSettings(o);s.setVisibilityForFormElements(o);this.getView().getModel("visibility").refresh();this.getView().getModel().refresh();if(!o.addNewCard){this._fCardWithRefresh();}}else{o.selectedKey=1;this.selectViewSwitch(E,o.selectedKey);}},resetView:function(){var o=this._oCardManifestSettings,i=this.getView().getModel(),j=parseInt(o.selectedKey,10),l=o.aViews[j],n=o.defaultViewSelected;if(!l.isLaterAddedView){var p=o.dataPointAnnotationPath?true:false,r=this._oOriginalCardManifestSettings.dataPointAnnotationPath?true:false;if(j){var t=o.aViews[j].initialSelectedKey;S.tabFields.forEach(function(v){if(v!=="dataPointAnnotationPath"||p){if(this._oOriginalCardManifestSettings.tabs&&this._oOriginalCardManifestSettings.tabs.length){var w=this._oOriginalCardManifestSettings.tabs[t-1][v];if(v!=='entitySet'||(v==='entitySet'&&w)){o[v]=w;o.tabs[j-1][v]=o[v];}}else{if(v!=='entitySet'){o[v]=this._oOriginalCardManifestSettings[v];o.tabs[j-1][v]=o[v];}}}}.bind(this));if(!this._oOriginalCardManifestSettings.tabs||!this._oOriginalCardManifestSettings.tabs.length){o.newViewCounter++;o.tabs[j-1].value=this.oOvpResourceBundle&&(this.oOvpResourceBundle.getText("OVP_KEYUSER_LABEL_VIEW_NAME")+" "+o.newViewCounter);}if(j===o.defaultViewSelected){o.aViews[j].text=o.tabs[j-1].value+" ("+this.oOvpResourceBundle.getText("OVP_KEYUSER_LABEL_DEFAULT_VIEW")+")";}else{o.aViews[j].text=o.tabs[j-1].value;}}else{S.mainFields.forEach(function(v){o[v]=this._oOriginalCardManifestSettings[v];}.bind(this));if(p!==r){if(r){o.tabs.forEach(function(v){if(v.prevDataPointAnnotationPath){v.dataPointAnnotationPath=v.prevDataPointAnnotationPath;}else{v.dataPointAnnotationPath=o.dataPoint[0].value;}});o.dataPointAnnotationPath=o.tabs[n].dataPointAnnotationPath;}else{o.tabs.forEach(function(v){v.prevDataPointAnnotationPath=v.dataPointAnnotationPath;v.dataPointAnnotationPath=undefined;});}}}}else{var u;if(o.dataPointAnnotationPath){u=o.dataPoint[0].value;}o.newViewCounter++;if(o.template==="sap.ovp.cards.charts.analytical"||o.template==="sap.ovp.cards.charts.smart.chart"){o.tabs[j-1]={chartAnnotationPath:o.chart[0].value,dataPointAnnotationPath:u,value:this.oOvpResourceBundle&&(this.oOvpResourceBundle.getText("OVP_KEYUSER_LABEL_VIEW_NAME")+" "+o.newViewCounter)};}else{o.tabs[j-1]={annotationPath:o.lineItem[0].value,dataPointAnnotationPath:u,value:this.oOvpResourceBundle&&(this.oOvpResourceBundle.getText("OVP_KEYUSER_LABEL_VIEW_NAME")+" "+o.newViewCounter)};}if(j===o.defaultViewSelected){o.aViews[j].text=this.oOvpResourceBundle&&(this.oOvpResourceBundle.getText("OVP_KEYUSER_LABEL_VIEW_NAME")+" "+o.newViewCounter+" ("+this.oOvpResourceBundle.getText("OVP_KEYUSER_LABEL_DEFAULT_VIEW")+")");}else{o.aViews[j].text=this.oOvpResourceBundle&&(this.oOvpResourceBundle.getText("OVP_KEYUSER_LABEL_VIEW_NAME")+" "+o.newViewCounter);}S.tabFields.forEach(function(v){var w=o.tabs[j-1][v];if(v!=='entitySet'||(v==='entitySet'&&w)){o[v]=w;}});}this.handleErrorHandling(i,"value","/tabs");o.isViewResetEnabled=false;o.aViews[j].isViewResetEnabled=false;s.addManifestSettings(o);s.setVisibilityForFormElements(o);this.getView().getModel("visibility").refresh();this.getView().getModel().refresh();if(!o.addNewCard){this._fCardWithRefresh();}},selectViewSwitch:function(E,i){var o=this._oCardManifestSettings,j=this.getView().getModel();if(!i){i=E.getSource().getSelectedIndex();}if(this.defaultViewSwitch){this.defaultViewSwitch.setEnabled(true);}this.setEnablePropertyForResetAndSaveButton(true);var l=o.metaModel,n,p=o.defaultViewSelected;if(!i){o.selectedKey=i;o.mainViewSelected=true;o.isViewResetEnabled=o.aViews[i].isViewResetEnabled;S.tabFields.forEach(function(u){var v=o.tabs[p-1][u];if(u!=='entitySet'||(u==='entitySet'&&v)){o[u]=v;}});this.handleErrorHandling(j,"value","/tabs");if(o.tabs[p-1].entitySet){n=l.getODataEntitySet(o.tabs[p-1].entitySet);o.entityType=l.getODataEntityType(n.entityType);this.resetSupportingObjectsOnEntitySetChange(o,p);}s.addManifestSettings(o);s.setVisibilityForFormElements(o);this.getView().getModel("visibility").refresh();this.getView().getModel().refresh();if(!o.addNewCard){this._fCardWithRefresh();}}else{o.mainViewSelected=false;o.isViewResetEnabled=o.aViews[i].isViewResetEnabled;if(!o.addNewCard){var r=this.getView().byId("dialogCard");if(r.getVisible()){var R=r.getComponentInstance().getRootControl();var t=R.getController();t.changeSelection(i,true,o);this.handleErrorHandling(j,"value","/tabs");if(o.tabs[i-1].entitySet){n=l.getODataEntitySet(o.tabs[i-1].entitySet);o.entityType=l.getODataEntityType(n.entityType);this.resetSupportingObjectsOnEntitySetChange(o,p);}s.addManifestSettings(o);s.setVisibilityForFormElements(o);S.tabFields.forEach(function(u){var v=o.tabs[i-1][u];if(u!=='entitySet'||(u==='entitySet'&&v)){o[u]=v;}});if(!!o.kpiAnnotationPath){this.setAnnotationPathInModel(o,"sapOvpSettingsKPIAnnotation",o.kpiAnnotationPath);}if(!!o.selectionPresentationAnnotationPath){this.setAnnotationPathInModel(o,"sapOvpSettingsFilterAndPresentedBy",o.selectionPresentationAnnotationPath);}this.getView().getModel("visibility").refresh();this.getView().getModel().refresh();}}else{if(!!o.tabs[i-1].entitySet){n=l.getODataEntitySet(o.tabs[i-1].entitySet);o.entityType=l.getODataEntityType(n.entityType);s.addManifestSettings(o);}this.aVariantNames.forEach(function(v){if(this._oCardManifestSettings[v.sPath]){this._oCardManifestSettings[v.sPath]=[];}}.bind(this));this.resetSupportingObjectsOnEntitySetChange(o,p);o.selectedKey=i;S.tabFields.forEach(function(u){var v=o.tabs[i-1][u];o[u]=v;});s.setVisibilityForFormElements(o);this.getView().byId("sapOVPEntitySetList").setValue(o.tabs[i-1].entitySet);this.getView().getModel().refresh();this.getView().getModel("visibility").refresh();}}},resetSupportingObjectsOnEntitySetChange:function(o,i){o=s.addSupportingObjects(o);var j=o.defaultViewSelected;if(j){o.aViews[j].text=o.tabs[j-1].value;}o.aViews[i].text+=" ("+this.oOvpResourceBundle.getText("OVP_KEYUSER_LABEL_DEFAULT_VIEW")+")";o.defaultViewSelected=i;},setAnnotationPathInModel:function(o,i,j){if(o.entityType[j]){this.setVariant(o,j);}if(i==="sapOvpSettingsKPIAnnotation"){s.addKPINavApplicationName(o);}},setCurrentActivePageForCarouselCard:function(i){var j=this.getView().byId("dialogCard");if(j.getVisible()){var o=j.getComponentInstance(),r=o.getRootControl(),l=r.byId("pictureCarousel");if(l){var p=l.getPages(),n=p[i];l.setActivePage(n);}}},onSelectionChange:function(E){var o=E.getSource(),j=o.getModel(),l=j.getData().staticContent,n=o.getSelectedItem(),p=n.getBindingContext().getObject(),v=o.getModel("visibility");for(var i=0;i<l.length;i++){if(l[i].id===p.id){v.setProperty("/moveToTheTop",!(l.length===1||i===0));v.setProperty("/moveUp",!(l.length===1||i===0));v.setProperty("/moveDown",!(l.length===1||i===(l.length-1)));v.setProperty("/moveToTheBottom",!(l.length===1||i===(l.length-1)));v.setProperty("/delete",true);j.setProperty("/selectedItemIndex",i);v.refresh(true);if(E.getParameter("listItem")){this.setCurrentActivePageForCarouselCard(i);}break;}}},handleErrorForProperty:function(o,p,i){o.firePropertyChange({context:o.getContext(i?i:"/"),path:p,value:o.getProperty(i?(i+"/"+p):p),reason:b.Change});},handleErrorHandling:function(o,p,j){var l=o.getProperty(j);o.firePropertyChange({context:o.getContext(j),path:j+","+p,value:o.getProperty(j),reason:b.Change});for(var i=0;i<l.length;i++){var n=j+"/"+i;o.firePropertyChange({context:o.getContext(n),path:p,value:o.getProperty(n+"/"+p),reason:b.Change});}},setEnablePropertyForResetAndSaveButton:function(E){s.enableResetButton(E);s.enableSaveButton(E);},getValueInRemString:function(v){return v+"rem";},_getSelectedItemIndex:function(o){return o.getProperty("/selectedItemIndex");},_getLastItemIndex:function(o){return this._getStaticContentArray(o).length-1;},_getStaticContentArray:function(o){return o.getProperty("/staticContent");},_setStaticContentArray:function(o,i){o.setProperty("/staticContent",i);},_setSelectedItemAndScrollToElement:function(i,H){var v=this.getView(),l=v.byId("sapOvpStaticLinkListLineItem"),o=v.byId("scrollContainer"),j=v.getModel();this.handleErrorHandling(j,"title","/staticContent");this.handleErrorHandling(j,"targetUri","/staticContent");var n=l.getItems()[i];if(H){this._oList=l;this._oItem=n;this._oScrollContainer=o;var p={onAfterRendering:function(E){this._oList.removeEventDelegate(this._oDelegateOnAfter);this._oScrollContainer.scrollToElement(this._oItem);delete this._oDelegateOnAfter;delete this._oList;delete this._oScrollContainer;delete this._oItem;}};this._oDelegateOnAfter=p;l.addEventDelegate(p,this);}else{o.scrollToElement(n);}l.setSelectedItem(n);l.fireSelectionChange();},_arrangeStaticContent:function(o,i,t){var j=this._getStaticContentArray(o);j.splice(t,0,j.splice(i,1)[0]);this._setStaticContentArray(o,j);this._setSelectedItemAndScrollToElement(t);},getIndexFromIdForStaticLinkList:function(i){var j=i.split("-");return j[j.length-1];},_getImageData:function(){var i=[];i.push({"Name":"AW.png","Image":L.formUrl(this.getView().getModel().getProperty("/baseUrl"),"img/AW.png")});return i;},_getIconData:function(j){var l=I.getIconNames(),n=[];if(j){var N=j.split("://")[1],o=l.indexOf(N);l.splice(o,1);n.push({"Name":N,"Icon":I.getIconURI(N)});}for(var i=0;i<l.length;i++){n.push({"Name":l[i],"Icon":I.getIconURI(l[i])});}return n;},_getLinkListItemId:function(o,i){return o.getProperty("/staticContent/"+i+"/index");},_makeLinkListItemId:function(i){return"linkListItem--"+i;},_makeLinkListItemIndex:function(i){return"Index--"+i;},getIconAndImageDataModel:function(i){var j=this._getIconData(i),l=this._getImageData();return new J({"Icons":j,"Images":l,"NoOfIcons":j.length,"NoOfImages":l.length});},destroyTemplatesAndObjects:function(){var v=this.getView();var t=v.byId("tableFilterImage");if(t){t.destroy();}var T=v.byId("tableFilter");if(T){T.destroy();}var o=v.byId("tableFilterLinks");if(o){o.destroy();}delete this._oEvent;delete this._iCurrentRow;delete this._oModel;delete this._oVisibilityModel;delete this._oIconsDialogContentView;delete this._oLinksDialogContentView;delete this._oLineItemDialogContentView;delete this._oKPIItemDialogContentView;},onExternalUrlChange:function(E){this.setEnablePropertyForResetAndSaveButton(true);},onLinkSourceChange:function(E){var o=E.getSource(),i=o.getModel(),v=o.getModel("visibility"),j=this.getIndexFromIdForStaticLinkList(o.getId()),l=E.getParameter("selectedIndex"),n=v.getProperty("/staticLink"),p=v.getProperty("/links"),r=this._getLinkListItemId(i,parseInt(j,10));if(l===0){n[r]=false;p[r]=true;i.setProperty("/staticContent/"+j+"/targetUri",undefined);}else{n[r]=true;p[r]=false;i.setProperty("/staticContent/"+j+"/semanticObject",undefined);i.setProperty("/staticContent/"+j+"/action",undefined);i.setProperty("/staticContent/"+j+"/targetUri","");}v.setProperty("/staticLink",n);v.setProperty("/links",p);v.refresh(true);i.refresh(true);this.handleErrorForProperty(i,"targetUri","/staticContent/"+j);this.setEnablePropertyForResetAndSaveButton(true);},onRemoveVisualPress:function(E){var o=E.getSource(),i=o.getModel(),v=o.getModel("visibility"),j=this.getIndexFromIdForStaticLinkList(o.getId()),l=this._getLinkListItemId(i,parseInt(j,10)),r=v.getProperty("/removeVisual");r[l]=false;v.setProperty("/removeVisual",r);v.refresh(true);i.setProperty("/staticContent/"+j+"/imageUri",undefined);i.refresh(true);this.updateCard(E,"sapOvpSettingsStaticLinkListRemoveVisual");},createValueHelpDialogForInternalUrl:function(E){var o=E.getSource(),i=o.getModel(),j=o.getModel("staticCardProperties"),v=o.getModel("visibility"),l=this.getIndexFromIdForStaticLinkList(o.getId());this.attachBrowserHeightChangeHandler();this._oEvent=q.extend({},E);this._iCurrentRow=l;this._oModel=i;this._oVisibilityModel=v;var n=new B("linksCancelBtn",{text:this.oOvpResourceBundle&&this.oOvpResourceBundle.getText("cancelBtn")});this.linksDialog=new D({title:this.oOvpResourceBundle&&this.oOvpResourceBundle.getText("OVP_KEYUSER_SELECT_APPLICATION_DIALOG"),buttons:[n]}).addStyleClass("sapOvpSettingsDialogBox");j.setProperty("/densityStyle",this.getDensityStyle());j.setProperty("/NoOfLinks",j.getProperty("/links").length);var p=new sap.ui.view("linksDialogContent",{viewName:"sap.ovp.cards.rta.SelectLinks",type:V.XML,preprocessors:{xml:{bindingContexts:{tableRows:j.createBindingContext("/")},models:{tableRows:j}}}});p.setModel(j);p.setModel(this.getView().getModel("ovpResourceModel"),"ovpResourceModel");this.linksDialog.addContent(p);p.loaded().then(function(r){this._oLinksDialogContentView=r;r.getController().updateLinkPath=function(t){var u=t.slice(1).split("-"),w=u[0],A=u[1];this._oModel.setProperty("/staticContent/"+this._iCurrentRow+"/semanticObject",w);this._oModel.setProperty("/staticContent/"+this._iCurrentRow+"/action",A);this._oModel.refresh(true);this.setEnablePropertyForResetAndSaveButton(true);this.cleanAndCloseDialog(n);}.bind(this);n.attachPress(function(){this.cleanAndCloseDialog(n);}.bind(this));this.linksDialog.open();setTimeout(function(){this.browserHeightChange();}.bind(this),0);}.bind(this));},onChangeVisualPress:function(E){var o=E.getSource(),i=o.getModel(),v=o.getModel("visibility"),j=this.getIndexFromIdForStaticLinkList(o.getId()),l=i.getProperty("/staticContent/"+j+"/imageUri"),n=L.isImageUrlStaticData(l);this.attachBrowserHeightChangeHandler();this._oEvent=q.extend({},E);this._iCurrentRow=j;this._oModel=i;this._oVisibilityModel=v;var p=new B("iconsCancelBtn",{text:this.oOvpResourceBundle&&this.oOvpResourceBundle.getText("cancelBtn")});this.iconsDialog=new D({title:this.oOvpResourceBundle&&this.oOvpResourceBundle.getText("OVP_KEYUSER_SELECT_VISUAL_DIALOG"),buttons:[p]}).addStyleClass("sapOvpSettingsDialogBox");var r=(n)?this.getIconAndImageDataModel():this.getIconAndImageDataModel(l);r.setProperty("/densityStyle",this.getDensityStyle());var t=new sap.ui.view("iconsDialogContent",{viewName:"sap.ovp.cards.rta.SelectIcons",type:V.XML,preprocessors:{xml:{bindingContexts:{tableRows:r.createBindingContext("/")},models:{tableRows:r}}}});r.setProperty("/tableName","IconTable");t.setModel(r);t.setModel(this.getView().getModel("ovpResourceModel"),"ovpResourceModel");this.iconsDialog.addContent(t);t.loaded().then(function(u){this._oIconsDialogContentView=u;u.getController().updateIconPath=function(U){var w=this._getLinkListItemId(this._oModel,parseInt(this._iCurrentRow,10)),R=this._oVisibilityModel.getProperty("/removeVisual");R[w]=true;this._oVisibilityModel.setProperty("/removeVisual",R);this._oVisibilityModel.refresh(true);this._oModel.setProperty("/staticContent/"+this._iCurrentRow+"/imageUri",U);this._oModel.refresh(true);this.updateCard(this._oEvent,"sapOvpSettingsStaticLinkListChangeVisual");this.cleanAndCloseDialog(p);}.bind(this);p.attachPress(function(){this.cleanAndCloseDialog(p);}.bind(this));this.iconsDialog.open();setTimeout(function(){this.browserHeightChange();}.bind(this),0);}.bind(this));},getDensityStyle:function(){if(!e.support.touch){return"compact";}else{return"cozy";}},cleanAndCloseDialog:function(o){if(this._oIconsDialogContentView){this._oIconsDialogContentView.destroy();}if(this._oLinksDialogContentView){this._oLinksDialogContentView.destroy();}if(this._oLineItemDialogContentView){this._oLineItemDialogContentView.destroy();}if(this._oKPIItemDialogContentView){this._oKPIItemDialogContentView.destroy();}this.destroyTemplatesAndObjects();if(this.iconsDialog){this.iconsDialog.close();}if(this.linksDialog){this.linksDialog.close();}if(this.lineItemDialog){this.lineItemDialog.close();}if(this.KPIItemDialog){this.KPIItemDialog.close();}o.destroy();this.detachBrowserHeightChangeHandler();},attachBrowserHeightChangeHandler:function(){e.resize.attachHandler(this.browserHeightChange,this);},detachBrowserHeightChangeHandler:function(){e.resize.detachHandler(this.browserHeightChange,this);},browserHeightChange:function(i){var o,j,l;if(this.iconsDialog&&this._oIconsDialogContentView){o=this.iconsDialog;j=this._oIconsDialogContentView;l="iconsScrollContainer";}else if(this.linksDialog&&this._oLinksDialogContentView){o=this.linksDialog;j=this._oLinksDialogContentView;l="linksScrollContainer";}else if(this.lineItemDialog&&this._oLineItemDialogContentView){o=this.lineItemDialog;j=this._oLineItemDialogContentView;l="lineItemScrollContainer";}else if(this.KPIItemDialog&&this._oKPIItemDialogContentView){o=this.KPIItemDialog;j=this._oKPIItemDialogContentView;l="KPIItemScrollContainer";}if(o&&j&&l){var n=o.getDomRef(),p=(i?(i.height*93)/100:s.dialogBox.getDomRef().getBoundingClientRect().height),r=n.getBoundingClientRect().height,H=Math.max(p,r)-(d.getPixelPerRem()*9),t=j.byId(l);t.setHeight(H+"px");}},handleMessagePopoverPress:function(E){s.oMessagePopOver.openBy(E.getSource());},onShowMorePress:function(E){var o=E.getSource(),i=o.getModel(),v=o.getModel("visibility"),j=this.getIndexFromIdForStaticLinkList(o.getId()),l=this._getLinkListItemId(i,parseInt(j,10)),n=v.getProperty("/showMore/"+l);if(n){v.setProperty("/showMore/"+l,false);}else{v.setProperty("/showMore/"+l,true);}v.refresh(true);},onPressDelete:function(E){this._oEvent=q.extend({},E);M.confirm(this.oOvpResourceBundle.getText("OVP_KEYUSER_MESSAGE_BOX_INFORMATION_MESSAGE_INFO"),{actions:[M.Action.OK,M.Action.CANCEL],icon:M.Icon.INFORMATION,title:this.oOvpResourceBundle.getText("OVP_KEYUSER_MESSAGE_BOX_TITLE_INFO"),initialFocus:M.Action.CANCEL,onClose:function(A){if(A==="OK"){var o=this._oEvent.getSource(),v=o.getModel("visibility"),i=o.getModel(),j=this._getStaticContentArray(i),l=this._getSelectedItemIndex(i),n=this._getLinkListItemId(i,l),p=v.getProperty("/staticLink"),r=v.getProperty("/links"),R=v.getProperty("/removeVisual"),t=v.getProperty("/showMore");delete p[n];delete r[n];delete R[n];delete t[n];v.setProperty("/staticLink",p);v.setProperty("/links",r);v.setProperty("/removeVisual",R);v.setProperty("/showMore",t);j.splice(l,1);this._setStaticContentArray(i,j);i.refresh(true);if(j.length>0){this._setSelectedItemAndScrollToElement(Math.min(parseInt(l,10),j.length-1),true);}if(j.length<=1){v.setProperty("/delete",false);}v.refresh(true);this.updateCard(this._oEvent,"sapOvpSettingsStaticLinkListDelete");}delete this._oEvent;}.bind(this)});},onPressAdd:function(E){var o=E.getSource(),v=o.getModel("visibility"),i=o.getModel(),j=this._getStaticContentArray(i),l=i.getProperty("/lineItemIdCounter"),n=this._makeLinkListItemId(l+1),p=this._makeLinkListItemIndex(l+1),r=v.getProperty("/staticLink"),t=v.getProperty("/links"),R=v.getProperty("/removeVisual"),u=v.getProperty("/showMore");i.setProperty("/lineItemIdCounter",l+1);j.unshift({"id":n,"index":p,"title":"Default Title","subTitle":"Default SubTitle","imageUri":"","imageAltText":"","targetUri":"","openInNewWindow":""});r[p]=true;t[p]=false;R[p]=false;u[p]=false;v.setProperty("/staticLink",r);v.setProperty("/links",t);v.setProperty("/removeVisual",R);v.setProperty("/showMore",u);v.refresh(true);this._setStaticContentArray(i,j);i.refresh(true);this._setSelectedItemAndScrollToElement(0);this.updateCard(E,"sapOvpSettingsStaticLinkListAdd");},onPressMoveToTheTop:function(E){var o=E.getSource().getModel();this._arrangeStaticContent(o,this._getSelectedItemIndex(o),0);this.updateCard(E,"sapOvpSettingsStaticLinkListSort");},onPressMoveUp:function(E){var o=E.getSource().getModel(),i=this._getSelectedItemIndex(o);this._arrangeStaticContent(o,i,i-1);this.updateCard(E,"sapOvpSettingsStaticLinkListSort");},onPressMoveDown:function(E){var o=E.getSource().getModel(),i=this._getSelectedItemIndex(o);this._arrangeStaticContent(o,i,i+1);this.updateCard(E,"sapOvpSettingsStaticLinkListSort");},onPressMoveToTheBottom:function(E){var o=E.getSource().getModel(),i=this._getSelectedItemIndex(o),j=this._getLastItemIndex(o);this._arrangeStaticContent(o,i,j);this.updateCard(E,"sapOvpSettingsStaticLinkListSort");},onResetButton:function(){this._oCardManifestSettings=q.extend(true,{},this._oOriginalCardManifestSettings);var o=this.getView().getModel();o.setProperty("/",this._oCardManifestSettings);s.setVisibilityForFormElements(this._oCardManifestSettings);this.getView().getModel("visibility").refresh();if(this._oCardManifestSettings.layoutDetail==="resizable"){if(this._oCardManifestSettings.stopResizing){this.getView().byId("sapOvpSettingsStopResize").setState(false);}else if(!this._oCardManifestSettings.stopResizing){this.getView().byId("sapOvpSettingsStopResize").setState(true);}}s.resetErrorHandling();this.setEnablePropertyForResetAndSaveButton(false);if(!this._oCardManifestSettings.addNewCard){this._fCardWithRefresh();}},handleValueStateofComboBox:function(E,p,j,l){var o=s.oMessagePopOver.getModel(),n=o.getProperty("/Messages"),r=o.getProperty("/Counter/All"),t=o.getProperty("/Counter/Error");this.bError=true;var u=true;if(l){for(var i=0;i<n.length;i++){if(n[i].fieldName===p){u=false;}}if(u){n.push({"type":"Error","title":E,"fieldName":p,"counter":t+1});r++;t++;this.getView().byId(j).setValueState("Error");}}else{this.bError=false;for(var i=0;i<n.length;i++){if(n[i].fieldName===p){n.splice(i,1);r--;t--;i--;}}this.getView().byId(j).setValueState("None");}if(!n.length){this.setEnablePropertyForResetAndSaveButton(true);}o.setProperty("/Messages",n);o.setProperty("/Counter/All",r);o.setProperty("/Counter/Error",t);o.refresh(true);},validateComboBox:function(o,p,K){var E;if((p==="KPICheckBox"&&K&&o.entitySet)||(p==="entitySet"&&o.addKPIHeaderCheckBox)){if(o.title===""){E=f.getText("OVP_KEYUSER_INPUT_ERROR");this.handleValueStateofComboBox(E,g.Annotations.title,"sapOvpCardTitle",true);}else{this.handleValueStateofComboBox("",g.Annotations.title,"sapOvpCardTitle",false);}if(o.subTitle===""){E=f.getText("OVP_KEYUSER_INPUT_ERROR_VALUE_STATE_SUBTITLE");this.handleValueStateofComboBox(E,g.Annotations.subTitle,"sapOvpCardSubTitle",true);}else{this.handleValueStateofComboBox("",g.Annotations.subTitle,"sapOvpCardSubTitle",false);}if(o.valueSelectionInfo===""){E=f.getText("OVP_KEYUSER_INPUT_ERROR_VALUE_STATE_SELECTIONVALUEINFO");this.handleValueStateofComboBox(E,g.Annotations.valueSelectionInfo,"sapOvpValueSelectionInfo",true);}else{this.handleValueStateofComboBox("",g.Annotations.valueSelectionInfo,"sapOvpValueSelectionInfo",false);}if(o.dataPointAnnotationPath===""){E=f.getText("OVP_KEYUSER_INPUT_ERROR_VALUE_STATE_DATAPOINT");this.handleValueStateofComboBox(E,g.Annotations.dataPoint,"sapOvpDataPoint",true);}else{this.handleValueStateofComboBox("",g.Annotations.dataPoint,"sapOvpDataPoint",false);}}else if(p==="entitySet"){E=f.getText("OVP_KEYUSER_INPUT_ERROR");this.handleValueStateofComboBox(E,g.Annotations.title,"sapOvpCardTitle",true);if(o.template==="sap.ovp.cards.linklist"){E=f.getText("OVP_KEYUSER_LISTFLAVOR_ERROR");this.handleValueStateofComboBox(E,g.Annotations.listFlavor,"sapOVPLinkListFlavor",true);}}else if(p==="KPICheckBox"&&!K&&o.entitySet){this.handleValueStateofComboBox("",g.Annotations.subTitle,"sapOvpCardSubTitle",false);this.handleValueStateofComboBox("",g.Annotations.valueSelectionInfo,"sapOvpValueSelectionInfo",false);this.handleValueStateofComboBox("",g.Annotations.dataPoint,"sapOvpDataPoint",false);}else{if(p==="title"){this.onComboBoxSelection(o,p,"OVP_KEYUSER_INPUT_ERROR",g.Annotations.title,"sapOvpCardTitle");}if(p==="subTitle"){this.onComboBoxSelection(o,p,"OVP_KEYUSER_INPUT_ERROR_VALUE_STATE_SUBTITLE",g.Annotations.subTitle,"sapOvpCardSubTitle");}if(p==="valueSelectionInfo"){this.onComboBoxSelection(o,p,"OVP_KEYUSER_INPUT_ERROR_VALUE_STATE_SELECTIONVALUEINFO",g.Annotations.valueSelectionInfo,"sapOvpValueSelectionInfo");}if(p==="dataPointAnnotationPath"){this.onComboBoxSelection(o,p,"OVP_KEYUSER_INPUT_ERROR_VALUE_STATE_DATAPOINT",g.Annotations.dataPoint,"sapOvpDataPoint");}if(p==="listFlavor"){this.onComboBoxSelection(o,p,"OVP_KEYUSER_LISTFLAVOR_ERROR",g.Annotations.listFlavor,"sapOVPLinkListFlavor");}}},onComboBoxSelection:function(o,p,t,i,j){var E;if(o[p]===""){E=f.getText(t);this.handleValueStateofComboBox(E,i,j,true);}else{this.handleValueStateofComboBox(E,i,j,false);}},onSaveButtonPress:function(){if(!this._oCardManifestSettings.addNewCard){if(s.bError||this.bError){s.oMessagePopOverButton.firePress();}else{this.createAndSubmitChange.bind(this)();}}else{this.createAndSubmitChange.bind(this)();}},onResizingChange:function(E){var i=E.getParameter("state");this._oCardManifestSettings.stopResizing=!i;this.updateCard(E);},onNumberOfRowsChanged:function(E){var r=+this._oCardManifestSettings.defaultSpan.rows;this._oCardManifestSettings.defaultSpan.rows=r;this._oCardManifestSettings.defaultSpan.showOnlyHeader=(r===0);this._oCardManifestSettings.cardLayout.showOnlyHeader=(r===0);var i=["sap.ovp.cards.list","sap.ovp.cards.table"];if(i.indexOf(this._oCardManifestSettings.template)!==-1){this._oCardManifestSettings.cardLayout.noOfItems=r;}else{this._oCardManifestSettings.cardLayout.rowSpan=r;}this.updateCard(E);},onNumberOfColumnsChanged:function(E){this._oCardManifestSettings.defaultSpan.cols=+this._oCardManifestSettings.defaultSpan.cols;this.updateCard(E);},setBusy:function(i){if(i){this.getView().addStyleClass("dialogContainerOverlay");var j=this.getView().byId("dialogCard");if(j.getVisible()&&j.getComponentInstance()){j.getComponentInstance().getRootControl().setBusy(i);}}else{this.getView().removeStyleClass("dialogContainerOverlay");setTimeout(function(){var j=this.getView().byId("dialogCard");if(j.getVisible()&&j.getComponentInstance()){j.getComponentInstance().getRootControl().setBusy(i);}}.bind(this),2000);}},_fCardWithoutRefresh:function(E,u){var v=this.getView(),o=this._oCardManifestSettings,i=v.byId("dialogCard").getComponentInstance(),r=i.getRootControl(),j=r.getController(),l=j.getCardPropertiesModel(),n,p,t=false,w;if(o.tabs&&o.tabs.length){t=true;w=parseInt(o.selectedKey,10);}if(u.formElementId==="sapOvpSettingsLineItemTitle"||u.formElementId==="sapOvpSettingsLineItemSubTitle"){n=r.byId(u.cardElementId+"--"+v.getModel().getProperty("/lineItemId"));}else{n=r.byId(u.cardElementId);if(!n){this._fCardWithRefresh(E,u.cardElementId);}}switch(u.formElementId){case"sapOvpSettingsLineItemTitle":case"sapOvpSettingsLineItemSubTitle":case"sapOvpSettingsTitle":case"sapOvpSettingsValueSelectionInfo":if(n){n.setText(E.getSource().getValue());}break;case"sapOvpSettingsSubTitle":l.setProperty("/subTitle",E.getSource().getValue());j._setSubTitleWithUnitOfMeasure();break;case"sapOvpSettingsViewName":var x=o.viewName;p=v.getModel();n.getItems()[w-1].setText(x);o.tabs[w-1].value=x;if(o.defaultViewSelected===w){x=x+" ("+this.oOvpResourceBundle.getText("OVP_KEYUSER_LABEL_DEFAULT_VIEW")+")";}o.aViews[w].text=x;p.refresh();break;case"sapOvpDefaultViewSwitch":if(E.getSource().getState()){var y=o.defaultViewSelected;p=v.getModel();o.defaultViewSelected=w;o.aViews[y].text=o.tabs[y-1].value;o.aViews[w].text+=" ("+this.oOvpResourceBundle.getText("OVP_KEYUSER_LABEL_DEFAULT_VIEW")+")";p.refresh();this.defaultViewSwitch=E.getSource();this.defaultViewSwitch.setEnabled(false);}break;case"sapOvpSettingsIdentification":if(t){o.tabs[w-1][u.updateProperty]=o[u.updateProperty];}break;case"sapOvpSettingsKPIHeaderSwitch":var z=v.getModel("visibility"),A=z.getData();A.dataPoint=false;A.valueSelectionInfo=false;if(t){o.tabs.forEach(function(H){H.prevDataPointAnnotationPath=H.dataPointAnnotationPath;H.dataPointAnnotationPath=undefined;});}else{var G=o.dataPointAnnotationPath;if(G){o.prevDataPointAnnotationPath=G;}o.dataPointAnnotationPath=undefined;}z.refresh(true);n.destroy();break;default:break;}},_fCardWithRefresh:function(E,u){var p,i,v,o,j,l=this._oCardManifestSettings,n=this.getView(),r=n.byId("dialogCard"),t=(!r.getComponentInstance())?undefined:r.getComponentInstance().getComponentData(),w=(!t)?"Dialog":t.cardId,x=(!t)?undefined:t.manifest.cards[w].model,y={cards:{}},z=false,A;if(l.tabs&&l.tabs.length){z=true;A=parseInt(l.selectedKey,10);}switch(u){case"subTitleSwitch":v=this.getView();o=v.getModel("visibility");if(E.getSource().getState()){if(z){i=l.defaultViewSelected;l.tabs.forEach(function(U){p=U.prevDynamicSubtitleAnnotationPath;if(p){U.dynamicSubtitleAnnotationPath=p;}else{U.dynamicSubtitleAnnotationPath=l.dynamicSubTitle[0].value;}});l.dynamicSubtitleAnnotationPath=l.tabs[i-1].dynamicSubtitleAnnotationPath;}else{p=l.prevDynamicSubtitleAnnotationPath;if(p){l.dynamicSubtitleAnnotationPath=p;}else{l.dynamicSubtitleAnnotationPath=l.dynamicSubTitle[0].value;}}n.byId("sapOvpSettingsDynamicSubTitle").setSelectedKey(l.dynamicSubtitleAnnotationPath);}else{if(z){l.tabs.forEach(function(U){U.prevDynamicSubtitleAnnotationPath=U.dynamicSubtitleAnnotationPath;U.dynamicSubtitleAnnotationPath=undefined;});l.dynamicSubtitleAnnotationPath=undefined;}else{var G=l.dynamicSubtitleAnnotationPath;if(G){l.prevDynamicSubtitleAnnotationPath=G;}l.dynamicSubtitleAnnotationPath=undefined;}}o.setProperty("/subTitle",s.getVisibilityOfElement(l,"subTitle",z));o.setProperty("/dynamicSubTitle",s.getVisibilityOfElement(l,"dynamicSubTitle",z)&&!!l["dynamicSubTitle"]&&!!l["dynamicSubTitle"].length);o.refresh(true);break;case"kpiHeader":v=this.getView();o=v.getModel("visibility");j=o.getData();j.valueSelectionInfo=true;j.dataPoint=true;if(l.tabs&&l.tabs.length){j.dataPoint=s.getVisibilityOfElement(l,"dataPoint",true);}if(!l.valueSelectionInfo){l.valueSelectionInfo=" ";}if(z){i=l.defaultViewSelected;l.tabs.forEach(function(U){p=U.prevDataPointAnnotationPath;if(p){U.dataPointAnnotationPath=p;}else{U.dataPointAnnotationPath=l.dataPoint[0].value;}});l.dataPointAnnotationPath=l.tabs[i-1].dataPointAnnotationPath;}else{p=l.prevDataPointAnnotationPath;if(p){l.dataPointAnnotationPath=p;}else{l.dataPointAnnotationPath=l.dataPoint[0].value;}}o.refresh(true);break;case"listType":l[u]=(E.getSource().getState())?"extended":"condensed";break;case"listFlavor":l[u]=(E.getSource().getState())?"bar":"";break;case"entitySet":if(z){l.tabs[A-1][u]=l[u];S.resetTabFields.forEach(function(U){delete l.tabs[A-1][U];delete l[U];});var H=l.metaModel,K=H.getODataEntitySet(l.tabs[A-1].entitySet),N=l.defaultViewSelected;l.entityType=H.getODataEntityType(K.entityType);this.resetSupportingObjectsOnEntitySetChange(l,N);}break;case"kpiAnnotationPath":if(z){l.tabs[A-1][u]=l[u];}var Q=n.byId("sapOvpSettingsKPIAnnotation").getSelectedKey();if(l.entityType[Q]){this.setVariant(l,Q);}s.addKPINavApplicationName(l);this.getView().getModel().refresh(true);break;case"selectionPresentationAnnotationPath":if(z){l.tabs[A-1][u]=l[u];}var Q=n.byId("sapOvpSettingsFilterAndPresentedBy").getSelectedKey();if(l.entityType[Q]){this.setVariant(l,Q);}this.getView().getModel().refresh(true);break;case"listFlavorForLinkList":case"annotationPath":case"chartAnnotationPath":case"presentationAnnotationPath":case"selectionAnnotationPath":case"dynamicSubtitleAnnotationPath":case"dataPointAnnotationPath":if(z){l.tabs[A-1][u]=l[u];}break;case"noOfRows":case"ovpHeaderTitle":case"add":case"removeVisual":case"changeVisual":case"sort":case"delete":break;default:break;}y.cards[w]={settings:l};if(s.bNewKPICardFlag){y.cards[w].template=l.template;}else{y.cards[w].template=t.template;}if(s.bNewKPICardFlag){if(x&&n.getModel(x)){n.getModel(x).destroy();n.setModel(null,x);}var R=this._oCardManifestSettings.selectedKPI,T=new sap.ui.model.odata.v2.ODataModel(R.ODataURI,{'annotationURI':R.ModelURI,'defaultCountMode':sap.ui.model.odata.CountMode.None});x=d._getLayerNamespace()+".kpi_card_model_"+s.getTrimmedDataURIName(R.ODataURI);n.setModel(T,x);}if(!!x){y.cards[w].model=x;}if(s.bNewKPICardFlag){T.getMetaModel().loaded().then(function(){var U=O.createCardComponent(n,y,"dialogCard");U.then(function(){n.setBusy(false);this.setBusy(false);}.bind(this)).catch(function(){s.setErrorMessage(y.cards[w].settings,"OVP_KEYUSER_ANNOTATION_FAILURE");s.createErrorCard(n,y,w);});}.bind(this),function(U){h.error(U);this.setBusy(false);n.setBusy(false);}.bind(this));T.attachMetadataFailed(function(){s.setErrorMessage(y.cards[w].settings,"OVP_KEYUSER_METADATA_FAILURE");s.createErrorCard(n,y,w);});}else{this.createCard(n,y);}},setVariant:function(o,i){var j=o.entityType[i];var l=j.SelectionVariant&&j.SelectionVariant.Path;if(/^@/.test(l)){l=l.slice(1);}o.selectionAnnotationPath=l;var p;if(i.indexOf(".KPI")!==-1){p=j.Detail&&j.Detail.DefaultPresentationVariant&&j.Detail.DefaultPresentationVariant.Path;}else if(i.indexOf(".SelectionPresentationVariant")!==-1){p=j.PresentationVariant&&j.PresentationVariant.Path;}if(/^@/.test(p)){p=p.slice(1);}o.presentationAnnotationPath=p;var v=o.entityType[o.presentationAnnotationPath]&&o.entityType[o.presentationAnnotationPath].Visualizations;for(var n=0;n<v.length;n++){var r=v[n].AnnotationPath;if(r){if(/^@/.test(r)){r=r.slice(1);}if(/.Chart/.test(r)){o.chartAnnotationPath=r;break;}}}},createCard:function(o,i){this.setBusy(true);var p=O.createCardComponent(o,i,"dialogCard");p.then(function(){this.setBusy(false);var l=this.getView().byId("sapOvpStaticLinkListLineItem");if(l){var j=l.getSelectedItem();if(j){var n=j.getId(),r=this.getIndexFromIdForStaticLinkList(n);this.setCurrentActivePageForCarouselCard(r);}}}.bind(this));p.catch(function(){this.setBusy(false);}.bind(this));},updateCard:function(E,l){var o=this._oCardManifestSettings,n=this.getView().byId("dialogCard");this.setEnablePropertyForResetAndSaveButton(true);if(n.getVisible()){if(o.tabs&&o.tabs.length){var p=parseInt(o.selectedKey,10);o.isViewResetEnabled=true;o.aViews[p].isViewResetEnabled=true;}var r=E.getSource(),t=(l)?l:r.getId(),u=false;if(t.indexOf("sapOvpStaticLinkListLineItem")!==-1){var v=r.getModel(),w=v.getData().staticContent,x=this.getIndexFromIdForStaticLinkList(t);this.setCurrentActivePageForCarouselCard(x);v.setProperty("/lineItemId",w[x].id);if(t.indexOf("sapOvpSettingsLineItemTitle")!==-1){t="sapOvpSettingsLineItemTitle";}else if(t.indexOf("sapOvpSettingsLineItemSubTitle")!==-1){t="sapOvpSettingsLineItemSubTitle";}}for(var i=0;i<this._aRefreshNotRequired.length;i++){if(t.indexOf(this._aRefreshNotRequired[i].formElementId)>-1){if(this._aRefreshNotRequired[i].isKpiSwitch&&E.getSource().getState()){break;}this._fCardWithoutRefresh(E,this._aRefreshNotRequired[i]);u=true;break;}}if(!u){for(var j=0;j<this._aRefreshRequired.length;j++){if(t.indexOf(this._aRefreshRequired[j].formElementId)>-1){this.setBusy(true);this._fCardWithRefresh(E,this._aRefreshRequired[j].updateProperty);break;}}}var y=d._getLayer();if(y===g.Layers.vendor){for(var z in this.oMandatoryPropertiesKey){if(t.indexOf(this.oMandatoryPropertiesKey[z])>-1){var R=false,T=z+"Key",A=z+"Property";o[z]=E.getParameter("value");o[A]=E.getParameter("value");for(var z in o.ai18nProperties){if(o.ai18nProperties[z].value===E.getParameter("value")){o[T]=o.ai18nProperties[z].key;R=true;break;}}if(!R){o[T]="";}break;}}}}},onExit:function(){s.oSaveButton.detachPress(this.onSaveButtonPress,this);s.oResetButton.detachPress(this.onResetButton,this);s.oMessagePopOverButton.detachPress(this.handleMessagePopoverPress,this);},getListItems:function(){var i=[],o=this._oCardManifestSettings,j=this.getView(),l=j.byId("dialogCard"),n=l.getComponentInstance().getComponentData(),p=o.entityType.$path+"/"+o.annotationPath,r=n.model.getMetaModel(),t=r.getContext(r.resolve(p,this.oView.getBindingContext()));var u=2,v=1,w=0;if(o.listFlavor==="bar"){u=1;v=2;}if(o.listType&&o.listType.toLowerCase()==="extended"){u=6;v=3;w=3;if(o.listFlavor==="bar"){u=5;}}else if(o.contentFragment==="sap.ovp.cards.table.Table"){u=3;v=1;w=1;}o.lineItem.forEach(function(x){var y=c.getSortedDataPoints(t,x.fields),z=c.getSortedDataFields(t,x.fields),A=[],E=[],G=s.getQualifier(x.value);y.forEach(function(Q){if(Q.Title){E.push(s.checkForEmptyString(Q.Title.String,""));}else{E.push(f.getText("OVP_KEYUSER_LABEL_DEFAULT_LABEL_WITH_QUALIFIER",[G]));}});z.forEach(function(Q){if(Q.Label){A.push(Q.Label.String);}else{A.push(f.getText("OVP_KEYUSER_LABEL_DEFAULT_LABEL_WITH_QUALIFIER",[G]));}});var H=Math.min(E.length,v),K=Math.min(w,H),N=A.slice(0,u-K).concat(E.slice(0,H));N.map(function(Q){return Q.charAt(0).toUpperCase()+Q.substr(1);});i.push({Value:x.value,Label:x.name,VisibleFields:N.toString()});});return i;},onSearch:function(E){var v=this.getView(),o=v.getModel(),l;this._filterTable(E,["GroupTitle","KPITitle","GroupID","KPIID","KPIQualifier"],"sapOvpKPITable");l=v.byId("sapOvpKPITable").getBinding("items").getLength();o.setProperty("/NoOfKPIItem",l);o.refresh(true);},_filterTable:function(E,j,l){var Q=E.getParameter("query"),G=null,n=[];for(var i=0;i<j.length;i++){n.push(new F(j[i],a.Contains,Q));}if(Q){G=new F(n,false);}this.getView().byId(l).getBinding("items").filter(G,"Application");},onItemPress:function(E){this.getView().setBusy(true);this.getView().setBusyIndicatorDelay(0);var o=E.getSource(),i=o.getBindingContext(),K=i.getObject();this.getView().byId("sapOvpSettingsTitle").setValue(K.GroupTitle);this.getView().byId("sapOvpSettingsSubTitle").setValue(K.KPITitle);this.onKPIUpdate(K);this.updateCard(E,"sapOvpSettingsNewKPICard");},onKPIUpdate:function(K){this._oCardManifestSettings.entitySet=K.ODataEntityset;this._oCardManifestSettings.kpiAnnotationPath="com.sap.vocabularies.UI.v1.KPI#"+K.KPIQualifier;this._oCardManifestSettings.title=K.GroupTitle;this._oCardManifestSettings.subTitle=K.KPITitle;this._oCardManifestSettings.template="sap.ovp.cards.charts.analytical";this._oCardManifestSettings.selectedKPI=K;},onSeePress:function(){this.attachBrowserHeightChangeHandler();var o=new B("KPIItemCancelBtn",{text:this.oOvpResourceBundle&&this.oOvpResourceBundle.getText("cancelBtn")});this.KPIItemDialog=new D({title:this.oOvpResourceBundle&&this.oOvpResourceBundle.getText("OVP_KEYUSER_KPI_DIALOG_TITLE"),buttons:[o]}).addStyleClass("sapOvpSettingsDialogBox");var r=new J({"KPIItem":this._oCardManifestSettings.KPIData});r.setProperty("/densityStyle",this.getDensityStyle());r.setProperty("/NoOfKPIItem",r.getProperty("/KPIItem").length);var K=new sap.ui.view("KPIItemDialogContent",{viewName:"sap.ovp.cards.rta.SelectKPI",type:V.XML,preprocessors:{xml:{bindingContexts:{tableRows:r.createBindingContext("/")},models:{tableRows:r}}}});K.setModel(r);K.setModel(this.getView().getModel("ovpResourceModel"),"ovpResourceModel");this.KPIItemDialog.addContent(K);K.loaded().then(function(v){this._oKPIItemDialogContentView=v;v.getController().updateKPIItemPath=function(i,E){this.getView().setBusy(true);this.getView().setBusyIndicatorDelay(0);this.getView().byId("sapOvpSettingsTitle").setValue(i.GroupTitle);this.getView().byId("sapOvpSettingsSubTitle").setValue(i.KPITitle);this.onKPIUpdate(i);this.updateCard(E,"sapOvpSettingsNewKPICard");this.cleanAndCloseDialog(o);}.bind(this);o.attachPress(function(){this.cleanAndCloseDialog(o);}.bind(this));this.KPIItemDialog.open();setTimeout(function(){this.browserHeightChange();}.bind(this),0);}.bind(this));},openLineItemValueHelpDialog:function(E){this.attachBrowserHeightChangeHandler();this._oEvent=q.extend({},E);var o=new B("lineItemCancelBtn",{text:this.oOvpResourceBundle&&this.oOvpResourceBundle.getText("cancelBtn")});this.lineItemDialog=new D({title:this.oOvpResourceBundle&&this.oOvpResourceBundle.getText("OVP_KEYUSER_LINEITEM_ANNO"),buttons:[o]}).addStyleClass("sapOvpSettingsDialogBox");var r=new J({"lineItem":this.getListItems()});r.setProperty("/densityStyle",this.getDensityStyle());r.setProperty("/NoOfLineItem",r.getProperty("/lineItem").length);var l=new sap.ui.view("lineItemDialogContent",{viewName:"sap.ovp.cards.rta.SelectLineItem",type:V.XML,preprocessors:{xml:{bindingContexts:{tableRows:r.createBindingContext("/")},models:{tableRows:r}}}});l.setModel(r);l.setModel(this.getView().getModel("ovpResourceModel"),"ovpResourceModel");this.lineItemDialog.addContent(l);l.loaded().then(function(v){this._oLineItemDialogContentView=v;v.getController().updateLineItemPath=function(i){var j=i.Value,n=this._oCardManifestSettings,p;if(n.tabs&&n.tabs.length){p=parseInt(n.selectedKey,10);}n.lineItemQualifier=s.getQualifier(j);n.annotationPath=j;if(n.tabs&&n.tabs.length){n.tabs[p-1].annotationPath=n.annotationPath;}this.getView().byId("sapOvpSettingsLineItem").setValue(i.Label);this._fCardWithRefresh(this._oEvent,"annotationPath");this.setEnablePropertyForResetAndSaveButton(true);if(n.tabs&&n.tabs.length){n.isViewResetEnabled=true;n.aViews[p].isViewResetEnabled=true;}this.cleanAndCloseDialog(o);}.bind(this);o.attachPress(function(){this.cleanAndCloseDialog(o);}.bind(this));this.lineItemDialog.open();setTimeout(function(){this.browserHeightChange();}.bind(this),0);}.bind(this));},createAndSubmitChange:function(){var p;if(s.bNewStaticLinkListCardFlag){p=P.getPayLoadForNewStaticLinkListCard.bind(this)(s);}else if(s.bNewKPICardFlag){p=P.getPayLoadForNewKPICard.bind(this)(s);}else if(s.bAddNewCardFlag){p=P.getPayLoadForNewCard.bind(this)(s);}else{p=P.getPayLoadForEditCard.bind(this)(s);}this.settingsResolve(p);s.dialogBox.close();},setMandatoryFieldState:function(v,o){o.setProperty("/dataPoint",v);o.setProperty("/valueSelectionInfo",v);o.setProperty("/requiredSubTitle",v);var i=o.getData(),j=false;for(var l=0;l<s.aVisiblePropertiesForAnnotation.length;l++){if(i[s.aVisiblePropertiesForAnnotation[l].sProperty]){j=true;break;}}o.setProperty("/setAnnotationCardProperties",j);},EnableKPIHeaderFields:function(i){var v=this.getView().getModel("visibility");if(!i){this.setMandatoryFieldState(false,v);}else{this.setMandatoryFieldState(true,v);}},onCardTypeSelected:function(E){var i=E.getParameters().id;this._oCardManifestSettings.template=E.getSource().getSelectedKey();this.getView().byId("sapOVPAddKpiCheckBoxID").setSelected(false);this.getView().byId("sapOVPAddODataSelect").setSelected(false);this._oCardManifestSettings.addKPIHeaderCheckBox=false;this.EnableKPIHeaderFields(this._oCardManifestSettings.addKPIHeaderCheckBox);this.resetPropertiesVisibility(i,this._oCardManifestSettings);},onDatasourceComboboxChanged:function(E){var j=E.getParameters().id;this._oCardManifestSettings.model=E.getParameters().value;this._oCardManifestSettings.allEntitySet="";if(!s.newDataSource){var l=this._oCardManifestSettings.datasources;for(var i=0;i<l.length;i++){if(l[i].Title===this._oCardManifestSettings.model){this._oCardManifestSettings.metaModel=l[i].oMetaModel;}}s.addSupportingObjects(this._oCardManifestSettings);if(this._oCardManifestSettings.allEntitySet.length===0){this._oCardManifestSettings.model="";this.resetPropertiesVisibility(j,this._oCardManifestSettings);var n=f.getText("OVP_KEYUSER_NO_RELEVANT_ANNOTATION");this.handleValueStateofComboBox(n,"datasSourceExisting","sapOVPDataSourceExistingComboBox",true);}else{this.handleValueStateofComboBox("","datasSourceExisting","sapOVPDataSourceExistingComboBox",false);this.resetPropertiesVisibility(j,this._oCardManifestSettings);}}else{var o=this._oCardManifestSettings.datasources.filter(function(p){return p.Title===this._oCardManifestSettings.model;}.bind(this));getMetaModelForNewDataSource(o,s.sApplicationId).then(function(p){if(p){s.newDataSourceModel=p.modelInformation;p.getODataEntityContainer=function(){return p.oEntityContainers;};p.getObject=function(r){return p.oSchema;};p.getODataEntityType=function(r){var t=p.oSchema[0].entityType.filter(function(u){var v=r.substr((p.oEntityContainers.namespace+".").length);return u.name===v;});return t[0];};this._oCardManifestSettings.metaModel=p;s.addSupportingObjects(this._oCardManifestSettings);if(this._oCardManifestSettings.allEntitySet.length===0){this._oCardManifestSettings.model="";this.resetPropertiesVisibility(j,this._oCardManifestSettings);var n=f.getText("OVP_KEYUSER_NO_RELEVANT_ANNOTATION");this.handleValueStateofComboBox(n,"datasSourceNew","sapOVPDataSourceNewInput",true);}else{this.handleValueStateofComboBox("","datasSourceNew","sapOVPDataSourceNewInput",false);this.resetPropertiesVisibility(j,this._oCardManifestSettings);}}else{this._oCardManifestSettings.model="";this.resetPropertiesVisibility(j,this._oCardManifestSettings);var n=f.getText("OVP_KEYUSER_UNAVAILABLE_DATASOURCE");this.handleValueStateofComboBox(n,"datasSourceNew","sapOVPDataSourceNewInput",true);}}.bind(this));}},onEntitySetChanged:function(E,j){var l=this._oCardManifestSettings.metaModel.getObject('/dataServices/schema')[0].entityType;this.aVariantNames.forEach(function(v){if(this._oCardManifestSettings[v.sPath]){this._oCardManifestSettings[v.sPath]=[];}}.bind(this));for(var i in l){if(l[i].name===E){this._oCardManifestSettings.entityType=l[i];break;}}s.addSupportingObjects(this._oCardManifestSettings);this.getView().byId("sapOVPAddODataSelect").setSelected(false);this.resetPropertiesVisibility(j,this._oCardManifestSettings);},addStaticParameterRow:function(){var o=this.getView().getModel();var i=o.getProperty("/aAllStaticParameters");if(i&&i.length){i.push({key:"",value:""});}else{i=[];i.push({key:"",value:""});}o.setProperty("/aAllStaticParameters",i);},addActionRow:function(){var o=this.getView().getModel();var i=o.getProperty("/objectStreamCardsSettings/customActions");if(i&&i.length){i.push({text:"",press:"",position:""});}else{i=[];i.push({text:"",press:"",position:""});}o.setProperty("/objectStreamCardsSettings/customActions",i);},onParameterDelete:function(E){var o=this.getView().getModel();var i=o.getProperty("/aAllStaticParameters");var j=E.getSource().getBindingContext().getObject()&&E.getSource().getBindingContext().getObject()["key"];i=i.filter(function(p){return p["key"]!=j;});o.setProperty("/aAllStaticParameters",i);if(!k(this._oCardManifestSettings.staticParameters,this._oOriginalCardManifestSettings.staticParameters)){this.setEnablePropertyForResetAndSaveButton(true);}this.getView().getModel().refresh();},onActionDelete:function(E){var o=this.getView().getModel();var i=o.getProperty("/objectStreamCardsSettings/customActions");var j=E.getSource().getBindingContext().getObject()&&E.getSource().getBindingContext().getObject()["text"];i=i.filter(function(p){return p["text"]!=j;});o.setProperty("/objectStreamCardsSettings/customActions",i);if(!k(this._oCardManifestSettings.objectStreamCardsSettings,this._oOriginalCardManifestSettings.objectStreamCardsSettings)){this.setEnablePropertyForResetAndSaveButton(true);}},updateProperty:function(E){var j=E.getSource().getId();var l=false,n;if(this._oCardManifestSettings.tabs&&this._oCardManifestSettings.tabs.length){l=true;n=parseInt(this._oCardManifestSettings.selectedKey,10);this._oCardManifestSettings.isViewResetEnabled=true;this._oCardManifestSettings.aViews[n].isViewResetEnabled=true;}for(var i=0;i<this._updateManifestProperties.length;i++){if(j.indexOf(this._updateManifestProperties[i].formElementId)>-1){var o=this._updateManifestProperties[i].formElement;switch(o){case"entitySet":var p=E.getSource().getSelectedKey();if(!l){this._oCardManifestSettings["entitySet"]=E.getParameter("value");}else{this._oCardManifestSettings.tabs[n-1]["entitySet"]=E.getParameter("value");}this.onEntitySetChanged(p,j);if(this._oCardManifestSettings["entitySet"].length!==0){this.validateComboBox(this._oCardManifestSettings,"entitySet");}break;case"identificationAnnotationPath":if(!l){this._oCardManifestSettings["identificationAnnotationPath"]=E.getParameter("value");}else{this._oCardManifestSettings.tabs[n-1]["identificationAnnotationPath"]=E.getParameter("value");}break;case"selectionPresentationAnnotationPath":if(!l){this._oCardManifestSettings["selectionPresentationAnnotationPath"]=E.getParameter("value");}else{this._oCardManifestSettings.tabs[n-1]["selectionPresentationAnnotationPath"]=E.getParameter("value");}break;case"selectionAnnotationPath":if(!l){this._oCardManifestSettings["selectionAnnotationPath"]=E.getParameter("value");}else{this._oCardManifestSettings.tabs[n-1]["selectionAnnotationPath"]=E.getParameter("value");}break;case"presentationAnnotationPath":if(!l){this._oCardManifestSettings["presentationAnnotationPath"]=E.getParameter("value");}else{this._oCardManifestSettings.tabs[n-1]["presentationAnnotationPath"]=E.getParameter("value");}break;case"annotationPath":if(!l){this._oCardManifestSettings["annotationPath"]=E.getParameter("value");}else{this._oCardManifestSettings.tabs[n-1]["annotationPath"]=E.getParameter("value");}break;case"listType":this._oCardManifestSettings.listType=E.getSource().getSelectedKey();break;case"listFlavor":this._oCardManifestSettings.listFlavor=E.getSource().getSelectedKey();if(j.indexOf("sapOVPLinkListFlavor")!==-1){this.validateComboBox(this._oCardManifestSettings,"listFlavor");}break;case"KPICheckBox":this._oCardManifestSettings.addKPIHeaderCheckBox=E.getParameter("selected");this.EnableKPIHeaderFields(this._oCardManifestSettings.addKPIHeaderCheckBox);this.validateComboBox(this._oCardManifestSettings,"KPICheckBox",this._oCardManifestSettings.addKPIHeaderCheckBox);break;case"dataPointAnnotationPath":if(!l){this._oCardManifestSettings["dataPointAnnotationPath"]=E.getParameter("value");}else{this._oCardManifestSettings.tabs[n-1]["dataPointAnnotationPath"]=E.getParameter("value");}this.validateComboBox(this._oCardManifestSettings,"dataPointAnnotationPath");break;case"addODataSelectCheckBox":this._oCardManifestSettings.addODataSelectCheckBox=E.getParameter("selected");break;case"requireAppAuthorization":this._oCardManifestSettings.requireAppAuthorization=E.getParameter("value");break;case"kpiAnnotationPath":if(!l){this._oCardManifestSettings["kpiAnnotationPath"]=E.getParameter("value");}else{this._oCardManifestSettings.tabs[n-1]["kpiAnnotationPath"]=E.getParameter("value");}this._oCardManifestSettings.kpiAnnotationPath=E.getParameter("value");break;case"navigationPath":this._oCardManifestSettings.navigationPath=E.getParameter("value");break;case"title":case"subTitle":case"valueSelectionInfo":var r=false;var t=o+"Key";var u=o+"Property";this._oCardManifestSettings[o]=E.getParameter("value");this._oCardManifestSettings[u]=E.getParameter("value");for(var v in this._oCardManifestSettings.ai18nProperties){if(this._oCardManifestSettings.ai18nProperties[v].value===E.getParameter("value")){this._oCardManifestSettings[t]=this._oCardManifestSettings.ai18nProperties[v].key;r=true;break;}}if(!r){this._oCardManifestSettings[t]="";}this.validateComboBox(this._oCardManifestSettings,o);break;case"existingDatasSource":if(E.mParameters.selected){s.newDataSource=false;this._oCardManifestSettings.newDataSource=false;this.handleValueStateofComboBox("","datasSourceExisting","sapOVPDataSourceExistingComboBox",false);this.resetPropertiesVisibility(j,this._oCardManifestSettings);var w=this.getView().getModel();w.setProperty("/datasources",this._oCardManifestSettings.datasourcesFromManifest);}break;case"newDatasSource":if(E.mParameters.selected){s.newDataSource=true;this._oCardManifestSettings.newDataSource=true;this.handleValueStateofComboBox("","datasSourceNew","sapOVPDataSourceNewInput",false);this.resetPropertiesVisibility(j,this._oCardManifestSettings);this.getView().setBusy(true);getNewDataSources(s.sApplicationId).then(function(x){this.getView().setBusy(false);var y=x.results;var w=this.getView().getModel();w.setSizeLimit(y.length);w.setProperty("/datasources",y);}.bind(this));}break;default:break;}}}},resetPropertiesVisibility:function(E,o){if(E.indexOf("sapOVPExistingDataSource")!==-1||E.indexOf("sapOVPNewDataSource")!==-1){this._updateManifestProperties.forEach(function(p){if(!p.formElementId.includes("sapOVPExistingDataSource")&&!p.formElementId.includes("sapOVPNewDataSource")){if(p.formElementId.includes("sapOVPAddODataSelect")){o[p.formElement]=false;}else{o[p.formElement]="";}}});o.model="";}else if(E.indexOf("sapOVPDataSource")!==-1){this._updateManifestProperties.forEach(function(p){if(!p.formElementId.includes("sapOVPExistingDataSource")&&!p.formElementId.includes("sapOVPNewDataSource")&&!E.includes(p.formElementId)){if(p.formElementId.includes("sapOVPAddODataSelect")){o[p.formElement]=false;}else{o[p.formElement]="";}}});}else if(E.indexOf("sapOVPCardType")!==-1){this._updateManifestProperties.forEach(function(p){if(!(p.formElementId.includes("sapOVPDataSource")||p.formElementId.includes("sapOVPCardType"))){if(p.formElementId.includes("sapOVPAddODataSelect")){o[p.formElement]=false;}else{o[p.formElement]="";}}});}else if(E.indexOf("sapOVPEntitySetList")!==-1){var i=this.getView().getModel("visibility").getData().showViewSwitch;this._updateManifestProperties.forEach(function(p){if(!(p.formElementId.includes("sapOVPDataSource")||p.formElementId.includes("sapOVPCardType")||p.formElementId.includes("sapOVPEntitySetList"))){if(p.formElementId.includes("sapOVPAddODataSelect")){o[p.formElement]=false;}else{if(!i){o[p.formElement]="";}else{S.tabFields.forEach(function(j){if(j!=='entitySet'&&j!=='value'){o[j]="";}});}}}});}s.resetErrorHandling();this.setEnablePropertyForResetAndSaveButton(false);s.setVisibilityForFormElements(o);this.getView().getModel().refresh();this.getView().getModel("visibility").refresh();}});});

/*
 * ! SAPUI5

		(c) Copyright 2009-2019 SAP SE. All rights reserved
	
 */
sap.ui.define(['sap/ui/model/json/JSONModel',"sap/base/util/array/diff","sap/m/Button",'sap/base/util/merge'],function(J,d,B,m){"use strict";var i=jQuery.sap.getUriParameters().get("P13nModal")==="true";var U={showP13nChart:function(c,s,p,a){this.sP13nType="Chart";var P="sap/ui/mdc/p13n/ChartItemPanel";return this._showDialog(c,s,p,a,P);},showP13nColumns:function(c,s,p,a){this.sP13nType="Columns";var P="sap/ui/mdc/p13n/SelectionPanel";return this._showDialog(c,s,p,a,P);},showP13nSort:function(c,s,p,a){this.sP13nType="Sort";var P="sap/ui/mdc/p13n/SortPanel";return this._showDialog(c,s,p,a,P);},_showDialog:function(c,s,p,a,P){return new Promise(function(r,b){sap.ui.require(i?['sap/m/Dialog',P]:['sap/m/ResponsivePopover',P],function(C,e){this.sortP13nData(p);this.oJSONModel=new J(p);this.oState=m({},p);this.oControl=c;var t=this._getPanelTitle(this.sP13nType);this.fnHandleChange=function(f){U.handleUserChanges(f,c).then(function(){if(a){a();}if(this.oJSONModel){this.oState=m({},this.oJSONModel.getData());}}.bind(this));}.bind(this);var o=new e({change:i?function(){}:this._registerChangeEvent.bind(this)});o.setModel(this.oJSONModel);var D=this._createDialog(C,o,i,this.oJSONModel,c,t,this.fnHandleChange);c.addDependent(D);if(i){D.open();}else{D.openBy(s);}r();}.bind(this));}.bind(this));},_registerChangeEvent:function(){var c=[],s,C=[],I=[],a=[];switch(this.sP13nType){case"Sort":s=function(o){return o.name+o.sortOrder;};C=["removeSort","addSort"];break;case"Columns":s=function(o){return o.name;};C=["removeColumn","addColumn"];break;case"Chart":s=function(o){return o.name+o.role;};C=["removeItem","addItem"];break;}var f=function(o){return o.selected;};I=this.oState.items.filter(f);a=this.oJSONModel.getData().items.filter(f);c=this._processResult(I,a,s,this.oControl,C[0],C[1]);this.oState=m({},this.oJSONModel.getData());this.fnHandleChange(c);},_createDialog:function(C,p,i,j,c,M,f){var o;var D=m({},j.getProperty("/"));var r=sap.ui.getCore().getLibraryResourceBundle("sap.ui.mdc");if(!i){o=new C({title:r.getText(M),horizontalScrolling:false,verticalScrolling:true,contentWidth:"25rem",resizable:true,placement:"HorizontalPreferredRight",content:p,afterClose:function(){o.destroy();f([]);}});}else{o=new C({title:r.getText(M),horizontalScrolling:false,verticalScrolling:true,contentWidth:"40rem",contentHeight:"55rem",draggable:true,resizable:true,stretch:"{device>/system/phone}",content:p,buttons:[new B({text:r.getText("p13nDialog.OK"),type:"Emphasized",press:function(){this._registerChangeEvent();o.close();o.destroy();}.bind(this)}),new B({text:r.getText("p13nDialog.CANCEL"),press:function(){o.close();o.destroy();j.setProperty("/",m({},D));f([]);}})]});}o.addStyleClass("sapUiMdcPersonalizationDialog");o.toggleStyleClass("sapUiSizeCompact",!!jQuery(c.getDomRef()).closest(".sapUiSizeCompact").length);return o;},_processResult:function(e,c,s,C,r,I){var R=d(e,c,s);var M=function(f,A){return A.filter(function(E){return E&&(E.name===f.name);})[0];};var a=[];var p=e.slice(0);R.forEach(function(o){if(o.type==="delete"&&p[o.index]===undefined){p.splice(o.index,1);return;}var E;if(o.type==="insert"){E=M(c[o.index],p);if(E){E.index=p.indexOf(E);p.splice(E.index,1,undefined);a.push({selectorElement:C,changeSpecificData:{changeType:r,content:E}});}}var P=o.type==="delete"?p[o.index]:c[o.index];P.index=o.index;if(o.type==="delete"){p.splice(P.index,1);}else{p.splice(P.index,0,P);}a.push({selectorElement:C,changeSpecificData:{changeType:o.type==="delete"?r:I,content:P}});});return a;},sortP13nData:function(D){var l=sap.ui.getCore().getConfiguration().getLocale().toString();var c=window.Intl.Collator(l,{});D.items.sort(function(f,F){if(f.selected&&F.selected){return(f.position||0)-(F.position||0);}else if(f.selected){return-1;}else if(F.selected){return 1;}else if(!f.selected&&!F.selected){return c.compare(f.label,F.label);}});},_getPanelTitle:function(p){var t;switch(p){case"Sort":t="sort.PERSONALIZATION_DIALOG_TITLE";break;case"Columns":t="fieldsui.COLUMNS";break;case"Chart":t="chart.PERSONALIZATION_DIALOG_TITLE";break;}return t;},handleUserChanges:function(c,C){return new Promise(function(r,a){sap.ui.require(["sap/ui/fl/write/api/ControlPersonalizationWriteAPI"],function(b){b.add({changes:c}).then(function(D){r(D);});});});}};return U;});

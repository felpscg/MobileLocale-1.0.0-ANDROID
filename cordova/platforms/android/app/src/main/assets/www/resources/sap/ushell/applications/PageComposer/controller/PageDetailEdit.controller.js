// Copyright (c) 2009-2017 SAP SE, All Rights Reserved
sap.ui.define(["sap/m/MessagePopover","sap/m/MessageItem","sap/ushell/applications/PageComposer/controller/BaseController","sap/ushell/applications/PageComposer/controller/Page","sap/ushell/applications/PageComposer/controller/TileSelector","sap/ui/model/json/JSONModel","sap/m/MessageBox","sap/ui/core/library","sap/m/MessageToast"],function(M,a,B,P,T,J,b,c,d){"use strict";var m=new J();var r={};function _(e){e.setData({page:{},edit:true,errors:[],errorslength:0,headerExpanded:true});}m.setProperty=function(p){if(p.indexOf("/page")===0&&!jQuery.isEmptyObject(m.getProperty("/page"))){sap.ushell.Container.setDirtyFlag(true);}J.prototype.setProperty.apply(this,arguments);};return B.extend("sap.ushell.applications.PageComposer.controller.PageDetailEdit",{onInit:function(){var R=this.getRouter();R.getRoute("edit").attachPatternMatched(this._onPageMatched,this);this.setModel(m);r.i18n=this.getResourceBundle();this.Page.init(this);this.TileSelector.init(this);this.TileSelector.setAddTileHandler(this._addContentToGroup.bind(this));},onExit:function(){this.Page.exit();},mCatalogTiles:{},Page:P,TileSelector:new T(),oMessagePopover:new M({items:{path:"/errors",template:new a({type:"{type}",title:"{title}",activeTitle:"{active}",description:"{description}",subtitle:"{subtitle}",counter:"{counter}"})}}).setModel(m),handleMessagePopoverPress:function(e){this.oMessagePopover.toggle(e.getSource());},onUpdateSideContentVisibility:function(){var p=this.getView().byId("layoutContent");p.setShowSideContent(!p.isSideContentVisible());},onTitleChange:function(e){var i=e.getSource();i.setValueStateText(r.i18n.getText("Message.EmptyTitle"));if(!i.getValue()){i.setValueState(c.ValueState.Error);}else{i.setValueState(c.ValueState.None);}},onSave:function(){var s=function(C){if(C===b.Action.OK){this._savePage(m.getProperty("/page")).then(function(){sap.ushell.Container.setDirtyFlag(false);d.show(r.i18n.getText("Message.SavedChanges"),{closeOnBrowserNavigation:false});},function(E){this.showMessageBoxError(E,false);}.bind(this));}}.bind(this);if(!m.getProperty("/page/content/title")){this.showMessageBoxError(r.i18n.getText("Message.EmptyTitle"));m.setProperty("/headerExpanded",true);return;}if(!window.navigator.onLine){this.showMessageBoxError(r.i18n.getText("Message.NoInternetConnection"));return;}if(m.getProperty("/errorslength")>0){var t=r.i18n.getText("Title.TilesHaveErrors"),e=r.i18n.getText("Message.TilesHaveErrors");sap.ushell.Container.getService("Message").confirm(e,s,t);return;}s(b.Action.OK);},onCancel:function(){this.navigateToPageOverview();},_updatePageWithMetadata:function(e){if(e&&e.metadata&&e.metadata.transportId){m.setProperty("/page/metadata/transportId",e.metadata.transportId);}},_onPageMatched:function(e){var p=e.getParameter("arguments").pageId;_(m);this._loadPage(decodeURIComponent(p)).then(function(o){m.setProperty("/page",o);m.setProperty("/edit",true);this.checkShowEditDialog(o,this._updatePageWithMetadata.bind(this),this.navigateToPageOverview.bind(this));this.Page.init(this);this._fetchCatalogInfo().then(function(f){this.mCatalogTiles=f.mCatalogTiles;this.TileSelector.initTiles(f);m.updateBindings(true);this._pageUpdated();if(!m.getProperty("/page/content/sections").length){this.Page.addGroup();}}.bind(this)).then(function(){sap.ushell.Container.setDirtyFlag(false);}).catch(function(E){this.showMessageBoxError(E,true);}.bind(this));}.bind(this));},_loadPage:function(p){return this.getPageRepository().getPage(p);},_savePage:function(p){return this.getPageRepository().updatePage(p);},_fetchCatalogInfo:function(){return sap.ushell.Container.getServiceAsync("LaunchPage").then(function(l){return l.getCatalogs().then(function(C){var e=C.map(function(o){var s=l.getCatalogId(o)||"";return l.getCatalogTitle(o)||s.split(":").slice(1).join(":");});return Promise.all(C.map(function(o){return l.getCatalogTiles(o);})).then(function(f){var v={};for(var i=0;i<f.length;i++){for(var j=0;j<f[i].length;j++){v[l.getCatalogTileId(f[i][j])]=f[i][j];}}return{catalogTitles:e,catalogTiles:f,mCatalogTiles:v};});});});},_pageUpdated:function(){sap.ushell.Container.setDirtyFlag(true);var e=this.Page.collectErrors();m.setProperty("/errors",e);m.setProperty("/errorslength",e.length);},addGroupAt:function(g){var G=m.getProperty("/page/content/sections");if(!g&&g!==0){g=G.length;}G.splice(g,0,{visualizations:[]});m.setProperty("/page/content/sections",G);this._pageUpdated();},deleteGroup:function(g){if(!g&&g!==0){return;}var G=m.getProperty("/page/content/sections");G.splice(g,1);m.setProperty("/page/content/sections",G);this._pageUpdated();},moveGroup:function(o,n){if(!o&&o!==0||!n&&n!==0){return;}var g=m.getProperty("/page/content/sections"),G=g.splice(o,1)[0];g.splice(n,0,G);m.setProperty("/page/content/sections",g);this._pageUpdated();},_addContentToGroup:function(e,g,f){if(!e||!g.length){return;}g.forEach(function(G){var C=m.getProperty("/page/content/sections/"+G+"/visualizations");if(!f&&f!==0){f=C.length;}C.splice(f,0,e);m.setProperty("/page/content/sections/"+G+"/visualizations",C);this._pageUpdated();}.bind(this));},deleteContentInGroup:function(e,g){if(!e&&e!==0||!g&&g!==0){return;}var C=m.getProperty("/page/content/sections/"+g+"/visualizations");C.splice(e,1);m.setProperty("/page/content/sections/"+g+"/visualizations",C);this._pageUpdated();},moveContentInGroup:function(o,n,e,f){if(!o&&o!==0||!n&&n!==0||!e&&e!==0||!f&&f!==0){return;}var O="/page/content/sections/"+e+"/visualizations",N="/page/content/sections/"+f+"/visualizations",g=m.getProperty(O),h=m.getProperty(N),C=g.splice(o,1);h.splice(n,0,C[0]);m.setProperty(O,g);m.setProperty(N,h);this._pageUpdated();}});});

// Copyright (c) 2009-2017 SAP SE, All Rights Reserved
sap.ui.define(["sap/ui/thirdparty/jquery","sap/ui/base/ManagedObject","sap/ui/core/Control","sap/ui/core/Icon","sap/ushell/resources","sap/ushell/ui/launchpad/AccessibilityCustomData","sap/base/Log","./TileRenderer"],function(q,M,C,I,r,A,L){"use strict";var T=C.extend("sap.ushell.ui.launchpad.Tile",{metadata:{library:"sap.ushell",properties:{long:{type:"boolean",group:"Misc",defaultValue:false},uuid:{type:"string",group:"Misc",defaultValue:null},tileCatalogId:{type:"string",group:"Misc",defaultValue:null},isCustomTile:{type:"boolean",group:"Misc",defaultValue:false},target:{type:"string",group:"Misc",defaultValue:null},debugInfo:{type:"string",group:"Misc",defaultValue:null},rgba:{type:"string",group:"Misc",defaultValue:null},animationRendered:{type:"boolean",group:"Misc",defaultValue:false},isLocked:{type:"boolean",group:"Misc",defaultValue:false},showActionsIcon:{type:"boolean",group:"Misc",defaultValue:false},tileActionModeActive:{type:"boolean",group:"Misc",defaultValue:false},ieHtml5DnD:{type:"boolean",group:"Misc",defaultValue:false},navigationMode:{type:"string",group:"Misc",defaultValue:null},isDraggedInTabBarToSourceGroup:{type:"boolean",group:"Misc",defaultValue:false}},aggregations:{tileViews:{type:"sap.ui.core.Control",multiple:true,singularName:"tileView"},pinButton:{type:"sap.ui.core.Control",multiple:true,singularName:"pinButton"}},events:{press:{},coverDivPress:{},afterRendering:{},showActions:{},deletePress:{}}}});T.prototype.getActionSheetIcon=function(){if(!this.getTileActionModeActive()){return undefined;}if(!this.actionSheetIcon){this.actionSheetIcon=new I({src:"sap-icon://overflow"});this.actionSheetIcon.setTooltip(r.i18n.getText("configuration.category.tile_actions"));this.actionSheetIcon.addStyleClass("sapUshellTileActionIconDivBottomInner");}return this.actionSheetIcon;};T.prototype.ontap=function(){L.info("Tile clicked:",this.getDebugInfo(),"sap.ushell.ui.launchpad.Tile");this.firePress();};T.prototype.destroy=function(s){this.destroyTileViews();C.prototype.destroy.call(this,s);};T.prototype.addTileView=function(o,s){o.setParent(null);M.prototype.addAggregation.call(this,"tileViews",o,s);};T.prototype.destroyTileViews=function(){if(this.mAggregations.tileViews){this.mAggregations.tileViews.length=0;}};T.prototype.onBeforeRendering=function(){var d=this.getDomRef();if(!d){return;}var i=d.querySelector("a.sapUshellTileInner");if(i){i.onclick=null;}};T.prototype.onAfterRendering=function(){if(this.getIsDraggedInTabBarToSourceGroup()===true){var t=this.getParent();t.removeAggregation("tiles",this,false);}this._redrawRGBA();this._disableInnerLink();this.fireAfterRendering();};T.prototype._disableInnerLink=function(){var d=this.getDomRef();var i=d.querySelector("a.sapUshellTileInner");if(i){i.onclick=function(e){e.preventDefault();};}};T.prototype._launchTileViaKeyboard=function(e){if(this.getTileActionModeActive()){this.fireCoverDivPress({id:this.getId()});}else if(e.target.tagName!=="BUTTON"){var t=this.getTileViews()[0],p=false,c,o;if(t.firePress){t.firePress({id:this.getId()});}else if(t.getComponentInstance){c=t.getComponentInstance();if(c._oController&&c._oController.oView.getContent()){o=c._oController.oView.getContent()[0];if(o&&o.firePress){o.firePress({id:this.getId()});}}}else{while(t.getContent&&!p){t=t.getContent()[0];if(t.firePress){t.firePress({id:this.getId()});p=true;}}}}};T.prototype.onsapenter=function(e){this._launchTileViaKeyboard(e);if(!this.getTileActionModeActive()){this._announceLoadingApplication();}};T.prototype.onsapspace=function(e){this._launchTileViaKeyboard(e);if(!this.getTileActionModeActive()){this._announceLoadingApplication();}};T.prototype.onfocusin=function(){var c=this.getDomRef().getAttribute("class"),p;p=c?c.indexOf("sapUshellPlusTile")!==-1:false;if(!p){var j=q(this.getDomRef()).prevUntil("h3"),e,s="",t,n,a;if(j.length>0){e=j[j.length-1].previousSibling;}else{e=this.getDomRef().previousSibling;}if(e){s=e.getAttribute("id");}a=this.getDomRef().querySelector(".sapUshellTileInner");var d=this.getDomRef().querySelector(".sapUshellTileDeleteClickArea .sapUiIcon");var b=d?d.id:"";if(a&&a.children&&a.children[0]){var f=(s&&s!=="")?"sapUshellCatalogAccessibilityTileText":"sapUshellDashboardAccessibilityTileText";t=a.children[0].getAttribute("id");var l=[f,t,b,s];n=this.getId()+"_navigationMode";var N=document.getElementById(n);if(N==null){var g=this.getNavigationMode();if(g){N=document.createElement("div");var i=document.createAttribute("id");i.value=n;N.setAttributeNode(i);N.style.display="none";var h=r.i18n.getText(g+"NavigationMode");if(h){N.innerHTML=h;}else{L.warning("could not get the navigation mode text of this tile to be added on the aria-labelledBby attribute");}a.appendChild(N);l.splice(1,0,n);}}else{l.splice(1,0,n);}if(this.getTileActionModeActive()){l.push("sapUshellDashboardAccessibilityTileEditModeText");}this.getDomRef().setAttribute("aria-labelledby",l.join(" "));}}};T.prototype.onclick=function(e){if(this.getTileActionModeActive()){var s=e.originalEvent.srcElement;if(q(s).closest(".sapUshellTileDeleteClickArea").length>0){this.fireDeletePress();}else{this.fireCoverDivPress({id:this.getId()});}}else{this._announceLoadingApplication();}};T.prototype._announceLoadingApplication=function(){var a=document.getElementById("sapUshellLoadingAccessibilityHelper-appInfo"),l=r.i18n.getText("screenReaderNavigationLoading");if(a){a.setAttribute("role","alert");a.innerHTML=l;setTimeout(function(){a.removeAttribute("role");a.innerHTML="";},0);}};T.prototype._initDeleteAction=function(){var t=this;if(!this.deleteIcon){this.deleteIcon=new I({src:"sap-icon://decline",tooltip:r.i18n.getText("removeButtonTItle")});this.deleteIcon.addEventDelegate({onclick:function(e){t.fireDeletePress();e.stopPropagation();}});this.deleteIcon.addStyleClass("sapUshellTileDeleteIconInnerClass");this.deleteIcon.addCustomData(new A({key:"aria-label",value:r.i18n.getText("removeButtonLabel"),writeToDom:true}));}return this.deleteIcon;};T.prototype.setShowActionsIcon=function(s){var t=this,i;if(s){i=new I({size:"1rem",src:"sap-icon://overflow",press:function(e){t.fireShowActions();t.addStyleClass("showTileActionsIcon");var E=sap.ui.getCore().getEventBus(),a=function(n,b,c){c.removeStyleClass("showTileActionsIcon");E.unsubscribe("dashboard","actionSheetClose",a);};E.subscribe("dashboard","actionSheetClose",a);}});i.addStyleClass("sapUshellTileActionsIconClass");this.actionIcon=i;}else if(this.actionIcon){this.actionIcon.destroy(true);}this.setProperty("showActionsIcon",s);};T.prototype.setIsDraggedInTabBarToSourceGroup=function(d){this.setProperty("isDraggedInTabBarToSourceGroup",d,true);this.setVisible(!d);};T.prototype.setVisible=function(v){this.setProperty("visible",v,true);return this.toggleStyleClass("sapUshellHidden",!v);};T.prototype.setTarget=function(v){this.setProperty("target",v,true);this.$().find(".sapUshellTileInner").attr("href",v);};T.prototype.setRgba=function(v){this.setProperty("rgba",v,true);this._redrawRGBA(arguments);};T.prototype.setAnimationRendered=function(v){this.setProperty("animationRendered",v,true);};T.prototype.setNavigationMode=function(v){this.setProperty("navigationMode",v,true);};T.prototype._handleTileShadow=function(j){if(j.length){j.unbind("mouseenter mouseleave");var u,t=j.css("border").split("px")[0],m=this.getModel();if(t>0){u=j.css("border-color");}else{u=this.getRgba();}j.hover(function(){if(!m.getProperty("/tileActionModeActive")){var o=q(j).css("box-shadow"),s=o?o.split(") ")[1]:null,U;if(s){U=s+" "+u;q(this).css("box-shadow",U);}}},function(){q(this).css("box-shadow","");});}};T.prototype._redrawRGBA=function(a){var R=this.getRgba(),j;if(R){j=q(document.getElementById(this.getId()));if(!j){return;}if(!this.getModel().getProperty("/animationRendered")){j.css("transition","background-color 2s");j.css("background-color",R);}else{j.css("background-color",R);}this._handleTileShadow(j,a);}};T.prototype.setLong=function(l){this.setProperty("long",l,true);return this.toggleStyleClass("sapUshellLong",!!l);};T.prototype.setUuid=function(u){this.setProperty("uuid",u,true);return this;};return T;});

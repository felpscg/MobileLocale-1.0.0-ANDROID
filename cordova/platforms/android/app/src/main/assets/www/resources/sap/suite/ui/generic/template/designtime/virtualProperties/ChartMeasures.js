sap.ui.define(["sap/suite/ui/generic/template/changeHandler/util/AnnotationChangeUtilsV2","sap/suite/ui/generic/template/designtime/utils/DesigntimeUtils","sap/suite/ui/generic/template/changeHandler/util/ChangeHandlerUtils"],function(A,D,C){"use strict";var a={},p=false,M="com.sap.vocabularies.UI.v1.ChartMeasureRoleType",b="com.sap.vocabularies.UI.v1.DataPoint",c="com.sap.vocabularies.UI.v1.ChartType/Area",d="com.sap.vocabularies.UI.v1.ChartType/Donut",e="com.sap.vocabularies.UI.v1.ChartType/Bullet";a._setPostponedRetemplating=function(v){p=v;};a._getPostponedRetemplating=function(){return p;};a.getMeasureDefinition=function(E){var m={Measure:{displayName:"Measure",type:"Edm.PropertyPath",namespace:"com.sap.vocabularies.UI.v1",annotation:"Chart",nullable:false},Role:{displayName:"Role",type:"EnumType",namespace:"com.sap.vocabularies.UI.v1",annotation:"Chart",possibleValues:{Axis1:{displayName:"Axis 1"},Axis2:{displayName:"Axis 2"},Axis3:{displayName:"Axis 3"}}},DataPointAnnotationPath:{displayName:"Data Point Reference",type:"Edm.AnnotationPath",namespace:"com.sap.vocabularies.UI.v1",annotation:"Chart",refersTo:{annotation:"DataPoint",namespace:"com.sap.vocabularies.UI.v1"}}};var o={properties:["ImprovementDirection","DeviationRangeLowValue","DeviationRangeHighValue","ToleranceRangeLowValue","ToleranceRangeHighValue"],expressionTypes:{"DeviationRangeLowValue":["Path"],"DeviationRangeHighValue":["Path"],"ToleranceRangeLowValue":["Path"],"ToleranceRangeHighValue":["Path"]}};var f=D.getChartFromParent(E),g=f&&f.entityType[f.chartID];if(!f||!g||!g.ChartType){return m;}switch(g.ChartType.EnumMember){case c:m.Role.nullable=false;m.DataPoint={displayName:"Data Point Properties",type:"ComplexType",namespace:"com.sap.vocabularies.UI.v1",annotation:"DataPoint",whiteList:{properties:["Value","TargetValue","CriticalityCalculation"],mandatory:["Value","TargetValue"],expressionTypes:{Value:["Path"],TargetValue:["Path","String","Int","Decimal"]},CriticalityCalculation:o}};break;case e:m.Role.nullable=true;m.DataPoint={displayName:"Data Point Properties",type:"ComplexType",namespace:"com.sap.vocabularies.UI.v1",annotation:"DataPoint",whiteList:{properties:["Value","TargetValue","ForecastValue","MinimumValue","MaximumValue","Criticality","CriticalityCalculation"],mandatory:["Value"],expressionTypes:{Value:["Path"],TargetValue:["Path","String","Int","Decimal"],ForecastValue:["Path","String","Int","Decimal"],Criticality:["Path"]},CriticalityCalculation:o}};break;case d:m.Role.nullable=true;m.DataPoint={displayName:"Data Point Properties",type:"ComplexType",namespace:"com.sap.vocabularies.UI.v1",annotation:"DataPoint",whiteList:{properties:["Value","TargetValue","Criticality","CriticalityCalculation"],mandatory:["Value"],expressionTypes:{Value:["Path"],TargetValue:["Path","String","Int","Decimal"],Criticality:["Path"]},CriticalityCalculation:o}};break;default:break;}return m;};a.getChartFromConnectedField=function(E,i){var r=C.getLineItemRecordForColumn(E),o,f;if(i===undefined){return;}if(r&&r.RecordType==="com.sap.vocabularies.UI.v1.DataFieldForAnnotation"&&r.Target&&r.Target.AnnotationPath.indexOf("FieldGroup")>=0){var F=r.Target.AnnotationPath,g=C.getEntityTypeFromAnnotationPath(E,F);if(g){F=F.substring(1);f={target:g.namespace+"."+g.name,fieldGroup:F,data:g[F]};}}var I=f&&f.data,h=[];if(I){h=JSON.parse(JSON.stringify(I.Data));}if(i>=0){var s=(h[i].Target&&h[i].Target.AnnotationPath).replace(/@/g,"");var j=C.getEntityTypeFromAnnotationPath(E,s);var q=s.search("/");var k=s.substring(q+1);o={chartID:k,entityType:j};}return o;};a.getMeasures=function(E,I){var m={},f=[],s,q,g,o,h,k={},l,n,r;if(E.sId.indexOf("FieldGroup")>=0){n=this.getChartFromConnectedField(E,I);}else{n=D.getChartFromParent(E);}r=n&&n.entityType[n.chartID];if(r&&r.Measures){var t=jQuery.extend(true,{},t,r);for(var i=0;i<t.Measures.length;i++){s=t.Measures[i].PropertyPath;g=false;if(t.MeasureAttributes){for(var j=0;j<t.MeasureAttributes.length;j++){o=t.MeasureAttributes[j];k={};if(o.Measure&&o.Measure.PropertyPath===s){g=true;if(o.DataPoint&&o.DataPoint.AnnotationPath){q=o.DataPoint.AnnotationPath.split("#").reverse()[0];h=q?b+"#"+q:b;l=n.entityType&&n.entityType[h]!==undefined?n.entityType[h]:n[h];if(l){jQuery.extend(true,k,l);}}m={Measure:{PropertyPath:o.Measure&&o.Measure.PropertyPath},DataPointAnnotationPath:{AnnotationPath:o.DataPoint&&o.DataPoint.AnnotationPath},DataPoint:k};if(o.Role&&o.Role.EnumMember){switch(o.Role.EnumMember){case"com.sap.vocabularies.UI.v1.ChartMeasureRoleType/Axis1":m.Role={EnumMember:"Axis1"};break;case"com.sap.vocabularies.UI.v1.ChartMeasureRoleType/Axis2":m.Role={EnumMember:"Axis2"};break;case"com.sap.vocabularies.UI.v1.ChartMeasureRoleType/Axis3":m.Role={EnumMember:"Axis3"};break;default:break;}}f.push(m);break;}}}if(!g){m={Measure:t.Measures[i]};f.push(m);}}}return f;};a.setMeasures=function(o,n,f){var i,j,k,m,E,N,s,g=[],h,l={},q,O;if(o.sId.indexOf("FieldGroup")>=0){var I=f.metadataPath.match(/\d+/g).map(Number)[0];q=this.getChartFromConnectedField(o,I);O=q&&q.entityType[q.chartID];}else{q=D.getChartFromColumn(o);O=q&&q.entityType&&q.entityType[q.chartID];}if(!O||jQuery.isEmptyObject(O)||!q||!n){return g;}if(f.delayRefresh){p=true;}var r=jQuery.extend(true,{},O),t;if(q.hasOwnProperty("entityType")){if(q.entityType.hasOwnProperty("namespace")&&q.entityType.hasOwnProperty("name")){t=q.entityType.namespace+"."+q.entityType.name;}else{t=q.entityType;}}else{t=q.namespace+"."+q.name;}if(r.Measures){for(i=r.Measures.length-1;i>=0;i--){E=false;m=r.Measures[i].PropertyPath;for(j=0;j<n.length;j++){if(n[j].Measure&&n[j].Measure.PropertyPath===m){E=true;break;}}if(!E){r.Measures.splice(i,1);if(r.MeasureAttributes){for(j=r.MeasureAttributes.length-1;j>=0;j--){h=r.MeasureAttributes[j].Measure;if(h&&h.PropertyPath===m){r.MeasureAttributes.splice(j,1);if(!m&&O.Measures.length>n.length){f.noRefreshOnChange=true;f.refreshPropertiesPane=true;}break;}}}}}}for(i=0;i<n.length;i++){N=n[i];if(jQuery.isEmptyObject(N)){N={Measure:{PropertyPath:""}};}E=false;if(r.MeasureAttributes){for(j=0;j<r.MeasureAttributes.length;j++){h=r.MeasureAttributes[j].Measure;if(N.Measure&&h&&h.PropertyPath===N.Measure.PropertyPath){E=true;if(N.DataPointAnnotationPath&&(!r.MeasureAttributes[j].DataPoint||r.MeasureAttributes[j].DataPoint.AnnotationPath!==N.DataPointAnnotationPath.AnnotationPath)){f.refreshPropertiesPane=true;p=true;}break;}}}if(N.DataPointAnnotationPath&&N.DataPointAnnotationPath.AnnotationPath){s=N.DataPointAnnotationPath.AnnotationPath;}else if(N.Measure&&N.Measure.PropertyPath){s="@"+b+"#"+N.Measure.PropertyPath;N.DataPointAnnotationPath={AnnotationPath:s};f.retemplateAfterPanelRefresh=true;f.refreshPropertiesPane=true;}else{s="";}l={Measure:{PropertyPath:N.Measure.PropertyPath},DataPoint:{AnnotationPath:s},RecordType:"com.sap.vocabularies.UI.v1.ChartMeasureAttributeType"};if(N.Role){switch(N.Role.EnumMember){case"Axis2":l.Role={EnumMember:M+"/Axis2"};break;case"Axis3":l.Role={EnumMember:M+"/Axis3"};break;default:l.Role={EnumMember:M+"/Axis1"};break;}}else{var u="Axis1";if(O.MeasureAttributes){var P=["Axis1","Axis2","Axis3"];u="Axis3";for(k=0;k<O.MeasureAttributes.length;k++){var R=O.MeasureAttributes[k].Role.EnumMember.split("/").reverse()[0];var v=P.indexOf(R);if(v!==-1){P.splice(v,1);}}if(P.length>0){u=P[0];}}N.Role={EnumMember:u};l.Role={EnumMember:M+"/"+u};}if(!E){if(!r.Measures){r.Measures=[];}r.Measures.push(N.Measure);if(!r.MeasureAttributes){r.MeasureAttributes=[];}r.MeasureAttributes.push(l);}else{r.MeasureAttributes[j]=l;}var w=D.modifyDataPointForChart(t,q.entityType?q.entityType:q,N,g);if(w){var x=["@",b,w];r.MeasureAttributes.DataPoint={AnnotationPath:x.join('')};}if(N.Measure.PropertyPath===""){f.noRefreshOnChange=true;if(O.Measures.length>r.Measures.length&&!p){k=0;while(!p&&k<O.Measures.length){if(O.Measures[k].PropertyPath){p=true;}k++;}}}else if(N.Measure.PropertyPath!==""&&N.DataPoint&&N.DataPoint.Value&&!f.noRefreshOnChange){p=false;}}if(p&&f.noRefreshOnChange){var H=false;k=0;while(!H&&k<r.Measures.length){if(!r.Measures[k].PropertyPath){H=true;}k++;}if(!H){f.noRefreshOnChange=false;f.refreshPropertiesPane=true;p=false;}}var y=A.createCustomAnnotationTermChange(t,r,O,q.chartID);g.push(y);return g;};return a;});

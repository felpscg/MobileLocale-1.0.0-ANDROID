// Copyright (c) 2009-2017 SAP SE, All Rights Reserved
sap.ui.define(["sap/base/util/isEmptyObject","sap/ui/model/json/JSONModel","sap/m/GenericTile","sap/m/ImageContent","sap/m/NumericContent","sap/m/TileContent","sap/ushell/Config"],function(i,J,G,I,N,T,C){"use strict";var m,p,r={};var v=new J({sizeBehavior:C.last("/core/home/sizeBehavior")});var _=C.on("/core/home/sizeBehavior").do(function(s){v.setProperty("/sizeBehavior",s);});function a(w){var P=w.getBindingContext().getPath().split("/"),W=P.pop();P.pop();return{widgetIndex:W,groupIndex:P.pop()};}return{init:function(c){m=c;p=c.getView().byId("page");p.setModel(c.getModel());p.setModel(v,"viewSettings");r.i18n=c.getResourceBundle();var e=c.getModel().getProperty("/edit");p.toggleStyleClass("sapUshellPageComposing",!!e);},exit:function(){_.off();},itemFactory:function(s,c){var o=c.getProperty(c.sPath),b=m.mCatalogTiles[o.vizId],d;if(b){var l=sap.ushell.Container.getService("LaunchPage");var h=l.getCatalogTilePreviewTitle(b)||l.getCatalogTileTitle(b);var S=l.getCatalogTilePreviewSubtitle(b);var f=l.getCatalogTilePreviewInfo(b);var e=l.getCatalogTilePreviewIcon(b);var g;var j;if(b.getChip){g=b.getChip().getBaseChipId()==="X-SAP-UI2-CHIP:/UI2/DYNAMIC_APPLAUNCHER";}else if(b.tileResolutionResult){g=!!b.tileResolutionResult.indicatorDataSource;}else{g=b.tileType==="sap.ushell.ui.tile.DynamicTile";}if(g){j=new N({icon:e,value:"0",width:"100%"});}else{j=new I({src:e});}d=new G(s,{header:h,subheader:S,tileContent:[new T({footer:f,content:[j]})]});if(o.error){d.setState("Failed");}}else if(!i(m.mCatalogTiles)){d=new G(s,{state:"Failed"});}else{d=new G(s,{state:"Loading"});}d.attachPress(function(E){if(E.getParameter("action")==="Remove"){var k=E.getSource(),w=a(k);m.deleteContentInGroup(w.widgetIndex,w.groupIndex);}});d.bindProperty("sizeBehavior","viewSettings>/sizeBehavior");d.setScope(m.getModel().getProperty("/edit")?"Actions":"Display");return d;},collectErrors:function(){var e=[];p.getGroups().forEach(function(g,b){var o=g.byId("title-edit");if(g.getTitle()===""){o.setValueState("Warning");o.setValueStateText(r.i18n.getText("Message.InvalidGroupTitle"));e.push({type:"Warning",title:r.i18n.getText("Title.NoGroupTitle",b+1),description:r.i18n.getText("Message.NoGroupTitle",b+1)});}else{o.setValueState("None");}g.getWidgets().forEach(function(t,c){if(t.getState()==="Failed"){if(t.getHeader()===""&&t.getSubheader()===""){e.push({type:"Error",title:r.i18n.getText("Title.UnsufficientRoles"),subtitle:r.i18n.getText("Title.ContentIsNotVisible"),description:r.i18n.getText("Message.LoadTileError",[(c+1)+".",g.getTitle()])});}else{e.push({type:"Warning",title:r.i18n.getText("Message.NavigationTargetError"),subtitle:r.i18n.getText("Title.ContentNotNavigateable"),description:r.i18n.getText("Message.NavTargetResolutionError",t.getHeader())});}}});});return e;},addGroup:function(e){var g=e?e.getParameter("index"):0;m.addGroupAt(g);},deleteGroup:function(e){var g=e.getSource();sap.ui.require(["sap/m/MessageBox"],function(M){function d(A){if(A===M.Action.DELETE){m.deleteGroup(p.indexOfGroup(g));}}sap.ushell.Container.getService("Message").confirm(r.i18n.getText("Message.DeleteGroup",g.getTitle()),d,r.i18n.getText("Button.Delete"),[M.Action.DELETE,M.Action.CANCEL]);});},moveGroup:function(o){var d=o.getParameter("draggedControl"),D=o.getParameter("droppedControl"),s=o.getParameter("dropPosition"),b=p.indexOfGroup(d),c=p.indexOfGroup(D);if(s==="After"){if(c<b){c++;}}else if(c>b){c--;}m.moveGroup(b,c);},moveContent:function(d){var D=d.getParameter("draggedControl"),o=d.getParameter("droppedControl"),s=d.getParameter("dropPosition"),b=a(o),c=b.widgetIndex,e=b.groupIndex;if(D.isA("sap.m.CustomTreeItem")){var f=d.getParameter("dragSession").getComplexData("callback");if(s==="After"){c++;}f(c,e);return;}var g=a(D),h=g.widgetIndex,j=g.groupIndex;if(j===e){if(s==="After"){if(c<h){c++;}}else if(c>h){c--;}}else if(s==="After"){c++;}m.moveContentInGroup(h,c,j,e);},addContent:function(d){var D=d.getParameter("draggedControl"),o=d.getParameter("droppedControl"),b=o.getWidgets().length,c=p.indexOfGroup(o);if(D.isA("sap.m.CustomTreeItem")){d.getParameter("dragSession").getComplexData("callback")(b,c);return;}var e=a(D),f=e.widgetIndex,g=e.groupIndex;m.moveContentInGroup(f,b,g,c);}};});
